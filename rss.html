<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>裏紙</title>
        <link>https://backpaper0.github.io/</link>
        <description>I ❤️ BotW.</description>
        <language>en-us</language>
        <pubDate>Thu, 22 Feb 2018 00:00:00 +0000</pubDate>
        
        <item>
            <link>https://backpaper0.github.io/2018/02/22/spring_proxy.html</link>
            <guid>https://backpaper0.github.io/2018/02/22/spring_proxy.html</guid>
            <title><![CDATA[Springのproxyとfinalメソッド、それからnull]]></title>
            <description><![CDATA[<h1>Springのproxyとfinalメソッド、それからnull</h1>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">SpringのRepositoryとComponentアノテ、動きに違いがあるのか、、<br/>Repositoryだとフィールドがnullになってハマった</p>— こざけ (@s_kozake) <a href="https://twitter.com/s_kozake/status/964792731548631040?ref_src=twsrc%5Etfw">2018年2月17日</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8">{}</script><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ようやく🍥Repositoryでフィールドの値がnullになる原因が分かった、、<br/>メソッドをfinal指定してました<br/>サブクラスベースのProxyではメソッドやクラスにfinalをつけてはいけないとあれほど_:(´ཀ`」 ∠):</p>— こざけ (@s_kozake) <a href="https://twitter.com/s_kozake/status/965462883864735744?ref_src=twsrc%5Etfw">2018年2月19日</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8">{}</script><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ここら辺、どこか詳しい資料ありますか？<br/>CGLIBを用いてサブクラスベースのProxyを実現している状況で、メソッドをfinalにした場合、内部でどのような状況になってnullのインスタンスを見るようになったかという<br/>まあ、そもそもfinal切るなって話なのですが</p>— こざけ (@s_kozake) <a href="https://twitter.com/s_kozake/status/965717257379659777?ref_src=twsrc%5Etfw">2018年2月19日</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>こざけさんがこんな感じでわちゃわちゃしていたので、詳しい資料はどこにあるか分からないけれど、なぜそうなったのか解説しようと思います。</p>
<p>なぜそうなるのか概ね理解していたけれど、理解していなかった点を調べる過程で私自身も学ぶことがあったので、正直こざけさんには調べるきっかけを作ってくれてありがとうございますという感じです！</p>
<div class="section" id="repositoryproxy">
<h2>@Repositoryとproxy</h2>
<p><span class="docutils literal"><span class="pre">@Repository</span></span> をクラスに付けると、そのクラスのproxyが作られます。</p>
<p>proxyてなんやねんって話ですが、これは実行時に生成される該当クラスのサブクラスで、他のコンポーネントにインジェクションされるのはこのproxyのインスタンスです。
実際のクラスのインスタンスへはproxyのインスタンスを経由して委譲される仕組みになっています。</p>
<p>このproxyの仕組みには、コンポーネントの利用者がスコープを意識しなくてよくなるという利点があります。</p>
<p>どういうことか、順を追って見ていきましょう。</p>
<div class="section" id="proxydi">
<h3>proxyという概念が無いDIコンテナ</h3>
<p>DIコンテナにはスコープというものがあります。</p>
<p>これはコンポーネントのライフサイクルを表すもので、Webアプリで動くDIコンテナであれば「リクエストスコープ」や「セッションスコープ」を持っています。
「リクエストスコープ」はその名の通りHTTPリクエストの開始から終了までの間に有効となるスコープです。
「セッションスコープ」もその名の通りでセッションを開始してから破棄されるまでの間に有効となるスコープです。</p>
<p>では「セッションスコープのコンポーネント」から「リクエストスコープのコンポーネント」を使用することを考えてみましょう。
コードで書くとこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//※これはSpringではない架空のDIコンテナのコード</span>

<span class="nd">@SessionScope</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Fuga</span> <span class="n">fuga</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fuga</span><span class="p">.</span><span class="na">process</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@RequestScope</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Fuga</span> <span class="p">{</span>
    <span class="c1">//フィールドやメソッドの定義は省略</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この <span class="docutils literal"><span class="pre">Hoge</span></span> と <span class="docutils literal"><span class="pre">Fuga</span></span> を使った処理の流れは、</p>
<ol class="arabic simple">
<li>HTTPリクエストを受け取る</li>
<li>セッションを作成する</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> のインスタンスを作成する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のインスタンスを作成する</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> に <span class="docutils literal"><span class="pre">Fuga</span></span> をインジェクションする</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> の <span class="docutils literal"><span class="pre">action</span></span> メソッドを実行する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> の <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行する</li>
<li>HTTPリクエストが終了する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のインスタンスをDIコンテナから破棄する</li>
<li>HTTPレスポンスを返す</li>
</ol>
<p>という感じ。</p>
<p>あんまり問題なさそうに見えますが、 <span class="docutils literal"><span class="pre">Fuga</span></span> の <span class="docutils literal"><span class="pre">process</span></span> メソッドが実行中に同じユーザーからもう一つHTTPリクエストが来たらどうなるでしょうか？</p>
<ol class="arabic simple">
<li>HTTPリクエストAを受け取る</li>
<li>セッションを作成する</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> のインスタンスを作成する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のインスタンスを作成する（リクエストAのスコープ）</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> に <span class="docutils literal"><span class="pre">Fuga</span></span> をインジェクションする</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> の <span class="docutils literal"><span class="pre">action</span></span> メソッドを実行する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> の <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行し始める</li>
<li>HTTPリクエストBを受け取る</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のインスタンスを作成する（リクエストBのスコープ）</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> に <span class="docutils literal"><span class="pre">Fuga</span></span> をインジェクションする……！？</li>
</ol>
<p>とまあ、こんな感じで <span class="docutils literal"><span class="pre">Hoge</span></span> にインジェクションされる <span class="docutils literal"><span class="pre">Fuga</span></span> がバッティングするわけです。</p>
<p>そういうわけでproxyの無いDIコンテナでは、あるスコープのコンポーネントには、それよりも小さいスコープ（ライフサイクルが短いと言い換えても良さそう）のコンポーネントをインジェクションできませんでした。
proxyが無くてこのような制約のあるDIコンテナとしてはSeasar2が挙げられます。</p>
</div>
<div class="section" id="id1">
<h3>proxyがあるDIコンテナ</h3>
<p>先に述べた問題をproxyがどのように解決するのか見ていきましょう。</p>
<p><span class="docutils literal"><span class="pre">Fuga</span></span> のproxyをコードで書くとこんな感じになります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//実際には実行時にクラスファイルが生成されるのでソースコードは存在しない</span>
<span class="c1">//あくまでもproxyのイメージ</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FugaProxy</span> <span class="kd">extends</span> <span class="n">Fuga</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">Container</span> <span class="n">container</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Fuga</span> <span class="n">component</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="na">getComponent</span><span class="p">(</span><span class="n">Fuga</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">component</span><span class="p">.</span><span class="na">process</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>コード上のコメントにも書きましたが、proxyは実際には実行時にクラスファイル（というかインメモリ上にバイトコードのデータ）として生成されるのが普通なので、ソースコードはありません。
コード例は雰囲気です。</p>
<p>コードを見てみると <span class="docutils literal"><span class="pre">process</span></span> メソッドが呼ばれるとDIコンテナからproxyではない実際の <span class="docutils literal"><span class="pre">Foo</span></span> インスタンスが取り出され、そのインスタンスの <span class="docutils literal"><span class="pre">process</span></span> メソッドが呼ばれています。</p>
<p>先ほどのproxyが無いDIコンテナで <span class="docutils literal"><span class="pre">Fuga</span></span> がバッティングしてしまったシナリオを、proxyがあるDIコンテナではどうなるか見てみましょう。</p>
<ol class="arabic simple">
<li>HTTPリクエストAを受け取る</li>
<li>セッションを作成する</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> のインスタンスを作成する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のインスタンスを作成する（リクエストAのスコープ）</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のproxyを作成する</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> に <span class="docutils literal"><span class="pre">Fuga</span></span> のproxyをインジェクションする</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> の <span class="docutils literal"><span class="pre">action</span></span> メソッドを実行する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のproxyの <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行し始める</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のproxy内でDIコンテナから実際の <span class="docutils literal"><span class="pre">Fuga</span></span> インスタンス（リクエストAのスコープ）を取り出して <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行し始める</li>
<li>HTTPリクエストBを受け取る</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のインスタンスを作成する（リクエストBのスコープ）</li>
<li><span class="docutils literal"><span class="pre">Hoge</span></span> の <span class="docutils literal"><span class="pre">action</span></span> メソッドを実行する</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のproxyの <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行し始める</li>
<li><span class="docutils literal"><span class="pre">Fuga</span></span> のproxy内でDIコンテナから実際の <span class="docutils literal"><span class="pre">Fuga</span></span> インスタンス（リクエストBのスコープ）を取り出して <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行し始める</li>
</ol>
<p>このようにproxyを経由してDIコンテナから異なる <span class="docutils literal"><span class="pre">Fuga</span></span> インスタンスを取り出して <span class="docutils literal"><span class="pre">process</span></span> メソッドを実行できました。</p>
<p>以上のことからproxyがあるDIコンテナではスコープを意識することなくインジェクションを行えることが分かりました。</p>
</div>
</div>
<div class="section" id="finalnull">
<h2>finalメソッドからフィールドを参照したらnullになった理由</h2>
<p>当初の問題に戻りましょう。
「 <span class="docutils literal"><span class="pre">@Respository</span></span> を付けたクラスの <span class="docutils literal"><span class="pre">final</span></span> なメソッドを実行するとインジェクションされたはずのフィールドへアクセスしたときに <span class="docutils literal"><span class="pre">NullPointerException</span></span> が発生した」という問題です。</p>
<p>次のコードを見てください。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">Bar</span> <span class="n">bar</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">method1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"%s%n%s%n"</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">getClass</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">method2</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"%s%n%s%n"</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">getClass</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">method1</span></span> と <span class="docutils literal"><span class="pre">method2</span></span> はどちらもフィールド <span class="docutils literal"><span class="pre">bar</span></span> と自分自身のクラスを文字列にして返しています。
異なる点は <span class="docutils literal"><span class="pre">method2</span></span> は <span class="docutils literal"><span class="pre">final</span></span> であるということだけです。</p>
<p><span class="docutils literal"><span class="pre">method1</span></span> の実行結果はこちら。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>com.example.demo.Bar@1db75e25
class com.example.demo.Foo
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">method2</span></span> の実行結果はこちら。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>null
class com.example.demo.Foo$$EnhancerBySpringCGLIB$$a65476ff
</pre></div>
</div>
<p>当初の問題と同じように <span class="docutils literal"><span class="pre">final</span></span> な方の <span class="docutils literal"><span class="pre">method2</span></span> では <span class="docutils literal"><span class="pre">bar</span></span> が <span class="docutils literal"><span class="pre">null</span></span> になっていますね。</p>
<p>ただ、クラス名にも注目してください。
<span class="docutils literal"><span class="pre">method1</span></span> では <span class="docutils literal"><span class="pre">Foo</span></span> となっていますが <span class="docutils literal"><span class="pre">method2</span></span> は <span class="docutils literal"><span class="pre">Foo</span></span> のproxyになっています。</p>
<p>ここで <span class="docutils literal"><span class="pre">Foo</span></span> のproxyがどうなっているのか、再び雰囲気でコードにしてみましょう。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//雰囲気</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo$$EnhancerBySpringCGLIB$$a65476ff</span> <span class="kd">extends</span> <span class="n">Foo</span> <span class="p">{</span>

    <span class="n">Container</span> <span class="n">container</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">method1</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Foo</span> <span class="n">component</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="na">getComponent</span><span class="p">(</span><span class="n">Foo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">component</span><span class="p">.</span><span class="na">method1</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//method2はfinalなのでoverrideできない</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ご覧の通り <span class="docutils literal"><span class="pre">method1</span></span> はコンテナから実際のインスタンスを取り出して委譲していますが、
<span class="docutils literal"><span class="pre">method2</span></span> は <span class="docutils literal"><span class="pre">final</span></span> なため <span class="docutils literal"><span class="pre">override</span></span> できずに実際のインスタンスに委譲されることなく実行されてしまいます。</p>
<p>proxyは、コンテナから実際のインスタンスを取り出して委譲するものなので、proxyに対してコンポーネントをインジェクションする意味はありません。
実際、元のクラスでインジェクション対象となっているフィールドはproxyでは <span class="docutils literal"><span class="pre">null</span></span> になります。</p>
<p>以上が、proxyが作られるクラスに定義された <span class="docutils literal"><span class="pre">final</span></span> メソッドがインジェクション対象のフィールドを参照している場合に <span class="docutils literal"><span class="pre">NullPointerException</span></span> になる理由です。</p>
</div>
<div class="section" id="proxy">
<h2>コンストラクタインジェクションとproxy</h2>
<p>さて、ここからが私も初めて知った事柄になります。
久しぶりにびっくりした。</p>
<p>次のようにコンストラクタインジェクションしているクラスを考えてみましょう。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Bar</span> <span class="n">bar</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">Bar</span> <span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">bar</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">.</span><span class="na">requireNonNull</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">method1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"%s%n%s%n"</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">getClass</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">method2</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"%s%n%s%n"</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">getClass</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>proxyの雰囲気コードはこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//雰囲気</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo$$EnhancerBySpringCGLIB$$a65476ff</span> <span class="kd">extends</span> <span class="n">Foo</span> <span class="p">{</span>

    <span class="n">Container</span> <span class="n">container</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Foo$$EnhancerBySpringCGLIB$$a65476ff</span><span class="p">(</span><span class="n">Bar</span> <span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">super</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">method1</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Foo</span> <span class="n">component</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="na">getComponent</span><span class="p">(</span><span class="n">Foo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">component</span><span class="p">.</span><span class="na">method1</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//method2はfinalなのでoverrideできない</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この場合、生成されるproxyのコンストラクタ引数 <span class="docutils literal"><span class="pre">bar</span></span> には何が入るのでしょうか？</p>
<p>先に述べた通り、proxyのインジェクション対象フィールドにはインジェクションする意味はありません。
かと言って <span class="docutils literal"><span class="pre">null</span></span> を渡すとスーパークラスのコンストラクタで <span class="docutils literal"><span class="pre">Objects.requireNonNull</span></span> によって <span class="docutils literal"><span class="pre">NullPointerException</span></span> がスローされます。</p>
<p>それではSpringはproxyをインスタンス化するときに何を渡すのでしょうか？</p>
<p>色々とがんばってソースコードを追っかけた末に分かったのですが、コンストラクタを呼ばずにインスタンス化していました。
何を言っているのか分かりませんね？</p>
<p>proxyのインスタンス化にはObjenesisというライブラリの次のクラスが使われていました。
（実際には <span class="docutils literal"><span class="pre">org.springframework.objenesis</span></span> にrepackageされています）</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/easymock/objenesis/blob/2.6/main/src/main/java/org/objenesis/instantiator/sun/SunReflectionFactoryInstantiator.java">https://github.com/easymock/objenesis/blob/2.6/main/src/main/java/org/objenesis/instantiator/sun/SunReflectionFactoryInstantiator.java</a></li>
</ul>
<p>クラスのJavadocに次の記載があります。</p>
<blockquote>
<div>Instantiates an object, WITHOUT calling it’s constructor, using internal sun.reflect.ReflectionFactory</div></blockquote>
<p>お、おう……！
って感じですが、JDKのinternalなクラスを使ってコンストラクタを呼ばずにインスタンス化していました。
だからフィールドが <span class="docutils literal"><span class="pre">null</span></span> だった、というわけですね。</p>
<p>コンストラクタ呼ばれないってどういうことだよ……と思いながら <span class="docutils literal"><span class="pre">SunReflectionFactoryInstantiator</span></span> を眺めていたら <span class="docutils literal"><span class="pre">newConstructorForSerialization</span></span> というメソッド名が出てきて、そういえばシリアライズされたオブジェクトをデシリアライズする時ってコンストラクタ呼ばれないんだっけ、とか雑な記憶で雑に思いました。
とか書いておくと詳しい人がコメントくれるはずです。
他力本願。</p>
</div>
<div class="section" id="id2">
<h2>まとめ</h2>
<ul class="simple">
<li>DIコンテナにはproxyを経由してスコープを意識せずに使える機能がある</li>
<li>proxyは実行時にサブクラスを生成して実現するので <span class="docutils literal"><span class="pre">final</span></span> メソッドを使うとマズい</li>
<li>SpringではproxyはJDKのinternalなクラスを使用してコンストラクタ呼び出し無しにインスタンス化される（その結果フィールドが <span class="docutils literal"><span class="pre">null</span></span> になる）</li>
</ul>
<p>こんな感じで、割と真っ黒な黒魔術に辿り着いた感があって楽しかったです。
こざけさん、ありがとう！</p>
<div class="section" id="id3">
<h3>ちなみに</h3>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">警告みたいなの欲しいですねー</p>— opengl-8080 (@opengl_8080) <a href="https://twitter.com/opengl_8080/status/965788137967386624?ref_src=twsrc%5Etfw">2018年2月20日</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8">{}</script><p><span class="docutils literal"><span class="pre">INFO</span></span> レベルですが、ログは出ているみたいです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>018-02-22 22:22:14.298  INFO 25770 --- [  restartedMain] o.s.aop.framework.CglibAopProxy          : Final method [public final java.lang.String com.example.demo.Foo.method2()] cannot get proxied via CGLIB: Calls to this method will NOT be routed to the target instance and might lead to NPEs against uninitialized fields in the proxy instance.
</pre></div>
</div>
</div>
</div>
]]></description>
             <pubDate>Thu, 22 Feb 2018 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2017/04/17/acrobook.html</link>
            <guid>https://backpaper0.github.io/2017/04/17/acrobook.html</guid>
            <title><![CDATA[「Java本格入門」を読んだ]]></title>
            <description><![CDATA[<h1>「Java本格入門」を読んだ</h1>
<p><a class="reference external" href="https://twitter.com/cero_t">せろさん</a>
に献本して貰いました。
ありがとうございます！</p>
<ul class="simple">
<li><a class="reference external" href="http://gihyo.jp/book/2017/978-4-7741-8909-3">Java本格入門 ～モダンスタイルによる基礎からオブジェクト指向・実用ライブラリまで：書籍案内｜技術評論社</a></li>
</ul>
<p>この本はJavaの入門書ではありますが「本格」と付いているだけあって、</p>
<ul class="simple">
<li>コレクションの実装に踏み込んでどの場面でどの実装を使うべきか</li>
<li><span class="docutils literal"><span class="pre">Map#computeIfAbsent</span></span> の現場あるあるな使い方</li>
<li>正規表現関連のオブジェクト( <span class="docutils literal"><span class="pre">Pattern</span></span> 、 <span class="docutils literal"><span class="pre">Matcher</span></span> )と <span class="docutils literal"><span class="pre">String</span></span> のメソッドの使い分け</li>
</ul>
<p>など、実践的な内容が含まれています。</p>
<p>また、Java 8を前提として書かれてはいますが、
ファイル操作に関してはJava 6までのやり方( <span class="docutils literal"><span class="pre">java.io</span></span> )とJava 7以降のやり方( <span class="docutils literal"><span class="pre">java.nio.file</span></span> )が、
日時操作に関してはJava 7までのやり方( <span class="docutils literal"><span class="pre">java.util.Date</span></span> 、 <span class="docutils literal"><span class="pre">java.util.Calendar</span></span> )とJava 8以降のやり方( <span class="docutils literal"><span class="pre">java.time</span></span> )が両方書かれています。
趣味プログラミングならいつでも最新のバージョンを使っていれば良いですが、仕事では案件によっては保守だけに徹しており古いやり方でコードを読み書きする必要がある場合もあるでしょう。
この本ならレガシーと最新のどちらのやり方も学ぶ事ができます。</p>
<p>他にも、文法的に許可されてはいるが実践的な観点から書かない方が良いコードを教えてくれたり、
インターフェースと抽象クラスの良い使い分け方を示してくれたり、
執筆陣の知識・経験を元に書かれていることが単なる初心者向けの入門書とは異なるところだと感じました。</p>
<p>私の感覚でいうと、まったくの新人ではなく現場に出て2年目あるいは3年目ぐらいがこの本を読むのに適したレベルかな、と思います。</p>
<div class="section" id="id3">
<h2>間違いと思われる記述</h2>
<p>いくつか間違いがあったので挙げておこうと思います。</p>
<div class="section" id="id4">
<h3>35ページ、 <span class="docutils literal"><span class="pre">&gt;&gt;</span></span> 演算子の説明</h3>
<blockquote>
<div>正負の符号を表すビットは保持し、それ以外の空いたビットは0埋めする。</div></blockquote>
<p>右方向の算術シフトは空いたビットを0埋めするのではなく、符号と同じビットで埋めます。</p>
</div>
<div class="section" id="id5">
<h3>82ページ、インターフェースの説明</h3>
<blockquote>
<div>インターフェースは必ずpublicになるため、インターフェース名の前に書くpublicは省略することができます。</div></blockquote>
<p>インターフェース名の前の <span class="docutils literal"><span class="pre">public</span></span> を省略するとパッケージプライベートになります。</p>
<p>また、ネストしたインターフェースは <span class="docutils literal"><span class="pre">private</span></span> にすることもできます。</p>
</div>
<div class="section" id="id6">
<h3>156ページ、メソッド参照の文法</h3>
<p>これは間違いというより、表の内容が足りていないと思われます。</p>
<p>staticメソッドを参照する記法のひとつとして次のものを挙げています。</p>
<blockquote>
<div>{クラス名}::{メソッド名}</div></blockquote>
<p>でもこれ、場合によってはインスタンスのメソッドを参照する記法としても使えます。</p>
<p>例えば、次のようなコードです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//{クラス名}::{メソッド名}の記法でインスタンスのメソッドを参照している</span>
<span class="n">ToIntFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">String</span><span class="p">::</span><span class="n">length</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="na">applyAsInt</span><span class="p">(</span><span class="s">"foobar"</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>197ページ、ラムダ式内での例外について</h3>
<blockquote>
<div>ラムダの中に記述した処理で例外が発生する可能性があります。
それが検査例外だった場合は、捕捉しないと、コンパイルエラーが発生します。</div></blockquote>
<p>Stream APIで使われるラムダ式、つまり <span class="docutils literal"><span class="pre">Function</span></span> や <span class="docutils literal"><span class="pre">Predicate</span></span> であればそうですが、
例えば <span class="docutils literal"><span class="pre">Callable</span></span> のラムダ式であれば <span class="docutils literal"><span class="pre">call</span></span> メソッドは <span class="docutils literal"><span class="pre">throws</span> <span class="pre">Exception</span></span> と宣言されているので
<span class="docutils literal"><span class="pre">Exception</span></span> を <span class="docutils literal"><span class="pre">catch</span></span> する必要はありません。</p>
</div>
<div class="section" id="id8">
<h3>その他の軽い間違い</h3>
<p>108ページ、フィボナッチ数を求める定義とコードが書かれていますが、定義を見ると <span class="docutils literal"><span class="pre">F0</span> <span class="pre">=</span> <span class="pre">0</span> <span class="pre">F1</span> <span class="pre">=</span> <span class="pre">1</span> <span class="pre">Fn</span> <span class="pre">=</span> <span class="pre">...</span></span>
となっていますが、
直後に記載されている昔ながらの <span class="docutils literal"><span class="pre">for</span></span> ループを使ったコードは <span class="docutils literal"><span class="pre">i</span> <span class="pre">&lt;=</span> <span class="pre">1</span></span> のときに <span class="docutils literal"><span class="pre">1</span></span> を代入しているので、
定義とコードが合ってないですね。</p>
<p>それと134ページ、「Mapインターフェースでの要素の取得、変換」に値の集合を取得するメソッドとして <span class="docutils literal"><span class="pre">valueSet</span></span>
が挙げられていますが <span class="docutils literal"><span class="pre">values</span></span> の間違いだと思います。
なお、 <span class="docutils literal"><span class="pre">values</span></span> の戻り値は集合( <span class="docutils literal"><span class="pre">Set</span></span> )ではなくコレクション( <span class="docutils literal"><span class="pre">Collection</span></span> )です。</p>
<p>あと、めっちゃ細かいところで言うと、183ページにAutoClosable、Closableという記述がありますが、
正しくはAutoCloseable、Closeableです。
(めっちゃ分かりづらいですが……)</p>
</div>
</div>
<div class="section" id="id9">
<h2>まとめ</h2>
<p>このようにいくつか間違いと思われる記述もありましたが、
これらは前半の章(文法の解説などのまさに入門的な章)に集中していました。</p>
<p>読み進めるにつれてより実践的な内容が増えており、
現場で使える知識を付けることができるのではないでしょうか。</p>
</div>
]]></description>
             <pubDate>Mon, 17 Apr 2017 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/12/31/good_bye_2016.html</link>
            <guid>https://backpaper0.github.io/2016/12/31/good_bye_2016.html</guid>
            <title><![CDATA[2016年ふりかえり]]></title>
            <description><![CDATA[<h1>2016年ふりかえり</h1>
<div class="section" id="id2">
<h2>今年の活動</h2>
<p>今年は意識的にいろいろ登壇するぞー、と昨年から決めていました。</p>
<p>結果は次の通り。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.oracle.co.jp/events/javaday/2016/">Java Day Tokyo 2016でJava EEとWebセキュリティに関するテーマで登壇</a></li>
<li><a class="reference external" href="http://backpaper0.github.io/2016/07/12/doma_tokyo.html">東京でDoma勉強会を開催してDoma作者の中村さんに初めてお会いした</a></li>
<li><a class="reference external" href="http://backpaper0.github.io/2016/10/09/scala_ks.html">Scala関西Summit 2016で登壇</a></li>
<li><a class="reference external" href="http://springday2016.springframework.jp/session.html#session2-5">Spring Day 2016でJava EE(JAX-RS、CDI)とSpring(Spring MVC、Spring Framework)の比較をテーマに登壇</a></li>
<li><a class="reference external" href="https://github.com/jjug-ccc/call-for-paper-2016fall/issues/37">JJUG CCC 2016 Fallで登壇</a></li>
</ul>
<p>登壇以外で言うと、いろふさんと二人でWEB+DB PRESSで「Javaの新定石」の連載をしたのが大きいです。</p>
<p>Java Day TokyoとSpring Dayの登壇、それからWEB+DB PRESSの連載は会社名を出して行いましたが、
出張扱いで交通費も完全に出して貰ったし、これらの社外活動も評価して貰えているので、弊社は良い中小SIerだなー、と思いました。</p>
<p>それから、これはネタ以外のなにものでもないけれど、
<a class="reference external" href="https://twitter.com/backpaper0/status/705763807964991488">セミコロンレスJavaで戻り値のあるメソッドを実装してのけました</a>
。
この時ばかりは、自分を天才かと思いました。</p>
</div>
<div class="section" id="id3">
<h2>来年に向けて</h2>
<p>私のGitHubリポジトリのアクティビティログには顕著に現れていますが、
最近は完全にSpringへ傾倒しています。</p>
<p>今年は表面の美味しいところをぺろぺろした感じなので、
来年は奥まで覗いてﾁｮｯﾄﾃﾞｷﾙになろうと思っています。</p>
<p>まだまだ足りておらず飢えてもいるので、いろいろ殴って強くなりたいです。</p>
</div>
]]></description>
             <pubDate>Sat, 31 Dec 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/12/01/wife_peropero.html</link>
            <guid>https://backpaper0.github.io/2016/12/01/wife_peropero.html</guid>
            <title><![CDATA[世界の中心で愛を叫んだうらがみ]]></title>
            <description><![CDATA[<h1>世界の中心で愛を叫んだうらがみ</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/1480">妻・夫を愛してるITエンジニア Advent Calendar 2016</a> の1日目です。</p>
<p>Twitterでのノリと勢いで作ったんですが、早い段階で埋まった上に <a class="reference external" href="http://www.adventar.org/calendars/1559">その2</a>
も作られて、なんだかんだですごく楽しみなAdvent Calendarになりました。</p>
<p>書くことは特に定めておらずフリースタイルとなっています。
みなさん、それぞれの形で惚気て頂ければと思います。</p>
<div class="section" id="id3">
<h2>5周年</h2>
<p><a class="reference external" href="http://d.hatena.ne.jp/backpaper0/20111122/1321954834">結婚</a> してからまる5年が経ちました。
特に激しいケンカもなく、のんびりと、ゆる〜く夫婦をやっております。</p>
</div>
<div class="section" id="id5">
<h2>距離感</h2>
<p>妻も私と同じくプログラマです。
だけど私と異なり、家でまでコードを書くようなプログラマではありません。
たぶん、まったくの別業界の人よりは私のようなプログラマに理解があり、それでいて私の趣味には干渉しないぐらいの距離感が心地良く感じています。</p>
<p>週末は二人で出かけることが多いですが、「今週末は勉強会に行きたい！」と言っても「良いよ」と返してくれて、別々に行動することもままあります。
もちろん、妻が友達と遊びたいと言ってきた場合は私も了承するので、お互いを縛ることなく楽しく過ごせています。</p>
</div>
<div class="section" id="id6">
<h2>日常</h2>
<p>朝は私が朝ごはんの準備をしている間に妻がお弁当の準備をしてくれます。
夜は先に帰った方が晩ごはんの準備をします。</p>
<p>仕事が終わって帰るときはLINEします。
たまに無意味なスタンプの応酬になります。
気付いたら最寄駅です。</p>
<p>寝るまでの間はお茶を飲みながらお互い好きに過ごします。
大抵、私はPCでコード書いたりTwitterしたりギター弾いたり、妻はスマホをいじったりテレビを見たりしています。
好きなことをしつつ、ときどき会話して、また好きなことをして、妻がドライヤーで髪を乾かし、また会話して。</p>
<p>お互いに別々のことをしていても同じ空間に居るのが大切で、結婚というのはそういうものなのかもなー、と思っています。</p>
</div>
<div class="section" id="id7">
<h2>しみじみ</h2>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">家に帰ってるだけじゃなくて人にも帰ってるのかもなー</p>— うらがみ⛄️ (@backpaper0) <a href="https://twitter.com/backpaper0/status/693023696630476800">2016年1月29日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script></div>
<div class="section" id="id8">
<h2>最近のデート</h2>
<p>京都水族館、楽しかった。</p>
<blockquote class="instagram-media" data-instgrm-version="7" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"/></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://www.instagram.com/p/BNK-RUcDylN/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">うらがみさん(@backpaper0)が投稿した写真</a> - <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2016-11-23T23:40:54+00:00">2016 11月 23 3:40午後 PST</time></p></div></blockquote>
<script async="" defer="defer" src="//platform.instagram.com/en_US/embeds.js">{}</script></div>
<div class="section" id="id9">
<h2>まとめ</h2>
<p>ただただ日常と、普段から思っていることを書いただけで、大して惚気られなかった気もしますがいかがでしたか？</p>
<p>結婚は人によって合う・合わないがあると思うので無条件ではオススメはしませんが、
私は結婚して良かったなーと思うことはあっても逆は一度もありません。</p>
<p>いつもそばに居てくれて、妻には感謝しているし、愛しています。</p>
<p>明日は <a class="reference external" href="https://twitter.com/susumuis">@susumuis</a> さんです。</p>
</div>
]]></description>
             <pubDate>Thu, 01 Dec 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/10/09/scala_ks.html</link>
            <guid>https://backpaper0.github.io/2016/10/09/scala_ks.html</guid>
            <title><![CDATA[Scala関西Summit 2016へ参加・登壇したぞ！ #scala_ks]]></title>
            <description><![CDATA[<h1>Scala関西Summit 2016へ参加・登壇したぞ！ #scala_ks</h1>
<p>参加した！</p>
<ul class="simple">
<li><a class="reference external" href="http://summit.scala-kansai.org/">http://summit.scala-kansai.org/</a></li>
<li><a class="reference external" href="http://skug.connpass.com/event/38349/">http://skug.connpass.com/event/38349/</a></li>
</ul>
<p>で、セッション募集に応募したら採用されたので登壇もした！</p>
<ul class="simple">
<li><a class="reference external" href="/ghosts/colon-colon/">詳解::</a></li>
</ul>
<p>セッションではScalaの表現力を支える仕様を解説して、仕組みが分かるとまた違った楽しさが見えてくるよねー、っていう思いを伝えたかったのでした。</p>
<p>レビューしてくれたがくぞさん、ありがとうございました！！！</p>
<p>私はJavaエンジニアなので懇親会ぼっちになるかなー、と少し思ってたんですが友人をはじめ、わいわいお話できて楽しかったです！</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ひしだまさんと写真撮ったぜー！！！</p>— うらがみ⛄ (@backpaper0) <a href="https://twitter.com/backpaper0/status/784691065202716672">2016年10月8日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script>]]></description>
             <pubDate>Sun, 09 Oct 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/10/01/unreachable_statements.html</link>
            <guid>https://backpaper0.github.io/2016/10/01/unreachable_statements.html</guid>
            <title><![CDATA[セミコロンレスJavaで戻り値のあるメソッドを定義する(ただし返ってこない)の解説]]></title>
            <description><![CDATA[<h1>セミコロンレスJavaで戻り値のあるメソッドを定義する(ただし返ってこない)の解説</h1>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">セミコロンレスJavaで戻り値のあるメソッドを定義する(ただし返ってこない) <a href="https://t.co/OQfRPvQWlN">https://t.co/OQfRPvQWlN</a></p>— うらがみ⛄ (@backpaper0) <a href="https://twitter.com/backpaper0/status/702826568838610944">2016年2月25日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>これがなぜコンパイルを通るのか？という疑問を見かけたので解説してみます。</p>
<div class="section" id="id1">
<h2>到達不能文</h2>
<p>例えば <span class="docutils literal"><span class="pre">while(false)</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></span> とした時、この <span class="docutils literal"><span class="pre">while</span></span> ブロック内の文は絶対に実行されません。
このように絶対に実行されない文を <strong>到達不能</strong> と表現し、到達不能な文がある場合はコンパイルエラーになります。</p>
<p>次のような内容で <span class="docutils literal"><span class="pre">Sample1.java</span></span> を作成して <span class="docutils literal"><span class="pre">javac</span></span> してみてください。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample1</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">whileSample</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"到達不能！"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>次のようなエラーになります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Sample1.java:3: エラー: この文に制御が移ることはありません
        while(false) {
                     ^
エラー1個
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">for</span></span> 文でも同じ事ができます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample2</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forSample</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(;</span><span class="kc">false</span><span class="p">;)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"到達不能！"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Sample2.java:3: エラー: この文に制御が移ることはありません
        for(;false;) {
                     ^
エラー1個
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">try</span></span> 文はエラーメッセージは違いますが、次のようコードは到達不能な文を含むのでコンパイルエラーになります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample3</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">trySample</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"到達可能"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"到達可能"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">IllegalArgumentException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"到達不能！"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Sample3.java:7: エラー: 例外IllegalArgumentExceptionはすでに捕捉されています
        } catch(IllegalArgumentException e) {
          ^
エラー1個
</pre></div>
</div>
</div>
<div class="section" id="if">
<h2>特別扱いの <span class="docutils literal"><span class="pre">if</span></span></h2>
<p>ここまで <span class="docutils literal"><span class="pre">while</span></span> 、 <span class="docutils literal"><span class="pre">for</span></span> 、 <span class="docutils literal"><span class="pre">try</span></span> の到達不能な文を含むコードがコンパイルエラーになる例を見てきました。
<span class="docutils literal"><span class="pre">if</span></span> 文でも同じような事ができるかと思いきや、次のコードはコンパイルできてしまいます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample4</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ifSample</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"到達不能！"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>到達不能な文を含んだ <span class="docutils literal"><span class="pre">if</span></span> 文はどのようにコンパイルされたのか、 <span class="docutils literal"><span class="pre">javap</span> <span class="pre">-c</span> <span class="pre">Sample4</span></span> して確認してみましょう。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Compiled from "Sample4.java"
public class Sample4 {
  public Sample4();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
       4: return

  public void ifSample();
    Code:
       0: return
}
</pre></div>
</div>
<p>ご覧の通り、 <span class="docutils literal"><span class="pre">if</span></span> 文が綺麗さっぱり消えていますね。</p>
<p>では、 <span class="docutils literal"><span class="pre">if</span></span> の条件式を <span class="docutils literal"><span class="pre">true</span></span> に変えてコンパイルして <span class="docutils literal"><span class="pre">javap</span></span> してみましょう。
（クラス名などは少し変えてあります）</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Compiled from "Sample5.java"
public class Sample5 {
  public Sample5();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
       4: return

  public void ifSample();
    Code:
       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
       3: ldc           #3                  // String 到達可能
       5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
       8: return
}
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">if</span></span> 文の中身はありますが、条件を評価している部分がなくなりました。</p>
<p><span class="docutils literal"><span class="pre">if</span></span> がこのように特別扱いになっているのは、次のようなコードを書けるようにするためです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">sample</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"logging"</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>先述の特徴があるので、定数 <span class="docutils literal"><span class="pre">DEBUG</span></span> が <span class="docutils literal"><span class="pre">true</span></span> ならロギングされるけども、
<span class="docutils literal"><span class="pre">false</span></span> ならロギングのコードがクラスファイルからも消える、という感じです。</p>
</div>
<div class="section" id="return">
<h2><span class="docutils literal"><span class="pre">return</span></span> を書かずに戻り値のあるメソッドを定義する</h2>
<p><span class="docutils literal"><span class="pre">return</span></span> 文にはどうしてもセミコロンを書く必要があります。
それが故にセミコロンレスJavaでは戻り値のあるメソッドを定義することはできないと考えられていました。</p>
<p>私も「どのようにすればセミコロンを省略して <span class="docutils literal"><span class="pre">return</span></span> が書けるのか」と考えては挫折を繰り返してきましたが、
あるとき「セミコロンを省略して <span class="docutils literal"><span class="pre">return</span></span> が書けないなら、そもそも <span class="docutils literal"><span class="pre">return</span></span> を書かなければ良いのでは」と発想の転換をしてみました。</p>
<p>前半で述べた通り、到達不能な文を含むとコンパイルエラーになります。
逆に考えると、無限ループは到達可能なのでコンパイルを通るし、無限ループの後ろは到達不能なので何を書いてもコンパイルエラーになる、ということですね。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//到達可能</span>
<span class="p">}</span>
<span class="c1">//到達不能</span>
</pre></div>
</div>
<p>これにより冒頭に記載したツイートの通り、セミコロンを書かずに戻り値のあるメソッドを定義できました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Semicolonless</span> <span class="p">{</span>

    <span class="n">String</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ちなみにセミコロンはともかく、 <span class="docutils literal"><span class="pre">return</span></span> を書かずに戻り値のあるメソッドを定義する方法としては例外を投げるというのもあります。
（例えば <span class="docutils literal"><span class="pre">Thread.destroy()</span></span> ）</p>
<p>戻り値のあるメソッドに <span class="docutils literal"><span class="pre">return</span></span> 文なんて要らんかったんや！！！</p>
</div>
<div class="section" id="id2">
<h2>まとめ</h2>
<ul class="simple">
<li>一見不可能に思えることでも考え方を変えることで解決する場合がある</li>
<li>とはいえ解決したところで役に立たないものもある</li>
</ul>
</div>
<div class="section" id="id3">
<h2>参考</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/unreachable-statements">前半に記載した到達不能コードたち</a></li>
<li><a class="reference external" href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-14.html#jls-14.21">Java Language Specification 14.21. Unreachable Statements</a></li>
<li><a class="reference external" href="https://twitter.com/backpaper0/status/705763807964991488">戻ってくるようになりました</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sat, 01 Oct 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/09/11/githubwww.html</link>
            <guid>https://backpaper0.github.io/2016/09/11/githubwww.html</guid>
            <title><![CDATA[GitHubで毎日草生やし続ける運動を終了する]]></title>
            <description><![CDATA[<h1>GitHubで毎日草生やし続ける運動を終了する</h1>
<div class="section" id="id1">
<h2>GitHubで毎日草生やし続ける運動とは</h2>
<p>GitHubはコミットしたりプルリクするとプロフィールページのタイルっぽいやつが緑になります。
緑になるから「草を生やす」って比喩してるんですけど、それを毎日続けて緑で埋め尽くそうというものです。</p>
</div>
<div class="section" id="id2">
<h2>進捗</h2>
<p>7月最後の週ぐらいに草だらけになりました。</p>
<div class="figure">
<img alt="Slackでわざわざ報告している図。" src="https://backpaper0.github.io/_images/githubwww.png"/>
</div>
<p>それからも毎日草生やしてたので400日ぐらいは継続できていると思います。</p>
</div>
<div class="section" id="id3">
<h2>なぜやろうと思ったか</h2>
<p>三十路になって「これからもコードを書いていられるのだろうか？(環境というよりは自分のモチベーション的な意味で)」と思うようになりました。
なので好きかどうか自分自身を試そうかなー、と。</p>
</div>
<div class="section" id="id4">
<h2>やってみて得たもの</h2>
<p>やる前に思ってたよりもずっと楽しんで続けられたので、やっぱり自分はコード書くの好きなんだな、と思えました。これは嬉しい。</p>
<p>あと、大したコードは書けてないですが、サンプルやらビルドスクリプトが溜まってきて何かと役立っています。</p>
</div>
<div class="section" id="id5">
<h2>なぜやめようと思ったか</h2>
<p>「継続」を目的としていたので、書きたいコードが思いつかない日はREADME.mdを修正するといったセコい草もたまには生やしていましたが、もうそうまでして草生やすのは面倒に思えてきました。</p>
<p>それに、読書のような草が生えない活動にももっと時間を使いたいなーと思い始めました。</p>
<p>当初の目標であった一年は継続できたので、やめるのにも未練は無いですし。
(でもなんか気持ちの整理的にやめることは記しておきたくてこのエントリを書いてる)</p>
</div>
<div class="section" id="id6">
<h2>まとめ</h2>
<ul class="simple">
<li>コード書くのが好きだと再確認できて個人的には意義がある試みでした</li>
<li>草生やし運動は人によって合う・合わないがあるので特別おすすめはしません</li>
<li>一年後、プロフィールページが不毛の地と化していたら嘲笑ってください</li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 11 Sep 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/09/06/private_method.html</link>
            <guid>https://backpaper0.github.io/2016/09/06/private_method.html</guid>
            <title><![CDATA[privateメソッドについての思いの変遷]]></title>
            <description><![CDATA[<h1>privateメソッドについての思いの変遷</h1>
<p><a class="reference external" href="http://su-kun1899.hatenablog.com/entry/2016/09/05/010104">UnitTestでのprivateメソッドとの向き合い方 - ジムには乗りたい</a>
を読んで、自分のprivateメソッドに対する思いを書き殴りたくなったので書いてみました。</p>
<div class="section" id="id1">
<h2>変遷</h2>
<p>新人の頃の☃「private？メソッド？というのがあるのか。ふむ。ふむ……？」</p>
<p>新人ではなくなったが若手の頃の☃「メソッドが大きくなってきたな。privateメソッドで分割だ！」</p>
<p>若手とは言えなくなった頃の☃「privateメソッドのテストコードってどう書いたら良いんだ？リフレクションか？」</p>
<p>2、3年前の☃「privateメソッドは共通処理を切り出すためのもの。呼び出し元のpublicメソッドのテストコードで担保される」</p>
<p>最近の☃「privateメソッド スベテ コロス！！！」</p>
</div>
<div class="section" id="id2">
<h2>解説</h2>
<p>新人の頃は割愛。</p>
<p>次の若手の頃の話は、これは大きいメソッドを単にぶつ切りにして満足しちゃってた感じ。
臭いものに蓋してるだけで何の解決にもなっていませんでしたね、今から思うと。</p>
<p>それからprivateメソッドのテストコードについて悩みました。
どうすれば良いんだ？と。
悩んだ挙句protectedにしちゃたりしてましたが、これも誤魔化しですね。</p>
<p>で、しばらくして、呼び出し元のテストで担保できるじゃろ、と思うようになりました。
この頃にprivateメソッドは複数のpublicメソッドに共通する処理を切り出すものだ、と考えるようになったのでした。
逆に言うと、publicメソッドの一部を共通化する以外の目的でのprivateメソッド導入はダメだと考えるようになりました。</p>
<p>そんでもって最近は、なるべくprivateメソッドは導入したくないと思っています。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">個人的にはprivateメソッドを導入する時点で、これ他のクラスのpublicメソッドなのがあるべき姿かも？と考えるようにしてる。</p>— うらがみ⛄ (@backpaper0) <a href="https://twitter.com/backpaper0/status/772544600317710336">2016年9月4日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>年々、小クラス主義になってるのかなー。
みたいな。</p>
</div>
<div class="section" id="id3">
<h2>まとめ</h2>
<p>冒頭で記載したエントリでは、</p>
<blockquote>
<div>結局のところ、privateメソッドの詳細に踏み込んだテストが必要になった時は、設計に何か問題がある可能性が高いということなのだと思う。</div></blockquote>
<p>と書かれていましたが、私はprivateメソッドを導入しようと思ったタイミングで設計に問題があるのでは？と疑ってみるようにしています。</p>
</div>
]]></description>
             <pubDate>Tue, 06 Sep 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/07/12/doma_tokyo.html</link>
            <guid>https://backpaper0.github.io/2016/07/12/doma_tokyo.html</guid>
            <title><![CDATA[東京でDoma勉強会やったぞ！！！ #doma_tokyo]]></title>
            <description><![CDATA[<h1>東京でDoma勉強会やったぞ！！！ #doma_tokyo</h1>
<p><a class="reference external" href="http://doma.readthedocs.io/">Doma</a>
作者の
<a class="reference external" href="https://twitter.com/nakamura_to">中村さん</a>
、
Domaヘビーユーザーの
<a class="reference external" href="https://twitter.com/gakuzzzz">がくぞさん</a>
と一緒にDoma勉強会を東京で開催してきました！！！</p>
<ul class="simple">
<li><a class="reference external" href="http://eventdots.jp/event/592052">【7/9(土)】Doma勉強会 in 東京 - dots. [ドッツ]</a></li>
</ul>
<div class="section" id="id3">
<h2>スライド</h2>
<p>私のスライドはこちら。
2本、話させて頂きました。
Domaの主要な機能を私なりに紹介した発表と、ドメインクラスで型最高！という発表です。</p>
<ul class="simple">
<li><a class="reference external" href="/ghosts/doma-intro.html">Domaの紹介</a></li>
<li><a class="reference external" href="/ghosts/doma-domainclass.html">ドメインクラスの話</a></li>
</ul>
<p>がくぞさんのスライドはこちら。
collect検索の活用方法、なるほど感すごかったです。
真似させてもらいます！</p>
<ul class="simple">
<li><a class="reference external" href="http://gakuzzzz.github.io/slides/doma_practice/">とあるDoma2の使い方</a></li>
</ul>
<p>そして、中村さんのスライドはこちら。
Doma開発のスタンス、我々ユーザーとの向き合い方に感動しました！！</p>
<ul class="simple">
<li><a class="reference external" href="http://qiita.com/nakamura-to/items/099cf72f5465d0323521">Domaの開発で大切にしている10のこと</a></li>
</ul>
<p>「LTやってよ！」ってさらっと無茶振りしたのに見事に応えてくれた
<a class="reference external" href="https://twitter.com/suke_masa">多田さん</a>
と
<a class="reference external" href="https://twitter.com/yy_yank">やんくさん</a>
もありがとうございました！</p>
<ul class="simple">
<li><a class="reference external" href="https://speakerdeck.com/masatoshitada/doma2tomvc1-dot-0dejava-ee-webapuriwozuo-rou">Doma2とMVC1.0でJava EE Webアプリを作ろう！</a></li>
<li><a class="reference external" href="http://www.slideshare.net/yyyank/doma2-with-kotlin">Doma2 with Kotlin</a></li>
</ul>
</div>
<div class="section" id="togetter">
<h2>他の方々のブログ、Togetterなど</h2>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/gloryof/20160709/1468060613">「Doma勉強会 in 東京」に行ってきました。 - シュンツのつまづき日記</a></li>
<li><a class="reference external" href="http://jappy.hatenablog.com/entry/2016/07/09/193939">Doma勉強会 in 東京に行ってきた #doma_tokyo - Splash of waters - 2nd. Season</a></li>
<li><a class="reference external" href="http://yyyank.blogspot.jp/2016/07/79doma-in-lt-domatokyo_96.html">【7/9(土)】Doma勉強会 in 東京でLTしてきました #doma_tokyo - Javaプログラマーのはしくれダイアリー</a></li>
<li><a class="reference external" href="http://togetter.com/li/997896">【7/9(土)】Doma勉強会 in 東京 - Togetterまとめ</a></li>
<li><a class="reference external" href="http://chonaso.hatenablog.com/entry/20160712/1468252323">Doma勉強会 in 東京に行ってきました　#doma_tokyo #eventdots  - Chonaso’s Commentary</a></li>
<li><a class="reference external" href="http://tenten0213.hatenablog.com/entry/2016/07/12/204730">【7/9(土)】Doma勉強会 in 東京 に参加してきた - てんてんのぶろぐ</a></li>
</ul>
</div>
<div class="section" id="tl">
<h2>TLへのリアクション</h2>
<p>内容については、他の方々のブログにお任せするとして、ここからは当日のTLから幾つかのツイートをピックアップして、リアクションしたいと思います。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">どこかにテンプレート的なものがあるらしい? &gt; build.gradle <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a></p>— 寝起き (@nashcft) <a href="https://twitter.com/nashcft/status/751644660729204737">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>これです！</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/domaframework/simple-boilerplate">https://github.com/domaframework/simple-boilerplate</a></li>
</ul>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">Dialectって主にページネーションの方言を吸収するのか。offsetやらlimitやら。 <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— 多田真敏(MasatoshiTada) (@suke_masa) <a href="https://twitter.com/suke_masa/status/751644728270004225">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>通常のSELECT文をページネーションするクエリや、
悲観排他するクエリに変換する際にRDBMSの方言を吸収するためのものですね。</p>
<p>ページネーションはH2なら <cite>offset</cite> と <cite>limit</cite> を使うけど、Oracleなら <cite>rownum</cite> を使うし、悲観排他はOracleなら <cite>for update</cite> を使うけど、SQLServerなら <cite>with(updlock)</cite> を使う、といった感じです。
この辺をDomaの中で吸収してくれるのが <cite>Dialect</cite> です。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ページネーションとかはSelectOptionsとかの話かな<a href="https://t.co/PETWtejqLi">https://t.co/PETWtejqLi</a><a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— やんく (@yy_yank) <a href="https://twitter.com/yy_yank/status/751645008592146432">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>そうです。
Domaは <cite>SelectOptions</cite> で <cite>offset</cite> と <cite>limit</cite> を指定する事ができます。
他にも悲観排他、それからカウント取得なんかの指定もできます。</p>
<ul class="simple">
<li><a class="reference external" href="http://doma.readthedocs.io/ja/stable/query/select/#id11">http://doma.readthedocs.io/ja/stable/query/select/#id11</a></li>
</ul>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr"><a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> NetBeansでは...らしい。（私はMavenでビルド定義して使ってる）</p>— Den (@den2sn) <a href="https://twitter.com/den2sn/status/751645057439019010">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>これは私の誤りのようです。
Mavenプロジェクトなのか、Gradleプロジェクトなのか、そういった違いにもよるのかも知れませんが、少なくともMavenプロジェクトだと何も不都合なく使えるようです。
NetBeans、ごめんなさい。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">アクセサいらんのか<a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— やんく (@yy_yank) <a href="https://twitter.com/yy_yank/status/751645347265409024">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>Domaはエンティティのフィールドを直接見に行くのでアクセサメソッドは不要です。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">エンティティリスナーでcreate_user、create_dateを設定したいという場合には非常に便利そう。<br/>共通項目クラスとかを用意する必要はありそうだけど。 <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— Junki Yamada（シュンツ） (@glory_of) <a href="https://twitter.com/glory_of/status/751646228098584578">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>仰る通り、共通項目だけを持つ基底クラスとなるエンティティを作る必要があります。
基底クラスがあればエンティティリスナーは1つで良いので、楽といえば楽です。</p>
<p>これは後日、サンプルを作ろうと思います。
(私のGitHubリポジトリを漁ったら既にあるかも知れませんが)</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">Stream にした場合はページングはやってくれるのかな？ <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a></p>— いとうちひろ(Chihiro Ito) (@chiroito) <a href="https://twitter.com/chiroito/status/751647049364287489">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>ページネーションは <cite>SelectOptions</cite> の <cite>offset</cite> と <cite>limit</cite> で指定します。
<cite>Stream</cite> 検索はあくまでも <cite>ResultSet.next</cite> してエンティティにマッピングする処理を <cite>Stream</cite> で表現しているだけです。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">Streamを返す版はリソース忘れが無いようにそのままだとコンパイル時に警告を出してくれます。close処理を書いたら心を込めてアノテーションつけると警告を外せます。 <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a></p>— がくぞ (@gakuzzzz) <a href="https://twitter.com/gakuzzzz/status/751648364362510336">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p><cite>Stream</cite> を返すためではなく、他の事に心を込めような！！！</p>
<p>……と、冗談はさておき、元々はSpring Batchの <cite>ItemReader</cite> では <cite>ResultSet.next</cite> がメソッドをまたぐ必要があるため、それに対応しやすいように入れられた機能です。
通常は使う機会は無いと思います。</p>
<p>これも後日サンプルを書いてみようと思います。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">RomaをSpringで使う場合、Spring Bootしか選択肢ないのかな？<br/>Boot以外では使えたりしないかな？<a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— Takafumi Iju (@ijufumi_0810) <a href="https://twitter.com/ijufumi_0810/status/751650514954137600">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>Spring BootではないSpringでも使えます。
実装には <a class="reference external" href="https://github.com/domaframework/doma-spring-boot/tree/master/doma-spring-boot-autoconfigure">doma-spring-boot-autoconfigure</a>
が参考になると思います。</p>
<p>Domaが必要とするのは <cite>DataSource</cite> だけですので、SpringでもJava EEでもJava SEでも、基本的にどこでも使えます。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ローカルトランザクション、Java SE環境で使えるのか<a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— やんく (@yy_yank) <a href="https://twitter.com/yy_yank/status/751650821838823424">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>使えます。
やってる事は単純で <cite>Connection.setAutoCommit</cite> と <cite>Connection.commit</cite> と <cite>Connection.rollback</cite> を組み合わせてトランザクションを行っているだけです。
あとは <cite>ThreadLocal</cite> を利用してトランザクションの期間中 <cite>Connection</cite> をスレッドに紐付けています。</p>
<p><cite>LocalTransactionDataSource</cite> まわりのコードは小さいので、読んでみるのも楽しいですよ！</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">今って[at]Transactionalアノテーションサポートしてる？ <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a></p>— Ktz (@ktz_alias) <a href="https://twitter.com/ktz_alias/status/751651022318112768">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p><cite>@Transactional</cite> はJava EEやSpringといったコンテナの機能で、Domaはサポートしていません。
Domaの範囲からは逸脱すると私は考えます。</p>
<p>とはいえ、例えばGuiceのような軽量コンテナであってもインターセプタの機能を有しているので、
Domaのローカルトランザクションと組み合わせて宣言的トランザクション機能を自作することは可能です。</p>
<p>これも後日サンプルをGuiceとDomaで書いてみますね。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">こんな感じで検索すればSQLも引っ掛けられる（STS） <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a> <a href="https://t.co/r2US1mwupJ">pic.twitter.com/r2US1mwupJ</a></p>— Junki Yamada（シュンツ） (@glory_of) <a href="https://twitter.com/glory_of/status/751655497397264384">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>シュンツさん、ありがとうございます！！！</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">「エンティティをDAO内で定義したい」は比較的実装しやすいかもしれません。すでにドメインクラスはネストし<br/>て定義できるようになっていますし。 <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— toshihiro nakamura (@nakamura_to) <a href="https://twitter.com/nakamura_to/status/751655785600393216">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>ソッコーで実装されててわろた。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/domaframework/doma/pull/159">https://github.com/domaframework/doma/pull/159</a></li>
</ul>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">「主キー検索クエリは自動で組み立てたい」は実装自体は簡単。ポリシーとして整合性を保てるか？アノテーションの書き方をどうするか？などが問題になりそうです。<a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— toshihiro nakamura (@nakamura_to) <a href="https://twitter.com/nakamura_to/status/751656499378737152">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>ですね、よくわかります。
(なのでわがまま言うつもりはありません)</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">社員ID,名前、住所、役職とか、これをstringではなく、ドメインクラスにしていくと、クラス数爆発しそう。線引きはどうするんだろ。 <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— まめぴか＠ (@mame_pika) <a href="https://twitter.com/mame_pika/status/751659291459719168">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>確かに、ドメインクラスを推進するとクラス数は多くなりますが、型の恩恵を受けられるメリットの方が大きいと私は判断しています。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ドメインクラスのgetValueをアプリケーションで呼ばない場合、プレゼンテーション層に値を渡す場合はどうすればいいんだろ？<br/>toStringでvalueを返せば良いのかな？<a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a> <a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— Takafumi Iju (@ijufumi_0810) <a href="https://twitter.com/ijufumi_0810/status/751664414336569344">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>フレームワークや共通部品のような抽象的な層なら <cite>getValue</cite> へのアクセスを許可します。
テンプレートにドメインクラスを渡す場合はコンバータを書きます(例えばJAXBの <a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/javax/xml/bind/annotation/adapters/XmlAdapter.html">XmlAdapter</a> )。
その際、コンバータには <cite>getValue</cite> へのアクセスを許可します。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">domaのコミュニティ素敵だなあ <a href="https://twitter.com/hashtag/doma_tokyo?src=hash">#doma_tokyo</a></p>— 寝起き (@nashcft) <a href="https://twitter.com/nashcft/status/751685884760592384">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>ありがとうございます。
本当に嬉しいお言葉です。
イベントを開催して良かった。</p>
</div>
<div class="section" id="ddd">
<h2>蛇足：DDDとの対比(個人的な見解)</h2>
<p>ドメインクラスという名前のせいか、DDDに関係するのかな？といったツイートを見かけた事がありますが、DomaはDDD用のフレームワークではありません。
しかし、DDDで語られる各要素がDomaで言えば何なのかを考える事はできます。</p>
<p>個人的には次のように考えています。</p>
<ul class="simple">
<li>Domaの「テーブルと1対1にマッピングするエンティティ」は、DDDの「エンティティ」に相当する</li>
<li>Domaの「検索結果にマッピングするエンティティ」と「ドメインクラス」は、DDDの「値オブジェクト」に相当する</li>
</ul>
</div>
<div class="section" id="id9">
<h2>懇親会について</h2>
<p>今回、懇親会の企画はしていたのですが、参加者を募集しませんでした。
これは、本当に私の我儘でして、中村さん、がくぞさんと私自身がたくさん話したい！と強く思っていたので、広く募集はせずにスタッフと最後まで残って会場の現状復帰に付き合ってくれた方々数名だけとさせて頂きました。</p>
<p>我儘を通した甲斐があって、楽しい夕食の時間を過ごさせて頂きました。</p>
</div>
<div class="section" id="dots">
<h2>イベント会場であるdotsについて</h2>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">dots. のイベントスペース、おしゃで綺麗で木の床があって受付にお姉さんがいてかなり良い！！！！！<a href="https://twitter.com/hashtag/eventdots?src=hash">#eventdots</a></p>— さらちむ (@syobochim) <a href="https://twitter.com/syobochim/status/751688326105542656">2016年7月9日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>ほんまそれ。</p>
<p>最高でした！
勉強会を開催したい方には、会場候補におすすめします！</p>
<ul class="simple">
<li><a class="reference external" href="http://eventdots.jp/">dots. [ドッツ] - IT勉強会・セミナーなどのイベント情報サイト</a></li>
</ul>
</div>
<div class="section" id="id10">
<h2>謝辞</h2>
<p>このイベントを開催しようと思ったきっかけは、春に東京へ遊びに行った際、一緒に晩御飯を食べてくれる人を募集したらがくぞさんが来てくださったところから始まりました。
がくぞさんが「一緒にやりましょう」と言ってくださったので中村さんにもお声がけする勇気が出ました。
がくぞさん、本当にありがとうございました！</p>
<p>同じく、その晩御飯の席に参加してくださっており、会場としてdotsを挙げてくださった
<a class="reference external" href="https://twitter.com/grimrose">とーますさん</a>
にも感謝です！
dotsに関する事のサポートや、懇親会のお店の手配をしてくださり、ありがたかったです。
晩御飯、美味しかったー！</p>
<p>それから、運営の手伝いを買って出てくださった多田さん、やんくさん、ありがとうございました！
無茶振りのLTにも応えてくださり、イベントがより華やかになりました！</p>
<p>そして、中村さん、突然お声がけしたにも関わらず登壇を快く引き受けてくださってありがとうございました！
ずっと以前からお会いしたくて、でもきっかけが無くて、がくぞさんのおかげで勇気を出せて、お声がけして、ようやくお会いできました。
本当に、本当に嬉しかったです！！！</p>
<p>あと、友人(と表現させてください)の
しょぼちむ、
うがさん、
てんてんさん、
ちっひー、
はすぬまさん、
@suzukijさん、
Denさん、
まめぴー、来てくださってありがとうございました！
中村さんの前での発表はこれでもか！！！ってぐらい緊張していたけど、みんなが居ると思えばこそ最後まで発表できた気がします。</p>
<p>シュンツさん、来てくださってありがとうございました！
参加登録者を見て、密かに「お会いできる！」とワクワクしていました。
お会いできて嬉しかったです！</p>
<p>最後になりますが、参加してくださった皆さん、本当にありがとうございました！
皆さんのおかげでイベントが賑やかになり、楽しく過ごす事ができました。</p>
<p>本当に楽しい、夢のような1日でした。</p>
<p>みんなで撮った集合写真は、MBPのデスクトップを飾っています。</p>
</div>
]]></description>
             <pubDate>Tue, 12 Jul 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/06/12/slider.html</link>
            <guid>https://backpaper0.github.io/2016/06/12/slider.html</guid>
            <title><![CDATA[関Javaで使ってたスマホでスライドめくるやつ]]></title>
            <description><![CDATA[<h1>関Javaで使ってたスマホでスライドめくるやつ</h1>
<p>今日は関Javaでした！</p>
<ul class="simple">
<li><a class="reference external" href="http://kanjava.connpass.com/event/32956/">http://kanjava.connpass.com/event/32956/</a></li>
</ul>
<p>で、私も発表したんですが……</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">スマホで操作してる？<a href="https://twitter.com/hashtag/kanjava?src=hash">#kanjava</a></p>— opengl-8080 (@opengl_8080) <a href="https://twitter.com/opengl_8080/status/741888387091554305">2016年6月12日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">スマホでスライド操作？<a href="https://twitter.com/hashtag/kanjava?src=hash">#kanjava</a></p>— セセリ (@serorigundam) <a href="https://twitter.com/serorigundam/status/741888565441748992">2016年6月12日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">うらがみさんのiPhone操作プレゼン、Reveal.jsとRemotes.ioとかかな？<a href="https://twitter.com/hashtag/kanjava?src=hash">#kanjava</a></p>— 佐々木和繁うなぎ㌠ (@kazsharp) <a href="https://twitter.com/kazsharp/status/741890063584239617">2016年6月12日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">うらがみさんのスライド操作。<br/>まさかのアイポンから？！<br/>アプリ自作？？<a href="https://twitter.com/hashtag/kanjava?src=hash">#kanjava</a></p>— EOA (@fukamiAO) <a href="https://twitter.com/fukamiAO/status/741889585978822656">2016年6月12日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>……というツイートを見て、気付いてくれた！
そこに興味持ってくれて嬉しいぞ！
という感じなので、これについて書きます。</p>
<div class="section" id="id1">
<h2>スライドめくるやついいなー</h2>
<p>いろんな人が発表しているのを見ていると、なんかリモコン的なやつとか指輪っぽいやつでリモートでスライドめくってて「いいなーアレ」と思っていました。</p>
<p>で、自分も発表する時に使いたいなと思ったんですけど、スマホがリモコン的に使えそうだし操作はページ送りできたら良いだけだし作るかー、と。</p>
</div>
<div class="section" id="id2">
<h2>作ってみた</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/slider">https://github.com/backpaper0/slider</a></li>
</ul>
<p>ざっくり言うと、Webアプリになっていまして、スマホのブラウザでページを開くとWebSocketで通信を開始し、コマンドを送ってページ送りを行っています。</p>
</div>
<div class="section" id="id3">
<h2>使い方と仕組み</h2>
<p>使い方と共にもうちょい詳しく書きます。</p>
<p>まずコードを <span class="docutils literal"><span class="pre">clone</span></span> して、ビルドします。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>git clone https://github.com/backpaper0/slider.git

<span class="nb">cd</span> slider

gradlew build
</pre></div>
</div>
<p>すると <span class="docutils literal"><span class="pre">build/libs/slider.jar</span></span> が出力されます。</p>
<p>スライドを表示する端末でWebアプリを起動します。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>java -jar build/libs/slider.jar
</pre></div>
</div>
<p>なお、サーバーにはUndertowを使っています。
また、mainメソッドの起動にはSpringBootを使っています。</p>
<p>Webアプリが起動するとスマホのブラウザからWebページを開く必要があるのですが、そのために私はスマホでテザリングをしています。
テザリングをして、 <span class="docutils literal"><span class="pre">ipconfig</span></span> とか <span class="docutils literal"><span class="pre">ifconfig</span></span> で端末のIPアドレスを確認したら <span class="docutils literal"><span class="pre">http://&lt;ipaddress&gt;:8080/</span></span> へスマホでアクセスします。</p>
<p>画面はこんな感じ。</p>
<img alt="../../../_images/slider.png" src="https://backpaper0.github.io/_images/slider.png"/>
<p><span class="docutils literal"><span class="pre">Left</span></span> と <span class="docutils literal"><span class="pre">Right</span></span> でそれぞれ左・右にページを送ります。
その際、スクリーンショットを撮ってブラウザに送ります。
スクリーンショットは <span class="docutils literal"><span class="pre">Screenshot</span></span> ボタンでも取得できます。
そして <span class="docutils literal"><span class="pre">Presentation</span></span> ですが、これは私が利用している <a class="reference external" href="http://remarkjs.com/">remark</a> というスライドツールのプレゼンテーションモードを切り替えるために使います。</p>
<p>これらの実現方法ですが、まず <span class="docutils literal"><span class="pre">Screenshot</span></span> や <span class="docutils literal"><span class="pre">Left</span></span> のボタンを押すとWebSocketでサーバーにコマンドを送ります。
コマンドと言っても <span class="docutils literal"><span class="pre">SCREENSHOT</span></span> や <span class="docutils literal"><span class="pre">LEFT</span></span> といった単純な文字列です。</p>
<p>サーバーではコマンドを受け取ると <a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/awt/Robot.html">Robotクラス</a> を利用して
<a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/awt/Robot.html#createScreenCapture-java.awt.Rectangle-">スクリーンショットを撮ったり</a> 、
<a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/awt/Robot.html#keyPress-int-">「左ボタンを押す」というシステム入力イベントを発生させたり</a> します。
これでスライドのページ送りができました。
なお、スクリーンショットはBase64エンコードしてData URIにしてブラウザに送っています。
ブラウザ側ではそれをそのままCanvasに書き出しています。</p>
</div>
<div class="section" id="id6">
<h2>欲しいものは作ればいいや</h2>
<p>仕組みとしては以上でして、まあ説明してみると大したことはしていないんですが、これまでプライベートコーディングではフレームワークを試したりサンプルコードばかり書き捨てていたので、改めて「欲しいと思ったものを自分でも作れるもんだなー」としみじみ思いました。
欲しけりゃ作ろ、と思うようになってきたのは、この数年で出会った何人かのエンジニアのお陰です。
名前を出すのは照れくさいので出しませんが、本当に尊敬しています。</p>
</div>
<div class="section" id="id7">
<h2>まとめ</h2>
<ul class="simple">
<li>作ってはみたものの、使う機会を逃しており今回が初の実践でしたが、なかなか上手く行って良かった！</li>
<li>何人かの方に気付いて貰えて嬉しかった！(「機会があったら使わせて欲しい」とまで言ってくれた方も居た！)</li>
</ul>
<p>使いながらもっと便利になるようにちまちまメンテしたい所存です。</p>
</div>
]]></description>
             <pubDate>Sun, 12 Jun 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/05/08/boxsing_and_cache.html</link>
            <guid>https://backpaper0.github.io/2016/05/08/boxsing_and_cache.html</guid>
            <title><![CDATA[ボクシングとキャッシュ]]></title>
            <description><![CDATA[<h1>ボクシングとキャッシュ</h1>
<div class="section" id="integer">
<h2>Integerのキャッシュ</h2>
<p><span class="docutils literal"><span class="pre">int</span></span> がボクシングされると <span class="docutils literal"><span class="pre">java.lang.Integer</span></span> になりますが、このとき <span class="docutils literal"><span class="pre">Integer.valueOf(int)</span></span> が使われます。
このことは次のようなボクシングされるコードを書いてコンパイルしてからjavapすればよく分かります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IntBoxingSample</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">boxing</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>javapしてみた結果は次の通り。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Compiled from "IntBoxingSample.java"
public class IntBoxingSample {
  public IntBoxingSample();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
       4: return

  public java.lang.Integer boxing(int);
    Code:
       0: iload_1
       1: invokestatic  #2                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
       4: areturn
}
</pre></div>
</div>
<p>で、この <span class="docutils literal"><span class="pre">Integer.valueOf(int)</span></span> ですが、 <span class="docutils literal"><span class="pre">-128</span></span> から <span class="docutils literal"><span class="pre">127</span></span> までの範囲はキャッシュされます。</p>
<p>このことは <a class="reference external" href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-5.html#jls-5.1.7">言語仕様の5.1.7</a> や
<a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/lang/Integer.html#valueOf-int-">Integer.valueOf(int)のJavadoc</a> に書かれています。</p>
<p>でもって、OpenJDKのコードを見た感じ、 <span class="docutils literal"><span class="pre">java.lang.Integer.IntegerCache.high</span></span> というシステムプロパティでキャッシュする範囲を変更できそうです。</p>
<ul class="simple">
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Integer.java#l829">Integer.valueOf(int)のコード</a></li>
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Integer.java#l785">Integerインスタンスをキャッシュする範囲を決定しているstaticイニシャライザ</a></li>
</ul>
<p>というわけで次のようなコードを書いてコンパイルして普通に実行すると <span class="docutils literal"><span class="pre">false</span></span> と表示されますが、 <span class="docutils literal"><span class="pre">-Djava.lang.Integer.IntegerCache.high=1000</span></span> という風にシステムプロパティを設定して実行すると <span class="docutils literal"><span class="pre">true</span></span> と表示されます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Integer</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="n">Integer</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>実行結果は次の通り。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span/>% java Sample
<span class="nb">false</span>
% java -Djava.lang.Integer.IntegerCache.high<span class="o">=</span><span class="m">1000</span> Sample
<span class="nb">true</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>他のプリミティブも見てみた</h2>
<p><span class="docutils literal"><span class="pre">Byte</span></span> 、 <span class="docutils literal"><span class="pre">Short</span></span> 、 <span class="docutils literal"><span class="pre">Long</span></span> は <span class="docutils literal"><span class="pre">Integer</span></span> と同じく <span class="docutils literal"><span class="pre">-128</span></span> から <span class="docutils literal"><span class="pre">127</span></span> までキャッシュされていました。
ただしキャッシュの範囲は変更できません。</p>
<ul class="simple">
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Byte.java#l101">Byte.valueOf(byte)のコード</a> と
<a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Byte.java#l77">Byteのキャッシュ構築コード</a></li>
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Short.java#l230">Short.valueOf(short)のコード</a> と
<a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Short.java#l203">Shortのキャッシュ構築コード</a></li>
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Long.java#l835">Long.valueOf(long)のコード</a> と
<a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Long.java#l806">Longのキャッシュ構築コード</a></li>
</ul>
<p>それから <span class="docutils literal"><span class="pre">Character</span></span> は <span class="docutils literal"><span class="pre">0</span></span> から <span class="docutils literal"><span class="pre">127</span></span> までキャッシュされていました。
ASCII文字コードの <span class="docutils literal"><span class="pre">NUL</span></span> から <span class="docutils literal"><span class="pre">DEL</span></span> ですね。</p>
<ul class="simple">
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Character.java#l4569">Character.valueOf(char)のコード</a> と
<a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Character.java#l4541">Characterのキャッシュ構築コード</a></li>
</ul>
<p><span class="docutils literal"><span class="pre">Boolean</span></span> は定数 <span class="docutils literal"><span class="pre">TRUE</span></span> と <span class="docutils literal"><span class="pre">FALSE</span></span> のどちらかを返すようになっています。</p>
<ul class="simple">
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Boolean.java#l149">Boolean.valueOf(boolean)のコード</a></li>
</ul>
<p>最後に <span class="docutils literal"><span class="pre">Float</span></span> と <span class="docutils literal"><span class="pre">Double</span></span> ですが、どちらもキャッシュせず常にインスタンス化するようになっていました。
浮動小数点数なので <span class="docutils literal"><span class="pre">-128.0</span></span> から <span class="docutils literal"><span class="pre">127.0</span></span> の間にも膨大な量のインスタンスを生成し得るので、まあ、そりゃキャッシュしないか、という感じ。</p>
<ul class="simple">
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Float.java#l432">Float.valueOf(float)のコード</a></li>
<li><a class="reference external" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/dc4322602480/src/share/classes/java/lang/Double.java#l518">Double.valueOf(double)のコード</a></li>
</ul>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<p>以上のように普段は意識しないような部分でキャッシュしておりパフォーマンス向上を図っていたりしています。
こういったJDKの努力に感謝しつつ、今後も意識せずにコーディングしようと思います。</p>
</div>
]]></description>
             <pubDate>Sun, 08 May 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/03/24/tokyo.html</link>
            <guid>https://backpaper0.github.io/2016/03/24/tokyo.html</guid>
            <title><![CDATA[東京でみんなと遊んできた]]></title>
            <description><![CDATA[<h1>東京でみんなと遊んできた</h1>
<p><a class="reference internal" href="https://backpaper0.github.io/2016/03/24/elastichandson.html"><span class="doc">Elasticsearchハンズオンに参加したので</span></a>
ついでに東京まで行ってみんなと遊んできた！</p>
<p>せろてぃーたちとカラオケ行ったり、
がくぞさんと初めてお会いしたり、
しょぼちむぺろぺろしたり、
まーやさん・ちっひーは二日連続で遊んでくれたり、
とーますさんが集合時間を一時間勘違いしてたり、
まめぴーが3000万円の車を買おうとしていたり、
高校時代の友人が(私がRTするせいで)こざけさんのファンになっていたり、
楽しい休日を過ごさせてもらった！！！</p>
<p>あと、グラニースミスのアップルパイはあいかわらず最高だった。
東京に行ったら必ず食べたい一品。</p>
<img alt="../../../_images/grannysmith-applepie.jpg" src="https://backpaper0.github.io/_images/grannysmith-applepie.jpg"/>
<p>みんなありがとう〜</p>
<p>楽しかった！！！</p>
]]></description>
             <pubDate>Thu, 24 Mar 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2016/03/24/elastichandson.html</link>
            <guid>https://backpaper0.github.io/2016/03/24/elastichandson.html</guid>
            <title><![CDATA[Acroquest Technology社のElasticsearchハンズオンに行ってきた #elastichandson]]></title>
            <description><![CDATA[<h1>Acroquest Technology社のElasticsearchハンズオンに行ってきた #elastichandson</h1>
<p>Elasticsearch、まったく触ったこと無くてそろそろ触ろうかなーと思ってた矢先にハンズオンがあることを知って即申し込んで行ってきました。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.acroquest.co.jp/bvd/infomation.html">Elasticsearchハンズオンセミナー| Acroquest Technology Co., Ltd</a></li>
</ul>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">来てる <a href="https://twitter.com/hashtag/elastichandson?src=hash">#elastichandson</a> <a href="https://t.co/IoeO0MNJky">pic.twitter.com/IoeO0MNJky</a></p>— うらがみ (@backpaper0) <a href="https://twitter.com/backpaper0/status/710705217273106432">2016年3月18日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><div class="section" id="id1">
<h2>ハンズオンの概要</h2>
<p>Acroquest Technology社が業務で収集した実データをベースにした大量のデータを使ってLogstash/Elasticsearch/Kibanaのインストールから入門的な操作を行いました。</p>
</div>
<div class="section" id="id2">
<h2>感想</h2>
<p>レベル的には先述の通り、入門！って感じでしたが、丁寧な資料や実データをもとにして手を動かしたのもあって次の学習ステップを想像しやすくて良かったです。</p>
<p>個人的にはElasticsearchには興味があったんだけど、
LogstashとかKibanaとかナニモノなのかよく分からないし、
興味はあるけど自分のリソース注ぎ込みまくるほど(当時は)優先順位は高くなかったので、
そういった意味でも触れる機会を得られて助かりました。</p>
</div>
<div class="section" id="id3">
<h2>その他</h2>
<p>ステッカー、一通りもらいました！</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">わーい <a href="https://twitter.com/hashtag/elastichandson?src=hash">#elastichandson</a> <a href="https://t.co/Apm0Oxdrgb">pic.twitter.com/Apm0Oxdrgb</a></p>— うらがみ (@backpaper0) <a href="https://twitter.com/backpaper0/status/710718430597349376">2016年3月18日</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"/></div>
<div class="section" id="id4">
<h2>結び</h2>
<p>私のようにElasticsearch/Logstash/Kibanaに入門したいけど何から手をつけたら良いのか分からないといった方は参加してみると良いのではないでしょうか。</p>
<p>Acroquest Technology社の皆様、
楽しく有用なハンズオンをありがとうございました！！！</p>
</div>
]]></description>
             <pubDate>Thu, 24 Mar 2016 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/12/24/run_at_startup_in_javaee.html</link>
            <guid>https://backpaper0.github.io/2015/12/24/run_at_startup_in_javaee.html</guid>
            <title><![CDATA[Java EEアプリケーションで起動時になにかしらの処理をする方法]]></title>
            <description><![CDATA[<h1>Java EEアプリケーションで起動時になにかしらの処理をする方法</h1>
<p>いくつか考えてみました。</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">HttpServlet.init</span></span> をオーバーライドする(Servlet)</li>
<li><span class="docutils literal"><span class="pre">ServletContainerInitializer</span></span> の実装クラスを作る(Servlet)</li>
<li><span class="docutils literal"><span class="pre">Singleton</span></span> セッションビーンに <span class="docutils literal"><span class="pre">@Startup</span></span> を付けて <span class="docutils literal"><span class="pre">@PostConstructed</span></span> を付けたメソッドを定義する(EJB)</li>
<li><span class="docutils literal"><span class="pre">Extension</span></span> の実装クラスを作ってライフサイクルイベントをハンドリングするオブザーバーメソッドを作る(CDI)</li>
<li><span class="docutils literal"><span class="pre">@ApplicationScoped</span></span> なCDI管理ビーンを作って <span class="docutils literal"><span class="pre">@Initialized(ApplicationScoped.class)</span></span> なイベントをハンドリングするオブザーバーメソッドを作る(CDI)</li>
</ul>
<p>他にもあったら教えてください！</p>
<p>で、個人的には</p>
<ul class="simple">
<li>Servlet APIを直接使うのは可能な限り避けたい</li>
<li>EJBは使わない</li>
</ul>
<p>という感じなのでCDIで実現するのが良さそうです。</p>
<p>起動時処理に <span class="docutils literal"><span class="pre">Extension</span></span> を使うのはなんか違う感じがしますし、
<span class="docutils literal"><span class="pre">@Initialized(ApplicationScoped.class)</span></span> を使った方法が好みです。</p>
<p>具体的にはこんなコードです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">javax.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.enterprise.context.Initialized</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.enterprise.event.Observes</span><span class="p">;</span>

<span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="nd">@Observes</span> <span class="nd">@Initialized</span><span class="p">(</span><span class="n">ApplicationScoped</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="n">Object</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//ここに起動時にしたい処理を書く</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>CDI以外のサンプルも含んだコードは次のURLです。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/javaee-startup-sample">https://github.com/backpaper0/sandbox/tree/master/javaee-startup-sample</a></li>
</ul>
]]></description>
             <pubDate>Thu, 24 Dec 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/12/13/semicolonless_javaee.html</link>
            <guid>https://backpaper0.github.io/2015/12/13/semicolonless_javaee.html</guid>
            <title><![CDATA[セミコロンレスJava EEでTODOリストアプリケーション #semicolonlessjava]]></title>
            <description><![CDATA[<h1>セミコロンレスJava EEでTODOリストアプリケーション #semicolonlessjava</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/952">セミコロンレスJava Advent Calendar</a>
の13日目です。</p>
<p>今回はセミコロンレスJava EEを使って簡単なTODOリストアプリケーションを作ってみました。</p>
<p>ソースコードは <a class="reference external" href="https://github.com/backpaper0/semicolonless-javaee-todolist-sample">https://github.com/backpaper0/semicolonless-javaee-todolist-sample</a> です。</p>
<p>使っているJava EEな技術は、</p>
<ul class="simple">
<li>JAX-RS</li>
<li>JPA</li>
<li>Java API for JSON Processing</li>
<li>CDI/JTA</li>
</ul>
<p>です。</p>
<p>このうちCDIとJTAはアノテーションを利用しただけなので特に解説の余地はありません。</p>
<p>Java API for JSON Processingもリソースクラスの引数にJsonObjectを利用したってだけなので解説するほどのものじゃないですね。</p>
<p>というわけで、JAX-RSとJPAの利用箇所について解説します。
なお分かりやすさのためここではセミコロンを書いて良い普通のJava言語でコード例を記載します。</p>
<div class="section" id="jax-rs">
<h2>セミコロンレスJAX-RS</h2>
<p>JAX-RSのリソースメソッドはレスポンスにエンティティボディを含むものであれば通常は次のようなコードになります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">"Hello, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"!"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>しかし <span class="docutils literal"><span class="pre">return</span></span> しようとするとセミコロンを書かざるを得ないのでこのコードは使えません。
セミコロンレスJavaでは(一部の特殊な状況を除いて) <span class="docutils literal"><span class="pre">return</span></span> するメソッドを実装できません。</p>
<p>そこで考えたのが <span class="docutils literal"><span class="pre">@Suspended</span></span> と <span class="docutils literal"><span class="pre">AsyncResponse</span></span> を利用する方法です。</p>
<p><span class="docutils literal"><span class="pre">@Suspended</span></span> と <span class="docutils literal"><span class="pre">AsyncResponse</span></span> はクライアントとの接続をsuspendしておき、 <span class="docutils literal"><span class="pre">AsyncResponse.resume</span></span> に値を渡すことでresumeするためのものですが、
これらを利用することで次のようなコードになりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span>
                  <span class="nd">@Suspended</span> <span class="n">AsyncResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">resume</span><span class="p">(</span><span class="s">"Hello, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"!"</span><span class="p">))</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">AsyncResponse.resume</span></span> は <span class="docutils literal"><span class="pre">boolean</span></span> を返すのでif文に押し込みやすいですね。</p>
<p>これでエンティティボディを返すリソースメソッドを定義できました。</p>
</div>
<div class="section" id="jpa">
<h2>セミコロンレスJPA</h2>
<p>次にJPAです。</p>
<p>のっけからアレですが、セミコロンレスJPAではフィールドもgetterも定義できないのでエンティティクラスを作れません。
(JPA詳しくないので、もし作れる方法があれば教えてください)</p>
<p>なのでネイティブクエリを使いまくるという、それJDBCでええやんけ、的な感じのコードになっております。</p>
<p>それはともかく、 <span class="docutils literal"><span class="pre">EntityManager</span></span> を取ってきましょう。
普通は次のコードのようにフィールドインジェクションすると思います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@PersistenceContext</span><span class="p">(</span><span class="n">unitName</span> <span class="o">=</span> <span class="s">"SampleUnit"</span><span class="p">)</span>
<span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">em</span><span class="p">;</span>
</pre></div>
</div>
<p>でも前述の通りセミコロンレスJavaではフィールドが定義できません。</p>
<p>なのでJNDI lookupしましょう。
JSR 338 JPA 2.1仕様の「7.2.1 Obtaining an Entity Manager in the Java EE Environment」を読むと、
アノテーションでJNDI名を定義してlookupできるっぽいのでこれを利用しました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@PersistenceContext</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"SampleEM"</span><span class="p">,</span> <span class="n">unitName</span> <span class="o">=</span> <span class="s">"SampleUnit"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleResource</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resourceMethod</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="p">{</span>
        <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">InitialContext</span><span class="p">.</span><span class="na">doLookup</span><span class="p">(</span><span class="s">"java:comp/env/SampleEM"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この例だと変数 <span class="docutils literal"><span class="pre">em</span></span> に代入していますが、セミコロンレスJavaでは変数宣言も出来ません。
なので次のように <span class="docutils literal"><span class="pre">Stream</span></span> を使うのが良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">if</span> <span class="p">(</span><span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">((</span><span class="n">EntityManager</span><span class="p">)</span> <span class="n">InitialContext</span>
                  <span class="p">.</span><span class="na">doLookup</span><span class="p">(</span><span class="s">"java:comp/env/SampleEM"</span><span class="p">))</span>
                  <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">em</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="cm">/* emを使った処理 */</span> <span class="p">})</span>
                  <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>あとは <span class="docutils literal"><span class="pre">EntityManager.createNativeQuery</span></span> でSQLを発行すればOKです。</p>
</div>
<div class="section" id="id1">
<h2>まとめ</h2>
<p>セミコロンレスJava EEで実用的なアプリケーションも作れる！(作らない)</p>
</div>
]]></description>
             <pubDate>Sun, 13 Dec 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/12/09/semicolonless_fizzbuzz.html</link>
            <guid>https://backpaper0.github.io/2015/12/09/semicolonless_fizzbuzz.html</guid>
            <title><![CDATA[セミコロンなどレスJavaでFizzBuzz #semicolonlessjava]]></title>
            <description><![CDATA[<h1>セミコロンなどレスJavaでFizzBuzz #semicolonlessjava</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/952">セミコロンレスJava Advent Calendar</a>
の9日目です。</p>
<div class="section" id="java-8fizzbuzz">
<h2>セミコロンレスJava 8でFizzBuzz</h2>
<p>セミコロンレスJava 8でFizzBuzzを書いてみましょう。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
                <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">15</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"FizzBuzz"</span>
                             <span class="p">:</span> <span class="n">i</span> <span class="o">%</span>  <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"Fizz"</span>
                             <span class="p">:</span> <span class="n">i</span> <span class="o">%</span>  <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"Buzz"</span>
                             <span class="p">:</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">" "</span><span class="p">)))</span>
                <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
                <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Stream APIとラムダ式のおかげでかなり簡単に書けました。</p>
</div>
<div class="section" id="id1">
<h2>可変長引数</h2>
<p>よく見ると <span class="docutils literal"><span class="pre">[</span></span> と <span class="docutils literal"><span class="pre">]</span></span> は <span class="docutils literal"><span class="pre">main</span></span> メソッドの引数で1回ずつしか使っていません。
可変長引数にすると消せますね。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
                <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">15</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"FizzBuzz"</span>
                             <span class="p">:</span> <span class="n">i</span> <span class="o">%</span>  <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"Fizz"</span>
                             <span class="p">:</span> <span class="n">i</span> <span class="o">%</span>  <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"Buzz"</span>
                             <span class="p">:</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">" "</span><span class="p">)))</span>
                <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
                <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="optional">
<h2>条件演算子とOptional</h2>
<p>セミコロンレスJava 8では <span class="docutils literal"><span class="pre">Optional</span></span> が使えます。
<span class="docutils literal"><span class="pre">Optional.getOrElse</span></span> を使えば条件演算子の代替になります。</p>
<p>例えば次のコードは、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">"yes"</span> <span class="p">:</span> <span class="s">"no"</span><span class="p">;</span>
</pre></div>
</div>
<p>こう書けます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"yes"</span><span class="p">).</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="s">"no"</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">:</span></span> と <span class="docutils literal"><span class="pre">?</span></span> を消せました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
                <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">%</span> <span class="mi">15</span> <span class="o">==</span> <span class="mi">0</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"FizzBuzz"</span><span class="p">)</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">%</span>  <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"Fizz"</span><span class="p">)</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">%</span>  <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"Buzz"</span><span class="p">)</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">toString</span><span class="p">()))))</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">" "</span><span class="p">)))</span>
                <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
                <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="biginteger">
<h2>数値演算とBigInteger</h2>
<p><span class="docutils literal"><span class="pre">int</span></span> を <span class="docutils literal"><span class="pre">BigInteger</span></span> にすると演算がメソッド呼び出しになります。</p>
<p>例えば次のコードは、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">...</span>
<span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>こう書けます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="n">BigInteger</span> <span class="n">i</span> <span class="o">=</span> <span class="p">...</span>
<span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">BigInteger</span><span class="p">(</span><span class="s">"2"</span><span class="p">)).</span><span class="na">equals</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">%</span></span> と <span class="docutils literal"><span class="pre">=</span></span> を消せました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
                <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
                        <span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="s">"15"</span><span class="p">))</span>
                        <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"FizzBuzz"</span><span class="p">)</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="s">"3"</span><span class="p">))</span>
                        <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"Fizz"</span><span class="p">)</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="s">"5"</span><span class="p">))</span>
                        <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s">"Buzz"</span><span class="p">)</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">toString</span><span class="p">()))))</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="s">" "</span><span class="p">)))</span>
                <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
                <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="stringbuilder">
<h2>文字列リテラルとStringBuilder</h2>
<p>文字列リテラルもなくしてしまいましょう。
<span class="docutils literal"><span class="pre">StringBuilder</span></span> に <span class="docutils literal"><span class="pre">char</span></span> を足し込んでやれば文字列は構築できます。</p>
<p>ただし <span class="docutils literal"><span class="pre">char</span></span> リテラルを使うと <span class="docutils literal"><span class="pre">'</span></span> を入れ混んじゃうので、
<span class="docutils literal"><span class="pre">int</span></span> をキャストしましょう。</p>
<p>例えば次のコードは、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"hello"</span><span class="p">;</span>
</pre></div>
</div>
<p>こう書けます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">().</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x68</span><span class="p">)</span>
                              <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x65</span><span class="p">)</span>
                              <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6c</span><span class="p">)</span>
                              <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6c</span><span class="p">)</span>
                              <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6f</span><span class="p">)</span>
                              <span class="p">.</span><span class="na">toString</span><span class="p">();</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">"</span></span> を消せました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
                <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
                        <span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">15</span><span class="p">)))</span>
                        <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x46</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x69</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x42</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x75</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">toString</span><span class="p">())</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
                        <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x46</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x69</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">toString</span><span class="p">())</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
                        <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x42</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x75</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                                <span class="p">.</span><span class="na">toString</span><span class="p">())</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">toString</span><span class="p">()))))</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x20</span><span class="p">).</span><span class="na">toString</span><span class="p">())))</span>
                <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
                <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>1引数のメソッド呼び出し化</h2>
<p>さて、最後は <span class="docutils literal"><span class="pre">,</span></span> です。
<span class="docutils literal"><span class="pre">IntStream.rangeClosed</span></span> の呼び出し部分でしか使ってないですね。
がんばって消してみましょう。</p>
<p>この <span class="docutils literal"><span class="pre">,</span></span> を消すには1引数のメソッド呼び出しだけで1〜100のストリームを生成する必要があります。
でも、ざっとStream APIを眺めましたがそれを叶えてくるメソッドはなさそうでした。</p>
<p>仕方がないので <span class="docutils literal"><span class="pre">AtomicInteger.incrementAndGet</span></span> と <span class="docutils literal"><span class="pre">IntStream.generate</span></span> を組み合わせてストリームを構築して、
<span class="docutils literal"><span class="pre">IntStream.limit</span></span> で上限を設定すれば1〜100の <span class="docutils literal"><span class="pre">IntStream</span></span> が手に入ります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>

<span class="c1">//1〜100のIntStreamを構築する普通の方法</span>
<span class="n">IntStream</span><span class="p">.</span><span class="na">rangeClosed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

<span class="c1">//AtomicIntegerを利用して1〜100のIntStreamを構築する方法</span>
<span class="n">AtomicInteger</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">IntStream</span><span class="p">.</span><span class="na">generate</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()).</span><span class="na">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">,</span></span> が消えて最終的にこうなりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">concurrent</span><span class="p">.</span><span class="na">atomic</span><span class="p">.</span><span class="na">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span>
                <span class="p">.</span><span class="na">generate</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">())</span>
                <span class="p">.</span><span class="na">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
                        <span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">15</span><span class="p">)))</span>
                    <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x46</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x69</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x42</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x75</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">toString</span><span class="p">())</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
                    <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x46</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x69</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">toString</span><span class="p">())</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="k">new</span> <span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
                    <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x42</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x75</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">).</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)</span>
                        <span class="p">.</span><span class="na">toString</span><span class="p">())</span>
                <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">toString</span><span class="p">()))))</span>
            <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x20</span><span class="p">).</span><span class="na">toString</span><span class="p">())))</span>
            <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
            <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これで使用している記号は <span class="docutils literal"><span class="pre">{}().-&gt;</span></span> だけになりました。</p>
<p><span class="docutils literal"><span class="pre">{}</span></span> はクラス定義やらメソッド定義に必要だし、
<span class="docutils literal"><span class="pre">().</span></span> はメソッド呼び出しあたりに必要だし、
<span class="docutils literal"><span class="pre">-&gt;</span></span> はラムダ式に必要なのでこれ以上の省略は難しそう感あります。</p>
<p>消せる方法が思いついたら教えてください。</p>
<p>というわけで、セミコロンなどレスJavaでFizzBuzzしてみた話でした。</p>
</div>
<div class="section" id="new">
<h2>追記：new演算子を消す</h2>
<p>new演算子を使っているのは次の3つのクラスです。</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">AtomicInteger</span></span></li>
<li><span class="docutils literal"><span class="pre">BigInteger</span></span></li>
<li><span class="docutils literal"><span class="pre">StringBuilder</span></span></li>
</ul>
<p>まず <span class="docutils literal"><span class="pre">BigInteger</span></span> ですが、
<span class="docutils literal"><span class="pre">BigInteger.valueOf</span></span> という便利なファクトリーメソッドがありました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>

<span class="c1">//これは</span>
<span class="k">new</span> <span class="n">BigInteger</span><span class="p">(</span><span class="s">"100"</span><span class="p">);</span>

<span class="c1">//これで良い！！</span>
<span class="n">BigInteger</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</pre></div>
</div>
<p>次に <span class="docutils literal"><span class="pre">StringBuilder</span></span> ですが、
<span class="docutils literal"><span class="pre">String.valueOf</span></span> と <span class="docutils literal"><span class="pre">String.concat</span></span> を併用すれば良い事に気が付きました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>

<span class="c1">//これは</span>
<span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x68</span><span class="p">)</span>
    <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x65</span><span class="p">)</span>
    <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6c</span><span class="p">)</span>
    <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6c</span><span class="p">)</span>
    <span class="p">.</span><span class="na">append</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6f</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>

<span class="c1">//これで良い！！</span>
<span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x68</span><span class="p">)</span>
   <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x65</span><span class="p">))</span>
   <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6c</span><span class="p">))</span>
   <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6c</span><span class="p">))</span>
   <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x6f</span><span class="p">));</span>
</pre></div>
</div>
<p>最後に <span class="docutils literal"><span class="pre">AtomicInteger</span></span> ですが、</p>
<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr"><a href="https://twitter.com/backpaper0">@backpaper0</a> <a href="https://twitter.com/nagise">@nagise</a> IntStream.generate(() -&gt; (int)(Math.random()*100)).distinct().limit(100).sorted()　これでどうでしょ？ツイートの長さ的に*使ってますけど，いい感じにしてください</p>— 卒研で死にそうなきつね (@bitter_fox) <a href="https://twitter.com/bitter_fox/status/674438084474200066">2015, 12月 9</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>素晴らしい！！！(いろんな意味で)</p>
<p>きつねさんのアイデアを元に、</p>
<ul class="simple">
<li>数値演算子を使わなくて済むように <span class="docutils literal"><span class="pre">Random.nextInt</span></span> を使用</li>
<li>new演算子を使わないためにstaticファクトリーメソッドがある <span class="docutils literal"><span class="pre">SecureRandom</span></span> を使用</li>
</ul>
<p>といった事に気をつけて次のようなコードにしました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>

<span class="c1">//これで1〜100のIntStreamが手に入る</span>
<span class="n">SecureRandom</span> <span class="n">r</span> <span class="o">=</span> <span class="n">SecureRandom</span><span class="p">.</span><span class="na">getInstanceStrong</span><span class="p">();</span>
<span class="n">IntStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">generate</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">101</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">distinct</span><span class="p">().</span><span class="na">limit</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
                            <span class="p">.</span><span class="na">sorted</span><span class="p">().</span><span class="na">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>ちなみに、私が考えついたのは次のようなコードでした。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを書いて良い普通のJava</span>
<span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">((</span><span class="n">ArrayList</span><span class="p">)</span> <span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">().</span><span class="na">supplier</span><span class="p">().</span><span class="na">get</span><span class="p">())</span>
      <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">list</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">.</span><span class="na">ONE</span><span class="p">))</span>
      <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">list</span> <span class="o">-&gt;</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">generate</span><span class="p">(()</span> <span class="o">-&gt;</span>
         <span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">((</span><span class="n">BigInteger</span><span class="p">)</span> <span class="n">list</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
               <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
               <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">.</span><span class="na">ONE</span><span class="p">)))</span>
               <span class="p">.</span><span class="na">findFirst</span><span class="p">().</span><span class="na">get</span><span class="p">().</span><span class="na">intValue</span><span class="p">()))</span>
      <span class="p">.</span><span class="na">findFirst</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<p>簡単に言うと <span class="docutils literal"><span class="pre">ArrayList</span></span> から値を取り出して返し、その値に1足して、また <span class="docutils literal"><span class="pre">ArrayList</span></span> に格納する、を繰り返しています。</p>
<p><span class="docutils literal"><span class="pre">ArrayList</span></span> の生成には <span class="docutils literal"><span class="pre">Collectors.toList</span></span> で返される <span class="docutils literal"><span class="pre">Collector</span></span> の <span class="docutils literal"><span class="pre">supplier</span></span> を利用しました。
ぶっちゃけ <span class="docutils literal"><span class="pre">Collectors.toList</span></span> の実装に依存しており美しくないですね。</p>
<p>また、記号を抑えるためにraw型を使用していますが、そのせいでキャストが多発しており、これも美しくないです。</p>
<p>その点、きつねさんが提案してくれた方法はコードが美しく、より狂気があふれており素晴らしい！！！</p>
<p>というわけで、セミコロンなどレスJavaで書いたFizzBuzzは次のようになりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFizzBuzz</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">security</span><span class="p">.</span><span class="na">SecureRandom</span><span class="p">.</span><span class="na">getInstanceStrong</span><span class="p">())</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">IntStream</span>
                <span class="p">.</span><span class="na">generate</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">101</span><span class="p">))</span>
                <span class="p">.</span><span class="na">distinct</span><span class="p">().</span><span class="na">limit</span><span class="p">(</span><span class="mi">101</span><span class="p">).</span><span class="na">sorted</span><span class="p">().</span><span class="na">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
                    <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span>
                                    <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x46</span><span class="p">)</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x69</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x42</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x75</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)))</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span>
                                    <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x46</span><span class="p">)</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x69</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)))</span>
         <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">mod</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                    <span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">math</span><span class="p">.</span><span class="na">BigInteger</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)).</span><span class="na">map</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span>
                                    <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x42</span><span class="p">)</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x75</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">))</span>
                            <span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x7a</span><span class="p">)))</span>
                <span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">toString</span><span class="p">()))))</span>
            <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Collectors</span><span class="p">.</span><span class="na">joining</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span> <span class="mh">0x20</span><span class="p">))))</span>
            <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">fizzbuzz</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fizzbuzz</span><span class="p">))</span>
            <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
]]></description>
             <pubDate>Wed, 09 Dec 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/12/05/semicolonless_java_enum_method.html</link>
            <guid>https://backpaper0.github.io/2015/12/05/semicolonless_java_enum_method.html</guid>
            <title><![CDATA[セミコロンレスJava 8の新機能「enumにメソッド生やす」 #semicolonlessjava]]></title>
            <description><![CDATA[<h1>セミコロンレスJava 8の新機能「enumにメソッド生やす」 #semicolonlessjava</h1>
<p>これは
<a class="reference external" href="http://www.adventar.org/calendars/952">セミコロンレスJava Advent Calendar 2015</a>
の5日目です。</p>
<div class="section" id="javaenum">
<h2>レガシーセミコロンレスJavaにおけるenumの制限</h2>
<p>Java言語ではenumにメソッドを生やす事ができます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンを付けても良いありふれた普通のJavaコード</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="n">Hoge</span> <span class="p">{</span>
    <span class="n">FOO</span><span class="p">,</span> <span class="n">BAR</span><span class="p">,</span> <span class="n">BAZ</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">println</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">name</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>しかしメソッドを定義するためには一番最後に宣言した列挙定数(上記の例でいうと
<span class="docutils literal"><span class="pre">BAZ</span></span>
)の後ろにセミコロンをつける必要があります。</p>
<p>これは回避できない制約なのでセミコロンレスJavaではenumにメソッドは生やせませんでした。</p>
</div>
<div class="section" id="java-8enum">
<h2>セミコロンレスJava 8におけるenumの新機能</h2>
<p>しかし、Java 8でインターフェースにデフォルトメソッドを持てるようになり、
その副次効果でセミコロンレスJava 8ではenumにメソッドを生やす事が出来るようになりました。</p>
<p>手順は簡単で、デフォルトメソッドを定義したインターフェースを用意してenumでそれをimplementsするだけです。</p>
<p>コード例を示します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">enum</span> <span class="n">Hoge</span> <span class="kd">implements</span> <span class="n">Fuga</span> <span class="p">{</span>
   <span class="n">FOO</span><span class="p">,</span> <span class="n">BAR</span><span class="p">,</span> <span class="n">BAZ</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Fuga</span> <span class="p">{</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">println</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">"%s%n"</span><span class="p">,</span> <span class="p">((</span><span class="n">Hoge</span><span class="p">)</span> <span class="k">this</span><span class="p">).</span><span class="na">name</span><span class="p">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>enumの列挙定数や他のメソッドにアクセスしたい場合はキャストすればOKです。</p>
</div>
<div class="section" id="id1">
<h2>まとめ</h2>
<ul class="simple">
<li>enumにメソッドを生やせるようになり、ますますセミコロンレスJavaが便利に！</li>
</ul>
</div>
]]></description>
             <pubDate>Sat, 05 Dec 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/12/01/jjug_ccc_2015_fall.html</link>
            <guid>https://backpaper0.github.io/2015/12/01/jjug_ccc_2015_fall.html</guid>
            <title><![CDATA[JJUG CCC 2015 Fallに行ってきた #jjug_ccc]]></title>
            <description><![CDATA[<h1>JJUG CCC 2015 Fallに行ってきた #jjug_ccc</h1>
<ul class="simple">
<li><a class="reference external" href="http://www.java-users.jp/?page_id=2056">http://www.java-users.jp/?page_id=2056</a></li>
</ul>
<div class="section" id="jax-rs">
<h2>JAX-RSネタで登壇してきた</h2>
<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">GH-1のタイポっぽいけどGlassFishっぽくて良いな！ <a href="https://t.co/jfu08S7JMW">pic.twitter.com/jfu08S7JMW</a></p>— うらがみ (@backpaper0) <a href="https://twitter.com/backpaper0/status/670444637669093376">2015, 11月 28</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><ul class="simple">
<li><a class="reference external" href="http://www.java-users.jp/?page_id=2064#AB-1">http://www.java-users.jp/?page_id=2064#AB-1</a></li>
</ul>
<p>というわけで登壇させて頂きました。</p>
<ul class="simple">
<li><a class="reference external" href="/ghosts/jaxrs-getting-started-and-practice.html">JAX-RS入門および実践</a></li>
</ul>
<p>ペース配分が甘くて最後のテストコードのパートをまるごと省略してしまい、聴講してくださった皆様には大変申し訳なく思っています。
おそらく関Javaで再演しますが、その際はしっかり最後まで話せるよう練習しておきます。</p>
<p>また、懇親会で「物足りなかった」というご意見を頂きました。
確かに、できる限りJAX-RSをご存知ない方にもJAX-RSを知って頂きたく、最大公約数的な内容にしたので物足りないと感じた方はいらっしゃるだろうなと思いました。</p>
<p>ですので次(JJUG CCCとは限りませんが)はもうちょっと濃い目の話しをしたいなと思っています。</p>
<p>私のセッションを選んでくださった聴講者の皆様、私のCfPを選んでくださったJJUGスタッフの皆様、資料レビューに付き合ってくれたほげメン・やんくさん、本当にありがとうございました！</p>
</div>
<div class="section" id="id2">
<h2>まーやさん、たろうさんのコミュニティセッションでお話してきた</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.java-users.jp/?page_id=2064#EF-7">http://www.java-users.jp/?page_id=2064#EF-7</a></li>
</ul>
<p>関Javaというコミュニティのスタッフをやっているという事でお声がけ頂いてお話してきました。</p>
<p>内容についてはまーやさんが素敵なレポートを書き上げてくださいました！</p>
<ul class="simple">
<li><a class="reference external" href="https://hotchpotchj37.wordpress.com/2015/11/30/2015%E5%B9%B4%EF%BC%91%EF%BC%91%E6%9C%8828%E6%97%A5jjug%E3%80%80ccc%E3%80%80%E5%8F%82%E5%8A%A0%E3%81%8D%E3%82%8D%E3%81%8F%EF%BD%9E%E7%99%BB%E5%A3%87%E7%B7%A8%EF%BD%9E/">2015年11月28日JJUG　CCC　参加きろく～登壇編～ | hotchpotch</a></li>
</ul>
<p>ここでは時間の都合で話せなかった事を記載しておきます。</p>
<div class="section" id="id3">
<h3>苦労話 会場の確保</h3>
<p>これは毎回悩みます。</p>
<p>テーマによってどの程度の集客が見込めるか考えて、その規模感に合った会場を探して、という感じで色々考えた挙句ばふぁさんを頼る、というのが最近のアレ。</p>
<p>本当に最近はばふぁさんを頼りすぎているのですが、いつも快く引き受けてくださって当日も笑顔で迎えてくださるのでもうホントなんというかマジ感謝ありがとうございます大好きラブ！って感じです。</p>
</div>
<div class="section" id="or">
<h3>抱えている課題(or 過去にあった課題) 調整力不足</h3>
<p>運営には登壇者と日程調整して、会場を探して、懇親会のお店を探して、内容によっては当日までにリマインダメールを投げたり、
というような事をする調整力というかなんというか、そんな感じのプログラマの苦手領域っぽいスキルが求められます。</p>
<p>私も最初は……というかまあ今も苦労してはいますが、何度もやっているうちに慣れてきて前よりは上手くやれるようになりました。
そして仕事をする上でも以前よりも調整事ができるようになって業務を円滑に進められるようになったと思っています。</p>
<p>プログラミングの勉強会の運営をやって、プログラミングスキル以外のスキルがレベルアップした、という。
棚ぼた。</p>
</div>
<div class="section" id="id4">
<h3>その他、個人的な思い</h3>
<p>私はコミュニティ運営をしていない一般の参加者だった頃、運営をやっている人たちを神格化していたように思います。
あの人たちはすごい！
参加しかしていない自分よりも上の人だ！
殿上人だ！
と。</p>
<p>でも自分が運営に関わってみると運営は神ではないし、「コミュニティ運営してる・してない」はエンジニアの優劣になんら関係無いという事を理解しました。
まあ当たり前っちゃ当たり前なんですが。
とはいえ勉強会って楽しいし、どうやって開催するのかその時は全然見当もつかなかったし、なんだかそう思っちゃってたんですよね。</p>
<p>まあ何が言いたいかというと「コミュニティ運営をしている・していない」は上下関係じゃなくて異なるレイヤーだということです。
やりたい人がやれば良いし、やってる人は楽しくてやってるだけなので運営に関われない事を負い目に感じる必要は無いんだよ、と。
そんな感じです。</p>
<p>私は(これは会場でも言いましたが)勉強会に参加してくださった方が書いた感想ブログを読んだり、
Twitterで「参加してよかった！」とツイートなさるのを見るのがすごく嬉しいので、まだしばらくはコミュニティ運営に関わって行きたいと思っています。</p>
<p>面白いセッションにお誘い頂いたまーやさん・たろうさん、一緒にパネラーをしたまみさん・ひつじさん、それから一緒に楽しんでくださった参加者の皆様、ありがとうございました！
楽しかったですね！</p>
</div>
</div>
<div class="section" id="id5">
<h2>拝聴したセッション</h2>
<p>ではここから拝聴したセッションについてざっくり記載します。</p>
<div class="section" id="ef-3-reactive-web-spring-5">
<h3>EF-3 Reactive Webアプリケーション – そしてSpring 5へ</h3>
<ul class="simple">
<li><a class="reference external" href="http://www.java-users.jp/?page_id=2064#EF-3">http://www.java-users.jp/?page_id=2064#EF-3</a></li>
</ul>
<p>まきさんのスピード感あふれるセッション(時間が足りない的な意味で)。
スピード感あふれていましたが、すごく分かりやすかったです。
(RxJavaをほんのり触った事があったからそれも幸いしたかな)</p>
<p>内容もすごく良かったのですが、時間が無いと仰っていたのにRod Johnsonとのツーショット写真やSpring Tシャツを嬉しそうに自慢するまきさんがかわいかったのも見所でした。</p>
</div>
<div class="section" id="ef-5-java">
<h3>EF-5 これからのコンピューティングの変化とJava</h3>
<ul class="simple">
<li><a class="reference external" href="http://www.java-users.jp/?page_id=2064#EF-5">http://www.java-users.jp/?page_id=2064#EF-5</a></li>
</ul>
<p>きしださんの癒しボイス満載のセッション。</p>
<p>FPGAとかよく分からないんですが、自然な流れでJVM・Java言語の話になっていき、最後にはなるほど感が残る素敵なセッションでした。</p>
<p>でもやっぱりFPGAとかよく分かってない事に今気がついたので、きしださんのブログを読んで勉強します。</p>
</div>
<div class="section" id="ab-6-java">
<h3>AB-6 【こっそり始める】Javaプログラマコーディングマイグレーション</h3>
<ul class="simple">
<li><a class="reference external" href="http://www.java-users.jp/?page_id=2064#AB-6">http://www.java-users.jp/?page_id=2064#AB-6</a></li>
</ul>
<p>資料レビューし合ったやんくさんのセッション。</p>
<p>自分が置かれている環境がアレな場合に、今居る環境を変える、もしくは別の環境に行く、
という二択のうち前者をとる話でした。</p>
<p>それも真正面から玉砕覚悟でぶつかっていくのではなく、隙を見つけてねじ込む搦め手をやってみようよ！っていう感じ。</p>
<p>個人的には「おれはやるだけやった、でもあいつらが分からず屋なんだ」と他責にしちゃうのは好きではないし、
過程よりも結果を残すのが大事だと思っているので、搦め手で確実に改善を狙うスタンスには好感を持ちました。</p>
</div>
</div>
<div class="section" id="id6">
<h2>懇親会</h2>
<p>そう長くない時間で色々あったけどまとめきれないので割愛！
楽しかった、とだけ言っておく！</p>
<p>色んな人に挨拶できたけど、しきれなかったので来春にリベンジします！</p>
<p>JJUG CCC 2015 Fall、楽しかった！！！</p>
</div>
]]></description>
             <pubDate>Tue, 01 Dec 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/11/15/javajok.html</link>
            <guid>https://backpaper0.github.io/2015/11/15/javajok.html</guid>
            <title><![CDATA[関西Java女子部主催「Javaでwebアプリケーション入門」をお手伝いしてきました #javajok]]></title>
            <description><![CDATA[<h1>関西Java女子部主催「Javaでwebアプリケーション入門」をお手伝いしてきました #javajok</h1>
<p>こんばんは！
Eclipseへのインポート手順を解説していた <a class="reference external" href="https://twitter.com/backpaper0">@backpaper0</a> です！</p>
<p>表題の通り、Javaのハンズオンイベントをお手伝いしてきました！</p>
<ul class="simple">
<li><a class="reference external" href="http://javajok.connpass.com/event/22044/">http://javajok.connpass.com/event/22044/</a></li>
<li><a class="reference external" href="http://irof.hateblo.jp/entry/2015/11/16/235913">http://irof.hateblo.jp/entry/2015/11/16/235913</a> 一緒にやった <a class="reference external" href="https://twitter.com/irof">@irofさん</a> のレポート</li>
</ul>
<p>会場は楽天株式会社大阪支社のカフェテリアをお借り致しました。
<a class="reference external" href="https://twitter.com/bufferings">@bufferingsさん</a> 、休日なのにいつも笑顔でお付き合いくださりありがとうございます！</p>
<p>なお、会場提供くださった楽天株式会社大阪支社では11月21日(土)に
<em>Rakuten Technology Conference 2015</em> というイベントのサテライトが行われるそうです。</p>
<ul class="simple">
<li><a class="reference external" href="http://bufferings.hatenablog.com/entry/2015/11/04/220925">http://bufferings.hatenablog.com/entry/2015/11/04/220925</a></li>
</ul>
<div class="section" id="id1">
<h2>参加してみて私が得たもの</h2>
<p>私は講師側として参加しましたが、分かりやすく教えることの難しさを学べました。</p>
<p>また、自分が初心者だった頃に何が分からなかったか、何を分かりたかったか、どうやって分かるようになったか、
などを見つめ直す良いきっかけとなりました。</p>
<p>運営にお誘いくださった <a class="reference external" href="https://twitter.com/aa7th">@aa7thさん</a> 、
今回のイベント開催のきっかけとなった <a class="reference external" href="https://twitter.com/ar_keyaki">@ar_keyakiさん</a> 、
それから今回ご参加頂いた皆さん、本当にありがとうございました！</p>
</div>
<div class="section" id="eclipse">
<h2>Eclipseへのインポートについて</h2>
<p>さて、本日はプロジェクトをEclipseへインポートする箇所で不手際があり参加者の皆さんにはご迷惑をお掛けし、申し訳ありませんでした。</p>
<p>もしご自宅で復習をなさる場合は、改めて <a class="reference external" href="https://github.com/javajok/simpletter">https://github.com/javajok/simpletter</a> からZIPファイルをダウンロードし、
<cite>gradlew eclipse</cite> を行ってインポートしてみてください。</p>
<p>なお、ダウンロードされるファイルの名前は「simpletter-master.zip」です。</p>
</div>
<div class="section" id="api">
<h2>APIについて</h2>
<p>ハンズオンで使用したAPIのソースコードは次のURLにあります。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/javajok/simpletter-api">https://github.com/javajok/simpletter-api</a></li>
</ul>
<p>こちらもsimpletterと同じく、ZIPファイルをダウンロード・解凍して <cite>gradlew eclipse</cite>
を行うことでEclipseにインポートする形式にできます。</p>
<p>余力がある方・興味がある方は宜しければこのAPIのソースコードも読んで、
色々といじってみてください。</p>
</div>
<div class="section" id="id2">
<h2>最後に</h2>
<p>私は基本的には詰まった時などのサポートに徹していました。</p>
<p>サポートの際はなるべく分かりやすく言葉を選び、そして「こうすれば出来る」だけでなく「なぜそうなるのか」も説明するよう心がけていました。
ですので、もし私のサポートがみなさんの理解の助けになれたのであれば、すごく嬉しいです。</p>
<p>それから、もしまた別のイベントでお会いする事があれば気軽にお声がけください。
今日の事を思い出しながらJavaでWebについてお話しましょう！</p>
<p>それでは繰り返しになりますが、本日は本当にありがとうございました！
すごく楽しかったです！</p>
</div>
]]></description>
             <pubDate>Sun, 15 Nov 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/10/08/spring_boot_rich_banner.html</link>
            <guid>https://backpaper0.github.io/2015/10/08/spring_boot_rich_banner.html</guid>
            <title><![CDATA[Spring Bootでカラフルなバナーを表示してみた]]></title>
            <description><![CDATA[<h1>Spring Bootでカラフルなバナーを表示してみた</h1>
<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">gradle build
java -jar build/libs/spring-boot-rich-banner-sample.jar
ではじぶーと
<a href="https://t.co/Z0kQb1fUGR">https://t.co/Z0kQb1fUGR</a> <a href="http://t.co/8wWuHiJwM6">pic.twitter.com/8wWuHiJwM6</a></p>— うらがみ (@backpaper0) <a href="https://twitter.com/backpaper0/status/651745561658265601">2015, 10月 7</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>というわけでカラフルなバナーを表示するBannerクラスを書いてみました。</p>
<div class="section" id="id1">
<h2>どうやってんのか</h2>
<p>ターミナルの背景色を変更してスペースを2つ出力、を繰り返して絵を描いています。
スペースを2つ出力することで正方形になって良い感じにドット絵っぽくなります。</p>
<p>背景色を変えるには</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>ESC + '[48;05;' + 色のインデックス + 'm'
</pre></div>
</div>
<p>で出来ます。</p>
<p>次のGroovyコマンドを試してみてください。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>groovy -e <span class="s2">"System.out.write(0x1b);println('[48;05;20mHello, World!')"</span>
</pre></div>
</div>
<p>背景色を元に戻すには</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>ESC + '[0m'
</pre></div>
</div>
<p>です。</p>
<p>それから、元画像はターミナルで出力できる色だけで構成されているわけではないので、
元画像から1ピクセルずつ色を読み込んでターミナルで出力できる256色の中から近い色を探して出力しています。</p>
<p>2つの色がどの程度近いかはカラーコードを三次元の座標に見立てて2つの色間の距離を求めて一番近いものを選んでいます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">rgb1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">rgb2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">g</span> <span class="o">=</span> <span class="p">((</span><span class="n">rgb1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">rgb2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">rgb2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">g</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">);</span>
</pre></div>
</div>
<p>概ねこんな感じです。</p>
</div>
<div class="section" id="id2">
<h2>いろいろブート</h2>
<p>うらがみブート。</p>
<img alt="../../../_images/uragami-boot.png" src="https://backpaper0.github.io/_images/uragami-boot.png"/>
<p>いろふブート。</p>
<img alt="../../../_images/irof-boot.png" src="https://backpaper0.github.io/_images/irof-boot.png"/>
<p>ちむブートﾍﾟﾛﾍﾟﾛ（＾ω＾）</p>
<img alt="../../../_images/syobochim-boot-peropero.png" src="https://backpaper0.github.io/_images/syobochim-boot-peropero.png"/>
<p>こざブート✌️( ・ㅂ・)و🍺</p>
<img alt="../../../_images/kozaboot.png" src="https://backpaper0.github.io/_images/kozaboot.png"/>
<p>ブートくしーさん。</p>
<img alt="../../../_images/bootksy.png" src="https://backpaper0.github.io/_images/bootksy.png"/>
<p>やんくブート:q!</p>
<img alt="../../../_images/yank-boot_q.png" src="https://backpaper0.github.io/_images/yank-boot_q.png"/>
</div>
<div class="section" id="id3">
<h2>ソースコード</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/spring-boot-rich-banner-sample">https://github.com/backpaper0/spring-boot-rich-banner-sample</a></li>
</ul>
</div>
]]></description>
             <pubDate>Thu, 08 Oct 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/08/25/serialized_lambda.html</link>
            <guid>https://backpaper0.github.io/2015/08/25/serialized_lambda.html</guid>
            <title><![CDATA[シリアライザブルなラムダ式]]></title>
            <description><![CDATA[<h1>シリアライザブルなラムダ式</h1>
<p>ラムダ式は <span class="docutils literal"><span class="pre">Serializable</span></span> にできます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//キャストしたり</span>
<span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">Serializable</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s">"x"</span><span class="p">;</span>

<span class="c1">//メソッドであれしたり</span>
<span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">consume</span><span class="p">(</span><span class="n">T</span> <span class="n">supplier</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>
</div>
<p>で、シリアライズできるぞー、と思ってこんなコード書いて、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Supplier</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample</span> <span class="p">{</span>

    <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">Serializable</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">toString</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>

        <span class="c1">//↓シリアライザブルなサプライヤー</span>
        <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Sample</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>

        <span class="c1">//シリアライズしてみる</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">(</span><span class="n">ObjectOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">baos</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">out</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>実行すると、</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Exception in thread "main" java.io.NotSerializableException: Sample
    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1184)
    at java.io.ObjectOutputStream.writeArray(ObjectOutputStream.java:1378)
    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1174)
    at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
    at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
    at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
    at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)
    at Sample.main(Sample.java:17)
</pre></div>
</div>
<p>例外です！</p>
<p>これはラムダ式で <span class="docutils literal"><span class="pre">Sample</span></span> クラスの <span class="docutils literal"><span class="pre">toString</span></span> メソッドを呼んでいるため
<span class="docutils literal"><span class="pre">Sample</span></span> がキャプチャされますが、 <span class="docutils literal"><span class="pre">Sample</span></span> はSerializableでないため例外が出ます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">Serializable</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">toString</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>キャプチャというのはラムダ式内でラムダ式のスコープの外側の変数を参照した場合にラムダ式の実行環境に持ってくるっぽい感じのあれです。</p>
<p>キャプチャされているインスタンスは <span class="docutils literal"><span class="pre">SerializedLambda</span></span> から取ってこれます。
<span class="docutils literal"><span class="pre">SerializedLambda</span></span> はprivate finalな <span class="docutils literal"><span class="pre">writeReplace</span></span> メソッドで取ってこれます。
取ってこれるからと言ってカジュアルに呼んで良いメソッドではないです。
<span class="docutils literal"><span class="pre">writeReplace</span></span> については <span class="docutils literal"><span class="pre">Serializable</span></span> のJavadocに書いてあります。</p>
<p>こんな感じで <span class="docutils literal"><span class="pre">SerializedLambda</span></span> とキャプチャしたインスタンスを取ってこれました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Sample</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>

<span class="n">Method</span> <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="s">"writeReplace"</span><span class="p">);</span>
<span class="n">m</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="n">SerializedLambda</span> <span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">SerializedLambda</span><span class="p">)</span> <span class="n">m</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sl</span><span class="p">.</span><span class="na">getCapturedArgCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">sl</span><span class="p">.</span><span class="na">getCapturedArg</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この辺りをもっといじくりまわすと面白い事ができそうな気がしなくもないですね！</p>
<div class="section" id="id2">
<h2>関係ありそうな、そうでもないような参考リソース</h2>
<ul class="simple">
<li><a class="reference external" href="http://mike-neck.hatenadiary.com/entry/2015/08/21/034542">http://mike-neck.hatenadiary.com/entry/2015/08/21/034542</a></li>
<li><a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/lang/invoke/SerializedLambda.html">https://docs.oracle.com/javase/jp/8/docs/api/java/lang/invoke/SerializedLambda.html</a></li>
<li><a class="reference external" href="https://docs.oracle.com/javase/jp/8/docs/api/java/io/Serializable.html">https://docs.oracle.com/javase/jp/8/docs/api/java/io/Serializable.html</a></li>
</ul>
</div>
<div class="section" id="id3">
<h2>まとめもオチもない</h2>
<p>とりあえず <span class="docutils literal"><span class="pre">Sample</span></span> クラスは <span class="docutils literal"><span class="pre">Serializable</span></span> をimplementsしましょう。</p>
</div>
]]></description>
             <pubDate>Tue, 25 Aug 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/07/30/gradle_plugin.html</link>
            <guid>https://backpaper0.github.io/2015/07/30/gradle_plugin.html</guid>
            <title><![CDATA[Gradleプラグインを書いて公開しちゃった]]></title>
            <description><![CDATA[<h1>Gradleプラグインを書いて公開しちゃった</h1>
<div class="section" id="id1">
<h2>きっかけ</h2>
<p>JAX-RSでWebフォントなどの静的リソースを返すリソースメソッドを書いたんですが、
ETagを使ってキャッシュをアレして転送量を節約したくなりました。</p>
<p>で、ETagにはMD5ハッシュ値を使ってたんですが毎回ハッシュ値を計算するのはあほくさいので、
ビルド時に計算してファイルに保存しておく事にしました。</p>
<p>その際にGradleプラグインを書いて、
どうせならと思って <a class="reference external" href="https://plugins.gradle.org/">https://plugins.gradle.org/</a> で公開する事にしました。</p>
</div>
<div class="section" id="id2">
<h2>Gradleプラグインを書く</h2>
<p>次の公式ドキュメント(の日本語訳)を参考にすればオッケー！</p>
<ul class="simple">
<li><a class="reference external" href="http://gradle.monochromeroad.com/docs/userguide/custom_tasks.html">第58章 カスタムタスクの作成</a></li>
<li><a class="reference external" href="http://gradle.monochromeroad.com/docs/userguide/custom_plugins.html">第59章 カスタムプラグインの作成</a></li>
</ul>
</div>
<div class="section" id="id5">
<h2>Gradleプラグインを公開する</h2>
<p><a class="reference external" href="https://plugins.gradle.org/docs/submit">How do I add my plugin to the plugin portal?</a>
の通りに進めていけばオッケー！</p>
<p>ざっくり書くと、
まず <a class="reference external" href="https://plugins.gradle.org/user/register">アカウントを作って</a> 、
自分のページでAPI Keyを作って、
それを <cite>~/.gradle/gradle.properties</cite> に書いて、
<cite>build.gradle</cite> へ <a class="reference external" href="https://plugins.gradle.org/docs/publish-plugin">Plugin Publishing Plugin</a>
の設定を書いて、
<span class="docutils literal"><span class="pre">gradle</span> <span class="pre">publishPlugins</span></span> で公開します。</p>
</div>
<div class="section" id="id7">
<h2>Gradleプラグインを書くときに知ってて良かったこと</h2>
<p>知ってて良かったことっていうかGroovyの文法なんですけど、
次のようなことを知ってたらわりとスムーズにプラグインを書けました。</p>
<ul class="simple">
<li>アクセサメソッドはフィールドアクセスのように書ける。<ul>
<li>例えば <span class="docutils literal"><span class="pre">foo.getBar()</span></span> は <span class="docutils literal"><span class="pre">foo.bar</span></span> と書ける。</li>
<li>そして <span class="docutils literal"><span class="pre">foo.setBar(baz)</span></span> は <span class="docutils literal"><span class="pre">foo.bar</span> <span class="pre">=</span> <span class="pre">baz</span></span> と書ける。</li>
</ul>
</li>
<li>メソッド呼び出しで最後の引数がクロージャだと括弧の外に出せる。
つまり <span class="docutils literal"><span class="pre">foo(bar,</span> <span class="pre">{</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">...</span> <span class="pre">})</span></span> は <span class="docutils literal"><span class="pre">foo(bar)</span> <span class="pre">{</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">...</span> <span class="pre">}</span></span> と書けて組み込みの構文のようにできる。</li>
<li>引数がMapなら <span class="docutils literal"><span class="pre">foo(bar:</span> <span class="pre">"...",</span> <span class="pre">baz:</span> <span class="pre">123)</span></span> みたいに書ける。</li>
<li>展開演算子。
<span class="docutils literal"><span class="pre">['hoge',</span> <span class="pre">'foo',</span> <span class="pre">'x'].collect</span> <span class="pre">{</span> <span class="pre">it.length()</span> <span class="pre">}</span></span>
を
<span class="docutils literal"><span class="pre">['hoge',</span> <span class="pre">'foo',</span> <span class="pre">'x']*.length()</span></span>
と書ける。</li>
<li><span class="docutils literal"><span class="pre">leftShift</span></span> という名前のメソッドは <span class="docutils literal"><span class="pre">&lt;&lt;</span></span> と書ける。
タスクを定義するときの <span class="docutils literal"><span class="pre">task</span> <span class="pre">hoge</span> <span class="pre">&lt;&lt;</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></span> は
<a class="reference external" href="https://docs.gradle.org/current/javadoc/org/gradle/api/Task.html#leftShift(groovy.lang.Closure)">Task.leftShiftメソッド</a>
です。</li>
</ul>
</div>
<div class="section" id="id8">
<h2>Gradleプラグインを書くにあたって参考にしたもの</h2>
<p>最初に挙げた公式ドキュメントの日本語訳はもちろん参考にしましたが、
他に
<a class="reference external" href="https://docs.gradle.org/current/javadoc/">GradleのAPIドキュメント</a>
が参考になりました。</p>
<p>特に次のクラスのドキュメントをよく読んだ気がします。</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html">Project</a></li>
<li><a class="reference external" href="https://docs.gradle.org/current/javadoc/org/gradle/api/tasks/TaskContainer.html">TaskContainer</a></li>
<li><a class="reference external" href="https://docs.gradle.org/current/javadoc/org/gradle/api/Task.html">Task</a></li>
</ul>
<p>それから <a class="reference external" href="https://github.com/gradle/gradle">Gradleのソースコード</a>
も参考になりました。
特に
<a class="reference external" href="https://github.com/gradle/gradle/blob/master/subprojects/plugins/src/main/groovy/org/gradle/api/plugins/JavaPlugin.java">JavaPlugin</a>
や
<a class="reference external" href="https://github.com/gradle/gradle/blob/master/subprojects/plugins/src/main/groovy/org/gradle/api/plugins/WarPlugin.java">WarPlugin</a>
を参考にしました。</p>
</div>
<div class="section" id="id10">
<h2>まとめ</h2>
<p>Gradleプラグインは書くのも公開するのもお手軽っぽいので、
これを読んで良いなと思ったらチャレンジしてみてくれさい！</p>
<p>ちなみに、こちらが私が書いたプラグインですどうぞ！</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/gradle-hash-plugin">gradle hash plugin</a></li>
</ul>
</div>
]]></description>
             <pubDate>Thu, 30 Jul 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/07/12/jsr310_and_lambda_handson.html</link>
            <guid>https://backpaper0.github.io/2015/07/12/jsr310_and_lambda_handson.html</guid>
            <title><![CDATA[Java 8徹底再入門やった #kanjava]]></title>
            <description><![CDATA[<h1>Java 8徹底再入門やった #kanjava</h1>
<ul class="simple">
<li><a class="reference external" href="http://kanjava.connpass.com/event/15515/">【Date and Time API】Java 8徹底再入門【ラムダ式ハンズオン】(大阪,7/11) - connpass</a></li>
</ul>
<p>東京から <a class="reference external" href="https://twitter.com/khasunuma">@khasunuma</a> さんを講師にお迎えして
<a class="reference external" href="https://jcp.org/en/jsr/detail?id=310">JSR 310: Date and Time API</a>
の解説をして頂きました。</p>
<p>またイベントの後半は
<a class="reference external" href="https://twitter.com/bitter_fox">@bitter_fox</a> さんにラムダ式・Stream APIのハンズオンを行って頂きました。</p>
<p>会場は楽天株式会社大阪支社のカフェテリアをお借り致しました。
<a class="reference external" href="https://twitter.com/bufferings">@bufferings</a> さん、いつもご協力ありがとうございます。</p>
<p>お二人とも初歩的な部分から丁寧にお話・ハンズオンをして頂いたので参加された方々は
Date and Time API と ラムダ式・Stream API
の基礎を身に付けることが出来たのではないでしょうか。</p>
<p>はすぬまさん、きつねさん、本当にありがとうございました！</p>
<div class="section" id="id1">
<h2>講師・参加者の皆様の感想</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.coppermine.jp/docs/programming/2015/07/jsr310-kanjava.html">「Java 8徹底再入門」に登壇しました。 - Programming Studio</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/ttshiko/20150712/1436659111">関ジャバに参加してきました： 【Date and Time API】Java 8徹底再入門【ラムダ式ハンズオン】(大阪,7/11) - ttshikoの日記</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/tomoTaka/20150712">【Date and Time API】Java 8徹底再入門【ラムダ式ハンズオン】(大阪,7/11)に参加してきました - tomoTakaの日記</a></li>
<li><a class="reference external" href="http://blog.tsukasaya.info/article/152218631.html">遠征してました→【Date and Time API】Java 8徹底再入門【ラムダ式ハンズオン】: 迷走記録</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 12 Jul 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/06/29/grgit.html</link>
            <guid>https://backpaper0.github.io/2015/06/29/grgit.html</guid>
            <title><![CDATA[Grgitでコミットのハッシュ値をファイルに書き出してwarに入れる]]></title>
            <description><![CDATA[<h1>Grgitでコミットのハッシュ値をファイルに書き出してwarに入れる</h1>
<p>今デプロイされてるwarはどのコミットから作ったんじゃろ？
っていう疑問を解決するためのやつです。
Gradleでwarを作る前に
<a class="reference external" href="https://github.com/ajoberstar/grgit">Grgit</a>
というものを使ってコミットのハッシュ値をファイルに書き出しておいて
warに入れてしまってついでにJAX-RSのリソースとしてあれしてしまいましょう、
という話。</p>
<div class="section" id="build-gradle">
<h2>build.gradle</h2>
<p>まずGrgitを使う準備。
Gradleは普通にGroovyコードを書けて便利。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">org.ajoberstar.grgit.Grgit</span>

<span class="n">ext</span><span class="o">.</span><span class="na">repo</span> <span class="o">=</span> <span class="n">Grgit</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="s1">'.'</span><span class="o">))</span>

<span class="n">buildscript</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">jcenter</span><span class="o">()</span>
        <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span><span class="o">(</span><span class="s1">'org.ajoberstar:gradle-git:1.1.0'</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>次にハッシュをファイルに書き出すタスクの定義とwarタスクとの依存関係の設定。
今回はwarファイル内の <cite>WEB-INF/classes/head</cite> にファイルがパッケージングされるようにしました。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">task</span> <span class="n">writeHeadCommitHash</span> <span class="o">&lt;&lt;</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">buildDir</span><span class="o">,</span> <span class="s1">'git/head'</span><span class="o">)</span>
    <span class="n">file</span><span class="o">.</span><span class="na">parentFile</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">()</span>
    <span class="n">file</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">repo</span><span class="o">.</span><span class="na">head</span><span class="o">().</span><span class="na">id</span><span class="o">)</span>
<span class="o">}</span>

<span class="n">war</span><span class="o">.</span><span class="na">classpath</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">buildDir</span><span class="o">,</span> <span class="s1">'git'</span><span class="o">)</span>

<span class="n">war</span><span class="o">.</span><span class="na">dependsOn</span> <span class="n">writeHeadCommitHash</span>
</pre></div>
</div>
</div>
<div class="section" id="jax-rs">
<h2>JAX-RSのリソースクラス</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">javayou</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.URISyntaxException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.enterprise.context.RequestScoped</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Named</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span><span class="p">;</span>

<span class="nd">@Named</span>
<span class="nd">@RequestScoped</span>
<span class="nd">@Path</span><span class="p">(</span><span class="s">"head"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GitCommitHashResource</span> <span class="p">{</span>

    <span class="nd">@GET</span>
    <span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_PLAIN</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getHead</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">URL</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">getClass</span><span class="p">().</span><span class="na">getResource</span><span class="p">(</span><span class="s">"/head"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">readAllBytes</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="na">toURI</span><span class="p">()));</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">URISyntaxException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">ignored</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">"&lt;none&gt;"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>コーディング中にIDEから動かしたとかそういうときはファイルが無いから
&lt;none&gt;
って表示されるようにしています。</p>
<p>これで、このリソースにアクセスすればどのコミットから作られたwarなのかが分かるます。</p>
</div>
<div class="section" id="id1">
<h2>動くコード例</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/java-you">https://github.com/backpaper0/java-you</a></li>
</ul>
<p>動かして <a class="reference external" href="http://localhost:8080/java-you/api/head">http://localhost:8080/java-you/api/head</a> を開いてください。</p>
</div>
]]></description>
             <pubDate>Mon, 29 Jun 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/06/19/payaya_micro_cluster.html</link>
            <guid>https://backpaper0.github.io/2015/06/19/payaya_micro_cluster.html</guid>
            <title><![CDATA[MacBook ProでPayara Microのクラスタリングを試そうとして躓いたけど出来た！]]></title>
            <description><![CDATA[<h1>MacBook ProでPayara Microのクラスタリングを試そうとして躓いたけど出来た！</h1>
<div class="section" id="id1">
<h2>問題</h2>
<p><a class="reference external" href="http://www.payara.co/payara_micro_clustering">Payara Micro Clustering</a>
を見ながらクラスタリング試そうと思ってあれしてみたんですが全然クラスタ組んでくれない！</p>
<p>Payara Microを2つ立ち上げた際の2つめのPayara Microのログの抜粋(クラスタ関連)がこれ。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>[2015-06-19T04:03:01.749+0900] [Payara 4.1] [INFO] [] [com.hazelcast.cluster.impl.MulticastJoiner] [tid: _ThreadID=1 _ThreadName=main] [timeMillis: 1434654181749] [levelValue: 800] [[
  [192.168.99.1]:5901 [dev] [3.4.2]


Members [1] {
        Member [192.168.99.1]:5901 this
}
]]
</pre></div>
</div>
<p>ご覧の通りメンバーがいない！
ソロ活動だ！</p>
<p>クラスタ組んでくだされ〜(´;ω;`)</p>
</div>
<div class="section" id="id2">
<h2>解決</h2>
<p>などとTwitterで嘆いてたら <a class="reference external" href="https://twitter.com/kazuhira_r">かずひらさん</a>
が助けてくれた！</p>
<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">NICも指定できないし…

あとは、-Djava.net.preferIPv4Stack=trueにしてIPv4にしてみるとかかな…</p>— かずひら (@kazuhira_r) <a href="https://twitter.com/kazuhira_r/status/611382429039788033">2015, 6月 18</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>かずひらさん、それです！</p>
<p>というわけで次のようにすればいけた。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>java -Djava.net.preferIPv4Stack<span class="o">=</span><span class="nb">true</span> -jar payara-micro-4.1.152.1.jar --deploy clusterjsp.war --port <span class="m">8000</span>
</pre></div>
</div>
<p>これでクラスタが組める！
組めるぞおおおおおおお！
( ﾟ∀ﾟ)ｱﾊﾊ八八ﾉヽﾉヽﾉヽﾉ ＼ / ＼/ ＼</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>[2015-06-19T04:11:18.909+0900] [Payara 4.1] [INFO] [] [com.hazelcast.cluster.ClusterService] [tid: _ThreadID=45 _ThreadName=hz.glassfish-web.server.generic-operation.thread-1] [timeMillis: 1434654678909] [levelValue: 800] [[
  [192.168.99.1]:5900 [dev] [3.4.2]

Members [21] {
        Member [192.168.99.1]:5900 this
        Member [192.168.99.1]:5901
        Member [192.168.99.1]:5902
        Member [192.168.99.1]:5903
        Member [192.168.99.1]:5904
        Member [192.168.99.1]:5905
        Member [192.168.99.1]:5906
        Member [192.168.99.1]:5907
        Member [192.168.99.1]:5908
        Member [192.168.99.1]:5909
        Member [192.168.99.1]:5910
        Member [192.168.99.1]:5911
        Member [192.168.99.1]:5912
        Member [192.168.99.1]:5913
        Member [192.168.99.1]:5914
        Member [192.168.99.1]:5915
        Member [192.168.99.1]:5916
        Member [192.168.99.1]:5917
        Member [192.168.99.1]:5918
        Member [192.168.99.1]:5919
        Member [192.168.99.1]:5920
}
]]
</pre></div>
</div>
<p>無駄に21クラスタ！</p>
<p>ここまで書いて、
まだまだいけんじゃね？と思い、
調子に乗ってPMC48(Payara Micro Clusterデス)とかやろうとしたけど30パヤラ越えたあたりからMacさんが唸りだしたのでビビって止めてしまった。</p>
</div>
<div class="section" id="id4">
<h2>謝辞</h2>
<p>かずひらさんありがとうございました！！！</p>
</div>
]]></description>
             <pubDate>Fri, 19 Jun 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/06/07/git_archive.html</link>
            <guid>https://backpaper0.github.io/2015/06/07/git_archive.html</guid>
            <title><![CDATA[Gitで管理してるソースをZIPにする]]></title>
            <description><![CDATA[<h1>Gitで管理してるソースをZIPにする</h1>
<p>小ネタです。
メモ的な。</p>
<p>GitHubにもpushしてない状態でちょっと人に見てもらいたいなー、
ってときにDropboxに置いてーとかやる事があるんですが、
そのときに.gitまで含めたくないし.gitignoreで無視してるファイルも含めたくないときに使うやつです。</p>
<p><span class="docutils literal"><span class="pre">git</span> <span class="pre">archive</span></span> コマンドを使います。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>git archive --format<span class="o">=</span>zip HEAD &gt; ../hoge.zip
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">--format</span></span> に使えるフォーマットは <span class="docutils literal"><span class="pre">git</span> <span class="pre">archive</span> <span class="pre">--list</span></span> で確認できます。</p>
]]></description>
             <pubDate>Sun, 07 Jun 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/05/29/wildfly_auto_download.html</link>
            <guid>https://backpaper0.github.io/2015/05/29/wildfly_auto_download.html</guid>
            <title><![CDATA[GradleでWildflyを自動でダウンロードしてからArquillianを実行する]]></title>
            <description><![CDATA[<h1>GradleでWildflyを自動でダウンロードしてからArquillianを実行する</h1>
<p>Java EEなアプリケーションのテストを回すのに <a class="reference external" href="http://arquillian.org/">Arquillian</a>
が便利なんですけど、
サンプル書くのに手動でアプリケーションサーバをダウンロードするのはちょい面倒なので、
Gradleにダウンロードしてもらうっていう話です。</p>
<p>アプリケーションサーバは <a class="reference external" href="http://wildfly.org/">Wildfly</a> を使用します。</p>
<p>それではbuild.gradleをいじりましょー！</p>
<p>まずdependenciesにWildflyのアーカイブを追加します。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">archives</span> <span class="s2">"org.wildfly:wildfly-dist:$wildflyVersion@zip"</span>
<span class="o">}</span>
</pre></div>
</div>
<p>次にアーカイブをunzipするタスクを書きます。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">task</span> <span class="nf">readyWildfly</span><span class="o">(</span><span class="nl">type:</span> <span class="n">Copy</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">wildflyZip</span> <span class="o">=</span> <span class="n">configurations</span><span class="o">.</span><span class="na">archives</span><span class="o">.</span><span class="na">find</span> <span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">name</span> <span class="o">==~</span> <span class="s">/wildfly.*/</span> <span class="o">}</span>

    <span class="n">from</span> <span class="nf">zipTree</span><span class="o">(</span><span class="n">wildflyZip</span><span class="o">)</span>
    <span class="n">into</span> <span class="n">buildDir</span>

    <span class="n">inputs</span><span class="o">.</span><span class="na">file</span> <span class="n">wildflyZip</span>
    <span class="n">outputs</span><span class="o">.</span><span class="na">upToDateWhen</span> <span class="o">{</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">buildDir</span><span class="o">,</span> <span class="s2">"wildfly-$wildflyVersion"</span><span class="o">).</span><span class="na">exists</span><span class="o">()</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>既にunzipされたWildflyがあったらタスクをスキップしてほしいので
<span class="docutils literal"><span class="pre">inputs.file</span></span> と <span class="docutils literal"><span class="pre">outputs.upToDateWhen</span></span> でこちょこちょやっています。</p>
<ul class="simple">
<li>参考： <a class="reference external" href="http://siosio.hatenablog.com/entry/2014/08/31/002105">Gradleで変更がない場合にタスク実行をスキップする方法 - しおしお(´・ω・｀)</a></li>
</ul>
<p>最後にテストを実行する前にreadyWildflyタスクを実行するようにします。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">test</span><span class="o">.</span><span class="na">dependsOn</span> <span class="n">readyWildfly</span>
</pre></div>
</div>
<p>あとは <span class="docutils literal"><span class="pre">gradlew</span> <span class="pre">build</span></span> するだけ。</p>
<p>ログはこんな感じ。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>:compileJava
:processResources UP-TO-DATE
:classes
:war
:assemble
:readyWildfly
:compileTestJava
:processTestResources
:testClasses
:test
:check
:build

BUILD SUCCESSFUL

Total time: 31.107 secs

This build could be faster, please consider using the Gradle Daemon: http://gradle.org/docs/2.4/userguide/gradle_daemon.html
</pre></div>
</div>
<p>testの前にreadyWildflyタスクが実行されていますね。
この時点で所定の場所へWildflyがunzipされています。</p>
<p>ではもう一度 <span class="docutils literal"><span class="pre">gradlew</span> <span class="pre">build</span></span> してみましょう。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>:compileJava UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:war UP-TO-DATE
:assemble UP-TO-DATE
:readyWildfly
:compileTestJava UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build UP-TO-DATE

BUILD SUCCESSFUL

Total time: 10.617 secs

This build could be faster, please consider using the Gradle Daemon: http://gradle.org/docs/2.4/userguide/gradle_daemon.html
</pre></div>
</div>
<p>なんということでしょう！
readyWildflyタスクがスキップされま……されてない！？</p>
<p>あれー？？？(´･_･`)</p>
<p>も、もう一度実行だ！</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>:compileJava UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:war UP-TO-DATE
:assemble UP-TO-DATE
:readyWildfly UP-TO-DATE
:compileTestJava UP-TO-DATE
:processTestResources UP-TO-DATE
:testClasses UP-TO-DATE
:test UP-TO-DATE
:check UP-TO-DATE
:build UP-TO-DATE

BUILD SUCCESSFUL

Total time: 8.532 secs

This build could be faster, please consider using the Gradle Daemon: http://gradle.org/docs/2.4/userguide/gradle_daemon.html
</pre></div>
</div>
<p>なぜスキップされたし(・_・)</p>
<p>というわけで、なんかあと一歩で出来てない感がありますが、一番の目的である
「自動でWildflyの準備してArquillian走らせる」ってのは出来たので一旦これで良いやー。</p>
<ul class="simple">
<li>コード：<a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/jaxrs-async-sample">https://github.com/backpaper0/sandbox/tree/master/jaxrs-async-sample</a></li>
</ul>
]]></description>
             <pubDate>Fri, 29 May 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/03/28/doma_listener_from_config.html</link>
            <guid>https://backpaper0.github.io/2015/03/28/doma_listener_from_config.html</guid>
            <title><![CDATA[Doma 2.2.0からEntityListenerをDIコンテナから取得できるようになった #doma2]]></title>
            <description><![CDATA[<h1>Doma 2.2.0からEntityListenerをDIコンテナから取得できるようになった #doma2</h1>
<p>Doma 2.1.0までは <span class="docutils literal"><span class="pre">EntityType</span></span> 実装クラス(コンパイル時に自動生成されるクラス)のコンストラクタ内で単純にインスタンス化されていましたが、
Doma 2.2.0からは <span class="docutils literal"><span class="pre">Config</span></span> に <span class="docutils literal"><span class="pre">getEntityListenerProvider</span></span> というメソッドが追加され、
そのメソッドが返す <span class="docutils literal"><span class="pre">EntityListenerProvider</span></span> をカスタマイズすることで
<span class="docutils literal"><span class="pre">EntityListener</span></span> のインスタンス取得をフックできるようになりました。</p>
<p><span class="docutils literal"><span class="pre">EntityListenerProvider</span></span> は <span class="docutils literal"><span class="pre">EntityListener</span></span> のインスタンスを取得する <span class="docutils literal"><span class="pre">get</span></span>
メソッドを持っています。
<span class="docutils literal"><span class="pre">EntityListenerProvider.get</span></span> メソッドのデフォルト実装は次のようになっています。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">default</span> <span class="o">&lt;</span><span class="n">ENTITY</span><span class="p">,</span> <span class="n">LISTENER</span> <span class="kd">extends</span> <span class="n">EntityListener</span><span class="o">&lt;</span><span class="n">ENTITY</span><span class="o">&gt;&gt;</span> <span class="n">LISTENER</span> <span class="nf">get</span><span class="p">(</span>
        <span class="n">Class</span><span class="o">&lt;</span><span class="n">LISTENER</span><span class="o">&gt;</span> <span class="n">listenerClass</span><span class="p">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">LISTENER</span><span class="o">&gt;</span> <span class="n">listenerSupplier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">listenerSupplier</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ご覧のように単純に <span class="docutils literal"><span class="pre">Supplier.get</span></span> メソッドを実行しているだけです。</p>
<p>この <span class="docutils literal"><span class="pre">EntityListenerProvider.get</span></span> メソッドをオーバーライドしてDIコンテナから <span class="docutils literal"><span class="pre">EntityListener</span></span>
のインスタンスを取得する例を書きます。
この例ではGuiceを使用しており <span class="docutils literal"><span class="pre">Config</span></span> 実装クラスと <span class="docutils literal"><span class="pre">EntityListenerProvider</span></span>
実装クラスもGuiceで管理しています。</p>
<p>まずは <span class="docutils literal"><span class="pre">EntityListenerProvider</span></span> 実装クラス。
Guiceの <span class="docutils literal"><span class="pre">Injector</span></span> をインジェクションしてそこから <span class="docutils literal"><span class="pre">EntityListener</span></span> のインスタンスを取得しています。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">sample</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Supplier</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.seasar.doma.jdbc.EntityListenerProvider</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.seasar.doma.jdbc.entity.EntityListener</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.google.inject.Injector</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleEntityListenerProvider</span> <span class="kd">implements</span> <span class="n">EntityListenerProvider</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Injector</span> <span class="n">injector</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">ENTITY</span><span class="p">,</span> <span class="n">LISTENER</span> <span class="kd">extends</span> <span class="n">EntityListener</span><span class="o">&lt;</span><span class="n">ENTITY</span><span class="o">&gt;&gt;</span> <span class="n">LISTENER</span> <span class="nf">get</span><span class="p">(</span>
            <span class="n">Class</span><span class="o">&lt;</span><span class="n">LISTENER</span><span class="o">&gt;</span> <span class="n">listenerClass</span><span class="p">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">LISTENER</span><span class="o">&gt;</span> <span class="n">listenerSupplier</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">listenerClass</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>次に <span class="docutils literal"><span class="pre">Config</span></span> 実装クラス。
<span class="docutils literal"><span class="pre">EntityListenerProvider</span></span> をインジェクションしてそのまま返しているだけです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">sample</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.seasar.doma.jdbc.Config</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.seasar.doma.jdbc.EntityListenerProvider</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.seasar.doma.jdbc.dialect.Dialect</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleConfig</span> <span class="kd">implements</span> <span class="n">Config</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">EntityListenerProvider</span> <span class="n">entityListenerProvider</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">dataSource</span><span class="p">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Dialect</span> <span class="n">dialect</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">EntityListenerProvider</span> <span class="nf">getEntityListenerProvider</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">entityListenerProvider</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">getDataSource</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dataSource</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Dialect</span> <span class="nf">getDialect</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dialect</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Guice以外のDIコンテナでも似たような方法を取れるでしょう。
例えばCDIだと <span class="docutils literal"><span class="pre">Injector</span></span> ではなく <span class="docutils literal"><span class="pre">BeanManager</span></span> をインジェクションして
<span class="docutils literal"><span class="pre">BeanManager</span></span> から <span class="docutils literal"><span class="pre">EntityListener</span></span> 実装クラスのインスタンスをルックアップすると良いと思います。
(CDI 1.1以降であれば <span class="docutils literal"><span class="pre">CDI.current().select(listenerClass)</span></span> でも良いと思います)</p>
<p><span class="docutils literal"><span class="pre">EntityListener</span></span> をDIコンテナから取得できるようになると色々とインジェクションできるのも嬉しいですし、
インターセプターをかますことも出来たりしてさらに嬉しいですね！！！</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/doma-listener-from-dicontainer-sample">Config.getEntityListenerProviderのサンプルコード</a></li>
</ul>
]]></description>
             <pubDate>Sat, 28 Mar 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/03/09/jersey_hk2_aop.html</link>
            <guid>https://backpaper0.github.io/2015/03/09/jersey_hk2_aop.html</guid>
            <title><![CDATA[Jerseyでリソースメソッドをトランザクション境界にする]]></title>
            <description><![CDATA[<h1>Jerseyでリソースメソッドをトランザクション境界にする</h1>
<p>ちょろっと話題に出たので簡単にまとめました。</p>
<div class="section" id="id1">
<h2>やりたいこと</h2>
<p>リソースメソッドをトランザクション境界にしたい。</p>
</div>
<div class="section" id="id2">
<h2>話題に出た方法</h2>
<p><a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/ws/rs/container/ContainerRequestFilter.html">ContainerRequestFilter</a>
や
<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/ws/rs/container/ContainerResponseFilter.html">ContainerResponseFilter</a>
を使って実現できないかなー、という話が出ましたが私は無理だと思っています。</p>
<p>ContainerRequestFilter
はリソースメソッドの前に実行されるだけ、
ContainerResponseFilter
はリソースメソッドの後に実行されるだけで
try-catch-finally
ができないからです。</p>
</div>
<div class="section" id="id3">
<h2>パッと思いつく方法</h2>
<p>GlasFishなどJava EE 7準拠のアプリケーションサーバで動かすのであればリソースクラスを
CDI管理ビーンにして
<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/transaction/Transactional.html">@Transactional</a>
で注釈すればそれだけでリソースメソッドがトランザクション境界になります。</p>
</div>
<div class="section" id="tomcat-jersey">
<h2>Tomcat + Jerseyぐらいの構成で実現する方法</h2>
<p>CDI使ってない、っていうかTomcatで動かしてる、つーかDIコンテナ使ってない！！！という場合はどうすれば良いのか？</p>
<p>Jerseyは内部的に <a class="reference external" href="https://hk2.java.net/">HK2</a> というDIコンテナを使っています。
このHK2のAOP機能を利用してリソースクラスにインテーセプターを適用して
リソースメソッドをトランザクション境界にする方法が取れます。</p>
<p>ザクッとサンプル書いてみたので詳細はコードを読んでください。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/jersey-interceptor-sample">https://github.com/backpaper0/jersey-interceptor-sample</a></li>
</ul>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<ul class="simple">
<li>JAX-RSの仕様ではサーブレットフィルタのような try-catch-finally ができるポイントが無い</li>
<li>CDIを併用すれば何とでもなる</li>
<li>Jerseyなら実装に依存するけどHK2を使うことで何とかなる</li>
</ul>
</div>
]]></description>
             <pubDate>Mon, 09 Mar 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/03/08/spring_boot_camp.html</link>
            <guid>https://backpaper0.github.io/2015/03/08/spring_boot_camp.html</guid>
            <title><![CDATA[Spring Bootキャンプをやった #kanjava_sbc]]></title>
            <description><![CDATA[<h1>Spring Bootキャンプをやった #kanjava_sbc</h1>
<p><a class="reference external" href="https://twitter.com/making">@making</a> さんを講師にお迎えしてSpring Bootを土台にしてプログラミングを楽しむハンズオンを開催しました。</p>
<ul class="simple">
<li><a class="reference external" href="http://kanjava.connpass.com/event/11579/">【脱初心者】Spring Bootキャンプ【ハンズオン】 - connpass</a></li>
<li><a class="reference external" href="http://spring-boot-camp.readthedocs.org/ja/latest/index.html">Spring Bootキャンプ ハンズオン資料</a></li>
<li><a class="reference external" href="http://bit.ly/hajiboot">はじめてのSpring Boot</a></li>
</ul>
<p>会場は楽天株式会社大阪支社のカフェテリアをお借り致しました。
<a class="reference external" href="https://twitter.com/bufferings">@bufferings</a> さん、ご協力ありがとうございました。</p>
<p>今回のハンズオンではカメラで撮った写真をSpring MVCに投げてOpenCVで画像変換をしました。
変換部分はJMSで非同期処理しクライアントとサーバー間はSTOMPというプロトコルをWebSocket上で利用して通信しました。</p>
<p><strong>Spring Bootの関係無さ感すごい！！！</strong></p>
<p>しかし、このように色々な技術を使ったWebサービスのハンズオンを特にややこしい設定もせず
約2時間半で進める事ができたのはいろいろと自動で設定を宜しくやってくれるSpring Bootがあってこそだと思いました。</p>
<p>楽しいハンズオンを行って頂いて@makingさんには本当に感謝です！！！</p>
<div class="figure">
<img alt="ハンズオンの様子" src="https://backpaper0.github.io/_images/spring-boot-camp.jpg"/>
</div>
<div class="section" id="id2">
<h2>ちなみに</h2>
<p>東京でも開催されるっぽいですよ！</p>
<blockquote class="twitter-tweet" lang="ja"><p>あ、Spring Bootキャンプ、3/25に東京でもやります。イベントページまだか・・・</p>— Toshiaki Maki (@making) <a href="https://twitter.com/making/status/574104291717177344">2015, 3月 7</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script></div>
<div class="section" id="id3">
<h2>おまけ</h2>
<p>Spring Boot + Jersey。
懇親会で話題に出たやつです。
前にちょこっとやりました。</p>
<ul class="simple">
<li><a class="reference internal" href="https://backpaper0.github.io/2015/01/14/spring_boot_jersey.html"><span class="doc">Spring BootのサンプルをJAX-RSにしてみた</span></a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 08 Mar 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/03/05/io.html</link>
            <guid>https://backpaper0.github.io/2015/03/05/io.html</guid>
            <title><![CDATA[Reader/Writer/InputStream/OutputStream]]></title>
            <description><![CDATA[<h1>Reader/Writer/InputStream/OutputStream</h1>
<p>少し話題に出たのでファイル読み書きなどでよく使う感じのアレをアレしたいと思います。</p>
<p>まず、</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">InputStream</span></span> / <span class="docutils literal"><span class="pre">OutputStream</span></span> はバイナリデータのストリームです。
<span class="docutils literal"><span class="pre">byte[]</span></span> で読み書きします。</li>
<li><span class="docutils literal"><span class="pre">Reader</span></span> / <span class="docutils literal"><span class="pre">Writer</span></span> はテキストデータのストリームです。
<span class="docutils literal"><span class="pre">char[]</span></span> で読み書きします。</li>
<li>ストリームというのは <span class="docutils literal"><span class="pre">byte[]</span></span> や <span class="docutils literal"><span class="pre">char[]</span></span> を使って少しずつデータを読み込んだり書き出したりするためのものです。</li>
</ul>
<p>というのが基本になります。</p>
<div class="section" id="id1">
<h2>ファイルの読み書き</h2>
<div class="section" id="id2">
<h3>テキストファイルを読み込む</h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">"path/to/file"</span><span class="p">);</span>
<span class="k">try</span> <span class="p">(</span><span class="n">BufferedReader</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">newBufferedReader</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//読み込み処理</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ファイルはUTF-8で読み込まれます。</p>
<p>UTF-8以外のファイルを読み込む場合は第二引数に <span class="docutils literal"><span class="pre">Charset</span></span> を渡します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">(</span><span class="n">BufferedReader</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">newBufferedReader</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">Charset</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">"Windows-31J"</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">line</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="na">readLine</span><span class="p">()))</span> <span class="p">{</span>
        <span class="c1">//読み込み処理</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>バイナリファイルを読み込む</h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">(</span><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="p">(</span><span class="n">Files</span><span class="p">.</span><span class="na">newInputStream</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span> <span class="p">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1000</span><span class="o">]</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span> <span class="p">{</span>
        <span class="c1">//読み込み処理</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">Files.newInputStream</span></span> はバッファリングされないので巨大なファイルやたくさんファイルを扱う処理だと遅いと思います。
基本的には <span class="docutils literal"><span class="pre">BufferedInputStream</span></span> でラップする方が良いかとー。</p>
</div>
<div class="section" id="id4">
<h3>テキストファイルを書き出す</h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">(</span><span class="n">BufferedWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">newBufferedWriter</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//書き出し処理</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>バイナリファイルを書き出す</h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">(</span><span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedOutputStream</span><span class="p">(</span><span class="n">Files</span><span class="p">.</span><span class="na">newOutputStream</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span> <span class="p">{</span>
    <span class="c1">//書き出し処理</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">Files.newInputStream</span></span> と同じく <span class="docutils literal"><span class="pre">Files.newOutputStream</span></span> もバッファリングされません。</p>
</div>
</div>
<div class="section" id="id6">
<h2>オンメモリで扱う</h2>
<p><span class="docutils literal"><span class="pre">Writer</span></span> を渡したらそこにもろもろ書き出してくれるライブラリがあるんだけど
わざわざファイルに書き出すんじゃなくてオンメモリで処理して <span class="docutils literal"><span class="pre">String</span></span> で結果を取りたいんや！
というような場合には <span class="docutils literal"><span class="pre">StringWriter</span></span> を使います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">StringWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="p">();</span>
<span class="n">library</span><span class="p">.</span><span class="na">writeTo</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">Reader</span></span> / <span class="docutils literal"><span class="pre">InputStream</span></span> / <span class="docutils literal"><span class="pre">OutputStream</span></span> にもそれぞれオンメモリで使用するためのクラスがあります。</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">StringReader</span></span> は <span class="docutils literal"><span class="pre">String</span></span> を読み込める <span class="docutils literal"><span class="pre">Reader</span></span></li>
<li><span class="docutils literal"><span class="pre">StringWriter</span></span> は <span class="docutils literal"><span class="pre">String</span></span> へ書き出せる <span class="docutils literal"><span class="pre">Writer</span></span></li>
<li><span class="docutils literal"><span class="pre">ByteArrayInputStream</span></span> は <span class="docutils literal"><span class="pre">byte[]</span></span> を読み込める <span class="docutils literal"><span class="pre">InputStream</span></span></li>
<li><span class="docutils literal"><span class="pre">ByteArrayOutputStream</span></span> は <span class="docutils literal"><span class="pre">byte[]</span></span> へ書き出せる <span class="docutils literal"><span class="pre">OutputStream</span></span></li>
</ul>
</div>
<div class="section" id="inputstreamreader-outputstreamwriter">
<h2>InputStreamをReaderへ/OutputStreamをWriterへ変換する</h2>
<p>それぞれ <span class="docutils literal"><span class="pre">InputStreamReader</span></span> と <span class="docutils literal"><span class="pre">OutputStreamWriter</span></span> を使って変換できます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>

<span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span>
</pre></div>
</div>
<p>第二引数に <span class="docutils literal"><span class="pre">Charset</span></span> を渡していますが、何も渡さない場合はデフォルトエンコーディングが使用されるので注意が必要です。
デフォルトエンコーディングとはシステムプロパティ <span class="docutils literal"><span class="pre">file.encoding</span></span> で取得できるものです。
変更したい場合は次のようにJava起動時にオプションを設定します。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>java -Dfile.encoding<span class="o">=</span>UTF-8 com.example.MainClass
</pre></div>
</div>
</div>
<div class="section" id="zip">
<h2>ZIPファイルを読み込む/書き出す</h2>
<p>ZIPファイルの読み書きには <span class="docutils literal"><span class="pre">ZipInputStream</span></span> と <span class="docutils literal"><span class="pre">ZipOutputStream</span></span> が使えます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="p">...</span>
<span class="k">try</span><span class="p">(</span><span class="n">ZipInputStream</span> <span class="n">zin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZipInputStream</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ZipEntry</span> <span class="n">zipEntry</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="p">(</span><span class="n">zipEntry</span> <span class="o">=</span> <span class="n">zin</span><span class="p">.</span><span class="na">getNextEntry</span><span class="p">()))</span> <span class="p">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1000</span><span class="o">]</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">zin</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span> <span class="p">{</span>
            <span class="c1">//読み込み処理</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="p">...</span>
<span class="k">try</span><span class="p">(</span><span class="n">ZipOutputStream</span> <span class="n">zout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZipOutputStream</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ZipEntry</span> <span class="n">zipEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZipEntry</span><span class="p">(</span><span class="s">"hoge.txt"</span><span class="p">);</span>
    <span class="n">zout</span><span class="p">.</span><span class="na">putNextEntry</span><span class="p">(</span><span class="n">zipEntry</span><span class="p">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="p">...</span>
    <span class="n">zout</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">zout</span><span class="p">.</span><span class="na">closeEntry</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>ファイルのコピー、移動をする</h2>
<p><span class="docutils literal"><span class="pre">Files</span></span> を使います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Path</span> <span class="n">src</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">Path</span> <span class="n">dest</span> <span class="o">=</span> <span class="p">...</span>

<span class="n">Files</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

<span class="n">Files</span><span class="p">.</span><span class="na">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="channel">
<h2>Channel</h2>
<p><span class="docutils literal"><span class="pre">Reader</span></span> / <span class="docutils literal"><span class="pre">Writer</span></span> / <span class="docutils literal"><span class="pre">InputStream</span></span> / <span class="docutils literal"><span class="pre">OutputStream</span></span>
の他に <span class="docutils literal"><span class="pre">Channel</span></span> というものもありますが <span class="docutils literal"><span class="pre">Channel</span></span> が必要になるライブラリには
ほぼ出会った事がないので覚えなくても生きて行けると思います。</p>
</div>
<div class="section" id="id8">
<h2>おまけ</h2>
<p>テキストファイルの読み込みには <span class="docutils literal"><span class="pre">Files.newBufferedReader</span></span> を使うと書きましたが
Java 6までは <span class="docutils literal"><span class="pre">FileReader</span></span> を使って次のようにファイル読み込みをしていました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">"path/to/file"</span><span class="p">);</span>
<span class="n">Reader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileReader</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="c1">//読み込み処理</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="n">in</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">Charset</span></span> を渡さずに <span class="docutils literal"><span class="pre">FileReader</span></span> をインスタンス化していますが、
この場合はデフォルトエンコーディングが使われていました。</p>
<p>しかも <span class="docutils literal"><span class="pre">FileReader</span></span> には <span class="docutils literal"><span class="pre">Charset</span></span> を受け取るコンストラクタは用意されていません。
ではデフォルトエンコーディング以外でファイルを読み込みたい場合はどうするのか？</p>
<p>その場合は、</p>
<ol class="arabic simple">
<li><span class="docutils literal"><span class="pre">FileInputStream</span></span> でファイルを開いて</li>
<li><span class="docutils literal"><span class="pre">InputStreamReader</span></span> で <span class="docutils literal"><span class="pre">Charset</span></span> を指定しつつラップする</li>
</ol>
<p>という方法をとっていました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">"path/to/file"</span><span class="p">);</span>
<span class="n">Reader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">Charset</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">"iso-2022-jp"</span><span class="p">));</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="c1">//読み込み処理</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="n">in</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>そういう訳で <span class="docutils literal"><span class="pre">java.io</span></span> で <span class="docutils literal"><span class="pre">Charset</span></span> を受け取らない場合はデフォルトエンコーディング、
<span class="docutils literal"><span class="pre">java.nio.file</span></span> で <span class="docutils literal"><span class="pre">Charset</span></span> を受け取らない場合はUTF-8が使われる、という感じです。</p>
<p>デフォルトエンコーディングは環境によって変わるので <span class="docutils literal"><span class="pre">java.nio.file</span></span> を使っておくのが安全だと思います。</p>
</div>
]]></description>
             <pubDate>Thu, 05 Mar 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/02/28/junit_4_12_test_rule.html</link>
            <guid>https://backpaper0.github.io/2015/02/28/junit_4_12_test_rule.html</guid>
            <title><![CDATA[JUnit 4.12から入ったTestRuleを軽く見てみる]]></title>
            <description><![CDATA[<h1>JUnit 4.12から入ったTestRuleを軽く見てみる</h1>
<div class="section" id="disableondebug">
<h2>DisableOnDebug</h2>
<p><span class="docutils literal"><span class="pre">DisableOnDebug</span></span> 他の <span class="docutils literal"><span class="pre">TestRule</span></span> をラップして、
デバッグ実行されているときのみラップした <span class="docutils literal"><span class="pre">TestRule</span></span> を適用します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">org.junit.Rule</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.rules.DisableOnDebug</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.rules.TestRule</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.rules.Timeout</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HogeTest</span> <span class="p">{</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">TestRule</span> <span class="n">timeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisableOnDebug</span><span class="p">(</span><span class="n">Timeout</span><span class="p">.</span><span class="na">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span> <span class="c1">//1秒以上かかったら失敗とみなす</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testHoge</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//test code</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>こんな感じで <span class="docutils literal"><span class="pre">Timeout</span></span> と組み合わせる事が多い気がします。</p>
<p>コマンドライン引数に次のいずれかが含まれていればデバッグ実行されていると判断するようです。</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">-Xdebug</span></span></li>
<li><span class="docutils literal"><span class="pre">-agentlib:jdwp</span></span></li>
</ul>
<p>デバッグ実行かどうかの判断は <span class="docutils literal"><span class="pre">DisableOnDebug.isDebugging</span></span> メソッドをオーバーライドすればカスタマイズできます。</p>
</div>
<div class="section" id="stopwatch">
<h2>Stopwatch</h2>
<p><span class="docutils literal"><span class="pre">Stopwatch</span></span> はテスト実行にかかった時間を <span class="docutils literal"><span class="pre">System.nanoTime</span></span> メソッドで計測します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Rule</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.rules.Stopwatch</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.Description</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FugaTest</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">FugaTest</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">Stopwatch</span> <span class="n">stopwatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Stopwatch</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">succeeded</span><span class="p">(</span><span class="kt">long</span> <span class="n">nanos</span><span class="p">,</span> <span class="n">Description</span> <span class="n">description</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"テストの実行に%,dナノ秒かかった"</span><span class="p">,</span> <span class="n">nanos</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//test code</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ロギング目的に使うのが多そうです。</p>
</div>
]]></description>
             <pubDate>Sat, 28 Feb 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/24/git_rebase_merge.html</link>
            <guid>https://backpaper0.github.io/2015/01/24/git_rebase_merge.html</guid>
            <title><![CDATA[Gitでブランチを統合する方法]]></title>
            <description><![CDATA[<h1>Gitでブランチを統合する方法</h1>
<p>こういうコミットを重ねたブランチを、</p>
<img alt="../../../_images/git_rebase_merge_1.png" src="https://backpaper0.github.io/_images/git_rebase_merge_1.png"/>
<p>どういう方法でmasterに統合すると嬉しい派なのか？っていう小ネタです。</p>
<div class="section" id="id1">
<h2>マージする</h2>
<img alt="../../../_images/git_rebase_merge_2.png" src="https://backpaper0.github.io/_images/git_rebase_merge_2.png"/>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>git checkout master
git merge other -m <span class="s2">"Merge branch 'other'"</span>
git branch -d other
</pre></div>
</div>
<p>操作が分かりやすい感じがする。</p>
</div>
<div class="section" id="id2">
<h2>リベースする</h2>
<img alt="../../../_images/git_rebase_merge_3.png" src="https://backpaper0.github.io/_images/git_rebase_merge_3.png"/>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>git checkout master
git rebase master other
git checkout master
git merge other
git branch -d other
</pre></div>
</div>
<p>コミットが一本化する。</p>
</div>
<div class="section" id="id3">
<h2>リベースしてからマージする</h2>
<img alt="../../../_images/git_rebase_merge_4.png" src="https://backpaper0.github.io/_images/git_rebase_merge_4.png"/>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>git checkout master
git rebase master other
git checkout master
git merge other --no-ff -m <span class="s2">"Merge branch 'other'"</span>
git branch -d other
</pre></div>
</div>
<p>コミットが一本化しつつブランチ単位の作業を把握しやすい。</p>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<p>私はリベースしてからマージする派！</p>
<div class="section" id="id5">
<h3>おまけ</h3>
<p>最初に提示したコミットを作るスクリプト。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/><span class="ch">#!/bin/sh</span>
rm -fr .git *.txt .gitignore
git init
<span class="nb">echo</span> init.sh&gt;.gitignore <span class="o">&amp;&amp;</span> git add .gitignore <span class="o">&amp;&amp;</span> git commit -m <span class="s2">"Initial Commit"</span>
<span class="nb">echo</span> b&gt;b.txt <span class="o">&amp;&amp;</span> git add b.txt <span class="o">&amp;&amp;</span> git commit -m <span class="s2">"master 1"</span>
git branch other
<span class="nb">echo</span> c&gt;c.txt <span class="o">&amp;&amp;</span> git add c.txt <span class="o">&amp;&amp;</span> git commit -m <span class="s2">"master 2"</span>
<span class="nb">echo</span> d&gt;d.txt <span class="o">&amp;&amp;</span> git add d.txt <span class="o">&amp;&amp;</span> git commit -m <span class="s2">"master 3"</span>
git checkout other
<span class="nb">echo</span> e&gt;e.txt <span class="o">&amp;&amp;</span> git add e.txt <span class="o">&amp;&amp;</span> git commit -m <span class="s2">"other 1"</span>
<span class="nb">echo</span> f&gt;f.txt <span class="o">&amp;&amp;</span> git add f.txt <span class="o">&amp;&amp;</span> git commit -m <span class="s2">"other 2"</span>
git checkout master
</pre></div>
</div>
</div>
</div>
]]></description>
             <pubDate>Sat, 24 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/18/getting_started_libgdx.html</link>
            <guid>https://backpaper0.github.io/2015/01/18/getting_started_libgdx.html</guid>
            <title><![CDATA[libGDXプロジェクトをセットアップする #libgdx]]></title>
            <description><![CDATA[<h1>libGDXプロジェクトをセットアップする #libgdx</h1>
<p>libGDXはJavaのゲームフレームワークで、デスクトップ・Android・iOS・HTML5用にビルドできるフレームワークです。
どのプラットフォームであっても起動用のクラス以外のほとんどのコードを共有できるすごいやつです。</p>
<ul class="simple">
<li><a class="reference external" href="http://libgdx.badlogicgames.com/">libGDX</a></li>
<li><a class="reference external" href="https://github.com/libgdx/libgdx/wiki">GitHubでホスティングされているlibGDXのWiki</a></li>
</ul>
<p>今回はlibGDXを使ったプロジェクトのセットアップ方法を書いていこうと思います。</p>
<div class="section" id="id1">
<h2>セットアップツールによるプロジェクトの生成</h2>
<p><a class="reference external" href="http://libgdx.badlogicgames.com/download.html">ダウンロードページ</a>
で “Download Setup App” をクリックして gdx-seup.jar をダウンロードしてください。</p>
<p>ダウンロードできたらダブルクリック、もしくは次のコマンドで実行してください。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>java -jar gdx-setup.jar
</pre></div>
</div>
<img alt="../../../_images/gdx-setup-screenshot.png" src="https://backpaper0.github.io/_images/gdx-setup-screenshot.png"/>
<p>各項目を編集します。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%"/>
<col width="80%"/>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Name</td>
<td>プロジェクトの名前。Androidプロジェクトはres/values/string.xmlのapp_nameにも使用される。</td>
</tr>
<tr class="row-even"><td>Package</td>
<td>出力されるサンプルコードのパッケージ。AndroidManifest.xmlに書かれるpackageにも使用される。</td>
</tr>
<tr class="row-odd"><td>Game class</td>
<td><a class="reference external" href="http://libgdx.badlogicgames.com/nightlies/docs/api/com/badlogic/gdx/ApplicationListener.html">ApplicationListener</a>
実装クラス。libGDXにおける起点となるクラス。</td>
</tr>
<tr class="row-even"><td>Destination</td>
<td>プロジェクトの出力先ディレクトリ。</td>
</tr>
<tr class="row-odd"><td>Android SDK</td>
<td>Android SDKのパス。Android用のビルドをする場合に必要。</td>
</tr>
</tbody>
</table>
<p>“LibGDX Version” は最新のものが選択されているはずなので、そのままで。</p>
<p>“Sub Projects” はすべてチェックされていると思います。
不要になればその時点で取り除けば良いし個別にビルドもできるので、これもそのままで。</p>
<p>“Extensions” は “Box2d” のみがチェックされていると思います。
ここについては詳しい解説が出来るほどの知識がありません。
誰か教えてください！
これもそのままでいきましょう。</p>
<p>以上の状態で “Generate” を押してください。</p>
<p>初回はGradleや依存JARのダウンロードが行われるので時間がかかります。
お茶でも飲んでお待ちください。</p>
<p>次のようなログが出ると完了です。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>BUILD SUCCESSFUL

Total time: 42.551 secs
Done!
To import in Eclipse: File -&gt; Import -&gt; Gradle -&gt; Gradle Project
To import to Intellij IDEA: File -&gt; Import -&gt; build.gradle
To import to NetBeans: File -&gt; Open Project...
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">プロジェクトのビルドには <a class="reference external" href="https://www.gradle.org/">Gradle</a>
( <a class="reference external" href="http://gradle.monochromeroad.com/docs/">日本語ドキュメント</a> )が使われていますが、
gdx-setup.jarが設定済みのbuild.gradleを出力してくれるのでGradleに詳しくなくても大丈夫です。</p>
</div>
</div>
<div class="section" id="git">
<h2>寄り道：Gitでバージョン管理を始める</h2>
<p>今後の事を考えてGitでのバージョン管理を始めておきましょう。</p>
<p>セットアップツールが .gitignore も出力してくれているのでややこしいことは何も考えずにバージョン管理を始められます。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>git init
git add .
git commit -m <span class="s2">"Initial commit"</span>
</pre></div>
</div>
</div>
<div class="section" id="eclipse">
<h2>Eclipseへのインポート</h2>
<p>セットアップのログを見た感じだとEclipseにGradleプラグインが入っているとそのままインポート出来そうですね。</p>
<p>私はGradleプラグインが入っていないEclipseを使っているので、その場合のインポート方法を書きます。</p>
<p>まずGradleでコマンドを実行します。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>gradlew eclipse
</pre></div>
</div>
<p>次にEclipseのメニューから
<span class="menuselection">File ‣ Import ‣ General ‣ Existing Projects into Workspace</span>
を選択します。
それから “Select root directory” にプロジェクトのパスを入力してください。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>プロジェクトのパスをコピーするときはMacなら次のコマンドを使うとクリップボードに格納されて便利です。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>pwd<span class="p">|</span>pbcopy
</pre></div>
</div>
<p>Windowsなら次のコマンドで同じ事ができます。</p>
<div class="last highlight-bat notranslate"><div class="highlight"><pre><span/><span class="k">cd</span><span class="p">|</span>clip
</pre></div>
</div>
</div>
<p>インポートするプロジェクトは code と desktop だけで良いでしょう。
基本的にはデスクトップで開発してたまに実機確認という感じで進められると思います。</p>
<p>インポートできたら（これが面倒なのですが）desktopプロジェクトにあるassetsディレクトリをクラスパスに加えてください。</p>
<p>手っ取り早い方法はassetsディレクトリで右クリックして
<span class="menuselection">Build Path ‣ Use as Source Folder</span>
です。</p>
<p>もしくは、プロジェクトのプロパティを開いて
<span class="menuselection">Java Build Path ‣ Libraries</span>
と辿って “Add Class Folder” を押してassetsディレクトリを指定してください。</p>
</div>
<div class="section" id="intellij-idea">
<h2>IntelliJ IDEAへのインポート</h2>
<p>私はIntelliJ IDEA分からんのですが、セットアップのログに書かれているように
<span class="menuselection">File ‣ Import ‣ build.gradle</span>
をやってみたところインポートできたっぽいです。</p>
</div>
<div class="section" id="id4">
<h2>実行する</h2>
<p>desktopプロジェクトの <span class="docutils literal"><span class="pre">src/main/java/yourpackage/DesktopLauncher.java</span></span> を実行してください。
( <span class="docutils literal"><span class="pre">yourpackage</span></span> はセットアップ時に設定したパッケージです。
適宜読み替えてください。)</p>
</div>
<div class="section" id="id5">
<h2>結び</h2>
<p>というわけでlibGDXプロジェクトのセットアップ方法を記載してみました。</p>
<p>libGDXはAndroidアプリであってもデスクトップ中心で開発でき、
コードの殆どを共有できるのがすごくて嬉しくてお気に入りです。</p>
<p>願わくばもっともっとlibGDXユーザーが増えますように！</p>
</div>
]]></description>
             <pubDate>Sun, 18 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/17/spring_boot_jsr330.html</link>
            <guid>https://backpaper0.github.io/2015/01/17/spring_boot_jsr330.html</guid>
            <title><![CDATA[Spring Bootのサンプルで使ってるアノテーションをJSR 330のものにした]]></title>
            <description><![CDATA[<h1>Spring Bootのサンプルで使ってるアノテーションをJSR 330のものにした</h1>
<p>最近Spring Bootで遊んでいます。</p>
<ul class="simple">
<li><a class="reference internal" href="https://backpaper0.github.io/2015/01/15/spring_boot_gradle.html"><span class="doc">Spring BootのサンプルをGradle化した、けども……</span></a></li>
<li><a class="reference internal" href="https://backpaper0.github.io/2015/01/14/spring_boot_jersey.html"><span class="doc">Spring BootのサンプルをJAX-RSにしてみた</span></a></li>
<li><a class="reference internal" href="https://backpaper0.github.io/2015/01/11/spring_boot.html"><span class="doc">Spring Bootをやってみた</span></a></li>
</ul>
<p>今回はSpringのアノテーションである
<a class="reference external" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/stereotype/Component.html">@Component</a>
と
<a class="reference external" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/Autowired.html">@Autowired</a>
をJSR 330のアノテーションである
<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/inject/Named.html">@Named</a>
と
<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/inject/Inject.html">@Inject</a>
に変更してみました。</p>
<p>ソースコードは <a class="reference external" href="https://github.com/backpaper0/spring_boot_sample">https://github.com/backpaper0/spring_boot_sample</a> です。</p>
<p>tagは <a class="reference external" href="https://github.com/backpaper0/spring_boot_sample/releases/tag/jsr330">https://github.com/backpaper0/spring_boot_sample/releases/tag/jsr330</a> です。</p>
<div class="section" id="id1">
<h2>本題</h2>
<p>特に書くことない。
普通に置き換えたら普通に動いたので。</p>
<p>ただしスコープのアノテーションはSpringのままです。
セッションスコープのクラスに付けたアノテーションを
<a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/enterprise/context/SessionScoped.html">@SessionScoped</a>
に変更したかったのですがJSR 330ではなくCDIのアノテーションのためどうしようもなかったというかなんというか。</p>
<p>まあいいか。</p>
</div>
<div class="section" id="id2">
<h2>まとめ</h2>
<p>JSR 330のアノテーションの方が見慣れていて個人的には良い。</p>
</div>
]]></description>
             <pubDate>Sat, 17 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/16/jersey2_15_cdi.html</link>
            <guid>https://backpaper0.github.io/2015/01/16/jersey2_15_cdi.html</guid>
            <title><![CDATA[Jersey 2.15のCDI統合を試す]]></title>
            <description><![CDATA[<h1>Jersey 2.15のCDI統合を試す</h1>
<p>Jersey 2.15でCDIとの統合機能が変更されたようです。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/jersey/jersey/releases/tag/2.15">https://github.com/jersey/jersey/releases/tag/2.15</a></li>
</ul>
<p>ざっくり読むと、これまではJava EEコンテナ(ていうかGlassFish？)との統合に注力してたけど
2.15からはJava EE環境じゃなくても統合できまっせ！という感じっぽいです。</p>
<div class="section" id="id1">
<h2>試した</h2>
<p>ハローワールドな、なんの役にも立たないWeb APIを作って試してみました。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/jersey2_15-cdi-example">https://github.com/backpaper0/sandbox/tree/master/jersey2_15-cdi-example</a></li>
</ul>
<p>メインクラスはこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">example</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.glassfish.jersey.jdkhttp.JdkHttpServerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.glassfish.jersey.server.ResourceConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.jboss.weld.environment.se.Weld</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpServer</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Weld</span> <span class="n">weld</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Weld</span><span class="p">();</span>
        <span class="n">weld</span><span class="p">.</span><span class="na">initialize</span><span class="p">();</span>
        <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">"http://localhost:8080/"</span><span class="p">);</span>
        <span class="n">ResourceConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceConfig</span><span class="p">(</span><span class="n">HelloResource</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">JdkHttpServerFactory</span><span class="p">.</span><span class="na">createHttpServer</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
        <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">addShutdownHook</span><span class="p">(</span><span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">server</span><span class="p">.</span><span class="na">stop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">weld</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
        <span class="p">}));</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"http://localhost:8080/hello?name=YourName"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ご覧の通りです。
普通にWeldを動かして、Jerseyを動かしてるだけです。
簡単です。</p>
<p>pom.xmlのdependencyはこんな感じ。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.ext.cdi<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jersey-weld2-se<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.ext.cdi<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jersey-cdi1x<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>所感</h2>
<p>私はJava EEは好きですがJava SEでも簡単に動くようになるのは嬉しいのでこの変更は嬉しいです！</p>
<p>アホっぽい感想ですが、まあそんな感じでー。</p>
</div>
]]></description>
             <pubDate>Fri, 16 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/15/spring_boot_gradle.html</link>
            <guid>https://backpaper0.github.io/2015/01/15/spring_boot_gradle.html</guid>
            <title><![CDATA[Spring BootのサンプルをGradle化した、けども……]]></title>
            <description><![CDATA[<h1>Spring BootのサンプルをGradle化した、けども……</h1>
<p>最近Spring Bootで遊んでいます。</p>
<ul class="simple">
<li><a class="reference internal" href="https://backpaper0.github.io/2015/01/14/spring_boot_jersey.html"><span class="doc">Spring BootのサンプルをJAX-RSにしてみた</span></a></li>
</ul>
<p>今回はMavenでビルドされているサンプルをGradle化しました。</p>
<p>ソースコードは <a class="reference external" href="https://github.com/backpaper0/spring_boot_sample">https://github.com/backpaper0/spring_boot_sample</a> です。</p>
<p>tagは <a class="reference external" href="https://github.com/backpaper0/spring_boot_sample/releases/tag/gradle">https://github.com/backpaper0/spring_boot_sample/releases/tag/gradle</a> です。</p>
<div class="section" id="id1">
<h2>本題</h2>
<p>まず、おもむろにgradle initしました。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>gradle init
</pre></div>
</div>
<p>すでにpom.xmlがあるので依存関係とか色々よろしくやってくれたbuild.gradleが出力されました。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'java'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'maven'</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'sample'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s1">'1.0-SNAPSHOT'</span>

<span class="n">description</span> <span class="o">=</span> <span class="s2">"""spring-boot-sample"""</span>

<span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="mf">1.8</span>
<span class="n">targetCompatibility</span> <span class="o">=</span> <span class="mf">1.8</span>



<span class="n">repositories</span> <span class="o">{</span>

     <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://repo.maven.apache.org/maven2"</span> <span class="o">}</span>
<span class="o">}</span>
<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="nl">group:</span> <span class="s1">'org.twitter4j'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'twitter4j-core'</span><span class="o">,</span> <span class="nl">version:</span><span class="s1">'4.0.2'</span>
    <span class="n">compile</span><span class="o">(</span><span class="nl">group:</span> <span class="s1">'org.springframework.boot'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'spring-boot-starter-jersey'</span><span class="o">,</span> <span class="nl">version:</span><span class="s1">'1.2.1.RELEASE'</span><span class="o">)</span> <span class="o">{</span>
<span class="n">exclude</span><span class="o">(</span><span class="nl">module:</span> <span class="s1">'spring-webmvc'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">compile</span><span class="o">(</span><span class="nl">group:</span> <span class="s1">'org.glassfish.jersey.ext'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'jersey-mvc'</span><span class="o">,</span> <span class="nl">version:</span><span class="s1">'2.14'</span><span class="o">)</span> <span class="o">{</span>
<span class="n">exclude</span><span class="o">(</span><span class="nl">module:</span> <span class="s1">'servlet-api'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">compile</span> <span class="nl">group:</span> <span class="s1">'org.springframework.boot'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'spring-boot-starter-thymeleaf'</span><span class="o">,</span> <span class="nl">version:</span><span class="s1">'1.2.1.RELEASE'</span>
    <span class="n">testCompile</span><span class="o">(</span><span class="nl">group:</span> <span class="s1">'org.springframework.boot'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'spring-boot-starter-test'</span><span class="o">,</span> <span class="nl">version:</span><span class="s1">'1.2.1.RELEASE'</span><span class="o">)</span> <span class="o">{</span>
<span class="n">exclude</span><span class="o">(</span><span class="nl">module:</span> <span class="s1">'commons-logging'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">testCompile</span> <span class="nl">group:</span> <span class="s1">'junit'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'junit'</span><span class="o">,</span> <span class="nl">version:</span><span class="s1">'4.12'</span>
<span class="o">}</span>
</pre></div>
</div>
<p>あとはSpring Bootのリファレンスの
<a class="reference external" href="http://docs.spring.io/spring-boot/docs/1.2.1.RELEASE/reference/htmlsingle/#getting-started-gradle-installation">10.1.2 Gradle installation</a>
を参考にしてちょこちょこっと編集しました。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">buildscript</span> <span class="o">{</span>
  <span class="n">repositories</span> <span class="o">{</span>
    <span class="n">jcenter</span><span class="o">()</span>
    <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://repo.spring.io/snapshot"</span> <span class="o">}</span>
    <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://repo.spring.io/milestone"</span> <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">dependencies</span> <span class="o">{</span>
    <span class="c1">//ここで拡張プロパティspringBootVersionは参照できひんの？_(:3｣∠)_</span>
    <span class="n">classpath</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-gradle-plugin:1.2.1.RELEASE"</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'java'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'spring-boot'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'eclipse'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'idea'</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'sample'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s1">'1.0-SNAPSHOT'</span>

<span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="mf">1.8</span>
<span class="n">targetCompatibility</span> <span class="o">=</span> <span class="mf">1.8</span>

<span class="n">ext</span> <span class="o">{</span>
  <span class="n">springBootVersion</span> <span class="o">=</span> <span class="s1">'1.2.1.RELEASE'</span>
<span class="o">}</span>

<span class="n">repositories</span> <span class="o">{</span>
  <span class="n">jcenter</span><span class="o">()</span>
  <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://repo.spring.io/snapshot"</span> <span class="o">}</span>
  <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"http://repo.spring.io/milestone"</span> <span class="o">}</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
  <span class="n">compile</span> <span class="s1">'org.twitter4j:twitter4j-core:4.0.2'</span>
  <span class="n">compile</span> <span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-jersey:$springBootVersion"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">exclude</span><span class="o">(</span><span class="nl">module:</span> <span class="s1">'spring-webmvc'</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="n">compile</span> <span class="o">(</span><span class="s1">'org.glassfish.jersey.ext:jersey-mvc:2.14'</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">exclude</span><span class="o">(</span><span class="nl">module:</span> <span class="s1">'servlet-api'</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="n">compile</span> <span class="s2">"org.springframework.boot:spring-boot-starter-thymeleaf:$springBootVersion"</span>
  <span class="n">testCompile</span> <span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-test:$springBootVersion"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">exclude</span><span class="o">(</span><span class="nl">module:</span> <span class="s1">'commons-logging'</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="n">testCompile</span> <span class="s1">'junit:junit:4.12'</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>知りたいこと</h2>
<p>build.gradleにも書いたけどbuildscriptのブロック内で拡張プロパティspringBootVersionを参照できないのでしょうか？
（試しに使ってみたらビルド失敗した。。。）</p>
<p>教えてくださいお願いしますお願いします（他力本願）。</p>
<div class="section" id="id3">
<h3>早速解決しました！</h3>
<blockquote class="twitter-tweet" lang="ja"><p><a href="https://twitter.com/backpaper0">@backpaper0</a> buildscriptブロック内で拡張プロパティが使えない件ですが、buildscriptブロック内で拡張プロパティを定義すれば、全体でその値を使えたと思いますよー</p>— さときち (@satokittyd) <a href="https://twitter.com/satokittyd/status/555730693188091904">2015, 1月 15</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>ありがとうございます！</p>
<p><a class="reference external" href="https://github.com/backpaper0/spring_boot_sample/commit/8ba07180a7758000522ebf99007d4c2b629378e2">修正してコミットしました！</a></p>
</div>
</div>
<div class="section" id="id5">
<h2>まとめ</h2>
<p>Gradle化すげえ簡単だった。</p>
</div>
<div class="section" id="id6">
<h2>あわせて読みたい</h2>
<ul class="simple">
<li><a class="reference external" href="http://syobochim.hatenablog.com/entry/2015/01/25/193327">初心者大歓迎! webアプリを作ってみよう!勉強会のレポ起因にブログ書いてもらったからやってみた！！！ - そこに仁義はあるのか(仮)</a></li>
</ul>
</div>
]]></description>
             <pubDate>Thu, 15 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/14/spring_boot_jersey.html</link>
            <guid>https://backpaper0.github.io/2015/01/14/spring_boot_jersey.html</guid>
            <title><![CDATA[Spring BootのサンプルをJAX-RSにしてみた]]></title>
            <description><![CDATA[<h1>Spring BootのサンプルをJAX-RSにしてみた</h1>
<p>先日写経したSpring BootのサンプルがSpring MVCで書かれていたのでJAX-RS、
というかJersey MVCにしてみました。</p>
<ul class="simple">
<li><a class="reference internal" href="https://backpaper0.github.io/2015/01/11/spring_boot.html"><span class="doc">Spring Bootをやってみた</span></a></li>
</ul>
<p>ソースコードは先日と同じ場所に置いてあります。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/spring_boot_sample">https://github.com/backpaper0/spring_boot_sample</a></li>
</ul>
<p>tag作りました。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/spring_boot_sample/releases/tag/jaxrs">https://github.com/backpaper0/spring_boot_sample/releases/tag/jaxrs</a></li>
</ul>
<div class="section" id="id1">
<h2>やったこと</h2>
<p>まず <a class="reference external" href="http://docs.spring.io/spring-boot/docs/1.2.1.RELEASE/reference/htmlsingle/#boot-features-jersey">Spring Bootのドキュメント</a> を参考にしてpom.xmlの編集とJerseyConfigクラスを作成しました。</p>
<p>次に <a class="reference external" href="https://jersey.java.net/documentation/latest/mvc.html#mvc.spi">Jerseyのリファレンス</a> を参考にしてTemplateProcessorの実装クラスを作成しました。</p>
<p>そして各ControllerクラスをSpring MVC仕様からJAX-RS仕様に変更しました。
詳細書くのは面倒なのでコミット見てください。</p>
</div>
<div class="section" id="id2">
<h2>例外出た</h2>
<p>一通りコードを書いて、IDEから動かしたら起動時に例外が出ました。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>java.util.concurrent.ExecutionException: org.apache.catalina.LifecycleException: Failed to start component [StandardEngine[Tomcat].StandardHost[localhost].StandardContext[]]
    at java.util.concurrent.FutureTask.report(FutureTask.java:122)
    at java.util.concurrent.FutureTask.get(FutureTask.java:192)
    at org.apache.catalina.core.ContainerBase.startInternal(ContainerBase.java:917)
    at org.apache.catalina.core.StandardHost.startInternal(StandardHost.java:868)
    at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)
    at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1409)
    at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1399)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    at java.lang.Thread.run(Thread.java:745)
Caused by: org.apache.catalina.LifecycleException: Failed to start component [StandardEngine[Tomcat].StandardHost[localhost].StandardContext[]]
    at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:154)
    ... 6 common frames omitted
Caused by: java.lang.NoSuchMethodError: javax.servlet.ServletContext.addFilter(Ljava/lang/String;Ljavax/servlet/Filter;)Ljavax/servlet/FilterRegistration$Dynamic;
    at org.springframework.boot.context.embedded.FilterRegistrationBean.onStartup(FilterRegistrationBean.java:250)
    at org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.selfInitialize(EmbeddedWebApplicationContext.java:222)
    at org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.access$000(EmbeddedWebApplicationContext.java:84)
    at org.springframework.boot.context.embedded.EmbeddedWebApplicationContext$1.onStartup(EmbeddedWebApplicationContext.java:206)
    at org.springframework.boot.context.embedded.tomcat.TomcatStarter.onStartup(TomcatStarter.java:54)
    at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5185)
    at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)
    ... 6 common frames omitted
</pre></div>
</div>
<p>なんかサーブレットAPIが古いようです。</p>
<p>十中八九Jersey関連が持ってきたんだろうな、と思いつつ、調査しました。
maven-dependency-plugin の treeゴールを使えば依存関係を一覧できます。
<span class="docutils literal"><span class="pre">-l</span></span> オプションでログをファイルに書き出してエディタで検索するのが楽だと思います。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>mvn -l log.txt dependency:tree -Dscope<span class="o">=</span><span class="nb">test</span>
</pre></div>
</div>
<p>Mavenを実行すると次のようなログが書き出されました。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building spring-boot-sample 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] --- maven-dependency-plugin:2.9:tree (default-cli) @ spring-boot-sample ---
[INFO] sample:spring-boot-sample:jar:1.0-SNAPSHOT
[INFO] +- org.twitter4j:twitter4j-core:jar:4.0.2:compile
[INFO] +- org.springframework.boot:spring-boot-starter-jersey:jar:1.2.1.RELEASE:compile
[INFO] |  +- org.springframework.boot:spring-boot-starter:jar:1.2.1.RELEASE:compile
[INFO] |  |  +- org.springframework.boot:spring-boot:jar:1.2.1.RELEASE:compile
[INFO] |  |  +- org.springframework.boot:spring-boot-autoconfigure:jar:1.2.1.RELEASE:compile
[INFO] |  |  +- org.springframework.boot:spring-boot-starter-logging:jar:1.2.1.RELEASE:compile
[INFO] |  |  |  +- org.slf4j:jcl-over-slf4j:jar:1.7.8:compile
[INFO] |  |  |  +- org.slf4j:jul-to-slf4j:jar:1.7.8:compile
[INFO] |  |  |  +- org.slf4j:log4j-over-slf4j:jar:1.7.8:compile
[INFO] |  |  |  \- ch.qos.logback:logback-classic:jar:1.1.2:compile
[INFO] |  |  |     \- ch.qos.logback:logback-core:jar:1.1.2:compile
[INFO] |  |  \- org.yaml:snakeyaml:jar:1.14:runtime
[INFO] |  +- org.springframework.boot:spring-boot-starter-tomcat:jar:1.2.1.RELEASE:compile
[INFO] |  |  +- org.apache.tomcat.embed:tomcat-embed-core:jar:8.0.15:compile
[INFO] |  |  +- org.apache.tomcat.embed:tomcat-embed-el:jar:8.0.15:compile
[INFO] |  |  +- org.apache.tomcat.embed:tomcat-embed-logging-juli:jar:8.0.15:compile
[INFO] |  |  \- org.apache.tomcat.embed:tomcat-embed-websocket:jar:8.0.15:compile
[INFO] |  +- com.fasterxml.jackson.core:jackson-databind:jar:2.4.4:compile
[INFO] |  |  +- com.fasterxml.jackson.core:jackson-annotations:jar:2.4.4:compile
[INFO] |  |  \- com.fasterxml.jackson.core:jackson-core:jar:2.4.4:compile
[INFO] |  +- org.hibernate:hibernate-validator:jar:5.1.3.Final:compile
[INFO] |  |  +- javax.validation:validation-api:jar:1.1.0.Final:compile
[INFO] |  |  +- org.jboss.logging:jboss-logging:jar:3.1.3.GA:compile
[INFO] |  |  \- com.fasterxml:classmate:jar:1.0.0:compile
[INFO] |  +- org.springframework:spring-core:jar:4.1.4.RELEASE:compile
[INFO] |  +- org.springframework:spring-web:jar:4.1.4.RELEASE:compile
[INFO] |  |  +- org.springframework:spring-aop:jar:4.1.4.RELEASE:compile
[INFO] |  |  |  \- aopalliance:aopalliance:jar:1.0:compile
[INFO] |  |  +- org.springframework:spring-beans:jar:4.1.4.RELEASE:compile
[INFO] |  |  \- org.springframework:spring-context:jar:4.1.4.RELEASE:compile
[INFO] |  |     \- org.springframework:spring-expression:jar:4.1.4.RELEASE:compile
[INFO] |  +- org.glassfish.jersey.core:jersey-server:jar:2.14:compile
[INFO] |  |  +- org.glassfish.jersey.core:jersey-common:jar:2.14:compile
[INFO] |  |  |  +- org.glassfish.jersey.bundles.repackaged:jersey-guava:jar:2.14:compile
[INFO] |  |  |  \- org.glassfish.hk2:osgi-resource-locator:jar:1.0.1:compile
[INFO] |  |  +- org.glassfish.jersey.core:jersey-client:jar:2.14:compile
[INFO] |  |  +- javax.annotation:javax.annotation-api:jar:1.2:compile
[INFO] |  |  +- org.glassfish.hk2:hk2-api:jar:2.4.0-b06:compile
[INFO] |  |  |  +- org.glassfish.hk2:hk2-utils:jar:2.4.0-b06:compile
[INFO] |  |  |  \- org.glassfish.hk2.external:aopalliance-repackaged:jar:2.4.0-b06:compile
[INFO] |  |  +- org.glassfish.hk2.external:javax.inject:jar:2.4.0-b06:compile
[INFO] |  |  \- org.glassfish.hk2:hk2-locator:jar:2.4.0-b06:compile
[INFO] |  |     \- org.javassist:javassist:jar:3.18.1-GA:compile
[INFO] |  +- org.glassfish.jersey.containers:jersey-container-servlet-core:jar:2.14:compile
[INFO] |  +- org.glassfish.jersey.containers:jersey-container-servlet:jar:2.14:compile
[INFO] |  +- org.glassfish.jersey.ext:jersey-spring3:jar:2.14:compile
[INFO] |  |  +- org.glassfish.hk2:hk2:jar:2.4.0-b06:compile
[INFO] |  |  |  +- org.glassfish.hk2:config-types:jar:2.4.0-b06:compile
[INFO] |  |  |  +- org.glassfish.hk2:core:jar:2.4.0-b06:compile
[INFO] |  |  |  +- org.glassfish.hk2:hk2-config:jar:2.4.0-b06:compile
[INFO] |  |  |  |  +- org.jvnet:tiger-types:jar:1.4:compile
[INFO] |  |  |  |  \- org.glassfish.hk2.external:bean-validator:jar:2.4.0-b06:compile
[INFO] |  |  |  +- org.glassfish.hk2:hk2-runlevel:jar:2.4.0-b06:compile
[INFO] |  |  |  \- org.glassfish.hk2:class-model:jar:2.4.0-b06:compile
[INFO] |  |  |     \- org.glassfish.hk2.external:asm-all-repackaged:jar:2.4.0-b06:compile
[INFO] |  |  \- org.glassfish.hk2:spring-bridge:jar:2.4.0-b06:compile
[INFO] |  \- org.glassfish.jersey.media:jersey-media-json-jackson:jar:2.14:compile
[INFO] |     +- com.fasterxml.jackson.jaxrs:jackson-jaxrs-base:jar:2.3.2:compile
[INFO] |     \- com.fasterxml.jackson.jaxrs:jackson-jaxrs-json-provider:jar:2.3.2:compile
[INFO] |        \- com.fasterxml.jackson.module:jackson-module-jaxb-annotations:jar:2.3.2:compile
<span class="hll">[INFO] +- org.glassfish.jersey.ext:jersey-mvc:jar:2.14:compile
</span><span class="hll">[INFO] |  +- javax.servlet:servlet-api:jar:2.4:compile
</span>[INFO] |  \- javax.ws.rs:javax.ws.rs-api:jar:2.0.1:compile
[INFO] +- org.springframework.boot:spring-boot-starter-test:jar:1.2.1.RELEASE:test
[INFO] |  +- org.mockito:mockito-core:jar:1.10.8:test
[INFO] |  |  \- org.objenesis:objenesis:jar:2.1:test
[INFO] |  +- org.hamcrest:hamcrest-core:jar:1.3:test
[INFO] |  +- org.hamcrest:hamcrest-library:jar:1.3:test
[INFO] |  \- org.springframework:spring-test:jar:4.1.4.RELEASE:test
[INFO] +- org.springframework.boot:spring-boot-starter-thymeleaf:jar:1.2.1.RELEASE:compile
[INFO] |  +- org.springframework.boot:spring-boot-starter-web:jar:1.2.1.RELEASE:compile
[INFO] |  |  \- org.springframework:spring-webmvc:jar:4.1.4.RELEASE:compile
[INFO] |  +- org.thymeleaf:thymeleaf-spring4:jar:2.1.4.RELEASE:compile
[INFO] |  |  +- org.thymeleaf:thymeleaf:jar:2.1.4.RELEASE:compile
[INFO] |  |  |  +- ognl:ognl:jar:3.0.8:compile
[INFO] |  |  |  \- org.unbescape:unbescape:jar:1.1.0.RELEASE:compile
[INFO] |  |  \- org.slf4j:slf4j-api:jar:1.7.8:compile
[INFO] |  \- nz.net.ultraq.thymeleaf:thymeleaf-layout-dialect:jar:1.2.7:compile
[INFO] \- junit:junit:jar:4.12:test
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 3.425 s
[INFO] Finished at: 2015-01-14T23:02:38+09:00
[INFO] Final Memory: 21M/165M
[INFO] ------------------------------------------------------------------------
</pre></div>
</div>
<p>servlet-apiを検索してヒットした箇所を見るとやはりjersey-mvcが依存していました。</p>
<p><a class="reference external" href="https://github.com/backpaper0/spring_boot_sample/commit/0f5c45d893948976d9f8dacfccc3790498dcd364">dependency要素にexclusion要素を追加してservlet-apiへの依存を除外した</a>
ところIDEからも起動できました。</p>
</div>
<div class="section" id="id3">
<h2>所感</h2>
<p>Spring MVCはMVCと言うだけあってビューを持つアプリケーションはさくさく作れそうな気がしました。</p>
<p>それに対してJAX-RSは単純にJSONを返すというようなAPIを作るのに特化してるなー、と改めて思いました。</p>
<p>まあ、そんな感じで。
おしまい。</p>
</div>
]]></description>
             <pubDate>Wed, 14 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2015/01/11/spring_boot.html</link>
            <guid>https://backpaper0.github.io/2015/01/11/spring_boot.html</guid>
            <title><![CDATA[Spring Bootをやってみた]]></title>
            <description><![CDATA[<h1>Spring Bootをやってみた</h1>
<p><a class="reference external" href="http://syobochim.hatenablog.com/entry/2015/01/10/195802">しょぼちむがSpring Bootのハンズオンのレポートを書いていた</a>
のでそれを参考に手を動かしてみました。
ブログ通りに写経していったら普通に動いたので楽ちんでした。</p>
<p>ただし私の知識がアレで
<a class="reference external" href="https://apps.twitter.com/">Twitter Application Management</a>
のSettingsタブにある
“Allow this application to be used to Sign in with Twitter”
にチェックを入れる必要があるっぽいのに気付かなくてそこだけちょっとつまずいた。
Twitterﾌﾟﾖｸﾞﾔﾐﾝｸﾞしてないのバレる！</p>
<div class="section" id="httpservletrequesthttpsession">
<h2>HttpServletRequestとHttpSessionをなくす</h2>
<p>さて、出来上がったアプリケーションでは
HttpServletRequest
と
HttpSession
を使っている箇所があったのでそれらを使わないように変更します。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">HttpServletRequest
と
HttpSession
はサーブレットのAPIでありSpringのAPIではありません。
なるべく低レベルのAPIを直接使用しない方がコードがシンプルになるし
ユニットテストが書きやすくて嬉しい、というのが個人的な考えです。</p>
</div>
<p>まずは HttpServletRequest を消します。
Twitterの認証から戻ってくるときに
oauth_verifier
というリクエストパラメータを受け取っている所に使われています。
これをTwitterControllerのdoTweetメソッドと同じやり方で受け取るように変更します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"accessToken"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">accessToken</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">,</span>
        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"oauth_verifier"</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="n">String</span> <span class="n">verifier</span><span class="p">)</span>
        <span class="kd">throws</span> <span class="n">TwitterException</span> <span class="p">{</span>
</pre></div>
</div>
<p>次いでHttpSessionを消します。
認証の際に必要となるリクエストトークンとアクセストークンを保持するために
HttpSession
が使用されているようです。
今回はそれらを格納するセッションスコープのクラスを作ってコントローラーにインジェクションする方法をとります。</p>
<p>まずこれがトークンを格納するセッションスコープのクラス。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">jp.co.bizreach.spring_boot_sample</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Scope</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ScopedProxyMode</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">twitter4j.auth.AccessToken</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">twitter4j.auth.RequestToken</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="nd">@Scope</span><span class="p">(</span><span class="n">proxyMode</span> <span class="o">=</span> <span class="n">ScopedProxyMode</span><span class="p">.</span><span class="na">TARGET_CLASS</span><span class="p">,</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">WebApplicationContext</span><span class="p">.</span><span class="na">SCOPE_SESSION</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TwitterAuth</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">AccessToken</span> <span class="n">accessToken</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">RequestToken</span> <span class="n">requestToken</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">AccessToken</span> <span class="nf">getAccessToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">accessToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccessToken</span><span class="p">(</span><span class="n">AccessToken</span> <span class="n">accessToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">accessToken</span> <span class="o">=</span> <span class="n">accessToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">RequestToken</span> <span class="nf">getRequestToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">requestToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRequestToken</span><span class="p">(</span><span class="n">RequestToken</span> <span class="n">requestToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">requestToken</span> <span class="o">=</span> <span class="n">requestToken</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>TwitterAuthController と TwitterController には次のようにフィールドにインジェクションします。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="n">TwitterAuth</span> <span class="n">auth</span><span class="p">;</span>
</pre></div>
</div>
<p>あとはこのフィールドを使ってトークンを格納したり取り出したりすればオッケーです。</p>
<p>これでサーブレットAPIをなくすことが出来ました！</p>
</div>
<div class="section" id="pom-xml">
<h2>pom.xmlを作る</h2>
<p>しょぼちむのブログより</p>
<blockquote>
<div>今回はサンプルアプリを作ってくれていて、基本的にはそれを動かしてみるって感じだったけど、pomファイルの作成のところからやってみたかったかも。</div></blockquote>
<p>作成しましょう！</p>
<p>サンプルはmvn archetype:generateで空のプロジェクトを作ったあとに
pom.xmlを編集してdependencyを追加したように見えます。</p>
<p>適当なディレクトリでmvn archetype:generateを実行します。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>mvn archetype:generate
</pre></div>
</div>
<p>すると色んな雛形が一覧でずらーっと出てくるので使いたいものを番号で指定します。</p>
<p>今回はデフォルトの <a class="reference external" href="http://repo1.maven.org/maven2/org/apache/maven/archetypes/maven-archetype-quickstart/">maven-archetype-quickstart</a> を使用しますので数字は何も入力せず次に進みます。</p>
<p>maven-archetype-quickstart
のバージョンを尋ねられます。
既に最新が選択されているのでここも何も入力せず次に進みます。</p>
<p>ここから groupId、artifactId、version、そしてアプリケーションの
package
を尋ねられます。
適宜入力してそのまま進むと次のようなログが出て空のプロジェクトが作成されます。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Old (1.x) Archetype: maven-archetype-quickstart:1.1
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: basedir, Value: /Users/backpaper0/src/temp
[INFO] Parameter: package, Value: app
[INFO] Parameter: groupId, Value: sample
[INFO] Parameter: artifactId, Value: spring-boot-sample
[INFO] Parameter: packageName, Value: app
[INFO] Parameter: version, Value: 1.0-SNAPSHOT
[INFO] ********************* End of debug info from resources from generated POM ***********************
[INFO] project created from Old (1.x) Archetype in dir: /Users/backpaper0/src/temp/spring-boot-sample
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 55.560 s
[INFO] Finished at: 2015-01-12T12:38:58+09:00
[INFO] Final Memory: 14M/95M
[INFO] ------------------------------------------------------------------------
</pre></div>
</div>
<p>作成されたファイルは次のような感じ。</p>
<ul class="simple">
<li>./pom.xml</li>
<li>./src/main/java/app/App.java</li>
<li>./src/test/java/app/AppTest.java</li>
</ul>
<p>pom.xmlとHello, world!するだけのクラス(App.java)とassertTrue(true)するだけのテストクラス(AppTest.java)です。</p>
<p>App.java
と
AppTest.java
は要らないので消します。</p>
<p>それからpom.xmlを編集します。</p>
<p>mvn archetype:generateした直後の状態は次のような感じです。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

  <span class="nt">&lt;groupId&gt;</span>sample<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-sample<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>

  <span class="nt">&lt;name&gt;</span>spring-boot-sample<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;url&gt;</span>http://maven.apache.org<span class="nt">&lt;/url&gt;</span>

  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>3.8.1<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
<p>これに
<a class="reference external" href="http://docs.spring.io/spring-boot/docs/1.2.1.RELEASE/reference/htmlsingle/#getting-started-maven-installation">リファレンスの10.1.1 Maven installation</a>
を参考にして parent要素と dependency要素を追加しました。
あとついでにJUnitのバージョンを4.12に上げました。
それとmaven-compiler-pluginの設定を追加してJava 8でビルドされるようにしました。
んでもって、spring-boot-maven-pluginの設定を追加してスタンドアロンJARを作れるようにしました。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

  <span class="nt">&lt;groupId&gt;</span>sample<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-sample<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>

  <span class="nt">&lt;name&gt;</span>spring-boot-sample<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;url&gt;</span>http://maven.apache.org<span class="nt">&lt;/url&gt;</span>

  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;parent&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.2.1.RELEASE<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/parent&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.twitter4j<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>twitter4j-core<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>4.0.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>

  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
          <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
          <span class="nt">&lt;encoding&gt;</span>${project.build.sourceEncoding}<span class="nt">&lt;/encoding&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
<p>これで概ねハンズオンのpom.xmlに近くなったと思います。</p>
</div>
<div class="section" id="id2">
<h2>今後の予定</h2>
<p>リファレンスには
<a class="reference external" href="http://docs.spring.io/spring-boot/docs/1.2.1.RELEASE/reference/htmlsingle/#getting-started-gradle-installation">10.1.2 Gradle installation</a>
というのがあったのでGradle化してみたいですね。</p>
<p>それと
<a class="reference external" href="http://repo1.maven.org/maven2/org/springframework/boot/spring-boot-starter-jersey/">spring-boot-starter-jersey</a>
というのがあるっぽいのでSpring MVCをJAX-RSに置き換えるというのもやってみたいです。</p>
<p>……やらない雰囲気が漂っていますが気にしない方向で！</p>
</div>
<div class="section" id="id3">
<h2>まとめ</h2>
<p>ひとのブログを写経しただけっていう他力本願がひどいブログ初めでした。</p>
<p>今年もよろしくお願い致します。</p>
</div>
<div class="section" id="id4">
<h2>今日のコード</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/spring_boot_sample">https://github.com/backpaper0/spring_boot_sample</a></li>
</ul>
</div>
<div class="section" id="id5">
<h2>あわせて読みたい</h2>
<ul class="simple">
<li><a class="reference external" href="http://syobochim.hatenablog.com/entry/2015/01/25/193327">初心者大歓迎! webアプリを作ってみよう!勉強会のレポ起因にブログ書いてもらったからやってみた！！！ - そこに仁義はあるのか(仮)</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 11 Jan 2015 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/24/glassfish_create_session_id.html</link>
            <guid>https://backpaper0.github.io/2014/12/24/glassfish_create_session_id.html</guid>
            <title><![CDATA[GlassFishでセッションIDを生成してるところ]]></title>
            <description><![CDATA[<h1>GlassFishでセッションIDを生成してるところ</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/383">GlassFish Advent Calendar 2014</a> の24日目です。</p>
<p>相変わらずの小ネタです。</p>
<p>以前調べたのですが、
GlassFishでのHttpSession実装クラスは <span class="docutils literal"><span class="pre">org.apache.catalina.session.StandardSession</span></span> で、
これはTomcatのコードを利用したものですが、
セッションIDの生成処理は変更されているようです。</p>
<p>なんやかんや辿って行くと <span class="docutils literal"><span class="pre">com.enterprise.util.uuid.UuidUtil</span></span> の <span class="docutils literal"><span class="pre">generateUuid</span></span>
メソッドに行き着きました。</p>
<p>コードを引用します。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//this method can take in the session object</span>
<span class="c1">//and insure better uniqueness guarantees</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">generateUuid</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//low order time bits</span>
    <span class="kt">long</span> <span class="n">presentTime</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">presentTimeLow</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">presentTime</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">presentTimeStringLow</span> <span class="o">=</span> <span class="n">formatHexString</span><span class="p">(</span><span class="n">presentTimeLow</span><span class="p">);</span>

    <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">presentTimeStringLow</span><span class="p">);</span>
    <span class="c1">//sb.append(":");</span>
    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">getIdentityHashCode</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
    <span class="c1">//sb.append(":");</span>
    <span class="c1">//sb.append(_inetAddr);</span>
    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">addRandomTo</span><span class="p">(</span><span class="n">_inetAddr</span><span class="p">));</span>
    <span class="c1">//sb.append(":");</span>
    <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">getNextRandomString</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>ご覧の通り、</p>
<ul class="simple">
<li>システム日付</li>
<li>セッションオブジェクトのIdentityハッシュコード</li>
<li>ローカルホストのIPアドレス</li>
<li>ランダムな文字列</li>
</ul>
<p>を繋げたものになっています。</p>
<p>ここから呼び出されているメソッドを細かく見て行くと7文字で切ってたりしてマジこれでセキュアなん？
とか思ってしまったりしましたが “insure better uniqueness guarantees”
とか書かれてるし衝突耐性高くて大丈夫なんでしょうたぶん。</p>
<p>ちなみに <span class="docutils literal"><span class="pre">org.apache.catalina.session.StandardSession</span></span> は <a class="reference external" href="http://repo1.maven.org/maven2/org/glassfish/main/web/web-core/4.1/">org.glassfish.main.web:web-core</a> に、
<span class="docutils literal"><span class="pre">com.enterprise.util.uuid.UuidUtil</span></span> は <a class="reference external" href="http://repo1.maven.org/maven2/org/glassfish/main/common/common-util/4.1/">org.glassfish.main.common:common-util</a> に入っています。</p>
<p>というわけであっさりしていますが、以上。</p>
<p>GlassFishさん、来年もお世話になります！</p>
]]></description>
             <pubDate>Wed, 24 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/24/syobotsum.html</link>
            <guid>https://backpaper0.github.io/2014/12/24/syobotsum.html</guid>
            <title><![CDATA[しょぼつむ #syobochim]]></title>
            <description><![CDATA[<h1>しょぼつむ #syobochim</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/327">しょぼちむ Advent Calendar 2014</a>
の24日目です。</p>
<blockquote class="twitter-tweet" lang="ja"><p>しょぼちむアドベントカレンダー、作っていただけたらきっと嬉しいんだろうけど、自分で作るのは違う気がする！！！！</p>— しょぼちむ@精進します (@syobochim) <a href="https://twitter.com/syobochim/status/529187751162163200">2014, 11月 3</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>というツイートを見て軽い気持ちで作ってみましたが蓋を開けると色んな人が色んな事を書いており、
しょぼちむ本当に良かったね！っていう感じでいっぱいの楽しいアドベントカレンダーもはや24日目となりました。</p>
<div class="section" id="id1">
<h2>「しょぼつむ」作りました</h2>
<p>さて、今回私はしょぼちむをモチーフにして「しょぼつむ」というゲーム作ってみました。
ゲームのイメージを貼ります。</p>
<img alt="../../../_images/syobotsum_screen_shot.png" src="https://backpaper0.github.io/_images/syobotsum_screen_shot.png"/>
<p>ルールは至ってシンプルです。
画面の下の方に見えているハート・レッドキング・雪だるまを指で弾くと飛んで行って着地します。
制限時間10秒の間に次々と弾いて高く積み上げてください。
雪降るクリスマスの街に積み上がった分だけ女子力が手に入ります。
という、なんかもうこの時点でしょぼちむすまん、と言いたくなる感じのコンセプトです。</p>
<p>積むものによってポイントが異なります。</p>
<ul class="simple">
<li>ハート：5ポイント</li>
<li>レッドキング：2ポイント</li>
<li>雪だるま：1ポイント</li>
</ul>
<p>ハートはポイント稼げますが落下速度がのんびりしています。</p>
<p>野良apkファイルを用意しました。
良ければ遊んでみてください。</p>
<ul class="simple">
<li><a class="reference download internal" href="https://backpaper0.github.io/_downloads/android-release.apk" download=""><span class="xref download docutils literal"><span class="pre">/assets/android-release.apk</span></span></a></li>
</ul>
<p>ソースコードはこちら。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/syobotsum">https://github.com/backpaper0/syobotsum</a></li>
</ul>
<p><span class="docutils literal"><span class="pre">gradlew</span> <span class="pre">android:build</span></span> したらapkをビルドできます。</p>
<p>ちなみに実機で確認していません(ｷﾘｯ</p>
</div>
<div class="section" id="id2">
<h2>ゲームを作ってみて</h2>
<p>すごく簡単なゲームですがゲーム作り初心者には難しい部分もありました。</p>
<p>しかし技術的な難しさよりもゲームシステムのアイデアが出なかったり絵の準備に手間取ってしまいました。</p>
<p>アドベントカレンダーのネタを考えていたときに「しょぼつむ」という言葉が先に浮かんだので何かを積むものにしようとは思っていたのですが、
ぷよぷよのような落ちものゲームにしようかなー、
それとも将棋崩しのようなものも積むという基本コンセプトからは逸脱しないかなー、
など悩みました。</p>
<p>悩みはしましたがなんせ普段はWebアプリでCRUDの亜種みたいなのばっか作ってる身としては凝った事をやるとしぬと思い、
シンプルなルールになるよう考えた末に前記のようなものになりました。</p>
<p>コーディングも普段やってる事とは異なりましたがなるべく高レベルAPIを利用する事で
なんとか形に出来ました。</p>
</div>
<div class="section" id="todo">
<h2>TODO</h2>
<p>とりあえず動きますが未完成です。
次にTODOを記載します。</p>
<ul class="simple">
<li>SEとBGMを付けたい</li>
<li>ヘルプを組込みたい。ブログに操作方法書くとかアレ</li>
<li>フェードアウト時、各パーツの枠のちらつきをなんとかしたい</li>
<li>画像のロードを非同期にしたい</li>
<li>結果画面がおとなしいからもっとわちゃわちゃさせたい</li>
<li>ソースコードにコメントほぼないの、たぶん後で困るから覚えてるうちに書いておきたい</li>
</ul>
<p>特にBGMはせっかくなので作曲したいと考えていましたがそんな時間はなかった（まがお</p>
<p>そもそもパソコンで曲作るのってどうしたら良いですかね？
教えてえろいひと！（他力本願</p>
</div>
<div class="section" id="id3">
<h2>技術的な話</h2>
<p>「しょぼつむ」はlibGDXで開発をしました。</p>
<ul class="simple">
<li><a class="reference external" href="http://libgdx.badlogicgames.com/">http://libgdx.badlogicgames.com/</a></li>
</ul>
<p>libGDXはJavaで書かれたゲームフレームワークで、ささーっとコードを書くとそのコードをデスクトップアプリ、Androidアプリ、iOSアプリなどにビルド出来るスゴいやつです。</p>
<p>私はAndroidスマホ持っていないしiOS開発者ライセンスも持っていないのでプライベートでスマホアプリ開発はしないのですが、
libGDXであればJava SEで書いてデスクトップで動かせるので私のような者であってもスマホアプリ開発が出来てしまいました。</p>
<p>libGDXの事を詳しく知りたい方は <a class="reference external" href="https://github.com/libgdx/libgdx/wiki">GitHubにあるlibGDXのWiki</a>
を読むか「libGDX しんさん」でググると良いでしょう。</p>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<ul class="simple">
<li>ゲーム作るの難しい</li>
<li>libGDXすごく良い</li>
</ul>
</div>
<div class="section" id="id5">
<h2>明日のアドベントカレンダーは</h2>
<p><a class="reference external" href="http://syobochim.hatenablog.com/entry/2014/12/25/221700">しょぼちむの番でフィナーレ</a> ですね！</p>
</div>
]]></description>
             <pubDate>Wed, 24 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/15/jersey_optional.html</link>
            <guid>https://backpaper0.github.io/2014/12/15/jersey_optional.html</guid>
            <title><![CDATA[Jersey 2.14でパラメータの受け取りにOptionalが使えるようになった]]></title>
            <description><![CDATA[<h1>Jersey 2.14でパラメータの受け取りにOptionalが使えるようになった</h1>
<p>Jersey 2.14がリリースされたようです！</p>
<ul class="simple">
<li><a class="reference external" href="https://jersey.java.net/release-notes/2.14.html">https://jersey.java.net/release-notes/2.14.html</a></li>
</ul>
<p>で、注目は <a class="reference external" href="https://java.net/jira/browse/JERSEY-2612">[JERSEY-2612]</a> です。
この対応のおかげで@QueryParamなどのパラメータをOptionalで定義する事が可能になります。
ただしParamConverterを書く必要はありますが。</p>
<p>ParamConverterってなんやねん！って方は <a class="reference internal" href="https://backpaper0.github.io/2013/07/17/jaxrs_parameter.html"><span class="doc">JAX-RSでパラメータの受け取り方をいろいろ試す</span></a>
の後半を読んでくださいませー。</p>
<div class="section" id="optional">
<h2>リクエストパラメータをOptionalで受け取るコード例</h2>
<p>適当ですがサクッちょとサンプル書きました。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox">https://github.com/backpaper0/sandbox</a> の <span class="docutils literal"><span class="pre">jersey-optional-example</span></span> ディレクトリ</li>
</ul>
<p>リソースクラスをこちらにも掲載します。
ちょー簡単な例ですが、こんな感じでリソースメソッドの引数にOptionalを使えるようになります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">example</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.QueryParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span><span class="p">;</span>

<span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="p">{</span>

    <span class="nd">@GET</span>
    <span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_PLAIN</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">"Hello, "</span> <span class="o">+</span> <span class="n">name</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="s">"world"</span><span class="p">)</span> <span class="o">+</span> <span class="s">"!"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意点としては先ほども書きましたがParamConverter実装クラスとParamConverterProvider実装クラスも
自前で準備しなくてはならない事です。
まあ、一度書いたら使い回せるはずなのでサクッと書いておきましょー。</p>
</div>
<div class="section" id="id1">
<h2>今までこれが出来なかった理由</h2>
<p>@QueryParamなどで注釈された引数へ渡される値はSingleValueExtractorのextractメソッドを
通るんですが、Jersey 2.13までのextractメソッドは「値がnullでなければParamConverterなどで変換、
nullなら@DefaultValueで設定された値を返す」という感じの実装になっていました。</p>
<p>その部分を抜粋します。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">T</span> <span class="nf">extract</span><span class="p">(</span><span class="n">MultivaluedMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">v</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">.</span><span class="na">getFirst</span><span class="p">(</span><span class="n">getName</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">fromString</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">WebApplicationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ProcessingException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ExtractorException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">defaultValue</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>このロジックが原因でOptionalのParamConverterを書いてもnullが渡ってくるアレっぷりでした。</p>
<p>しかしこのextractメソッドはJersey 2.14で次のように修正されました。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">T</span> <span class="nf">extract</span><span class="p">(</span><span class="n">MultivaluedMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">v</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">.</span><span class="na">getFirst</span><span class="p">(</span><span class="n">getName</span><span class="p">());</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">fromString</span><span class="p">((</span><span class="n">v</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isDefaultValueRegistered</span><span class="p">())</span> <span class="o">?</span> <span class="n">getDefaultValueString</span><span class="p">()</span> <span class="p">:</span> <span class="n">v</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">WebApplicationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ProcessingException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">defaultValue</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ExtractorException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>ご覧の通り「値がnullかつデフォルト値が設定されていればデフォルト値を、
そうでなければ値をParamConverterなどに渡す」という風になっています。</p>
<p>これで値がnullの場合でもParamConverterを通るようになり、Optionalへの変換が可能になりました。</p>
</div>
<div class="section" id="id2">
<h2>まとめ</h2>
<ul class="simple">
<li>Jerseyでリクエストパラメータなどの受け取りにOptional使えるようになって嬉しい</li>
<li>ハイテンションでブログ書いたら文章やばい</li>
</ul>
<p>そんな感じでー</p>
</div>
]]></description>
             <pubDate>Mon, 15 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/14/kotlin_static_method.html</link>
            <guid>https://backpaper0.github.io/2014/12/14/kotlin_static_method.html</guid>
            <title><![CDATA[Kotlinでstaticメソッドが定義できるようになったのでJAX-RSリベンジ]]></title>
            <description><![CDATA[<h1>Kotlinでstaticメソッドが定義できるようになったのでJAX-RSリベンジ</h1>
<p>ことりん〜(挨拶)</p>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/477">Kotlin Advent Calendar 2014</a>
の14日目です。</p>
<p>夏の終わりに
<a class="reference internal" href="https://backpaper0.github.io/2014/09/14/kotlinkansai.html"><span class="doc">関西Kotlin勉強会</span></a>
を開催し、私はKotlinでJAX-RSをやるという発表をしました。
JAX-RSにいくつかあるリクエストパラメータの受け取りかたのうち
「Stringの引数をひとつだけ受け取る”valueOf”という名前のstaticファクトリメソッドを持つクラス」
が実現できませんでした。
そのときのKotlinのバージョン(M7)ではstaticメソッドが定義できなかったからです。</p>
<ul class="simple">
<li><a class="reference external" href="http://backpaper0.github.io/ghosts/kotlin-jaxrs.html#/16">http://backpaper0.github.io/ghosts/kotlin-jaxrs.html#/16</a></li>
</ul>
<p>しかしバージョンM9からplatformStaticアノテーションを使用してstaticメソッドを定義できるようになったようです。</p>
<ul class="simple">
<li><a class="reference external" href="http://taro.hatenablog.jp/entry/2014/10/17/213252">Kotlin M9まとめ - 算譜王におれはなる!!!!</a></li>
</ul>
<p>というわけでリベンジしました。
次のような感じで書けます。</p>
<div class="highlight-kotlin notranslate"><div class="highlight"><pre><span/><span class="k">package</span> <span class="nn">app</span>

<span class="k">import</span> <span class="nn">kotlin.platform.platformStatic</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ValueObj</span> <span class="k">private</span> <span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">object</span> <span class="p">{</span>
    <span class="n">platformStatic</span> <span class="k">fun</span> <span class="nf">valueOf</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">ValueObj</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Kotlinの思想がどうあれJava言語、または既存のJavaライブラリとの共存を考慮するとstaticメソッドの
定義は必要だろうなーと思っていたのでこの機能追加は良いと思います。</p>
<p>個人的にはstaticファクトリメソッドを持つバリューオブジェクトを多用するので大変助かります。</p>
<p>おしまい。</p>
<div class="section" id="id1">
<h2>今日のコード</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox">https://github.com/backpaper0/sandbox</a> の <span class="docutils literal"><span class="pre">kotlin-staticmethod-example</span></span> ディレクトリ</li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 14 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/07/tinkerer_hatena_star.html</link>
            <guid>https://backpaper0.github.io/2014/12/07/tinkerer_hatena_star.html</guid>
            <title><![CDATA[Tinkererにはてなスターを設置した]]></title>
            <description><![CDATA[<h1>Tinkererにはてなスターを設置した</h1>
<p><a class="reference external" href="http://tinkerer.me/">Tinkerer</a> で書いてるこのブログに <a class="reference external" href="http://s.hatena.ne.jp/">はてなスター</a>
を設置したのでその辺まとめておきます。
なお、私は <span class="docutils literal"><span class="pre">modern5</span></span> をベースにカスタマイズしたテーマを使用していますので別のテーマだと多少異なるかも知れません。</p>
<p>まずはてなスターのマイページでブログを登録します。
マイページのURLは <a class="reference external" href="http://s.hatena.ne.jp">http://s.hatena.ne.jp</a>/&lt;自分のID&gt; です。</p>
<p>次に _templates/page.html のextraheadブロック(
<span class="docutils literal"><span class="pre">{%-</span> <span class="pre">block</span> <span class="pre">extrahead</span> <span class="pre">-%}</span></span> と <span class="docutils literal"><span class="pre">{%-</span> <span class="pre">endblock</span> <span class="pre">-%}</span></span>
に囲まれたところ)に次のJavaScriptコードを書きます。</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span/><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;</span>
   <span class="nx">Hatena</span><span class="p">.</span><span class="nx">Star</span><span class="p">.</span><span class="nx">Token</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">自分のトークン</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="nx">Hatena</span><span class="p">.</span><span class="nx">Star</span><span class="p">.</span><span class="nx">SiteConfig</span> <span class="o">=</span> <span class="p">{</span>
     <span class="nx">entryNodes</span><span class="o">:</span> <span class="p">{</span>
       <span class="s1">'div.main-container'</span><span class="o">:</span> <span class="p">{</span>
         <span class="nx">uri</span><span class="o">:</span> <span class="s1">'window.location'</span><span class="p">,</span>
         <span class="nx">title</span><span class="o">:</span> <span class="s1">'document.title'</span><span class="p">,</span>
         <span class="nx">container</span><span class="o">:</span> <span class="s1">'span.hatenastar'</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">};</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">&lt;自分のトークン&gt;</span></span> にはマイページでブログを追加したあとに表示されるトークンを書いてください。</p>
<p>最後に実際にはてなスターを設置する場所となる要素を追加します。
私はエントリのいっちゃん下に置きたかったのでbodyブロックの最後の方に次のspan要素を書きました。</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span/><span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">"hatenastar"</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>自分のTinkererちからが低すぎて悩んだりもしたけれど、出来てしまえば簡単でした！</p>
<p>より詳しくは <a class="reference external" href="http://d.hatena.ne.jp/hatenastar/20070707">http://d.hatena.ne.jp/hatenastar/20070707</a> を参照くださいですじゃ。</p>
]]></description>
             <pubDate>Sun, 07 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/07/glassfish_asadmin.html</link>
            <guid>https://backpaper0.github.io/2014/12/07/glassfish_asadmin.html</guid>
            <title><![CDATA[よく使うasadminのコマンドを紹介する]]></title>
            <description><![CDATA[<h1>よく使うasadminのコマンドを紹介する</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/383">GlassFish Advent Calendar 2014</a> の7日目です。</p>
<p>小ネタです。
私がよく使うasadminのコマンドを、引数も書いて実際に使っている感じを出しつつ紹介します。</p>
<dl class="docutils">
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">list-commands</span></span></dt>
<dd>どんなコマンドあったっけなー、ってときどき確認します。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">list-domain</span></span></dt>
<dd>GlassFishはドメインという単位で管理しますが、このコマンドで今あるドメインを確認します。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">delete-domain</span> <span class="pre">domain1</span></span></dt>
<dd>要らんドメインを消します。
ドメインは <span class="docutils literal"><span class="pre">glassfish/domains/</span></span> 以下に作成されますが、ここを心を込めて手動で消しても大丈夫っぽいです。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">create-domain</span> <span class="pre">--portbase=9000</span> <span class="pre">domain1</span></span></dt>
<dd>ドメインを作ります。
portbaseを指定すればHTTPは9080、管理は9048という風に良い感じにポートを設定してくれます。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">start-domain</span> <span class="pre">domain1</span></span></dt>
<dd>ドメインを起動します。
後述するcreate-jdbc-connection-poolコマンドなど一部のコマンドはドメインが起動していないと実行できなかったりします。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">stop-domain</span> <span class="pre">domain1</span></span></dt>
<dd>起動しているドメインを停止します。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">create-jdbc-connection-pool</span> <span class="pre">--datasourceclassname</span> <span class="pre">org.h2.jdbcx.JdbcDataSource</span> <span class="pre">--restype</span> <span class="pre">javax.sql.DataSource</span> <span class="pre">--property</span> <span class="pre">url=jdbc\\:h2\\:sampleDB:user=sa:password=secret</span> <span class="pre">samplePool</span></span></dt>
<dd>JDBCコネクションプールを作ります。
propertyにURLを書く場合、コロンをエスケープしないといけないので気をつけましょー。
一番最後の引数(この例でいうとsamplePool)がコネクションプールIDです。
なお、JDBCドライバは <span class="docutils literal"><span class="pre">glassfish/domains/domain1/lib/ext/</span></span> (domain1はドメインの名前なので適宜置き換えてください)に置きます。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">create-jdbc-resource</span> <span class="pre">--connectionpoolid</span> <span class="pre">samplePool</span> <span class="pre">jdbc/sample</span></span></dt>
<dd>JDBCリソースを作ります。
アプリケーションからはここで設定したJNDI名(この例でいうとjdbc/sample)で参照します。
ひとつのJDBCコネクションプールに対して複数のJDBCリソースを作ることもできます。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">create-jvm-options</span> <span class="pre">-Xmx1024m</span></span></dt>
<dd>JVMオプションを設定します。
この例では最大メモリサイズを設定しています。
このコマンドで設定したJVMオプションはドメインを再起動したときに反映されます。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">set-log-levels</span> <span class="pre">org.seasar.doma=CONFIG</span></span></dt>
<dd>ログレベルを設定します。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">deploy</span> <span class="pre">--contextroot=sample</span> <span class="pre">--name=sample</span> <span class="pre">sample.war</span></span></dt>
<dd>デプロイします。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">redeploy</span> <span class="pre">--name=sample</span> <span class="pre">sample.war</span></span></dt>
<dd>再デプロイします。
デプロイと再デプロイでコマンドを使い分けなきゃダメなのはちょっと面倒です。</dd>
<dt><span class="docutils literal"><span class="pre">asadmin</span> <span class="pre">undeploy</span> <span class="pre">sample</span></span></dt>
<dd>アンデプロイします。
引数にはデプロイ時に設定したnameを指定します。</dd>
</dl>
<p>とまあ、よく使うのはこんな所でしょうか。
自分が思っていたより少なかったですね。</p>
<p>簡単ですが、以上になります。
おそまつさまでした。</p>
]]></description>
             <pubDate>Sun, 07 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/07/application_class.html</link>
            <guid>https://backpaper0.github.io/2014/12/07/application_class.html</guid>
            <title><![CDATA[どうやってApplicationサブクラスの名前取ってきてんの？]]></title>
            <description><![CDATA[<h1>どうやってApplicationサブクラスの名前取ってきてんの？</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/380">JavaFX Advent Calendar 2014</a> の7日目です。</p>
<p>小ネタです。</p>
<p>JavaFXアプリケーションのメインクラスは次のように書きますよね。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">javafx.application.Application</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.stage.Stage</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hoge</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">launch</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">Stage</span> <span class="n">primaryStage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//略</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これを初めて見たとき、launchメソッドにApplicationサブクラスのインスタンスや
Classを渡してるわけでもないのにインスタンス化されてstartメソッドが呼ばれるのが
キモいなー、と思ったのでした。</p>
<p>で、だいたい予想はつきましたが、Application.javaを読んでみました。
その部分を引用します。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">// Figure out the right class to call</span>
<span class="n">StackTraceElement</span><span class="o">[]</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getStackTrace</span><span class="p">();</span>

<span class="kt">boolean</span> <span class="n">foundThisMethod</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="n">String</span> <span class="n">callingClassName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">StackTraceElement</span> <span class="n">se</span> <span class="p">:</span> <span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Skip entries until we get to the entry for this class</span>
    <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">se</span><span class="p">.</span><span class="na">getClassName</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">se</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">foundThisMethod</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">callingClassName</span> <span class="o">=</span> <span class="n">className</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
            <span class="o">&amp;&amp;</span> <span class="s">"launch"</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">methodName</span><span class="p">))</span> <span class="p">{</span>

        <span class="n">foundThisMethod</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>という感じで、スタックトレースを取得して現在のメソッド(launch)のひとつ前の
メソッド名(main)とクラス名(Hoge)を取得していました。</p>
<p>予想通り割とキモい方法でクラス名を取ってきていたことが分かって満足です。</p>
<p>JavaFXである必要性の薄い内容でしたが、以上になります。
おそまつさまでした。</p>
]]></description>
             <pubDate>Sun, 07 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/04/validation.html</link>
            <guid>https://backpaper0.github.io/2014/12/04/validation.html</guid>
            <title><![CDATA[BeanValidationの相関バリデーションとそもそもの話]]></title>
            <description><![CDATA[<h1>BeanValidationの相関バリデーションとそもそもの話</h1>
<p>BeanValidationで相関バリデーションするときに新しいメソッド作って@AssertTrueを使うよ！
っていう話があったので、それについて思う事を書きます。</p>
<p>なお、以下はWebアプリケーションでリクエストパラメータをPOJOにマッピングして
BeanValidationを行うという流れを想定しています。</p>
<div class="section" id="asserttrue">
<h2>@AssertTrueでバリデーション</h2>
<p>件の相関バリデーションはたぶんこんな感じです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kt">int</span> <span class="n">from</span><span class="p">;</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="n">to</span><span class="p">;</span>

<span class="nd">@AssertTrue</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFromLessThanTo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">from</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>私は、これは</p>
<ul class="simple">
<li>メソッド内にバリデーションロジックを書くので再利用性が低い</li>
<li>@AssertTrue、そしてbooleanは宣言的ではない</li>
</ul>
<p>と思っています。</p>
</div>
<div class="section" id="id1">
<h2>じゃあ、どうすればいいのか</h2>
<p><span class="docutils literal"><span class="pre">from</span> <span class="pre">&lt;</span> <span class="pre">to</span></span> を検証するアノテーションとカスタムバリデータを作りましょう。
そしてそれを付けるメソッドはbooleanではなくタプル(のような何か)を返します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kt">int</span> <span class="n">from</span><span class="p">;</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="n">to</span><span class="p">;</span>

<span class="nd">@FromLessThanTo</span>
<span class="kd">public</span> <span class="n">Pair</span> <span class="nf">isFromLessThanTo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Pair</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>こうする事で、</p>
<ul class="simple">
<li>バリデーションのロジックはカスタムバリデータに閉じ込めたので再利用性高まる</li>
<li>アノテーションで大小関係があるって分かって宣言的っぽい</li>
</ul>
<p>となるかと。</p>
</div>
<div class="section" id="id2">
<h2>そもそも</h2>
<p>アノテーションを使ったバリデーションってどうなんでしょうね？</p>
<p>例えば、次のようなコードがあったとします。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Isbn</span>
<span class="kd">public</span> <span class="n">String</span> <span class="n">isbn1</span><span class="p">;</span>

<span class="nd">@Isbn</span>
<span class="kd">public</span> <span class="n">String</span> <span class="n">isbn2</span><span class="p">;</span>
</pre></div>
</div>
<p>アノテーションを見ればisbn1もisbn2もISBNであるということは分かるのですが、
でもそれってアノテーションの役割じゃなくて型じゃないの？と思うのです。</p>
<p>本来あるべき姿はこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="n">Isbn</span> <span class="n">isbn1</span><span class="p">;</span>

<span class="kd">public</span> <span class="n">Isbn</span> <span class="n">isbn2</span><span class="p">;</span>
</pre></div>
</div>
<p>この場合バリデーションはIsbn型へ変換するときに行うのが良いと思われます。</p>
</div>
<div class="section" id="id3">
<h2>型よ</h2>
<p>基本的にバリデーションは次の順番で行われると思います。</p>
<ul class="simple">
<li>必須バリデーション</li>
<li>フォーマットバリデーション(日付とされる値がyyyy/MM/ddになっているか？みたいなことです)</li>
<li>相関バリデーション</li>
</ul>
<p>必須バリデーションを行うか否かも型で表したい。
Optionalでないものは必須！という感じです。
たぶんそれが良いと思う。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//必須</span>
<span class="kd">public</span> <span class="n">Isbn</span> <span class="n">isbn1</span><span class="p">;</span>

<span class="c1">//必須でない</span>
<span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Isbn</span><span class="o">&gt;</span> <span class="n">isbn2</span><span class="p">;</span>
</pre></div>
</div>
<p>フォーマットも先述の通り型で表す事ができます。</p>
<p>それから相関バリデーションですが、最初の例であればRangeといった型を作ってそこにfromとtoを
詰め込めばfromとtoの大小関係を型で表す事ができます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">new</span> <span class="n">Range</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<p>まとまりません！
もっと理想的なバリデーションフレームワークが欲しい！</p>
<p>というわけでバリデーションへの悩みは尽きません。
悩ましい。</p>
</div>
]]></description>
             <pubDate>Thu, 04 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/01/javaee_advent_calendar_2014.html</link>
            <guid>https://backpaper0.github.io/2014/12/01/javaee_advent_calendar_2014.html</guid>
            <title><![CDATA[JAX-RSを始める #javaee]]></title>
            <description><![CDATA[<h1>JAX-RSを始める #javaee</h1>
<p>これは <a class="reference external" href="http://qiita.com/advent-calendar/2014/javaee">Java EE Advent Calendar 2014</a>
の1日目です。</p>
<p>今回は参照実装である <a class="reference external" href="https://jersey.java.net/">Jersey</a>
を使ってJAX-RSを始めるための環境構築などをだらだら書こうと思います。</p>
<div class="section" id="id1">
<h2>ビルドツール</h2>
<p>昨今はGradleが人気のような雰囲気漂っていますが、
<a class="reference external" href="http://maven.apache.org/">Maven</a> を使いましょう。</p>
<p>JerseyはMavenのprofileという機能を使っていてGradleではその辺のサポートがないっぽいのでたぶんしんどいです。</p>
<ul class="simple">
<li>参考： <a class="reference external" href="http://d.hatena.ne.jp/irof/20130505/p1">JAX-RSをGradleでアレしたい - 日々常々</a></li>
</ul>
<p>……と書きましたが最近のGradleはprofile対応してるようです。</p>
<blockquote class="twitter-tweet" lang="ja"><p>JAX-RSを始める <a href="https://twitter.com/hashtag/javaee?src=hash">#javaee</a> — 裏紙 <a href="http://t.co/mAX6m50PMd">http://t.co/mAX6m50PMd</a> 現在はGradleもProfileに対応してます <a href="http://t.co/pHMXxcnt7T">http://t.co/pHMXxcnt7T</a></p>— Nobuhiro Sue (@nobusue) <a href="https://twitter.com/nobusue/status/539304292822159361">2014, 12月 1</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8">{}</script><p>というわけでサンプルにGradleのビルドファイルも追加しました。</p>
<p>Mavenのインストールはバイナリを任意の場所にダウンロードして <span class="docutils literal"><span class="pre">bin</span></span> ディレクトリにパスを通せばおkです。</p>
</div>
<div class="section" id="id2">
<h2>ビルドファイルの準備</h2>
<div class="section" id="id3">
<h3>Mavenの場合</h3>
<p>まず、 <span class="docutils literal"><span class="pre">mvn</span> <span class="pre">archetype:generate</span></span> してください。
それから出来たpom.xmlを編集します。</p>
<p>次のdependencyManagement要素を追加してください。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependencyManagement&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-bom<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.13<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
      <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/dependencyManagement&gt;</span>
</pre></div>
</div>
<p>それからjersey-bomのpom.xmlを見ながら好きなものを選んでdependency要素に追加します。
とはいえJerseyはサーバ側のAPI、クライアント側のAPI、MVC拡張など多数のJARに別れて提供されているので
何を追加すれば良いのか最初は分からないと思います。</p>
<p>今回はサーバ側のコードを書きたいので、 <span class="docutils literal"><span class="pre">jersey-server</span></span> を追加します。
また、Jerseyは <a class="reference external" href="https://grizzly.java.net/">Grizzly</a> や <a class="reference external" href="http://eclipse.org/jetty/">Jetty</a>
などのコンテナ上で動きますが、今回は <a class="reference external" href="https://docs.oracle.com/javase/8/docs/jre/api/net/httpserver/spec/com/sun/net/httpserver/HttpServer.html">JDK付属のHttpServer</a>
で動かしたいので <span class="docutils literal"><span class="pre">jersey-container-jdk-http</span></span> を追加します。
どんなコンテナが使えるかは <a class="reference external" href="http://repo1.maven.org/maven2/org/glassfish/jersey/containers/">http://repo1.maven.org/maven2/org/glassfish/jersey/containers/</a> を参照ください。
最後にJUnitでサクッと走らせてテストするため <span class="docutils literal"><span class="pre">jersey-test-framework-provider-jdk-http</span></span> を追加します。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-server<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-container-jdk-http<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.test-framework.providers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-test-framework-provider-jdk-http<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<p>とまあ、こんな感じで良いでしょう。</p>
<p>でもこんなことチンタラやってられないと思うので <a class="reference external" href="https://github.com/backpaper0/sandbox">https://github.com/backpaper0/sandbox</a> をcloneして
<span class="docutils literal"><span class="pre">jersey-blank</span></span> ディレクトリ内の <span class="docutils literal"><span class="pre">pom.xml</span></span> をご利用ください。
私も大抵、自分が過去に書いたビルドファイルをコピります。</p>
</div>
<div class="section" id="gradle">
<h3>Gradleの場合</h3>
<p>こんな感じ？</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="s1">'org.glassfish.jersey.core:jersey-server:2.13'</span>
    <span class="n">compile</span> <span class="s1">'org.glassfish.jersey.containers:jersey-container-jdk-http:2.13'</span>
    <span class="n">testCompile</span> <span class="s1">'org.glassfish.jersey.test-framework.providers:jersey-test-framework-provider-jdk-http:2.13'</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>コードを書く</h2>
<p>まあ、この辺は適当に、足し算する簡単なやつで。</p>
<p><span class="docutils literal"><span class="pre">src/main/java/app/Calc.java</span></span> を作ります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.QueryParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span><span class="p">;</span>

<span class="nd">@Path</span><span class="p">(</span><span class="s">"calc"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calc</span> <span class="p">{</span>

    <span class="nd">@Path</span><span class="p">(</span><span class="s">"add"</span><span class="p">)</span>
    <span class="nd">@GET</span>
    <span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_PLAIN</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"b"</span><span class="p">)</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>で、JUnitテストです。
<span class="docutils literal"><span class="pre">src/test/java/app/CalcTest.java</span></span> を作ります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">org.hamcrest.CoreMatchers.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.junit.Assert.*</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.ws.rs.core.Application</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.glassfish.jersey.server.ResourceConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.glassfish.jersey.test.JerseyTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalcTest</span> <span class="kd">extends</span> <span class="n">JerseyTest</span> <span class="p">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">target</span><span class="p">(</span><span class="s">"calc/add"</span><span class="p">).</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"a"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                  <span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                                  <span class="p">.</span><span class="na">request</span><span class="p">()</span>
                                  <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">is</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Application</span> <span class="nf">configure</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResourceConfig</span><span class="p">(</span><span class="n">Calc</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>test-frameworkを使うととても簡単にJUnitテストを書ける事が分かると思います。</p>
</div>
<div class="section" id="id5">
<h2>テスト走らせる</h2>
<p>IDEから実行するかMavenで。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>mvn <span class="nb">test</span>
</pre></div>
</div>
<p>簡単ですね！</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running app.CalcTest
11 30, 2014 10:55:12 午後 org.glassfish.jersey.test.jdkhttp.JdkHttpServerTestContainerFactory$JdkHttpServerTestContainer &lt;init&gt;
情報: Creating JdkHttpServerTestContainer configured at the base URI http://localhost:9998/
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5.109 sec

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0
</pre></div>
</div>
</div>
<div class="section" id="main">
<h2>mainメソッドでサーバーを立てる</h2>
<p>JUnitテストを走らせている事からもお分かり頂けると思いますが、
簡単にサーバーを立てる事もできます。</p>
<p>こんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.glassfish.jersey.jdkhttp.JdkHttpServerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.glassfish.jersey.server.ResourceConfig</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpServer</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">"http://localhost:8080/rest/"</span><span class="p">);</span>

        <span class="n">ResourceConfig</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceConfig</span><span class="p">();</span>
        <span class="n">rc</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">Calc</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="n">HttpServer</span> <span class="n">httpServer</span> <span class="o">=</span> <span class="n">JdkHttpServerFactory</span><span class="p">.</span><span class="na">createHttpServer</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
        <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">addShutdownHook</span><span class="p">(</span><span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">httpServer</span><span class="p">.</span><span class="na">stop</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"JAX-RS started"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>アプリケーションサーバにデプロイする</h2>
<p>GlassFishにデプロイする場合はdependencyのscopeをprovidedにしてWARファイルを作ってそれをデプロイすれば良いと思います。</p>
<p>Tomcatにデプロイする場合は <span class="docutils literal"><span class="pre">jersey-container-jdk-http</span></span> を消して、
<span class="docutils literal"><span class="pre">jersey-container-servlet</span></span> を追加してWARファイルを作りましょう。
こんな感じです。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-server<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-container-servlet<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<p>私はServlet APIに依存しないよう作る方がポータビリティが高そうで好きなのでscopeをruntimeにしています。
Servlet APIじゃんじゃん使いたい場合はscopeをcompileにしてください。</p>
</div>
<div class="section" id="id7">
<h2>まとめ</h2>
<p>というわけでJerseyを使用したJAX-RSの導入部分、如何でしたでしょうか？
簡単ですよね？
特にJava EEの一部なのにアプリケーションサーバがなくても簡単に使えるのが良いですよね！ね！</p>
<p>最後に、手前味噌ですがJAX-RSの参考資料を挙げておきます。</p>
<ul class="simple">
<li><a class="reference internal" href="https://backpaper0.github.io/2013/05/02/jaxrs.html"><span class="doc">JAX-RSとかの話</span></a></li>
<li><a class="reference internal" href="https://backpaper0.github.io/2013/07/07/devkan_jaxrs.html"><span class="doc">DevLOVE関西「開発スターターキット」におけるJAX-RSの簡単な解説</span></a></li>
<li><a class="reference internal" href="https://backpaper0.github.io/2014/07/21/jersey_standalone.html"><span class="doc">Jerseyをjava -jarで動かす</span></a></li>
</ul>
<p>はー、これらの資料もJAX-RS 2.0にアップデートしないといけないなー（しろめ</p>
<p>簡単ですが、以上。</p>
</div>
]]></description>
             <pubDate>Mon, 01 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/01/syobochim_advent_calendar_2014.html</link>
            <guid>https://backpaper0.github.io/2014/12/01/syobochim_advent_calendar_2014.html</guid>
            <title><![CDATA[Tinkererのしょぼちむテーマ作った #syobochim]]></title>
            <description><![CDATA[<h1>Tinkererのしょぼちむテーマ作った #syobochim</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/327">しょぼちむ Advent Calendar 2014</a>
の1日目です。</p>
<p><a class="reference external" href="https://twitter.com/syobochim">しょぼちむ</a> とは、</p>
<ul class="simple">
<li>レッドキングをこよなく愛し</li>
<li>Kotlinアイドルであり（Kotlinやったことないけど）</li>
<li>でもClojureやってたりして</li>
<li><a class="reference external" href="http://syobochim.github.io/DEVLOVESlide/#/">DevLOVE甲子園でLTを頑張り</a></li>
<li><a class="reference external" href="http://syobochim.hatenablog.com/">そこに仁義はあるのか(仮)</a> というブログを書いている</li>
</ul>
<p>そんな若手エンジニアです。</p>
<p>このアドベントカレンダーではみんなで毎日しょぼちむに関する何かを書こうというもので、
作った当初は全日程埋まるか本人も心配していましたが割と早々に埋まったので良かったね、っていう。</p>
<p>Java EE アドベントカレンダーよりも早く埋まったのは少々複雑でありますが！
いや、でも、埋まって良かったね！</p>
<div class="section" id="id3">
<h2>本題</h2>
<p>さて、今回はこのブログの基盤となっているブログツール、
<a class="reference external" href="http://tinkerer.me/">Tinkerer</a> のカスタムテーマを作ってみました。
と言ってもゼロから作るようなセンスは皆無なので、組込みの modern5 というテーマをコピーして
ウルトラ怪獣としょぼちむカラーを混ぜ込んでみました。</p>
<p>今後、もとのテーマに戻した場合を考慮してスクリーンショット貼っておきます。</p>
<img alt="../../../_images/syobochim-theme.png" src="https://backpaper0.github.io/_images/syobochim-theme.png"/>
<p>ヘッダ、本文、サイドバーなどの構成や基本的なカラーリングは modern5 のままですが、
ヘッダの背景色とリンクの色を変えてしょぼちむカラーにし、ヘッダの背景画像とセクションの見出しに
ウルトラ怪獣の絵をはめ込みました。
余談ですが、私はバルタン星人が好きです(V)o\o(V)フォフォフォ。</p>
<p>あと、ブログタイトルをしょぼちむのブログっぽくするためbefore疑似要素、after疑似要素で文章を足しています。
念のため書いておきますが、このブログのタイトルは「裏紙」です。</p>
<p>……といった所で、残念ながらだいぶ力尽きました。
己のHTMLちから不足、CSSちから不足、Tinkererちから不足などに凹みました。</p>
<p>まあやり過ぎるよりは良いかー、と言う感じでどうかひとつ！
このとおりだ！</p>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<p>ここまで”しょぼちむカラー”の説明なし！</p>
</div>
<div class="section" id="id5">
<h2>おまけ</h2>
<p>セクションの見出しの前に出してるレッドキングがちょっとかわいく描けた気がするので
もうちょい大きいサイズも置いておきます。</p>
<img alt="../../../_images/redking.png" src="https://backpaper0.github.io/_images/redking.png"/>
</div>
]]></description>
             <pubDate>Mon, 01 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/12/01/irof_advent_calendar_2014.html</link>
            <guid>https://backpaper0.github.io/2014/12/01/irof_advent_calendar_2014.html</guid>
            <title><![CDATA[スタックトレースろふ #irof]]></title>
            <description><![CDATA[<h1>スタックトレースろふ #irof</h1>
<p>これは <a class="reference external" href="http://www.adventar.org/calendars/331">いろふ Advent Calendar 2014</a> の1日目です。</p>
<p>いろふアドベントカレンダーとは、我らが <a class="reference external" href="https://twitter.com/irof">いろふさん</a>
への愛をワールドワイドなインターネッツに大公開する感じのやつです。</p>
<p>いろふさんをご存じない方はTwitterでﾋｮﾛｰをキメて、著書である養成読本を熟読すると良いですよ！</p>
<ul class="simple">
<li><a class="reference external" href="http://gihyo.jp/book/2014/978-4-7741-6931-6">Javaエンジニア養成読本［現場で役立つ最新知識、満載！］：書籍案内｜技術評論社</a></li>
</ul>
<div class="section" id="id2">
<h2>本編という名の出オチ</h2>
<p>こちらのリポジトリをcloneして、</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox">https://github.com/backpaper0/sandbox</a></li>
</ul>
<p>irofディレクトリに移動し <span class="docutils literal"><span class="pre">gradlew</span> <span class="pre">run</span></span> してください。</p>
<p>するとこうなります。</p>
<img alt="../../../_images/stacktracerof.png" src="https://backpaper0.github.io/_images/stacktracerof.png"/>
<p>なんといろふさんが例外吐いて終了しました！ (-∧-；)　ﾅﾑｰ</p>
</div>
<div class="section" id="id3">
<h2>投げっぱなしの解説</h2>
<p>Java言語ではメソッド名に空白や記号を使えませんがクラスファイルとJVM的にはもうちょい制約緩いっぽいので
その辺を利用してスタックトレースでいろふさんを描きました。</p>
<p>いろふさんのアイコンからAAを作ったのは次のサービスです。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.text-image.com/convert/ascii.html">http://www.text-image.com/convert/ascii.html</a></li>
</ul>
<p>で、クラスファイルを書き出したのはASMというライブラリです。</p>
<ul class="simple">
<li><a class="reference external" href="http://asm.ow2.org/">http://asm.ow2.org/</a></li>
</ul>
<p>ASMの <a class="reference external" href="http://asm.ow2.org/asm50/javadoc/user/org/objectweb/asm/ClassWriter.html">ClassWriter</a>
と <a class="reference external" href="http://asm.ow2.org/asm50/javadoc/user/org/objectweb/asm/commons/GeneratorAdapter.html">GeneratorAdapter</a>
を使えば割と簡単にクラスファイルを書き出す事ができます。
詳しくはGeneratorAdapterのJavadocと今回のいろふソースコードを参照ください。</p>
<p>それと今回は使っていませんが <a class="reference external" href="http://asm.ow2.org/asm50/javadoc/user/org/objectweb/asm/ClassReader.html">ClassReader</a>
を使うとクラスファイルを読む事ができます。</p>
<p>例えばインスタンスメソッドを実行してるコードを見つけて標準出力に書き出すようなアレは次のように書けます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">ClassReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassReader</span><span class="p">(</span><span class="s">"irof.Irof"</span><span class="p">);</span>

<span class="n">MethodVisitor</span> <span class="n">methodVisitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodVisitor</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ASM5</span><span class="p">)</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">visitMethodInsn</span><span class="p">(</span><span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">String</span> <span class="n">owner</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">desc</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">itf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Opcodes</span><span class="p">.</span><span class="na">INVOKEVIRTUAL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">"owner=%1$s name=%2$s desc=%3$s%n"</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">ClassVisitor</span> <span class="n">classVisitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassVisitor</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ASM5</span><span class="p">)</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">MethodVisitor</span> <span class="nf">visitMethod</span><span class="p">(</span><span class="kt">int</span> <span class="n">access</span><span class="p">,</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">desc</span><span class="p">,</span> <span class="n">String</span> <span class="n">signature</span><span class="p">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">exceptions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">methodVisitor</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">reader</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">classVisitor</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>ちなみにASMはJDKにも入っています。
<span class="docutils literal"><span class="pre">rt.jar</span></span> の <span class="docutils literal"><span class="pre">com.sun.xml.internal.ws.org.objectweb.asm</span></span> 以下がそうですね。
JAX-WSに使われているようです。</p>
<p>あと <a class="reference external" href="http://repo1.maven.org/maven2/org/glassfish/jersey/core/jersey-server/">jersey-server</a> にも使われています。
<span class="docutils literal"><span class="pre">jersey.repackaged.org.objectweb.asm</span></span> 以下がそうです。</p>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<p>いざやってみるとすんなり出来ちゃって変態度が低すぎてアレですが、まあいいか。</p>
</div>
]]></description>
             <pubDate>Mon, 01 Dec 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/11/12/java_engineer_training_book.html</link>
            <guid>https://backpaper0.github.io/2014/11/12/java_engineer_training_book.html</guid>
            <title><![CDATA[「Javaエンジニア養成読本」読んだ]]></title>
            <description><![CDATA[<h1>「Javaエンジニア養成読本」読んだ</h1>
<p>献本して頂きました。
私を推薦してくれたのざきひろふみさん、ありがとうございます！</p>
<ul class="simple">
<li><a class="reference external" href="http://gihyo.jp/book/2014/978-4-7741-6931-6">Javaエンジニア養成読本［現場で役立つ最新知識、満載！］：書籍案内｜技術評論社</a></li>
</ul>
<p>この本は経験の浅いJavaエンジニアがふつうのJavaエンジニアになるために必要な技術的な知識
(と技術以外の知識)
を一度に取り入れる事ができるような内容になっています。</p>
<p>「特集1」ではJava入門という事で誰もが通る道について解説されています。
ただしよくある入門書のように制御文やintの取りうる範囲、演算子の優先順位などをちまちま解説したりはしません。</p>
<p>その代わりJava言語の要であるクラスについて2章をまるごと使って解説しています。
トップレベルのクラス、インナークラス、staticなネストしたクラス、匿名クラスの違いを説明できますか？
この本を読めば説明できるようになります。</p>
<p>また、例外の扱いかたについても実践的な視点で書かれています。
しっかり読んで <span class="docutils literal"><span class="pre">e.printStackTrace()</span></span> から卒業しましょう。</p>
<p>「特集2」ではラムダ式とStream APIについてコンパクトながらも分かりやすく解説しています。
文法や使い方だけでなくラムダ式がなぜ必要になったのかもよく分かります。</p>
<p>「特集3」はJava EEです。
広大なJava EEの仕様群からServlet、JSF、JAX-RS、JPA、CDI、EJBをピックアップして解説しています。
Java EEの主要技術の雰囲気を掴めるのではないでしょうか。</p>
<p>「特集4」ではJavaの技術ではなくチーム開発に必要な知識として
Git、Maven、JUnit、Jenkinsについてそれらが必要となる背景や導入方法、
使用上の注意点などが解説されています。
もはやEclipseでWAR作ってるなどと言う現場はないと思いますが、
これら(あるいはこれらに類する他のツール)を導入していない場合はこの特集が役立つでしょう。</p>
<p>ページは前後しますが、「巻頭記事」ではJavaの歴史とJavaにまつわる(しょーもない)ネタを解説しています。
これを一読しておくとTwitterをより楽しめるようになりますたぶん。</p>
<p>そして一番後ろに記載されている「一般記事」は少々趣が変わり、
受託開発の現場で必要となるスキルが簡潔にまとめられています。
Excelにスクリーンショットを貼付けるといった (´；ω；｀)ｳｯ… となるスキルにも触れていますが、
Java以外にもこういうスキルが必要なんだなと理解できる内容になっています。</p>
<div class="section" id="id2">
<h2>細かい感想・気になった点など</h2>
<p>というわけで細かい部分を挙げていきます。</p>
<ul>
<li><p class="first">29ページ。</p>
<blockquote>
<div><p>通常の業務システムを開発する中でアノテーションを作成することは少ないので”</p>
</div></blockquote>
<p>CDIというものがあってだな（ry</p>
</li>
<li><p class="first">30ページ。</p>
<p>インナークラスに名前付き定数を持てるの知らなかった。
勉強になりました！</p>
</li>
<li><p class="first">34ページ、リスト19。</p>
<p>複数コンストラクタを用意する場合、
オプション引数は後ろの引数(ここでいうと <span class="docutils literal"><span class="pre">b</span></span> )にする方が一般的と思います。</p>
</li>
<li><p class="first">35ページ。</p>
<blockquote>
<div><p>例外オブジェクトには例外が発生した時の状態が詰め込まれてます。</p>
</div></blockquote>
<p>「状態」よりも「情報」の方がしっくりくるかなー。
前章で可変と不変について言及しているのも相まって分かりにくい気がしました。</p>
</li>
<li><p class="first">38、39ページ。</p>
<p><a class="reference external" href="https://docs.oracle.com/javase/jp/8/api/java/lang/reflect/InvocationTargetException.html">InvocationTargetException</a> は他のリフレクション例外と意味合いがちょっと違うと思っています。
他のリフレクション例外が「指定されたメソッドを実行できなかった」のに対して
InvocationTargetExceptionは「指定されたメソッドを実行中に例外が発生した」という状況です。
それによってハンドリングが変わるかどうかはケースバイケースとは思いますが。
あとここはマルチキャッチについて書いてて、たまたまリフレクション使っただけなので
InvocationTargetExceptionの扱いとか関係無いか。
まあ気になったということで。</p>
<p>気になったと言えば例外の中では <a class="reference external" href="https://docs.oracle.com/javase/jp/8/api/java/lang/InterruptedException.html">InterruptedException</a> の扱いにも注意が必要と思うので
言及しておいたほうが良いのではと一瞬思いましたが、
後のほうでマルチスレッドはうかつに触るなって書いてあるしまあいいか。</p>
</li>
<li><p class="first">43ページ。</p>
<p>Java 1.7のtry-with-resources構文のために追加された
<a class="reference external" href="https://docs.oracle.com/javase/jp/8/api/java/lang/Throwable.html#addSuppressed-java.lang.Throwable-">Throwable#addSuppressed(Throwable)</a> も使えそうですね。</p>
</li>
<li><p class="first">68ページ、リスト6。69ページ。</p>
<p><a class="reference external" href="https://docs.oracle.com/javase/jp/8/api/java/nio/file/Files.html#lines-java.nio.file.Path-">Files.lines()</a> をtry-with-resourcesでクローズしてるのは流石だと思いました。
ここはハマりどころになりそうな気がしますねー。</p>
</li>
<li><p class="first">87ページ、リスト5。</p>
<blockquote>
<div><p>ボタンの押下時にAjaxで処理</p>
</div></blockquote>
<p>“押下”の現場感すごい。</p>
</li>
<li><p class="first">95、96ページ。</p>
<p>JAXB経由のJSONプロバイダはJAX-RSの標準仕様ではない(ですよね？)から注意が必要ですね。</p>
</li>
<li><p class="first">98ページ、リスト3</p>
<p>JPAにおけるReadとUpdate。
mergeはupdateではなくて永続コンテキスト外のエンティティを
永続コンテキストに突っ込む行為と思います。
<span class="docutils literal"><span class="pre">em.find(clazz,</span> <span class="pre">id)</span></span> したエンティティは永続コンテキストで管理されているので
mergeする必要はないですよね？
……とか思っていたら100ページでmergeの説明があった。</p>
</li>
<li><p class="first">105ページ。</p>
<blockquote>
<div><p>モックによってテスト容易性を高めたり、</p>
</div></blockquote>
<p>具体例が欲しい気がしました。
CDIのalternativeはbeans.xmlを編集しなきゃいけなかったりして面倒い。
個人的にはCDIを使う場合はユニットテストにはGuiceを使うのが楽で良いと思っています。</p>
</li>
</ul>
<p>あと、JVMへの言及が見当たらないのが気になりました。
<span class="docutils literal"><span class="pre">-Xmx</span></span> とか。</p>
<p>Java EEは、範囲が広くて仕様がでかいので仕方ないのですが、
内容が薄めだと感じてしまいました。
いっそJAX-RSやCDIなどの各仕様の説明はもっとシンプルにして、
チュートリアルを手厚くするという手もあったのかもかなー、などと無責任に思いました。</p>
<p>特にServletとEJBの説明はなくても良かったかも知れませんね。
すっぴんのサーブレットは使わないしEJBはトランザクション境界が欲しいってのが殆どと思いますし。
デカい案件やったことないので見当違いの意見かもしれませんが。</p>
</div>
<div class="section" id="id3">
<h2>まとめ</h2>
<p>というわけで、色々と細かいことも書きましたが総合的には間違い無く良書だと思っています。
冒頭にも書きましたがこの本は経験の浅いJavaエンジニアの皆様へオススメです。
この本を読んで学んで楽しいJavaライフを送りましょう！</p>
<p>あなたと！</p>
<p>(続きははてなブックマークのコメントでお願いします)</p>
</div>
<div class="section" id="id4">
<h2>執筆陣のブログエントリ</h2>
<p>まだ買ってないひとはキクタローさんのブログのアフィリンクから買おう！</p>
<ul class="simple">
<li><a class="reference external" href="http://kikutaro777.hatenablog.com/entry/2014/11/03/191215">http://kikutaro777.hatenablog.com/entry/2014/11/03/191215</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/irof/20141104/p1">http://d.hatena.ne.jp/irof/20141104/p1</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/bitter_fox/20141111/1415687739">http://d.hatena.ne.jp/bitter_fox/20141111/1415687739</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/nowokay/20141114">http://d.hatena.ne.jp/nowokay/20141114</a></li>
</ul>
</div>
<div class="section" id="id5">
<h2>他の書評</h2>
<ul class="simple">
<li><a class="reference external" href="http://vividcode.hatenablog.com/entry/book/java-engineer-dokuhon">http://vividcode.hatenablog.com/entry/book/java-engineer-dokuhon</a></li>
</ul>
</div>
]]></description>
             <pubDate>Wed, 12 Nov 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/11/08/semicolonless_tail_call_optimization.html</link>
            <guid>https://backpaper0.github.io/2014/11/08/semicolonless_tail_call_optimization.html</guid>
            <title><![CDATA[セミコロンレスJavaで末尾再帰の最適化]]></title>
            <description><![CDATA[<h1>セミコロンレスJavaで末尾再帰の最適化</h1>
<p><a class="reference internal" href="https://backpaper0.github.io/2014/11/03/semicolonless_java_fibonacci_without_z_combinator.html"><span class="doc">前回</span></a>
はセミコロンレスJavaで再帰ができる事が分かりました。</p>
<p>ただし再帰しすぎるとスタックオーバーフローでしにます。</p>
<p>再帰による <span class="docutils literal"><span class="pre">1</span> <span class="pre">+</span> <span class="pre">2</span> <span class="pre">+</span> <span class="pre">...</span> <span class="pre">+</span> <span class="pre">n</span></span> を見てみましょう。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessRecursion</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">))</span>
            <span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">of</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">m</span> <span class="o">+</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">sum</span> <span class="o">-&gt;</span> <span class="n">sum</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">sum</span><span class="p">,</span> <span class="n">n</span><span class="p">)))</span>
            <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">)</span>
            <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">F</span><span class="o">&lt;</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">BiFunction</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&lt;</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>とっても分かりやすいコードですが <span class="docutils literal"><span class="pre">n</span></span> に <span class="docutils literal"><span class="pre">10000</span></span> 程度を与えただけでスタックオーバーフローになります。</p>
<p>この再帰を末尾再帰にして最適化を行うのが今回の目的です。</p>
<div class="section" id="id1">
<h2>普通のJavaで末尾再帰最適化</h2>
<p>最初からセミコロンレスJavaで考えてもしんどいだけなので、
まずは普通のJavaで末尾再帰最適化版のコードを書いてみます。
実装するに当たって
<a class="reference external" href="http://www.oreilly.co.jp/books/9784873117041/">「Javaによる関数型プログラミング」</a>
の7章を参考にしました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TailCallOptimization</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>

        <span class="n">F</span> <span class="n">sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">done</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">:</span> <span class="n">call</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">p</span><span class="p">));</span>

        <span class="n">TailCall</span> <span class="n">t</span> <span class="o">=</span> <span class="n">sum</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">sum</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="n">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">.</span><span class="na">iterate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TailCall</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">TailCall</span><span class="p">::</span><span class="n">result</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">findFirst</span><span class="p">()</span>
                               <span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">F</span> <span class="p">{</span>

        <span class="n">TailCall</span> <span class="nf">apply</span><span class="p">(</span><span class="n">F</span> <span class="n">f</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">p</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">r</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="n">TailCall</span> <span class="nf">call</span><span class="p">(</span><span class="n">TailCall</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="n">TailCall</span> <span class="nf">done</span><span class="p">(</span><span class="n">Integer</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">TailCall</span><span class="p">()</span> <span class="p">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">TailCall</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">result</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">TailCall</span> <span class="p">{</span>

        <span class="n">TailCall</span> <span class="nf">get</span><span class="p">();</span>

        <span class="k">default</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">result</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>多少セミコロンレスJavaへの変換を意識していますが普通のJavaです。
これをセミコロンレスJavaにしていきます。</p>
</div>
<div class="section" id="id3">
<h2>セミコロンレス化の布石</h2>
<p>Java 8時代におけるセミコロンレスJavaの鍵はラムダ式だと思っています。
値を返すメソッドの定義が出来ないセミコロンレスJavaですが、
ラムダ式を使う事でセミコロンレスに関数を定義する事が可能です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//ふたつのintを足して返す関数を定義して2, 3に適用する</span>
<span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
    <span class="p">.</span><span class="o">&lt;</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">BinaryOperator</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">of</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">add</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">)</span>
    <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ラムダ式を使う為に必要となるのは関数型インターフェースです。
セミコロンレスJavaではインターフェースの定義は出来ますが、その中でメソッド定義が出来ません。
ただし、幸いにもJavaの標準APIには関数型インターフェースが豊富に用意されているので
それらをextendsすることで用途に特化した関数型インターフェースを手に入れる事ができます。</p>
<p>まず <span class="docutils literal"><span class="pre">TailCall</span></span> を関数型インターフェースにする事から始めましょう。
ここでの課題は <span class="docutils literal"><span class="pre">get()</span></span> と <span class="docutils literal"><span class="pre">result()</span></span> の一本化です。
今のままではどうしても匿名クラスを導入する必要があります。</p>
<p><span class="docutils literal"><span class="pre">TailCall</span></span> と <span class="docutils literal"><span class="pre">Optional&lt;Integer&gt;</span></span> の <span class="docutils literal"><span class="pre">Pair</span></span> を返す <span class="docutils literal"><span class="pre">Supplier</span></span> とすることで
<span class="docutils literal"><span class="pre">TailCall</span></span> を関数型インターフェースにできました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">interface</span> <span class="nc">TailCall</span> <span class="kd">extends</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">TailCall</span><span class="p">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span><span class="p">{}</span>
</pre></div>
</div>
<p>これにより <span class="docutils literal"><span class="pre">done(Integer)</span></span> が返す値を匿名クラスではなくラムダ式で書けるようになりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">static</span> <span class="n">TailCall</span> <span class="nf">done</span><span class="p">(</span><span class="n">Integer</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>また <span class="docutils literal"><span class="pre">call(TailCall)</span></span> は次のように変更します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">static</span> <span class="n">TailCall</span> <span class="nf">call</span><span class="p">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">TailCall</span><span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>こうすることで関数 <span class="docutils literal"><span class="pre">sum</span></span> は次のように書けます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">F</span> <span class="n">sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">done</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">:</span> <span class="n">call</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">p</span><span class="p">));</span>
</pre></div>
</div>
<p>それから結果を求める <span class="docutils literal"><span class="pre">Stream</span></span> 操作ですが、
普通の再帰版では <span class="docutils literal"><span class="pre">TailCall</span></span> の <span class="docutils literal"><span class="pre">get()</span></span> を呼び出すことで <span class="docutils literal"><span class="pre">Stream</span></span>
を構築していましたが <span class="docutils literal"><span class="pre">get()</span></span> が <span class="docutils literal"><span class="pre">Pair&lt;TailCall,</span> <span class="pre">Optional&lt;Integer&gt;&gt;</span></span>
を返すようにしたので、
<span class="docutils literal"><span class="pre">Pair&lt;TailCall,</span> <span class="pre">Optional&lt;Integer&gt;&gt;</span></span> の <span class="docutils literal"><span class="pre">Stream</span></span> を構築するようにします。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Stream</span><span class="p">.</span><span class="na">iterate</span><span class="p">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">empty</span><span class="p">()),</span>
               <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">getKey</span><span class="p">().</span><span class="na">get</span><span class="p">())</span>
      <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Pair</span><span class="p">::</span><span class="n">getValue</span><span class="p">)</span>
      <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span>
      <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
      <span class="p">.</span><span class="na">findFirst</span><span class="p">()</span>
      <span class="p">.</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<p>ここまでのコード全体を次に記載します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Supplier</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javafx.util.Pair</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TailCallOptimization</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>

        <span class="n">F</span> <span class="n">sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">done</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">:</span> <span class="n">call</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">p</span><span class="p">));</span>

        <span class="n">TailCall</span> <span class="n">t</span> <span class="o">=</span> <span class="n">sum</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">sum</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="n">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">.</span><span class="na">iterate</span><span class="p">(</span><span class="k">new</span> <span class="n">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">empty</span><span class="p">()),</span>
                                        <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">getKey</span><span class="p">().</span><span class="na">get</span><span class="p">()).</span><span class="na">map</span><span class="p">(</span><span class="n">Pair</span><span class="p">::</span><span class="n">getValue</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
                               <span class="p">.</span><span class="na">findFirst</span><span class="p">()</span>
                               <span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">F</span> <span class="p">{</span>

        <span class="n">TailCall</span> <span class="nf">apply</span><span class="p">(</span><span class="n">F</span> <span class="n">f</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">p</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">r</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="n">TailCall</span> <span class="nf">call</span><span class="p">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">TailCall</span><span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="n">TailCall</span> <span class="nf">done</span><span class="p">(</span><span class="n">Integer</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">TailCall</span> <span class="kd">extends</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">TailCall</span><span class="p">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>そしてセミコロンレスへ……</h2>
<p>あとはちょっとずつまとめたりなんやかんやしてセミコロンレスJavaに変更していきます。</p>
<p>というわけでセミコロンレスJavaで末尾再帰最適化を行ったコードが次になります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessTailCallOptimization</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">))</span>
            <span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span> <span class="nf">of</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&lt;</span> <span class="mi">1</span>
                <span class="o">?</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">javafx</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">pr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">))</span>
                <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">javafx</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]</span> <span class="p">{</span> <span class="n">pr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="n">pr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">}),</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">()))</span>
            <span class="p">.</span><span class="o">&lt;</span><span class="n">TailCall</span><span class="o">&gt;</span> <span class="nf">map</span><span class="p">(</span><span class="n">sum</span> <span class="o">-&gt;</span> <span class="n">sum</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">sum</span><span class="p">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]</span> <span class="p">{</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span> <span class="p">})))</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span>
            <span class="p">.</span><span class="na">iterate</span><span class="p">(</span><span class="k">new</span> <span class="n">javafx</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Pair</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">empty</span><span class="p">()),</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">getKey</span><span class="p">().</span><span class="na">get</span><span class="p">())</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">javafx</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Pair</span><span class="p">::</span><span class="n">getValue</span><span class="p">)</span>
            <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span>
            <span class="p">.</span><span class="na">findFirst</span><span class="p">()</span>
            <span class="p">.</span><span class="na">get</span><span class="p">())</span>
            <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">)</span>
            <span class="p">.</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">F</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">BiFunction</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="kt">int</span><span class="o">[]</span><span class="p">,</span> <span class="n">TailCall</span><span class="o">&gt;</span> <span class="p">{}</span>

    <span class="kd">interface</span> <span class="nc">TailCall</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">Supplier</span><span class="o">&lt;</span><span class="n">javafx</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Pair</span><span class="o">&lt;</span><span class="n">TailCall</span><span class="p">,</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>まとめ</h2>
<p>セミコロンレスJavaでも末尾再帰の最適化が出来る事が分かりました。
これによりセミコロンレスJavaがまた一歩、実用的な言語へと近づいたと思われます。</p>
<p>なお、今回は <span class="docutils literal"><span class="pre">javax.util.Pair</span></span> を使用しましたが、これが大変便利でした。
特にふたつの値を返す場合に今までは配列あたりを使用していたのでキャストが必須になっていましたが、
<span class="docutils literal"><span class="pre">Pair</span></span> があればキャストも不要でコードがすっきりしました。
また、ふたつ以上の値を返す場合は <span class="docutils literal"><span class="pre">Pair&lt;T,</span> <span class="pre">Pair&lt;U,</span> <span class="pre">V&gt;&gt;</span></span> などとすれば良いですね。</p>
<p>というわけでこれからもセミコロンレスJavaの可能性を探って行きたいと思います。</p>
</div>
]]></description>
             <pubDate>Sat, 08 Nov 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/11/03/semicolonless_java_fibonacci_without_z_combinator.html</link>
            <guid>https://backpaper0.github.io/2014/11/03/semicolonless_java_fibonacci_without_z_combinator.html</guid>
            <title><![CDATA[セミコロンレスJavaでフィボナッチをZコンビネータなしで]]></title>
            <description><![CDATA[<h1>セミコロンレスJavaでフィボナッチをZコンビネータなしで</h1>
<p><a class="reference internal" href="https://backpaper0.github.io/2014/11/02/semicolonless_java_fibonacci.html"><span class="doc">セミコロンレスJavaでフィボナッチ</span></a> でZコンビネータ使って再帰だ！(ドヤ)
とか書きましたがそんなものは必要なかった。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFibonacci</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span><span class="p">.</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span> <span class="nf">of</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">n</span> <span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)))</span>
            <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">).</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">F</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">BiFunction</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>難しく考え過ぎんなって話ですね_(:3｣∠)_</p>
]]></description>
             <pubDate>Mon, 03 Nov 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/11/02/semicolonless_java_fibonacci.html</link>
            <guid>https://backpaper0.github.io/2014/11/02/semicolonless_java_fibonacci.html</guid>
            <title><![CDATA[セミコロンレスJavaでフィボナッチ]]></title>
            <description><![CDATA[<h1>セミコロンレスJavaでフィボナッチ</h1>
<p>概要：ネタでしかない</p>
<div class="section" id="id1">
<h2>セミコロンレスJavaとは</h2>
<p>以下を参照ください。</p>
<ul class="simple">
<li><a class="reference external" href="http://seesaawiki.jp/w/semicolonlessjava/">Semicolonless Java公式Wiki</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/Nagise/20100321/1269182606">Javaでセミコロンなしでプログラムを書く - プログラマーの脳みそ</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/Nagise/20131111/1384170146">Semicolonless Java8 - プログラマーの脳みそ</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/bitter_fox/20141022/1413947357">セミコロンレスJavaはJava8の夢を見るか？ - bitter_foxの日記</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/bitter_fox/20141022/1413955082">セミコロンレスJavaはJava8の夢を見るか？～変数編～ - bitter_foxの日記</a></li>
</ul>
</div>
<div class="section" id="id4">
<h2>ある項のフィボナッチ数を書き出す</h2>
<p>結論から行きましょう。</p>
<p>ある項のフィボナッチ数を書き出すプログラムですが、こんなコードになりました。
うわ横に長え。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemicolonlessFibonacci</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">stream</span><span class="p">.</span><span class="na">Stream</span><span class="p">.</span><span class="o">&lt;</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">Function</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;&gt;</span> <span class="nf">of</span><span class="p">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">n</span> <span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="p">((</span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">Function</span><span class="o">&lt;</span><span class="n">G</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span><span class="p">)))).</span><span class="na">apply</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span><span class="p">))))</span>
            <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">fib</span> <span class="o">-&gt;</span> <span class="n">fib</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)))</span>
            <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">).</span><span class="na">findFirst</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">interface</span> <span class="nc">F</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">Function</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="p">{}</span>

    <span class="kd">interface</span> <span class="nc">G</span> <span class="kd">extends</span> <span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">function</span><span class="p">.</span><span class="na">Function</span><span class="o">&lt;</span><span class="n">G</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これを <span class="docutils literal"><span class="pre">SemicolonlessFibonacci.java</span></span> という名前で保存して
<span class="docutils literal"><span class="pre">javac</span> <span class="pre">SemicolonlessFibonacci.java</span></span> でコンパイルし、
<span class="docutils literal"><span class="pre">java</span> <span class="pre">-cp</span> <span class="pre">.</span> <span class="pre">SemicolonlessFibonacci</span> <span class="pre">10</span></span> というふうに実行してください。</p>
<p>引数をいろいろ変えて試すと標準出力にフィボナッチ数が書き出されることがお分かり頂けると思います。</p>
</div>
<div class="section" id="id5">
<h2>やりたかったこと</h2>
<p>今回、実現したかったことはステートレスな再帰です。</p>
<p>セミコロンレスJavaでは戻り値をもつメソッドを定義できない( <span class="docutils literal"><span class="pre">return</span></span> にはセミコロンが必須のため )
という制限のためミュータブルなオブジェクトを引数にしてそれを更新することでメソッドの呼び出し元に値を戻すしかありません。
たぶん。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//戻り値のあるメソッドはreturnでセミコロン必要</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//ミュータブルな引数で値を戻す</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">holder</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">holder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">"hoge"</span><span class="p">))</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>セミコロンレスJava 8からはラムダ式を使えば戻り値をもつ処理を定義できるようになりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">if</span> <span class="p">(</span><span class="n">Stream</span><span class="p">.</span><span class="o">&lt;</span><span class="n">IntBinaryOperator</span><span class="o">&gt;</span> <span class="nf">of</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="c1">//二つのintを足して返す関数を定義</span>
          <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">applyAsInt</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>            <span class="c1">//関数適用</span>
          <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">)</span>               <span class="c1">//出力</span>
          <span class="p">.</span><span class="na">findFirst</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ですが、自身を再帰呼び出しすることはできません。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="c1">//これはセミコロンJava……ていうかJava</span>
<span class="n">IntUnaryOperator</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="n">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                                           <span class="c1">//~~~ コンパイルエラー</span>
</pre></div>
</div>
</div>
<div class="section" id="z">
<h2>Zコンビネータ</h2>
<p>これらの問題を解決するのがZコンビネータです。</p>
<ul class="simple">
<li><a class="reference external" href="http://ja.wikipedia.org/wiki/%E4%B8%8D%E5%8B%95%E7%82%B9%E3%82%B3%E3%83%B3%E3%83%93%E3%83%8D%E3%83%BC%E3%82%BF#Z.E3.82.B3.E3.83.B3.E3.83.93.E3.83.8D.E3.83.BC.E3.82.BF">不動点コンビネータ - Wikipedia</a></li>
</ul>
<p>この辺は全然詳しくないんですがラムダ計算で再帰を行うことが出来るアレっぽいです。
きしださんのエントリも参考にさせて頂きました。</p>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/nowokay/20090409">おとうさん、ぼくにもYコンビネータがわかりましたよ！ - きしだのはてな</a></li>
</ul>
<p>再帰するにはYコンビネータというのもあるようですが正格評価戦略の言語ではスタックオーバーフローになるっぽいです。
ていうかなりました。</p>
<p>というわけでZコンビネータです。
その定義は次の通りです。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>Z = λf. (λx. f (λy. x x y)) (λx. f (λy. x x y))
</pre></div>
</div>
<p>これをJavaで書くとこんな感じになりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">static</span> <span class="n">F</span> <span class="nf">z</span><span class="p">(</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Function</span><span class="o">&lt;</span><span class="n">G</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>
    <span class="n">G</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="na">apply</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">interface</span> <span class="nc">F</span> <span class="kd">extends</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="p">{}</span>

<span class="kd">interface</span> <span class="nc">G</span> <span class="kd">extends</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">G</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="p">{}</span>
</pre></div>
</div>
<p>このzメソッドを用いてフィボナッチ数を求める処理を再帰で書いたのが次になります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Function</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">n</span> <span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                                        <span class="c1">//~~~~~~~~~~~~~~   ~~~~~~~~~~~~~~ この辺が再帰</span>

<span class="n">F</span> <span class="n">fib</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">fib</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="mi">11</span><span class="p">));</span> <span class="c1">//11番目のフィボナッチ数を出力する</span>
</pre></div>
</div>
<p>あとはセミコロンを消す為になんやかんやいろいろやって一番最初のコードになりました。</p>
</div>
<div class="section" id="id6">
<h2>まとめ</h2>
<p>Java 8時代になりセミコロンレスJavaでも再帰を使えるようになりました。
これによりセミコロンレスJava 8が秘めたる可能性を更に感じる事ができました。</p>
<p>今回は末尾再帰最適化まで考える力は残っていませんでしたが、
<a class="reference external" href="http://www.oreilly.co.jp/books/9784873117041/">「Javaによる関数型プログラミング」</a>
の7章を参考にすればなんとかなるかもしれません。
ならないかもしれません。</p>
<p>みなさんもセミコロンレスJavaをはじめてみませんか？
みませんね。
はい、ごめんなさい。</p>
<p>続き： <a class="reference internal" href="https://backpaper0.github.io/2014/11/03/semicolonless_java_fibonacci_without_z_combinator.html"><span class="doc">セミコロンレスJavaでフィボナッチをZコンビネータなしで</span></a></p>
</div>
]]></description>
             <pubDate>Sun, 02 Nov 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/11/01/prefix_domain.html</link>
            <guid>https://backpaper0.github.io/2014/11/01/prefix_domain.html</guid>
            <title><![CDATA[前方一致の検索条件とドメインクラス #doma2]]></title>
            <description><![CDATA[<h1>前方一致の検索条件とドメインクラス #doma2</h1>
<p><a class="reference external" href="http://doma.readthedocs.org/">Doma 2</a> で前方一致の検索条件をドメインクラスでどう扱うか考えた話です。</p>
<div class="section" id="id1">
<h2>馬鹿正直にドメインクラスを使う</h2>
<p>SIerで業務アプリ作ってると検索して結果をグリッド表示する画面とかよく作ると思うんですが、
その際に前方一致の検索条件を扱う事も多いのです。</p>
<p>例えば従業員を検索するときに条件に従業員番号と所属部門番号を使えるとします。
加えて、どちらも前方一致で検索するとします。
この検索を行うDAOメソッドを何も考えずに書くとこうなります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Select</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Emp</span><span class="o">&gt;</span> <span class="nf">select</span><span class="p">(</span><span class="n">EmpId</span> <span class="n">empId</span><span class="p">,</span> <span class="n">DeptId</span> <span class="n">deptId</span><span class="p">);</span>
</pre></div>
</div>
<p>ちなみにSQLファイルは雰囲気こんな感じで。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span/><span class="k">SELECT</span> <span class="cm">/*%expand */</span><span class="o">*</span>
  <span class="k">FROM</span> <span class="n">emp</span>
 <span class="k">WHERE</span> <span class="n">empId</span> <span class="k">LIKE</span> <span class="cm">/* empId */</span><span class="s1">'AA%'</span>
   <span class="k">AND</span> <span class="n">deptId</span> <span class="k">LIKE</span> <span class="cm">/* deptId */</span><span class="s1">'BB%'</span>
</pre></div>
</div>
<p>EmpIdは従業員番号を表すドメインクラスです。
検索条件は前方一致、つまり従業員番号の後ろが欠けた中途半端な状態のものが渡される可能性があります。
そういった項目にEmpIdを使用するのはおかしいのではないでしょうか？</p>
</div>
<div class="section" id="string">
<h2>Stringを使う</h2>
<p>そこで検索条件を汎用的な型であるStringに変更します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Select</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Emp</span><span class="o">&gt;</span> <span class="nf">select</span><span class="p">(</span><span class="n">String</span> <span class="n">empId</span><span class="p">,</span> <span class="n">String</span> <span class="n">deptId</span><span class="p">);</span>
</pre></div>
</div>
<p>EmpIdの不適切な使用はなくなりましたが、
<span class="docutils literal"><span class="pre">select(deptId,</span> <span class="pre">empId)</span></span> というふうに引数の順番を間違えてもコンパイル時に検出されなくなってしまいました。</p>
</div>
<div class="section" id="prefix-domain">
<h2>ドメインクラスPrefix&lt;DOMAIN&gt;を作る</h2>
<p>というわけで考えたのがPrefix&lt;DOMAIN&gt;というドメインクラスです。</p>
<p>次にコードを記載します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.seasar.doma.Domain</span><span class="p">;</span>

<span class="nd">@Domain</span><span class="p">(</span><span class="n">valueType</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">factoryMethod</span> <span class="o">=</span> <span class="s">"of"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Prefix</span><span class="o">&lt;</span><span class="n">DOMAIN</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">private</span> <span class="nf">Prefix</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getValue</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Prefix</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">of</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="na">map</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">Prefix</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>型パラメータDOMAINには他のドメインクラスをバインドします。</p>
<p>このPrefix&lt;DOMAIN&gt;を使用するとDAOメソッドは次のようになります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Select</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Emp</span><span class="o">&gt;</span> <span class="nf">select</span><span class="p">(</span><span class="n">Prefix</span><span class="o">&lt;</span><span class="n">EmpId</span><span class="o">&gt;</span> <span class="n">empId</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">&lt;</span><span class="n">DeptId</span><span class="o">&gt;</span> <span class="n">deptId</span><span class="p">);</span>
</pre></div>
</div>
<p>これで、</p>
<ul class="simple">
<li>ドメインクラスに適しない前方一致に使用するような中途半端な状態を持てる</li>
<li>DAOメソッドの引数の順を間違えてもコンパイル時に検出できる</li>
</ul>
<p>という思いを実現する事ができました。
現時点ではベターな手法だと思っています。</p>
<p>これはドメインクラスをジェネリックなクラスに出来るが故にとれた手法ですが、
そういった事ができるようになったのは実は私の要望だったりします。</p>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/taedium/20130811/p1">ドメインクラスで型パラメータをサポート - taediumの日記</a></li>
</ul>
<p>あのときはこんなことに使えるとは露程も思っていませんでした(・ω&lt;) ﾃﾍﾍﾟﾛ</p>
<p>Doma 2良いよ！</p>
</div>
]]></description>
             <pubDate>Sat, 01 Nov 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/11/01/funcitonal_programming_in_java.html</link>
            <guid>https://backpaper0.github.io/2014/11/01/funcitonal_programming_in_java.html</guid>
            <title><![CDATA[「Javaによる関数型プログラミング」読んだ]]></title>
            <description><![CDATA[<h1>「Javaによる関数型プログラミング」読んだ</h1>
<p>さくらばさんに献本して頂きました。
ありがとうございます！</p>
<ul class="simple">
<li><a class="reference external" href="http://www.oreilly.co.jp/books/9784873117041/">Javaによる関数型プログラミング――Java 8ラムダ式とStream</a></li>
</ul>
<p>物理的に薄い本ですし、ラムダ式と関数型プログラミングへの入門として良い本だと思います。
チームの後輩に読んで欲しい。</p>
<p>関数型プログラミングへの入門に丁度いいということで、数年前にコップ本で入門を済ませていた私としては少々物足りない気がしました。
ただし7章は末尾再帰の最適化を行うという内容で、そこはJavaコンパイラはサポートしていない部分なので興味深く読みました。
恥ずかしながら、末尾再帰の最適化を自分で書くという発想は無かったので参考になります。</p>
<p>以下、気になった点を挙げます。
タイポも含む。</p>
<ul>
<li><p class="first">2〜3ページ。宣言的なコードとはどういうことかを、
いきなりラムダ式を登場させるのではなくJava 7までの語彙で説明しているのが良いですね。</p>
</li>
<li><p class="first">28ページの例2-7。
これメソッド参照になっていないのでコンパイルエラーですね。</p>
</li>
<li><p class="first">70ページ。</p>
<blockquote>
<div><p>JDKの新しい ClosableStream インターフェース</p>
</div></blockquote>
<p>とありますが、そのようなクラスはありません。</p>
<p>リリース前にはあったようですが <a class="reference external" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/rev/be6ca7197e0e">be6ca7197e0e</a> あたりで削除されました。
ちなみに ClosableStream じゃなくて Clos<strong>e</strong>ableStream でした。</p>
</li>
<li><p class="first">89ページの例4-17。
コードを引用します。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span>
    <span class="k">new</span> <span class="n">URL</span><span class="p">(</span><span class="s">"http://ichart.finance.yahoo.com/table.csv?s="</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">);</span>

  <span class="kd">final</span> <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span>
    <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="na">openStream</span><span class="p">()));</span>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">lines</span><span class="p">().</span><span class="na">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">findFirst</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>
  <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">dataItems</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">","</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="p">(</span><span class="n">dataItems</span><span class="o">[</span><span class="n">dataItems</span><span class="p">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>これ、readerがcloseされていません。
readerをtry-with-resourcesで囲むべきと思います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span>
    <span class="k">new</span> <span class="n">URL</span><span class="p">(</span><span class="s">"http://ichart.finance.yahoo.com/table.csv?s="</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">);</span>

<span class="hll">  <span class="k">try</span><span class="p">(</span><span class="kd">final</span> <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span>
</span><span class="hll">      <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="na">openStream</span><span class="p">())))</span> <span class="p">{</span>
</span>    <span class="kd">final</span> <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="na">lines</span><span class="p">().</span><span class="na">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">findFirst</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>
    <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">dataItems</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">","</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="p">(</span><span class="n">dataItems</span><span class="o">[</span><span class="n">dataItems</span><span class="p">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span><span class="p">);</span>
<span class="hll">  <span class="p">}</span>
</span><span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>参考： <a class="reference external" href="http://mike-neck.hatenadiary.com/entry/2014/10/12/133434">StreamはAutoCloseableであると認識していないとアレな件 - mike-neckのブログ</a></li>
</ul>
</li>
<li><p class="first">130〜135ページのインスタンス化の遅延。
面白いアプローチですが最終的に出来上がったコードは少々分かりにくかったし、synchronizedを使っていたのでConcurrency Utilitiesでもうちょっと良い感じに書けるんじゃ？
と思い色々考えた挙げ句、次のようなコードを書いてみましたがたいして分かりやすくなりませんでした_(:3｣∠)_</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.FutureTask</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicReference</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HoderNaive</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Heavy</span><span class="o">&gt;&gt;</span> <span class="n">heavy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="kd">public</span> <span class="n">Heavy</span> <span class="nf">getHeavy</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">heavy</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Heavy</span><span class="p">::</span><span class="k">new</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">heavy</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">run</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">heavy</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getCause</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">161ページ。</p>
<blockquote>
<div><p>正しい5の階乗と、120の階乗の一部</p>
</div></blockquote>
<p>120ではなく20000の階乗ですね。</p>
</li>
</ul>
<div class="section" id="id1">
<h2>まとめ</h2>
<p>関数型プログラミングにまったく触れたことがない人や若手にJava 8を教える立場にある人にはおすすめです。</p>
<p>コップ本を読んだ程度には関数型プログラミングに触れたことがある人は7章だけ読みましょう。</p>
</div>
]]></description>
             <pubDate>Sat, 01 Nov 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/10/26/uragamiattack.html</link>
            <guid>https://backpaper0.github.io/2014/10/26/uragamiattack.html</guid>
            <title><![CDATA[迎撃されてきた #uragamiattack]]></title>
            <description><![CDATA[<h1>迎撃されてきた #uragamiattack</h1>
<ul class="simple">
<li><a class="reference external" href="http://connpass.com/event/8570/">10月25日うらがみさん迎撃会 - connpass</a></li>
<li><a class="reference external" href="http://togetter.com/li/736904">うらがみさん迎撃会クンカクンカ #uragamiattack - Togetterまとめ</a></li>
</ul>
<p>土曜日は迎撃会、日曜日はプチ観光で東京勢にめちゃくちゃ甘えさせて貰って幸せいっぱいほくほくの週末でした。</p>
<p>この週末で私に関わってくれたみなさん、本当にありがとうございました！</p>
<p>特にゆとりさんは初日に幹事をしてくれた上に翌日も遊んでくれてありがとうございました！</p>
<p>それとしょぼちむも二日連続で愛人やってくれてありがとうございました！</p>
<p>こんな私ですが、今後とも宜しくお願いしまっす╭( ・ㅂ・)و ̑̑ ｸﾞｯ !</p>
]]></description>
             <pubDate>Sun, 26 Oct 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/10/26/java_8_hotspot_meeting.html</link>
            <guid>https://backpaper0.github.io/2014/10/26/java_8_hotspot_meeting.html</guid>
            <title><![CDATA[Java 8 HotSpot meetingを開催した #kanjava]]></title>
            <description><![CDATA[<h1>Java 8 HotSpot meetingを開催した #kanjava</h1>
<ul class="simple">
<li><a class="reference external" href="http://kanjava.connpass.com/event/8860/">Java 8 HotSpot meeting - connpass</a></li>
<li><a class="reference external" href="http://togetter.com/li/736384">Java 8 HotSpot meeting #kanjava のまとめ - Togetterまとめ</a></li>
</ul>
<p>上には上がいるもんだなぁ、と白目剥きながらセッションを拝見しました。</p>
<p>以上。</p>
]]></description>
             <pubDate>Sun, 26 Oct 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/10/04/stream_collect.html</link>
            <guid>https://backpaper0.github.io/2014/10/04/stream_collect.html</guid>
            <title><![CDATA[Streamのcollectメソッドを学ぶ]]></title>
            <description><![CDATA[<h1>Streamのcollectメソッドを学ぶ</h1>
<p><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html">Stream</a> にある数多くのメソッドの中でも分かり辛い感じがする
<a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> について学びます。</p>
<div class="section" id="collect">
<h2><span class="docutils literal"><span class="pre">collect</span></span> メソッドの概要</h2>
<p>端的に述べると <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> は <span class="docutils literal"><span class="pre">Stream&lt;T&gt;</span></span> を <span class="docutils literal"><span class="pre">R</span></span> に変換する操作です。</p>
<p>より詳しく述べると、
<span class="docutils literal"><span class="pre">Stream</span></span> の各要素( <span class="docutils literal"><span class="pre">T</span></span> )を中間コンテナ( <span class="docutils literal"><span class="pre">A</span></span> )に折り畳んだ後に最終的な結果( <span class="docutils literal"><span class="pre">R</span></span> )に変換する操作です。</p>
<p>括弧内のアルファベットは <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html">Collector</a> が持つ3つの型変数に対応しています。</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">T</span></span> : Streamの要素の型</li>
<li><span class="docutils literal"><span class="pre">A</span></span> : <strong>ミュータブル</strong> な中間コンテナの型</li>
<li><span class="docutils literal"><span class="pre">R</span></span> : 最終的に返される結果の型</li>
</ul>
<p>例えば <span class="docutils literal"><span class="pre">Stream&lt;Character&gt;</span></span> を単純に繋げて <span class="docutils literal"><span class="pre">String</span></span> にする場合は、
<span class="docutils literal"><span class="pre">Stream</span></span> の各 <span class="docutils literal"><span class="pre">Character</span></span> ( <span class="docutils literal"><span class="pre">T</span></span> )を <span class="docutils literal"><span class="pre">StringBuilder</span></span> ( <span class="docutils literal"><span class="pre">A</span></span> )に <span class="docutils literal"><span class="pre">append</span></span> した後に <span class="docutils literal"><span class="pre">String</span></span> ( <span class="docutils literal"><span class="pre">R</span></span> )に変換する、
という流れになります。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">高パフォーマンスを得るため中間コンテナは <strong>ミュータブル</strong> となっています。
詳細は <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/package-summary.html#MutableReduction">java.util.streamパッケージの「可変リダクション」</a> を参照ください。</p>
</div>
</div>
<div class="section" id="collector">
<h2><span class="docutils literal"><span class="pre">Collector</span></span> インターフェースの説明</h2>
<p><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> は引数に <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html">Collector</a> を取ります。
<a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html">Collector</a> は「関数を返す4つのメソッド」と「特性を返すメソッド」を持ったインターフェースです。</p>
<p>「特性」については後述するとして、まず「4つの関数」を説明します。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#supplier--">supplier</a> : 中間コンテナを生成する関数。
順次処理のとき最初の1回だけ実行される。
並列処理のときは複数回実行されることがある。</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#accumulator--">accumulator</a> : 中間コンテナへ値を折り畳む関数。
<span class="docutils literal"><span class="pre">Stream</span></span> の要素の数だけ実行される。</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#combiner--">combiner</a> : ふたつの中間コンテナをひとつにマージする関数。
並列処理のときに実行されることがある。</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#finisher--">finisher</a> : 中間コンテナから最終的な結果へ変換する。
最後の1回だけ実行される。</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">日本語Javadocの説明文ではそれぞれ「サプライヤ」「アキュムレータ」「コンバイナ」「フィニッシャ」と表記されています。
勉強会などで読み方を牽制し合わなくて済みますね！</p>
</div>
<div class="section" id="id1">
<h3>文字を結合する <span class="docutils literal"><span class="pre">Collector</span></span> の例</h3>
<p>例えば <span class="docutils literal"><span class="pre">Character</span></span> の <span class="docutils literal"><span class="pre">Stream</span></span> を <span class="docutils literal"><span class="pre">StringBuilder</span></span> へ折り畳んで最終的に
<span class="docutils literal"><span class="pre">String</span></span> に変換するという処理を考えてみます。</p>
<p><span class="docutils literal"><span class="pre">Collector</span></span> が返す関数はそれぞれ次のような処理を行うようにします。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#supplier--">supplier</a> で <span class="docutils literal"><span class="pre">StringBuilder</span></span> のインスタンスを生成する</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#accumulator--">accumulator</a> で <span class="docutils literal"><span class="pre">StringBuilder</span></span> へ <span class="docutils literal"><span class="pre">Character</span></span> を <span class="docutils literal"><span class="pre">append</span></span> する</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#combiner--">combiner</a> でふたつの <span class="docutils literal"><span class="pre">StringBuilder</span></span> をひとつにマージする</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#finisher--">finisher</a> で <span class="docutils literal"><span class="pre">StringBuilder</span></span> を <span class="docutils literal"><span class="pre">toString</span></span> する</li>
</ul>
<p>各関数のコードを記載します。</p>
<ul>
<li><p class="first"><span class="docutils literal"><span class="pre">supplier</span></span></p>
<p>引数なしで <span class="docutils literal"><span class="pre">StringBuilder</span></span> のインスタンスを返します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">()</span>
</pre></div>
</div>
<p>またはコンストラクタ参照でも良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nl">StringBuilder:</span><span class="p">:</span><span class="k">new</span>
</pre></div>
</div>
</li>
<li><p class="first"><span class="docutils literal"><span class="pre">accumulator</span></span></p>
<p><span class="docutils literal"><span class="pre">StringBuilder</span></span> と <span class="docutils literal"><span class="pre">Character</span></span> を受け取って
<span class="docutils literal"><span class="pre">append</span></span> します。
戻り値は <span class="docutils literal"><span class="pre">void</span></span> です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>またはメソッド参照でも良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nl">StringBuilder:</span><span class="p">:</span><span class="n">append</span>
</pre></div>
</div>
</li>
<li><p class="first"><span class="docutils literal"><span class="pre">combiner</span></span></p>
<p>ふたつの <span class="docutils literal"><span class="pre">StringBuilder</span></span> を受け取ってひとつの
<span class="docutils literal"><span class="pre">StringBuilder</span></span> にマージして返します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="n">sb1</span><span class="p">,</span> <span class="n">sb2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sb1</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">sb2</span><span class="p">);</span>
</pre></div>
</div>
<p>またはメソッド参照でも良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nl">StringBuilder:</span><span class="p">:</span><span class="n">append</span>
</pre></div>
</div>
</li>
<li><p class="first"><span class="docutils literal"><span class="pre">finisher</span></span></p>
<p><span class="docutils literal"><span class="pre">StringBuilder</span></span> を受け取って <span class="docutils literal"><span class="pre">String</span></span> へ変換して返します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">sb</span> <span class="o">-&gt;</span> <span class="n">sb</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
</pre></div>
</div>
<p>またはメソッド参照でも良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nl">StringBuilder:</span><span class="p">:</span><span class="n">toString</span>
</pre></div>
</div>
</li>
</ul>
<p>これら4つの関数をもとにして <span class="docutils literal"><span class="pre">Collector</span></span> インスタンスを生成します。
愚直に <span class="docutils literal"><span class="pre">Collector</span></span> インターフェースを実装したクラスを作っても良いのですが
<span class="docutils literal"><span class="pre">Collector</span></span> の <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.html#of-java.util.function.Supplier-java.util.function.BiConsumer-java.util.function.BinaryOperator-java.util.function.Function-java.util.stream.Collector.Characteristics...-">ofメソッド</a> を利用するのが楽です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Collector</span><span class="o">&lt;</span><span class="n">Character</span><span class="p">,</span> <span class="n">StringBuilder</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">characterJoiner</span> <span class="o">=</span>
        <span class="n">Collector</span><span class="p">.</span><span class="na">of</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(),</span>     <span class="c1">//supplier</span>
                     <span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>       <span class="c1">//accumulator</span>
                     <span class="p">(</span><span class="n">sb1</span><span class="p">,</span> <span class="n">sb2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sb1</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">sb2</span><span class="p">),</span> <span class="c1">//combiner</span>
                     <span class="n">sb</span> <span class="o">-&gt;</span> <span class="n">sb</span><span class="p">.</span><span class="na">toString</span><span class="p">()));</span>         <span class="c1">//finisher</span>

<span class="c1">//コンストラクタ参照・メソッド参照バージョン</span>
<span class="n">Collector</span><span class="o">&lt;</span><span class="n">Character</span><span class="p">,</span> <span class="n">StringBuilder</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">characterJoiner</span> <span class="o">=</span>
        <span class="n">Collector</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">StringBuilder</span><span class="p">::</span><span class="k">new</span><span class="p">,</span>        <span class="c1">//supplier</span>
                     <span class="n">StringBuilder</span><span class="p">::</span><span class="n">append</span><span class="p">,</span>     <span class="c1">//accumulator</span>
                     <span class="n">StringBuilder</span><span class="p">::</span><span class="n">append</span><span class="p">,</span>     <span class="c1">//combiner</span>
                     <span class="n">StringBuilder</span><span class="p">::</span><span class="n">toString</span><span class="p">));</span> <span class="c1">//finisher</span>
</pre></div>
</div>
<p>この <span class="docutils literal"><span class="pre">Collector</span></span> を使って文字を連結してみます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="sc">'h'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'o'</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">characterJoiner</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">//hello</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3><span class="docutils literal"><span class="pre">Collector</span></span> の特性</h3>
<p><span class="docutils literal"><span class="pre">Collector</span></span> はネストした列挙型 <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collector.Characteristics.html">Characteristics</a> を使用してみっつの特性を表すことができます。
各特性について説明します。</p>
<ul>
<li><p class="first"><span class="docutils literal"><span class="pre">CONCURRENT</span></span> : ひとつの結果コンテナインスタンスに対して複数スレッドから <span class="docutils literal"><span class="pre">accumulator</span></span> を実行できる特性です。</p>
<p>つまり次のような処理を行っても不整合が起こらなければ、この特性を持っていると言えます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">A</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">supplier</span><span class="p">.</span><span class="na">get</span><span class="p">();</span> <span class="c1">//中間コンテナ</span>

<span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">accumulator</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">t1</span><span class="p">)).</span><span class="na">start</span><span class="p">();</span>

<span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">accumulator</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">t2</span><span class="p">)).</span><span class="na">start</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p class="first"><span class="docutils literal"><span class="pre">IDENTITY_FINISH</span></span> : <span class="docutils literal"><span class="pre">finisher</span></span> が恒等関数であり、省略できる特性です。</p>
<p>つまり <span class="docutils literal"><span class="pre">finisher</span></span> が次のような実装になる場合、この特性を持っていると言えます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Function</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">finisher</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first"><span class="docutils literal"><span class="pre">UNORDERED</span></span> : 操作が要素の順序に依存しない特性です。</p>
</li>
</ul>
<p>いずれの特性も性能向上のためのものと思われます。
ですので特性をひとつも持たないとしても致命的な問題は無さそうです。
むしろ自作 <span class="docutils literal"><span class="pre">Collector</span></span> がどの特性を持っているか分からない、いまいち自信が無いなどの場合は
<span class="docutils literal"><span class="pre">Characteristics</span></span> を設定しない方が良いかも知れませんね。</p>
<p><span class="docutils literal"><span class="pre">Collector</span></span> インスタンスを生成する際に特性を与えたい場合は <span class="docutils literal"><span class="pre">of</span></span> メソッドの第5引数(可変長引数です)を使用します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">collector</span> <span class="o">=</span>
        <span class="n">Collector</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">supplier</span><span class="p">,</span> <span class="n">accumulator</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">finisher</span><span class="p">,</span>
                     <span class="n">Characteristics</span><span class="p">.</span><span class="na">CONCURRENT</span><span class="p">,</span>
                     <span class="n">Characteristics</span><span class="p">.</span><span class="na">IDENTITY_FINISH</span><span class="p">,</span>
                     <span class="n">Characteristics</span><span class="p">.</span><span class="na">UNORDERED</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>中間コンテナの型変数について</h2>
<p><span class="docutils literal"><span class="pre">Collector</span></span> は自分で実装しても良いですが、よく使われそうな実装を返す
<span class="docutils literal"><span class="pre">static</span></span> メソッドを多数定義した <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collectors.html">Collectors</a> というユーティリティクラスが提供されています。</p>
<p><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collectors.html">Collectors</a> のメソッド一覧を眺めて戻り値に注目するとほとんどが
<span class="docutils literal"><span class="pre">Collector&lt;T,</span> <span class="pre">?,</span> <span class="pre">R&gt;</span></span> となっており、
中間コンテナの型がワイルドカードで宣言されていることが分かります。</p>
<p>冒頭でも書きましたが <span class="docutils literal"><span class="pre">Stream</span></span> の <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> は <span class="docutils literal"><span class="pre">Stream&lt;T&gt;</span></span> を <span class="docutils literal"><span class="pre">R</span></span> に変換する操作です。
このときの <span class="docutils literal"><span class="pre">T</span></span> と <span class="docutils literal"><span class="pre">R</span></span> は <span class="docutils literal"><span class="pre">Collector&lt;T,</span> <span class="pre">A,</span> <span class="pre">R&gt;</span></span> のそれに対応します。
つまり <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> を使うひと―― <span class="docutils literal"><span class="pre">Collector</span></span> の利用者――にとっては中間コンテナが何であるか意識する必要はないんですね。</p>
<p>このように利用者には不要な中間コンテナの型が見えており、
実際にはワイルドカードが宣言されているというのは少し残念であり、
<a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> をややこしく感じさせている一因かも知れないな、と思います。</p>
<p>というわけで <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Collectors.html">Collectors</a> の各メソッドでのワイルドカードは空気のように扱うことにしましょう。</p>
</div>
<div class="section" id="id4">
<h2>まとめ、それと自分への宿題</h2>
<ul class="simple">
<li>使う側としては中間コンテナの存在は無視る</li>
<li>よく分からんかったら <span class="docutils literal"><span class="pre">Characteristics</span></span> は付与しない</li>
<li>何はともあれ <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collectメソッド</a> 便利</li>
</ul>
<p>こっから宿題。</p>
<ul>
<li><p class="first">Scalaの <span class="docutils literal"><span class="pre">scan</span></span> みたいなやつを実装してみる。</p>
<p>こんなやつです。</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span/><span class="c1">//これはScalaコード</span>
<span class="k">val</span> <span class="n">xs</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">5</span> <span class="n">toList</span>
<span class="n">xs</span><span class="o">.</span><span class="n">scan</span><span class="o">(</span><span class="mi">0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span> <span class="c1">//0, 1, 3, 6, 10, 15</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id5">
<h3>追記：宿題やった</h3>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/blob/master/garakuta/src/test/java/ScanCollectorTest.java">ScanCollectorTest.java</a></li>
</ul>
</div>
</div>
]]></description>
             <pubDate>Sat, 04 Oct 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/10/04/stream_methods.html</link>
            <guid>https://backpaper0.github.io/2014/10/04/stream_methods.html</guid>
            <title><![CDATA[Streamのメソッドを操作の種類別で一覧にした]]></title>
            <description><![CDATA[<h1>Streamのメソッドを操作の種類別で一覧にした</h1>
<p><span class="docutils literal"><span class="pre">Stream</span></span> の操作は <strong>中間操作</strong> と <strong>終端操作</strong> がありますが、
各メソッドがどちらの操作にあたるのか一覧にしてみました。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">中間操作と終端操作の詳細は
<a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/package-summary.html#StreamOps">ストリーム操作とパイプライン</a>
を参照してください。</p>
</div>
<p>ちなみに一覧中の <span class="docutils literal"><span class="pre">T</span></span> は <span class="docutils literal"><span class="pre">Stream</span></span> が取る型変数です。
例えば <span class="docutils literal"><span class="pre">String[]</span></span> をストリーム化した場合 <span class="docutils literal"><span class="pre">T</span></span> は <span class="docutils literal"><span class="pre">String</span></span> になります。</p>
<p>それから <span class="docutils literal"><span class="pre">S</span></span> は <span class="docutils literal"><span class="pre">BaseStream</span></span> が取る型変数で <span class="docutils literal"><span class="pre">Stream&lt;T&gt;</span></span> を指します。</p>
<div class="section" id="id2">
<h2>中間操作</h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#filter-java.util.function.Predicate-">Stream&lt;T&gt; filter(Predicate&lt;? super T&gt; predicate)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#map-java.util.function.Function-">&lt;R&gt; Stream&lt;R&gt; map(Function&lt;? super T, ? extends R&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#mapToInt-java.util.function.ToIntFunction-">IntStream mapToInt(ToIntFunction&lt;? super T&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#mapToLong-java.util.function.ToLongFunction-">LongStream mapToLong(ToLongFunction&lt;? super T&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#mapToDouble-java.util.function.ToDoubleFunction-">DoubleStream mapToDouble(ToDoubleFunction&lt;? super T&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#flatMap-java.util.function.Function-">&lt;R&gt; Stream&lt;R&gt; flatMap(Function&lt;? super T, ? extends Stream&lt;? extends R&gt;&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#flatMapToInt-java.util.function.Function-">IntStream flatMapToInt(Function&lt;? super T, ? extends IntStream&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#flatMapToLong-java.util.function.Function-">LongStream flatMapToLong(Function&lt;? super T, ? extends LongStream&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#flatMapToDouble-java.util.function.Function-">DoubleStream flatMapToDouble(Function&lt;? super T, ? extends DoubleStream&gt; mapper)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#peek-java.util.function.Consumer-">Stream&lt;T&gt; peek(Consumer&lt;? super T&gt; action)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#sequential--">S sequential()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#parallel--">S parallel()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#unordered--">S unordered()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#onClose-java.lang.Runnable-">S onClose(Runnable closeHandler)</a></li>
</ul>
<div class="section" id="id3">
<h3>ステートフルな中間操作</h3>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#distinct--">Stream&lt;T&gt; distinct()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#sorted--">Stream&lt;T&gt; sorted()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#sorted-java.util.Comparator-">Stream&lt;T&gt; sorted(Comparator&lt;? super T&gt; comparator)</a></li>
</ul>
</div>
<div class="section" id="id4">
<h3>ステートフルな短絡中間操作</h3>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#limit-long-">Stream&lt;T&gt; limit(long maxSize)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#skip-long-">Stream&lt;T&gt; skip(long n)</a></li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h2>終端操作</h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#forEach-java.util.function.Consumer-">void forEach(Consumer&lt;? super T&gt; action)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#forEachOrdered-java.util.function.Consumer-">void forEachOrdered(Consumer&lt;? super T&gt; action)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#toArray--">Object [] toArray()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#toArray-java.util.function.IntFunction-">&lt;A&gt; A[] toArray(IntFunction&lt;A[]&gt; generator)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#reduce-T-java.util.function.BinaryOperator-">T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#reduce-java.util.function.BinaryOperator-">Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#reduce-U-java.util.function.BiFunction-java.util.function.BinaryOperator-">&lt;U&gt; U reduce(U identity, BiFunction&lt;U, ? super T, U&gt; accumulator, BinaryOperator&lt;U&gt; combiner)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.function.Supplier-java.util.function.BiConsumer-java.util.function.BiConsumer-">&lt;R&gt; R collect(Supplier&lt;R&gt; supplier, BiConsumer&lt;R, ? super T&gt; accumulator, BiConsumer&lt;R, R&gt; combiner)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">&lt;R, A&gt; R collect(Collector&lt;? super T, A, R&gt; collector)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#min-java.util.Comparator-">Optional&lt;T&gt; min(Comparator&lt;? super T&gt; comparator)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#max-java.util.Comparator-">Optional&lt;T&gt; max(Comparator&lt;? super T&gt; comparator)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#count--">long count()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#iterator--">Iterator&lt;T&gt; iterator()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#spliterator--">Spliterator&lt;T&gt; spliterator()</a></li>
</ul>
<div class="section" id="id6">
<h3>短絡終端操作</h3>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#anyMatch-java.util.function.Predicate-">boolean anyMatch(Predicate&lt;? super T&gt; predicate)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#allMatch-java.util.function.Predicate-">boolean allMatch(Predicate&lt;? super T&gt; predicate)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#noneMatch-java.util.function.Predicate-">boolean noneMatch(Predicate&lt;? super T&gt; predicate)</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#findFirst--">Optional&lt;T&gt; findFirst()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/Stream.html#findAny--">Optional&lt;T&gt; findAny()</a></li>
</ul>
</div>
</div>
<div class="section" id="id7">
<h2>その他(中間操作・終端操作のどちらにも分類されないもの)</h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#isParallel--">boolean isParallel()</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/stream/BaseStream.html#close--">void close()</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sat, 04 Oct 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/09/30/jersey_rx_client.html</link>
            <guid>https://backpaper0.github.io/2014/09/30/jersey_rx_client.html</guid>
            <title><![CDATA[Jersey ClientのRxサポートを軽〜く試す]]></title>
            <description><![CDATA[<h1>Jersey ClientのRxサポートを軽〜く試す</h1>
<p>Jersey 2.13がリリースされました。</p>
<ul class="simple">
<li><a class="reference external" href="https://jersey.java.net/release-notes/2.13.html">Release Notes - Jersey 2.13</a></li>
</ul>
<p>リリースノートを見ると <a class="reference external" href="https://java.net/jira/browse/JERSEY-2639">[JERSEY-2639] - Jersey Client - Add Support for Rx</a> というのがあったので試してみましたん。</p>
<div class="section" id="pom-xmldependency">
<h2>pom.xmlに突っ込むdependency</h2>
<p><a class="reference external" href="http://repo1.maven.org/maven2/org/glassfish/jersey/ext/rx/">jersey-rx-clientの実装</a> には、</p>
<ul class="simple">
<li>jersey-rx-client-guava</li>
<li>jersey-rx-client-java8</li>
<li>jersey-rx-client-jsr166e</li>
<li>jersey-rx-client-rxjava</li>
</ul>
<p>があるっぽいですがRxJavaとかよく分かんないので今回はjava8で試します。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.ext.rx<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jersey-rx-client-java8<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>クライアントコード</h2>
<p>名前を渡したらこんにちは言ってくれるいつものリソースクラスがあったとします。</p>
<p>まずはふつうのJAX-RSクライアントのコード。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">WebTarget</span> <span class="n">target</span> <span class="o">=</span> <span class="n">ClientBuilder</span><span class="p">.</span><span class="na">newClient</span><span class="p">().</span><span class="na">target</span><span class="p">(</span><span class="s">"http://localhost:8080/rest/hello"</span><span class="p">);</span>

<span class="n">String</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"world"</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">request</span><span class="p">()</span>
                    <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span> <span class="c1">//Hello, world!</span>
</pre></div>
</div>
<p>うむ。普通。</p>
<p>次にRx板のコードです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">WebTarget</span> <span class="n">target</span> <span class="o">=</span> <span class="n">ClientBuilder</span><span class="p">.</span><span class="na">newClient</span><span class="p">().</span><span class="na">target</span><span class="p">(</span><span class="s">"http://localhost:8080/rest/hello"</span><span class="p">);</span>

<span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stage</span> <span class="o">=</span> <span class="n">RxCompletionStage</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                                    <span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"world"</span><span class="p">)</span>
                                    <span class="p">.</span><span class="na">request</span><span class="p">()</span>
                                    <span class="p">.</span><span class="na">rx</span><span class="p">()</span>
                                    <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="n">stage</span><span class="p">.</span><span class="na">thenAccept</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">s</span><span class="p">));</span> <span class="c1">//Hello, world!</span>
</pre></div>
</div>
<p>ご覧の通り <a class="reference external" href="http://docs.oracle.com/javase/jp/8/api/java/util/concurrent/CompletionStage.html">CompletionStage</a> であれこれできるっぽいです。</p>
</div>
<div class="section" id="id2">
<h2>まとめ</h2>
<p>RxJava学ぼうかな。</p>
</div>
<div class="section" id="id3">
<h2>本日のコード</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/jersey-rx-client-java8-example">https://github.com/backpaper0/sandbox/tree/master/jersey-rx-client-java8-example</a></li>
</ul>
</div>
]]></description>
             <pubDate>Tue, 30 Sep 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/09/26/nullpo.html</link>
            <guid>https://backpaper0.github.io/2014/09/26/nullpo.html</guid>
            <title><![CDATA[ぬるぽ]]></title>
            <description><![CDATA[<h1>ぬるぽ</h1>
<p>あなたとぬるぽ。</p>
<div class="section" id="for">
<h2>拡張forループ</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kt">int</span><span class="o">[]</span> <span class="n">xs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">:</span> <span class="n">xs</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>配列・リストが <span class="docutils literal"><span class="pre">null</span></span> なら拡張forループでぬるぽっ！</p>
</div>
<div class="section" id="id2">
<h2>アンボクシング</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Integer</span> <span class="n">x</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</pre></div>
</div>
<p>プリミティブラッパーをプリミティブにアンボクシングするときにぬるぽっ！</p>
<p>普通に数字の足し算とかしててぬるぽが出たらこれを疑います。</p>
</div>
<div class="section" id="throw">
<h2>throw</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">UnsupportedOperationException</span> <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">throw</span> <span class="n">e</span><span class="p">;</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">null</span></span> を <span class="docutils literal"><span class="pre">throw</span></span> したら投げられる例外はぬるぽっ！</p>
</div>
<div class="section" id="string-switch">
<h2>String switch</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">String</span> <span class="n">x</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">String</span></span> のswitch文でぬるぽっ！</p>
</div>
<div class="section" id="try-with-resources">
<h2>try with resources</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">try</span> <span class="p">(</span><span class="n">AutoCloseable</span> <span class="n">x</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>try with resourcesで <span class="docutils literal"><span class="pre">AutoCloseable</span></span> が <span class="docutils literal"><span class="pre">null</span></span> なら <span class="docutils literal"><span class="pre">close</span></span> するときにぬるぽっ！には <strong>ならない</strong> 。</p>
<p><span class="docutils literal"><span class="pre">close</span></span> の前に <span class="docutils literal"><span class="pre">null</span></span> チェックするようにコンパイルされます。</p>
</div>
<div class="section" id="id3">
<h2>コンストラクタ</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="k">new</span> <span class="n">Hoge</span><span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span><span class="na">x</span><span class="p">.</span><span class="na">length</span><span class="p">());</span>
</pre></div>
</div>
<p>何の変哲も無いコンストラクタですが、ぬるぽっ！になるケースがあります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">x</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Hoge</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Hoge</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="na">x</span> <span class="o">=</span> <span class="s">"hoge"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>フィールド <span class="docutils literal"><span class="pre">x</span></span> はfinalなのにぬるぽになるというアレです。
コンストラクタ終わってないインスタンスはメソッドに渡さないでおきましょー。</p>
</div>
<div class="section" id="id4">
<h2>メソッド実行</h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Hoge</span> <span class="n">x</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="n">x</span><span class="p">.</span><span class="na">foobar</span><span class="p">();</span>
</pre></div>
</div>
<p>ぬるぽっ！ <strong>にはならないケースがあります</strong> 。</p>
<p>これ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">foobar</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>まあ実際はこんなコードに出会うことは無いでしょう。</p>
<p>無いでしょう。</p>
</div>
<div class="section" id="id5">
<h2>本日のコード</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/blob/master/garakuta/src/test/java/NullPo.java">NullPo.java</a></li>
</ul>
</div>
]]></description>
             <pubDate>Fri, 26 Sep 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/09/14/kotlinkansai.html</link>
            <guid>https://backpaper0.github.io/2014/09/14/kotlinkansai.html</guid>
            <title><![CDATA[関西Kotlin勉強会やった #kotlin]]></title>
            <description><![CDATA[<h1>関西Kotlin勉強会やった #kotlin</h1>
<p>東京からKotlinエバンジェリスト(自称)の <a class="reference external" href="https://twitter.com/ngsw_taro">たろうさん</a>
をお招きして神戸でKotlinの勉強会をだらだらやったった。</p>
<ul class="simple">
<li><a class="reference external" href="http://togetter.com/li/718906">関西Kotlin勉強会 - Togetterまとめ</a></li>
</ul>
<div class="section" id="id2">
<h2>私の発表</h2>
<ul class="simple">
<li><a class="reference external" href="/ghosts/kotlin-jaxrs.html">KotlinでJAX-RS + おまけ</a></li>
</ul>
<p>要約すると、</p>
<ul class="simple">
<li>KotlinでJAX-RSは普通にできるけれどKotlinの良さを活かしきれないのがちょっとくやしい</li>
<li>JVM言語は最終的にはjavapすればアレ</li>
<li>しょぼちむネタにしてごめんな、今度ごはんおごるわー</li>
</ul>
<p>という感じです。</p>
</div>
<div class="section" id="lt">
<h2>こざけさんのLT</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.slideshare.net/s_kozake/null-39038741">Nullなのはいけないと思います！</a></li>
</ul>
<p>関西Kotlin勉強会の一週間前にScalaMatsuriでたろうさんに「LTやってくださいよ」と無茶振りされた <a class="reference external" href="https://twitter.com/s_kozake">こざけさん</a> のLT。</p>
<p>お金がnullなのはいけないと思いますが、お金をnullにしたのはご自身なのでアレですね。</p>
</div>
<div class="section" id="id4">
<h2>たろうさんの発表</h2>
<ul class="simple">
<li><a class="reference external" href="https://speakerdeck.com/ntaro">たろうさんの資料たち</a></li>
</ul>
<p>過去のスライドからいくつかを選んで大事な部分をかいつまんで話してくれました。</p>
<p>まったりした雰囲気だったとはいえ2時間ほどノンストップでお話してくださったのはすごかった。</p>
<p>すごい勢いでKotlinを吸収できた気がするのである程度定着するよう復習しておかねばなりません。</p>
</div>
<div class="section" id="id6">
<h2>まとめ</h2>
<ul class="simple">
<li>Kotlin面白い</li>
<li>でもREPLはよく落ちるから <a class="reference external" href="http://kotlin-demo.jetbrains.com/">Kotlin Web Demo</a> で遊ぶと良い</li>
<li>イベント後、店変えつつ5時間ぐらい飲み食いしててイベントよりも長いやんけ的な</li>
<li>その飲み食いも込みでめちゃくちゃ楽しかった</li>
</ul>
</div>
<div class="section" id="id7">
<h2>関連するあれこれ</h2>
<ul class="simple">
<li><a class="reference external" href="http://yyyank.blogspot.jp/2014/09/kotlin-advent-calendar-2012.html">Javaプログラマーのはしくれダイアリー: 「Kotlin Advent Calendar 2012 (全部俺)」を全部俺が読んだ話</a></li>
<li><a class="reference external" href="http://taro.hatenablog.jp/entry/2014/09/15/115444">関西Kotlin勉強会で発表してきたよ〜 - 算譜王におれはなる!!!!</a></li>
<li><a class="reference external" href="http://kozake.hatenablog.com/entry/2014/09/15/123229">関西Kotlin勉強会に参加したよ - シスアーキ in はてな</a></li>
<li><a class="reference external" href="http://togetter.com/li/719487">関西Kotlin勉強会その後〜たろうさん大阪珍道中 - Togetterまとめ</a></li>
<li><a class="reference external" href="http://yyyank.blogspot.jp/2014/09/kotlinkotlin.html">Javaプログラマーのはしくれダイアリー: 【Kotlinかわいいよ】関西Kotlin勉強会に行ってきた</a></li>
<li><a class="reference external" href="http://shiget84.hateblo.jp/entry/2014/09/23/223034">関西Kotlin勉強会に参加してきた話 - shiget84’s blog</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 14 Sep 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/08/27/wildflykansai.html</link>
            <guid>https://backpaper0.github.io/2014/08/27/wildflykansai.html</guid>
            <title><![CDATA[関西WildFly勉強会をやった #wildflykansai]]></title>
            <description><![CDATA[<h1>関西WildFly勉強会をやった #wildflykansai</h1>
<p>やりました。</p>
<ul class="simple">
<li><a class="reference external" href="http://connpass.com/event/7529/">関西WildFly 8(旧JBoss AS)勉強会</a></li>
</ul>
<p><a class="reference external" href="https://twitter.com/nekop">@nekopさん</a> にお越し頂いてたっぷりと喋って貰って大満足でした！</p>
<p>というか私はお昼ごはんを一緒させて貰った時点でかなり満足した。</p>
<p>ワタクシのスライドん。</p>
<ul class="simple">
<li><a class="reference external" href="/ghosts/arquillian.html">Arquillianではじめるコンテナを使ったテスト</a></li>
</ul>
<div class="section" id="id1">
<h2>関連</h2>
<ul class="simple">
<li><a class="reference external" href="http://nekop.hatenablog.com/entry/2014/08/25/145905">関西WildFly 8(旧JBoss AS)勉強会でしゃべってきた - nekop’s blog</a></li>
<li><a class="reference external" href="http://odashinsuke.hatenablog.com/entry/2014/08/25/223342">関西WildFly 8(旧JBoss AS)勉強会 でお話しさせてもらいました - お だ のスペース</a></li>
</ul>
</div>
]]></description>
             <pubDate>Wed, 27 Aug 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/08/02/glassfish_admingui.html</link>
            <guid>https://backpaper0.github.io/2014/08/02/glassfish_admingui.html</guid>
            <title><![CDATA[GlassFish 3.1.2.2の管理コンソールでlocalhostをプロキシ経由しようとしていて困ったけど解決した話]]></title>
            <description><![CDATA[<h1>GlassFish 3.1.2.2の管理コンソールでlocalhostをプロキシ経由しようとしていて困ったけど解決した話</h1>
<div class="section" id="id1">
<h2>現象</h2>
<p>ローカルでGlassFish 3.1.2.2を動かして管理コンソールを開こうと思ったら開けなくて困りました。</p>
<p>具体的には次のような症状です。</p>
<ul class="simple">
<li>デフォルトのドメイン <span class="docutils literal"><span class="pre">domain1</span></span> で管理コンソールの起動にかなり時間がかかる。</li>
<li><span class="docutils literal"><span class="pre">domain1</span></span> は管理パスワードが設定されていないのでログインなしで管理コンソールを開けるはずなのにログインフォームが表示される。</li>
<li>ユーザー名だけ入力してログインしようとするとかなり時間がかかった挙げ句ログインできない。</li>
</ul>
</div>
<div class="section" id="id2">
<h2>環境</h2>
<ul class="simple">
<li>GlassFish 3.1.2.2</li>
<li>JDK 1.7.0_65</li>
<li>Windows 7</li>
<li>ネットワークの設定でプロキシ設定済み</li>
</ul>
</div>
<div class="section" id="id3">
<h2>調査</h2>
<p>まず管理コンソールの起動に時間がかかっている際のスレッドダンプを取得することにしました。</p>
<p>GlassFishを起動して <span class="docutils literal"><span class="pre">http://localhost:4848</span></span> をブラウザで開きます。</p>
<p>管理コンソールがなかなか起動されないことを確認したあと
JVisualVMでGlassFishに接続してボタンぽちっとスレッドダンプ取得しました。
JVisualVM便利。</p>
<p>スレッドダンプをエディタにコピペして <span class="docutils literal"><span class="pre">glassfish</span></span> という文字列を検索してそれっぽいスレッドを探しました。</p>
<p>その結果、次に記載するスレッドが怪しそうでした。
ソケットからのデータ読み込み中で止まってる感じがします。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>"admin-thread-pool-4848(3)" daemon prio=6 tid=0x000000000a861800 nid=0xb08 runnable [0x000000001275c000]
   java.lang.Thread.State: RUNNABLE
    at java.net.SocketInputStream.socketRead0(Native Method)
    at java.net.SocketInputStream.read(SocketInputStream.java:152)
    at java.net.SocketInputStream.read(SocketInputStream.java:122)
    at java.io.BufferedInputStream.fill(BufferedInputStream.java:235)
    at java.io.BufferedInputStream.read1(BufferedInputStream.java:275)
    at java.io.BufferedInputStream.read(BufferedInputStream.java:334)
    - locked &lt;0x00000000f7a63a80&gt; (a java.io.BufferedInputStream)
    at sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:687)
    at sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:633)
    at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1323)
    - locked &lt;0x00000000f7a47030&gt; (a sun.net.www.protocol.http.HttpURLConnection)
    at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:468)
    at com.sun.jersey.client.urlconnection.URLConnectionClientHandler._invoke(URLConnectionClientHandler.java:240)
    at com.sun.jersey.client.urlconnection.URLConnectionClientHandler.handle(URLConnectionClientHandler.java:147)
    at com.sun.jersey.api.client.filter.CsrfProtectionFilter.handle(CsrfProtectionFilter.java:97)
    at com.sun.jersey.api.client.Client.handle(Client.java:648)
    at com.sun.jersey.api.client.WebResource.handle(WebResource.java:670)
    at com.sun.jersey.api.client.WebResource.access$200(WebResource.java:74)
    at com.sun.jersey.api.client.WebResource$Builder.get(WebResource.java:503)
    at org.glassfish.admingui.common.util.RestUtil.get(RestUtil.java:755)
    at org.glassfish.admingui.common.util.RestUtil.restRequest(RestUtil.java:191)
    at org.glassfish.admingui.common.handlers.RestApiHandlers.restRequest(RestApiHandlers.java:223)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:606)
    at com.sun.jsftemplating.layout.descriptors.handler.Handler.invoke(Handler.java:442)
    at com.sun.jsftemplating.layout.descriptors.LayoutElementBase.dispatchHandlers(LayoutElementBase.java:420)
    at com.sun.jsftemplating.layout.descriptors.LayoutElementBase.dispatchHandlers(LayoutElementBase.java:394)
    at com.sun.jsftemplating.layout.descriptors.LayoutComponent.beforeCreate(LayoutComponent.java:348)
    at com.sun.jsftemplating.layout.descriptors.LayoutComponent.getChild(LayoutComponent.java:288)
    at com.sun.jsftemplating.layout.LayoutViewHandler.buildUIComponentTree(LayoutViewHandler.java:556)
    at com.sun.jsftemplating.layout.LayoutViewHandler.createView(LayoutViewHandler.java:255)
    at com.sun.faces.lifecycle.RestoreViewPhase.execute(RestoreViewPhase.java:247)
    at com.sun.faces.lifecycle.Phase.doPhase(Phase.java:101)
    at com.sun.faces.lifecycle.RestoreViewPhase.doPhase(RestoreViewPhase.java:116)
    at com.sun.faces.lifecycle.LifecycleImpl.execute(LifecycleImpl.java:118)
    at javax.faces.webapp.FacesServlet.service(FacesServlet.java:593)
    at org.apache.catalina.core.StandardWrapper.service(StandardWrapper.java:1550)
    at org.apache.catalina.core.ApplicationDispatcher.doInvoke(ApplicationDispatcher.java:809)
    at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:671)
    at org.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:505)
    at org.apache.catalina.core.ApplicationDispatcher.doDispatch(ApplicationDispatcher.java:476)
    at org.apache.catalina.core.ApplicationDispatcher.dispatch(ApplicationDispatcher.java:355)
    at org.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:305)
    at org.glassfish.admingui.common.security.AdminConsoleAuthModule.validateRequest(AdminConsoleAuthModule.java:232)
    at com.sun.enterprise.security.jmac.config.GFServerConfigProvider$GFServerAuthContext.validateRequest(GFServerConfigProvider.java:1171)
    at com.sun.web.security.RealmAdapter.validate(RealmAdapter.java:1452)
    at com.sun.web.security.RealmAdapter.invokeAuthenticateDelegate(RealmAdapter.java:1330)
    at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:551)
    at org.apache.catalina.core.StandardPipeline.doInvoke(StandardPipeline.java:623)
    at org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:595)
    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:161)
    at org.apache.catalina.connector.CoyoteAdapter.doService(CoyoteAdapter.java:331)
    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:231)
    at com.sun.enterprise.v3.services.impl.ContainerMapper$AdapterCallable.call(ContainerMapper.java:317)
    at com.sun.enterprise.v3.services.impl.ContainerMapper.service(ContainerMapper.java:195)
    at com.sun.grizzly.http.ProcessorTask.invokeAdapter(ProcessorTask.java:860)
    at com.sun.grizzly.http.ProcessorTask.doProcess(ProcessorTask.java:757)
    at com.sun.grizzly.http.ProcessorTask.process(ProcessorTask.java:1056)
    at com.sun.grizzly.http.DefaultProtocolFilter.execute(DefaultProtocolFilter.java:229)
    at com.sun.grizzly.DefaultProtocolChain.executeProtocolFilter(DefaultProtocolChain.java:137)
    at com.sun.grizzly.DefaultProtocolChain.execute(DefaultProtocolChain.java:104)
    at com.sun.grizzly.DefaultProtocolChain.execute(DefaultProtocolChain.java:90)
    at com.sun.grizzly.http.HttpProtocolChain.execute(HttpProtocolChain.java:79)
    at com.sun.grizzly.ProtocolChainContextTask.doCall(ProtocolChainContextTask.java:54)
    at com.sun.grizzly.SelectionKeyContextTask.call(SelectionKeyContextTask.java:59)
    at com.sun.grizzly.ContextTask.run(ContextTask.java:71)
    at com.sun.grizzly.util.AbstractThreadPool$Worker.doWork(AbstractThreadPool.java:532)
    at com.sun.grizzly.util.AbstractThreadPool$Worker.run(AbstractThreadPool.java:513)
    at java.lang.Thread.run(Thread.java:745)
</pre></div>
</div>
<p>JerseyクライアントでHTTPリクエストを行っているようです。</p>
<p><span class="docutils literal"><span class="pre">RestApiHandlers.java:223</span></span> にブレークポイントを置いてデバッグしてみることにしました。
デバッグにはEclipseを使いました。</p>
<p>一旦ドメインを停止してデバッグモードで起動し直します。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>asadmin start-domain --debug domain1
</pre></div>
</div>
<p>起動したらコンソールにデバッグポートが表示されるのでそれを参考にリモートデバッグします。
Eclipseのデバッグの設定から <span class="docutils literal"><span class="pre">Remote</span> <span class="pre">Java</span> <span class="pre">Application</span></span> を選んで実行します。</p>
<p>デバッグ用に適当にプロジェクトを作りました。
<span class="docutils literal"><span class="pre">dependency</span></span> は適当に使ってそうなやつを突っ込んでおきました。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.main.admingui<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>console-core<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.1.2.2<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.main.admingui<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>console-common<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.1.2.2<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ちなみにNetBeansはこんな面倒なことをしなくてもプロジェクトをデバッグ実行すれば自動でGlassFishもデバッグモードで起動したと思います。</p>
</div>
<p>そんな感じでデバッグしてみたところ
<span class="docutils literal"><span class="pre">http://localhost:4848/management/domain/anonymous-user-enabled</span></span>
へのGETリクエストがなかなか返って来ませんでした。</p>
<p>やっとこさ返ってきたレスポンスは503エラーでした。
エンティティボディを見るとプロキシから応答が無いなどと書かれており
HTTPリクエストがプロキシ経由になっているのがマズいようでした。</p>
</div>
<div class="section" id="id4">
<h2>対応</h2>
<p><span class="docutils literal"><span class="pre">localhost</span></span> をプロキシを通過する対象から外してみました。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>asadmin create-jvm-options -Dhttp.nonProxyHosts<span class="o">=</span>localhost
</pre></div>
</div>
<p>GlassFishを再起動して管理コンソールにアクセスすると問題なく起動してくれました。</p>
<p>というわけで当座の問題は解決しました。</p>
</div>
<div class="section" id="id5">
<h2>疑問</h2>
<p>Windowsのプロキシ設定には
“ローカル アドレスにはプロキシ サーバーを使用しない”
というチェックボックスがありますが、
これにチェック入れてもJavaのソケットAPIは <span class="docutils literal"><span class="pre">localhost</span></span> を除外してくれないのでしょうか？</p>
<p>教えてエロいひと！</p>
</div>
]]></description>
             <pubDate>Sat, 02 Aug 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/07/21/jersey_standalone.html</link>
            <guid>https://backpaper0.github.io/2014/07/21/jersey_standalone.html</guid>
            <title><![CDATA[Jerseyをjava -jarで動かす]]></title>
            <description><![CDATA[<h1>Jerseyをjava -jarで動かす</h1>
<p>Jerseyはサーブレット経由でなく <a class="reference external" href="http://docs.oracle.com/javase/jp/7/jre/api/net/httpserver/spec/index.html">com.sun.net.httpserver.HttpServer</a>
や <a class="reference external" href="https://grizzly.java.net/">Grizzly</a> 、Jettyで動かす事もできるのでmaven-shade-pluginなどでひとつのJARにまとめてしまえば <span class="docutils literal"><span class="pre">java</span> <span class="pre">-jar</span></span>
で実行できるJAX-RSアプリケーションの完成です。</p>
<p>例えば <span class="docutils literal"><span class="pre">com.sun.net.httpserver.HttpServer</span></span> を使用するやつをdependenciesに突っ込んで、</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-container-jdk-http<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;dependencyManagement&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-bom<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.10.1<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
      <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/dependencyManagement&gt;</span>
</pre></div>
</div>
<p>mavne-shade-pluginを突っ込んで、</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.3<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;id&gt;</span>standalone-jar<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;transformers&gt;</span>
          <span class="nt">&lt;transformer</span>
            <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;mainClass&gt;</span>app.Main<span class="nt">&lt;/mainClass&gt;</span>
          <span class="nt">&lt;/transformer&gt;</span>
        <span class="nt">&lt;/transformers&gt;</span>
       <span class="nt">&lt;createDependencyReducedPom&gt;</span>false<span class="nt">&lt;/createDependencyReducedPom&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>
</div>
<p>JAX-RSなコードを書いて、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.ws.rs.DefaultValue</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.QueryParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span><span class="p">;</span>

<span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="p">{</span>

    <span class="nd">@GET</span>
    <span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_PLAIN</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="nd">@DefaultValue</span><span class="p">(</span><span class="s">"world"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"Hello, %s!"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>メインクラス書いて、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.glassfish.jersey.filter.LoggingFilter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.glassfish.jersey.jdkhttp.JdkHttpServerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.glassfish.jersey.server.ResourceConfig</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">//ベースとなるURL</span>
        <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">"http://localhost:8080/"</span><span class="p">);</span>

        <span class="c1">//リソースクラスなどを登録する</span>
        <span class="c1">//以下は一例</span>
        <span class="n">ResourceConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceConfig</span><span class="p">();</span>

        <span class="c1">//appパッケージ以下のリソースクラスなどJAX-RSに関係するクラスを登録する</span>
        <span class="c1">//パッケージは再帰的にスキャンされる</span>
        <span class="n">config</span><span class="p">.</span><span class="na">packages</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="s">"app"</span><span class="p">);</span>

        <span class="c1">//リクエストとレスポンスに関する情報をログ出力するフィルターを登録する</span>
        <span class="n">config</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">LoggingFilter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="c1">//サーバー起動</span>
        <span class="n">JdkHttpServerFactory</span><span class="p">.</span><span class="na">createHttpServer</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>

        <span class="c1">//http://localhost:8080/hello?name=foobar にアクセスして動作確認</span>
        <span class="c1">//control + cでJVM落としてサーバも停止する</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">mvn</span> <span class="pre">package</span></span> でJAR作って <span class="docutils literal"><span class="pre">java</span> <span class="pre">-jar</span> <span class="pre">hoge.jar</span></span> で動かしましょう。</p>
<p>ギッハブにもサンプル置いています。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/jersey-standalone-example">jersey-standalone-example</a></li>
</ul>
<p>Gradleではどうやったら良いんでしょうね？
誰か書いて下さいお願いします。</p>
]]></description>
             <pubDate>Mon, 21 Jul 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/07/06/kotlin_default_parameter.html</link>
            <guid>https://backpaper0.github.io/2014/07/06/kotlin_default_parameter.html</guid>
            <title><![CDATA[Kotlinのデフォルト引数を調べた]]></title>
            <description><![CDATA[<h1>Kotlinのデフォルト引数を調べた</h1>
<p>こっとりーん！(挨拶)</p>
<p>Kotlinはこんな感じでデフォルト引数が使えます。</p>
<div class="highlight-kotlin notranslate"><div class="highlight"><pre><span/><span class="k">class</span> <span class="nc">Calc</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">2</span><span class="p">):</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">x</span> <span class="p">+</span> <span class="n">y</span>
  <span class="k">fun</span> <span class="nf">add2</span><span class="p">()</span> <span class="p">=</span> <span class="n">add</span><span class="p">(</span><span class="m">8</span><span class="p">,</span> <span class="m">16</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">add3</span><span class="p">()</span> <span class="p">=</span> <span class="n">add</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
  <span class="k">fun</span> <span class="nf">add4</span><span class="p">()</span> <span class="p">=</span> <span class="n">add</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>addの引数にデフォルト値を設定しているのでadd3やadd4で引数を省略できています。</p>
<p>で、これをjavapしました。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>public final int add(int, int);
  descriptor: (II)I
  flags: ACC_PUBLIC, ACC_FINAL
  Code:
    stack=2, locals=3, args_size=3
       0: iload_1
       1: iload_2
       2: iadd
       3: ireturn
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       4     0  this   LCalc;
          0       4     1     x   I
          0       4     2     y   I
    LineNumberTable:
      line 2: 0
  RuntimeVisibleParameterAnnotations:
    parameter 0:
      0: #22(#23=s#24)
    parameter 1:
      0: #22(#23=s#25)

public static int add$default(Calc, int, int, int);
  descriptor: (LCalc;III)I
  flags: ACC_PUBLIC, ACC_STATIC
  Code:
    stack=4, locals=4, args_size=4
       0: aload_0
       1: iload_3
       2: iconst_1
       3: iand
       4: ifeq          9
       7: iconst_1
       8: istore_1
       9: iload_1
      10: iload_3
      11: iconst_2
      12: iand
      13: ifeq          18
      16: iconst_2
      17: istore_2
      18: iload_2
      19: invokevirtual #32                 // Method add:(II)I
      22: ireturn
    LineNumberTable:
      line 2: 7
    StackMapTable: number_of_entries = 2
         frame_type = 73 /* same_locals_1_stack_item */
        stack = [ class Calc ]
         frame_type = 255 /* full_frame */
        offset_delta = 8
        locals = [ class Calc, int, int, int ]
        stack = [ class Calc, int ]


public final int add2();
  descriptor: ()I
  flags: ACC_PUBLIC, ACC_FINAL
  Code:
    stack=3, locals=1, args_size=1
       0: aload_0
       1: bipush        8
       3: bipush        16
       5: invokevirtual #32                 // Method add:(II)I
       8: ireturn
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       9     0  this   LCalc;
    LineNumberTable:
      line 3: 0

public final int add3();
  descriptor: ()I
  flags: ACC_PUBLIC, ACC_FINAL
  Code:
    stack=4, locals=1, args_size=1
       0: aload_0
       1: iconst_4
       2: iconst_0
       3: iconst_2
       4: invokestatic  #37                 // Method add$default:(LCalc;III)I
       7: ireturn
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       8     0  this   LCalc;
    LineNumberTable:
      line 4: 0

public final int add4();
  descriptor: ()I
  flags: ACC_PUBLIC, ACC_FINAL
  Code:
    stack=4, locals=1, args_size=1
       0: aload_0
       1: iconst_0
       2: iconst_0
       3: iconst_3
       4: invokestatic  #37                 // Method add$default:(LCalc;III)I
       7: ireturn
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       8     0  this   LCalc;
    LineNumberTable:
      line 5: 0

public Calc();
  descriptor: ()V
  flags: ACC_PUBLIC
  Code:
    stack=1, locals=1, args_size=1
       0: aload_0
       1: invokespecial #41                 // Method java/lang/Object."&lt;init&gt;":()V
       4: return
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       5     0  this   LCalc;
</pre></div>
</div>
<p>コンスタントプールやコンストラクタは省略しました。</p>
<p>注目すべきはadd$default(Calc, int, int, int)というstaticメソッドですね。
第2,3引数はaddメソッドの第1,2引数に対応しています。</p>
<p>そして第4引数がデフォルト値が必要かどうかを判断するためのビット演算を利用したフラグです。
判断の方法ですが、例えば第4引数と1との論理積が0の場合は第1引数にデフォルト値を、第4引数と2との論理積が0の場合は第2引数にデフォルト値を使用する、といった具合です。
次に示す箇所がそれに当たります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>1: iload_3
2: iconst_1
3: iand
4: ifeq          9
7: iconst_1
8: istore_1
9: iload_1
</pre></div>
</div>
<p>intは32ビットなので33以上の引数にはどう対応してるのだろうと思って調べてみたところ第33引数では一周回って1との論理積で判断していました。
ということは第1引数に明示的に値を指定すると第33引数に何も指定していなくてもデフォルト値は使用されないということになりますね。
試してはいないですが。</p>
<p>javapの抜粋を掲載しますがインデックス416以降がそれに当たります。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>390: iload         34
392: ldc           #77                 // int 1073741824
394: iand
395: ifeq          401
398: iconst_1
399: istore        31
401: iload         31
403: iload         34
405: ldc           #78                 // int -2147483648
407: iand
408: ifeq          414
411: iconst_1
412: istore        32
414: iload         32
416: iload         34
418: iconst_1
419: iand
420: ifeq          426
423: iconst_1
424: istore        33
426: iload         33
428: invokevirtual #80                 // Method x:(IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII)I
431: ireturn
</pre></div>
</div>
<p>ただしKotlinはまだM8なので改善されるかも知れませんね。
ていうか33も引数使うんじゃねえ、って話ですが。</p>
<p>そんなこんなでKotlinのデフォルト引数を調べてみました。
あとやっぱりjavapは楽しいです。</p>
]]></description>
             <pubDate>Sun, 06 Jul 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2014/07/01/kotlin_jaxrs.html</link>
            <guid>https://backpaper0.github.io/2014/07/01/kotlin_jaxrs.html</guid>
            <title><![CDATA[KotlinではじめるJAX-RS]]></title>
            <description><![CDATA[<h1>KotlinではじめるJAX-RS</h1>
<p>こっとりーん！（挨拶）</p>
<p>説明はもろもろすっ飛ばしてリソースクラスのコード掲載します。</p>
<div class="highlight-kotlin notranslate"><div class="highlight"><pre><span/><span class="k">package</span> <span class="nn">app</span>

<span class="k">import</span> <span class="nn">javax.ws.rs.core.MediaType</span>
<span class="k">import</span> <span class="nn">javax.ws.rs.GET</span>
<span class="k">import</span> <span class="nn">javax.ws.rs.Path</span>
<span class="k">import</span> <span class="nn">javax.ws.rs.Produces</span>
<span class="k">import</span> <span class="nn">javax.ws.rs.QueryParam</span> <span class="k">as</span> <span class="n">q</span>

<span class="n">Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="n">Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="n">TEXT_PLAIN</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Hello</span> <span class="p">{</span>

    <span class="n">GET</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">String</span> <span class="p">=</span> <span class="s">"Hello, ${name}!"</span>
<span class="p">}</span>
</pre></div>
</div>
<p>という感じで普通にJAX-RSできました。</p>
<p>というかnameがnull許容しないので@DefaultValueを付けるべきと今思いましたので気が向いたら直しておきます（やらないパターン）。</p>
<p>サンプルが簡易すぎてKotlinの良さが出ていないのが悲しいですね。</p>
<p>良かった点。</p>
<ul class="simple">
<li>Mavenで簡単にビルドできた</li>
<li>MavenプロジェクトをIntellij IDEAで容易くインポートできた</li>
<li><a class="reference external" href="https://twitter.com/ngsw_taro/">たろーさん</a> とTwitterで絡めた</li>
</ul>
<p>微妙な点。</p>
<ul class="simple">
<li>Intellij IDEAのKotlinプラグインのOrganize Importが弱い気がする</li>
<li>Intellij IDEAのコードフォーマットが <span class="kbd docutils literal"><span class="pre">option</span> <span class="pre">+</span> <span class="pre">command</span> <span class="pre">+</span> <span class="pre">l</span></span> で両手使うのがやだ</li>
<li>Intellij IDEAで <span class="kbd docutils literal"><span class="pre">command</span> <span class="pre">+</span> <span class="pre">w</span></span> でファイルが閉じてくれなかった</li>
</ul>
<p>そんな感じです。
要するにIntellij IDEAに慣れていないだけ、と。</p>
<p>それと <a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/kotlin-jaxrs-example/blob/master/src/test/java/app/HelloTest.java">テストクラス</a> はJavaで書いていますが、これはアノテーション付きのstaticメソッドの書き方が分からなかったからです。
きっと誰かがKotlinに直してプルリクしてくれるに違いない(ﾁﾗｯ</p>
<p>本日のコードはGitHubにあります。
<a class="reference external" href="http://arquillian.org/">Arquillian</a> のwildfly-managedでテスト書いてます。
テスト実行すると多くのJARと <a class="reference external" href="http://www.wildfly.org/">WildFly 8.1.0.Final</a> をダウンロードするので時間のあるときにどうぞ。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/kotlin-jaxrs-example">kotlin-jaxrs-example</a></li>
</ul>
<p>Kotlinの勉強会もあるみたいですよ。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.zusaar.com/event/12417003">第2回 かわいいKotlin勉強会 #jkug</a></li>
</ul>
]]></description>
             <pubDate>Tue, 01 Jul 2014 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/12/30/javafx.html</link>
            <guid>https://backpaper0.github.io/2013/12/30/javafx.html</guid>
            <title><![CDATA[JavaFXでクラサバする事を考えた]]></title>
            <description><![CDATA[<h1>JavaFXでクラサバする事を考えた</h1>
<p>私はエスアイヤーでギョームアプリ作ってるのでその辺りにJavaFXぶっ込んだらどうなるか考えてみました。</p>
<p>とりあえず次に挙げた機能が必要っぽいかなーと思います。</p>
<ul class="simple">
<li>画面遷移</li>
<li>検索結果などのグリッド表示</li>
<li>グリッドから詳細画面を開く的なやつ</li>
<li>ダイアログ</li>
<li>バックグラウンド処理</li>
<li>サーバとの通信</li>
</ul>
<div class="section" id="id1">
<h2>画面遷移</h2>
<p>Hoge駆動の忘年会というぁゃしぃ集まりでは</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javafx/2/api/javafx/stage/Stage.html#setScene(javafx.scene.Scene)">Stage#setScene(Scene)</a> でSceneを入れ替える</li>
<li><a class="reference external" href="http://docs.oracle.com/javafx/2/api/javafx/scene/Scene.html#setRoot(javafx.scene.Parent)">Scene#setRoot(Parent)</a> でルートノードを入れ替える</li>
</ul>
<p>という案を挙げてみました。
このふたつのうちSceneを入れ替える方法だと画面がチラついてしまいましたので
ルートノードを入れ替える方法がベターかなー、と思っていましたが、
StackPaneあたりに必要なだけNodeを突っ込んでvisibleを切り替える、
というのがもっと良いんじゃないかと現時点では思っています。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">sample</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javafx.application.Application</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.event.ActionEvent</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.event.EventHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.Scene</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.control.Button</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.layout.BorderPane</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.layout.StackPane</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.stage.Stage</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScreenTransitionSample</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">launch</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">Stage</span> <span class="n">stage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>

        <span class="kd">final</span> <span class="n">BorderPane</span> <span class="n">firstPane</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BorderPane</span><span class="p">();</span>
        <span class="n">Button</span> <span class="n">next</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Button</span><span class="p">(</span><span class="s">"次へ行く"</span><span class="p">);</span>
        <span class="n">firstPane</span><span class="p">.</span><span class="na">setCenter</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>

        <span class="kd">final</span> <span class="n">BorderPane</span> <span class="n">secondPane</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BorderPane</span><span class="p">();</span>
        <span class="n">Button</span> <span class="n">prev</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Button</span><span class="p">(</span><span class="s">"前へ戻る"</span><span class="p">);</span>
        <span class="n">secondPane</span><span class="p">.</span><span class="na">setCenter</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
        <span class="n">secondPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="n">StackPane</span> <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StackPane</span><span class="p">();</span>
        <span class="n">root</span><span class="p">.</span><span class="na">getChildren</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">firstPane</span><span class="p">);</span>
        <span class="n">root</span><span class="p">.</span><span class="na">getChildren</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">secondPane</span><span class="p">);</span>

        <span class="n">next</span><span class="p">.</span><span class="na">setOnAction</span><span class="p">(</span><span class="k">new</span> <span class="n">EventHandler</span><span class="o">&lt;</span><span class="n">ActionEvent</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">ActionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">firstPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
                <span class="n">secondPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="n">prev</span><span class="p">.</span><span class="na">setOnAction</span><span class="p">(</span><span class="k">new</span> <span class="n">EventHandler</span><span class="o">&lt;</span><span class="n">ActionEvent</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">ActionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">firstPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                <span class="n">secondPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="n">Scene</span> <span class="n">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scene</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
        <span class="n">stage</span><span class="p">.</span><span class="na">setScene</span><span class="p">(</span><span class="n">scene</span><span class="p">);</span>
        <span class="n">stage</span><span class="p">.</span><span class="na">setTitle</span><span class="p">(</span><span class="s">"画面遷移"</span><span class="p">);</span>
        <span class="n">stage</span><span class="p">.</span><span class="na">show</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>検索画面などのグリッド表示</h2>
<p><a class="reference external" href="http://docs.oracle.com/javafx/2/api/javafx/scene/control/TableView.html">TableView</a> を使います。</p>
<p>Scene Builderを使って画面を組み立てる場合はまずTableViewをペタっと置いて、
カラムを足す場合はTableColumnを貼付けたTableViewへペロっと置きます。</p>
<p>データを表示するときは <a class="reference external" href="http://docs.oracle.com/javafx/2/api/javafx/scene/control/TableColumn.html#setCellValueFactory(javafx.util.Callback)">TableColumn#setCellValueFactory(Callback)</a> を使って値のファクトリーを設定して、
TableViewのitemsへaddします。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">sample</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ResourceBundle</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.fxml.FXML</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.fxml.Initializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.control.TableColumn</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.control.TableView</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.control.cell.PropertyValueFactory</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GridController</span> <span class="kd">implements</span> <span class="n">Initializable</span> <span class="p">{</span>

    <span class="nd">@FXML</span>
    <span class="kd">private</span> <span class="n">TableView</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span><span class="p">;</span>
    <span class="nd">@FXML</span>
    <span class="kd">private</span> <span class="n">TableColumn</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">;</span>
    <span class="nd">@FXML</span>
    <span class="kd">private</span> <span class="n">TableColumn</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">;</span>
    <span class="nd">@FXML</span>
    <span class="kd">private</span> <span class="n">TableColumn</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">desc</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">URL</span> <span class="n">location</span><span class="p">,</span> <span class="n">ResourceBundle</span> <span class="n">resources</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span><span class="p">.</span><span class="na">setCellValueFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">PropertyValueFactory</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"id"</span><span class="p">));</span>
        <span class="n">name</span><span class="p">.</span><span class="na">setCellValueFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">PropertyValueFactory</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"name"</span><span class="p">));</span>
        <span class="n">desc</span><span class="p">.</span><span class="na">setCellValueFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">PropertyValueFactory</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"desc"</span><span class="p">));</span>

        <span class="n">Account</span> <span class="n">account1</span> <span class="o">=</span> <span class="n">Account</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="s">"backpaper0"</span><span class="p">,</span> <span class="s">"うらがみ"</span><span class="p">,</span> <span class="s">"全裸"</span><span class="p">);</span>
        <span class="n">Account</span> <span class="n">account2</span> <span class="o">=</span> <span class="n">Account</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="s">"tan_go238"</span><span class="p">,</span> <span class="s">"たんご"</span><span class="p">,</span> <span class="s">"カレー"</span><span class="p">);</span>
        <span class="n">Account</span> <span class="n">account3</span> <span class="o">=</span> <span class="n">Account</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="s">"irof"</span><span class="p">,</span> <span class="s">"いろふ"</span><span class="p">,</span> <span class="s">"足首"</span><span class="p">);</span>

        <span class="n">accounts</span><span class="p">.</span><span class="na">getItems</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">account1</span><span class="p">);</span>
        <span class="n">accounts</span><span class="p">.</span><span class="na">getItems</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">account2</span><span class="p">);</span>
        <span class="n">accounts</span><span class="p">.</span><span class="na">getItems</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">account3</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>こんな感じになります。</p>
<img alt="../../../_images/GridSample.png" src="https://backpaper0.github.io/_images/GridSample.png"/>
</div>
<div class="section" id="id3">
<h2>グリッドから詳細画面を開く的なやつ</h2>
<p><a class="reference external" href="http://docs.oracle.com/javafx/2/api/javafx/scene/control/TableColumn.html#setCellFactory(javafx.util.Callback)">TableColumn#setCellFactory(Callback)</a> を使います。
Callback実装クラスではセル毎にcallメソッドが呼ばれるようですが、
ここでTableCellを作成して返します。
TableCellではsetGraphicメソッドでボタンをセットしています。
これでセルにボタンを置く事が出来るようです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GridController</span> <span class="kd">implements</span> <span class="n">Initializable</span> <span class="p">{</span>

    <span class="p">...</span>

    <span class="nd">@FXML</span>
    <span class="kd">private</span> <span class="n">TableColumn</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">opener</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">URL</span> <span class="n">location</span><span class="p">,</span> <span class="n">ResourceBundle</span> <span class="n">resources</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">opener</span><span class="p">.</span><span class="na">setCellFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">OpenerFactory</span><span class="p">());</span>

        <span class="n">opener</span><span class="p">.</span><span class="na">setCellValueFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">PropertyValueFactory</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"id"</span><span class="p">));</span>

        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">OpenerFactory</span> <span class="kd">implements</span> <span class="n">Callback</span><span class="o">&lt;</span><span class="n">TableColumn</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TableCell</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TableCell</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">call</span><span class="p">(</span><span class="n">TableColumn</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">TableCell</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">tableCell</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TableCell</span><span class="o">&lt;</span><span class="n">Account</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

            <span class="kd">private</span> <span class="n">Pane</span> <span class="n">pane</span> <span class="o">=</span> <span class="n">createPane</span><span class="p">();</span>

            <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="p">;</span>

            <span class="kd">private</span> <span class="n">Pane</span> <span class="nf">createPane</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">HBox</span> <span class="n">pane</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HBox</span><span class="p">();</span>
                <span class="n">pane</span><span class="p">.</span><span class="na">setAlignment</span><span class="p">(</span><span class="n">Pos</span><span class="p">.</span><span class="na">CENTER</span><span class="p">);</span>

                <span class="n">Button</span> <span class="n">button</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Button</span><span class="p">(</span><span class="s">"詳細を開く"</span><span class="p">);</span>
                <span class="n">button</span><span class="p">.</span><span class="na">setOnAction</span><span class="p">(</span><span class="k">new</span> <span class="n">EventHandler</span><span class="o">&lt;</span><span class="n">ActionEvent</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">ActionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
                <span class="n">pane</span><span class="p">.</span><span class="na">getChildren</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">button</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">pane</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">updateItem</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">empty</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">super</span><span class="p">.</span><span class="na">updateItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">empty</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">empty</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
                    <span class="n">setGraphic</span><span class="p">(</span><span class="n">pane</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="n">tableCell</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ボタンが置けました。</p>
<img alt="../../../_images/GridOpenerSample.png" src="https://backpaper0.github.io/_images/GridOpenerSample.png"/>
</div>
<div class="section" id="id4">
<h2>ダイアログ</h2>
<p>Swingで言うところのJOptionPaneのようなお手軽ダイアログは無いようですが、Stageを使う事で実現可能っぽいです。</p>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/aoe-tk/20130526/1369577773">JavaFX2.2でダイアログを作る方法 - AOEの日記</a></li>
</ul>
</div>
<div class="section" id="id5">
<h2>バックグラウンド処理</h2>
<p><a class="reference external" href="http://docs.oracle.com/javafx/2/api/javafx/concurrent/Service.html">Service</a> を使います。
SwingWorker的なやつです。
こんな感じの雰囲気で。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Service</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Service</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Task</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">createTask</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Task</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Task</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">String</span> <span class="nf">call</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
                <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
                <span class="k">return</span> <span class="s">"終わったよーん"</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">succeeded</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">text</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">getValue</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="n">service</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
</pre></div>
</div>
<p>Service#createTask()でTaskを返しています。
Taskではcallメソッドを実装していますが、これがSwingWorkerでいうdoInBackgroundのようです。
succeededメソッドは処理が正常終了したときに呼ばれます。
他にキャンセルしたときに呼ばれるcancelledメソッドや失敗したときに呼ばれるfailedメソッドがあります。</p>
<p>しかし結果がどうあれ必ず呼ばれるfinally的なメソッドがありません。
これは不便な気がします。</p>
<p>finally的なアレを実現する方法として今んところ思いついているのは、Taskには実行中かそうでないかを表すrunningというbooleanのプロパティがあるので、
それにリスナーを追加します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">task</span><span class="p">.</span><span class="na">runningProperty</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span>
        <span class="k">new</span> <span class="n">ChangeListener</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changed</span><span class="p">(</span><span class="n">ObservableValue</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">observable</span><span class="p">,</span>
                                <span class="n">Boolean</span> <span class="n">oldValue</span><span class="p">,</span> <span class="n">Boolean</span> <span class="n">newValue</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newValue</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"終わったよーん"</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
</pre></div>
</div>
<p>もっと良い方法があったら教えて欲しいです。</p>
<p>あと、処理中にProgressIndicatorというのを表示しておくと良い感じになりそうです。
StackPaneにメインとなるPaneとProgressIndicatorを含んだPaneを突っ込んでvisibleで切り替えます。</p>
<p>というわけでバックグラウンド処理のサンプルを次に記載します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">sample</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.application.Application</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.concurrent.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.concurrent.Task</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.concurrent.WorkerStateEvent</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.event.ActionEvent</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.event.EventHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.geometry.Pos</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.Scene</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.control.Button</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.control.ProgressIndicator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.layout.GridPane</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.layout.StackPane</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.scene.text.Text</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javafx.stage.Stage</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongTimeTaskSample</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">launch</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="n">Stage</span> <span class="n">primaryStage</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>

        <span class="c1">//インジケータを含むPaneを組み立てる</span>
        <span class="kd">final</span> <span class="n">GridPane</span> <span class="n">progressPane</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GridPane</span><span class="p">();</span>
        <span class="n">progressPane</span><span class="p">.</span><span class="na">setAlignment</span><span class="p">(</span><span class="n">Pos</span><span class="p">.</span><span class="na">CENTER</span><span class="p">);</span>

        <span class="n">ProgressIndicator</span> <span class="n">indicator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProgressIndicator</span><span class="p">();</span>
        <span class="n">progressPane</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="c1">//メインとなるPaneを組み立てる</span>
        <span class="n">GridPane</span> <span class="n">mainPane</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GridPane</span><span class="p">();</span>
        <span class="n">mainPane</span><span class="p">.</span><span class="na">setAlignment</span><span class="p">(</span><span class="n">Pos</span><span class="p">.</span><span class="na">CENTER</span><span class="p">);</span>
        <span class="n">mainPane</span><span class="p">.</span><span class="na">setHgap</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="n">mainPane</span><span class="p">.</span><span class="na">setVgap</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

        <span class="n">Button</span> <span class="n">button</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Button</span><span class="p">(</span><span class="s">"重い処理を行う"</span><span class="p">);</span>
        <span class="n">mainPane</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="kd">final</span> <span class="n">Text</span> <span class="n">text</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Text</span><span class="p">();</span>
        <span class="n">mainPane</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="c1">//StackPaneに突っ込む</span>
        <span class="n">StackPane</span> <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StackPane</span><span class="p">();</span>
        <span class="n">root</span><span class="p">.</span><span class="na">getChildren</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">mainPane</span><span class="p">);</span>
        <span class="n">root</span><span class="p">.</span><span class="na">getChildren</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">progressPane</span><span class="p">);</span>

        <span class="c1">//最初はインジケータは見えなくする</span>
        <span class="n">progressPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="n">button</span><span class="p">.</span><span class="na">setOnAction</span><span class="p">(</span><span class="k">new</span> <span class="n">EventHandler</span><span class="o">&lt;</span><span class="n">ActionEvent</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">ActionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>

                <span class="c1">//ボタンが押されたらインジケータを見せる</span>
                <span class="n">progressPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                <span class="n">text</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
                <span class="n">Service</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Service</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

                    <span class="nd">@Override</span>
                    <span class="kd">protected</span> <span class="n">Task</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">createTask</span><span class="p">()</span> <span class="p">{</span>
                        <span class="n">Task</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Task</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

                            <span class="nd">@Override</span>
                            <span class="kd">protected</span> <span class="n">String</span> <span class="nf">call</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
                                <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
                                <span class="k">return</span> <span class="s">"終わったよーん"</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">};</span>
                        <span class="n">task</span><span class="p">.</span><span class="na">setOnSucceeded</span><span class="p">(</span><span class="k">new</span> <span class="n">EventHandler</span><span class="o">&lt;</span><span class="n">WorkerStateEvent</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>

                            <span class="nd">@Override</span>
                            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">WorkerStateEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
                                <span class="c1">//タスクが終わったらインジケータを見えなくする</span>
                                <span class="n">progressPane</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
                                <span class="n">text</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">getValue</span><span class="p">());</span>
                            <span class="p">}</span>
                        <span class="p">});</span>
                        <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">};</span>
                <span class="n">service</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="n">Scene</span> <span class="n">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scene</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
        <span class="n">primaryStage</span><span class="p">.</span><span class="na">setScene</span><span class="p">(</span><span class="n">scene</span><span class="p">);</span>
        <span class="n">primaryStage</span><span class="p">.</span><span class="na">setTitle</span><span class="p">(</span><span class="s">"重い処理"</span><span class="p">);</span>
        <span class="n">primaryStage</span><span class="p">.</span><span class="na">show</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>実行したらこんな感じです。</p>
<p>ポチっと。</p>
<img alt="../../../_images/LongTimeTaskSample1.png" src="https://backpaper0.github.io/_images/LongTimeTaskSample1.png"/>
<p>くるくるー。</p>
<img alt="../../../_images/LongTimeTaskSample2.png" src="https://backpaper0.github.io/_images/LongTimeTaskSample2.png"/>
<p>どーん！</p>
<img alt="../../../_images/LongTimeTaskSample3.png" src="https://backpaper0.github.io/_images/LongTimeTaskSample3.png"/>
<p>ちなみにこのコードだとインジケータが表示されているときにボタンはクリックできなくなっていますが、
タブでフォーカス移動してスペースキーで押せたりします。
きっとjava.awt.FocusTraversalPolicyのようなものがあると思うのでまた勉強しておくことにします。</p>
</div>
<div class="section" id="id6">
<h2>サーバとの通信</h2>
<p>(　ﾟ∀ﾟ)o彡°JAX-RS！JAX-RS！</p>
</div>
<div class="section" id="id7">
<h2>まとめ</h2>
<p>ここ数日JavaFXを触ってみてエスアイヤーのギョームアプリも普通に書けそうだなー、と感じました。</p>
<p>また今回はフォーカスしませんでしたがFXMLで画面を組めるのがすごく良いですね。
Scene Builderでサクッとモックを作って、OKならそのまま実装する、というスタイルが楽にできそうで嬉しいです。</p>
<p>あとScene Builderが特定のIDEに依存していないのも嬉しいですね。
好きなIDEを使えます。</p>
<p>という訳でJava 8がリリースされたら是非ともJavaFXでアプリケーション組みたいなー、と思ったのでした。</p>
<p>おわり。</p>
</div>
<div class="section" id="id8">
<h2>参考資料</h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javafx/">JavaFX Documentation</a></li>
<li><a class="reference external" href="http://skrb.hatenablog.com/">JavaFX in the Box</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/aoe-tk/searchdiary?word=%2A%5BJavaFX%5D">AOEの日記</a> ※リンクURLはJavaFXタグを検索しています</li>
<li><a class="reference external" href="http://itpro.nikkeibp.co.jp/article/COLUMN/20060915/248243/">Java技術最前線：ITpro</a> ※2012年8月～のテーマ「JavaFX 2で始めるGUI開発」</li>
</ul>
</div>
]]></description>
             <pubDate>Mon, 30 Dec 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/12/22/visitor.html</link>
            <guid>https://backpaper0.github.io/2013/12/22/visitor.html</guid>
            <title><![CDATA[Visitorパターンについて考えた]]></title>
            <description><![CDATA[<h1>Visitorパターンについて考えた</h1>
<p>というお話。縦に長いです。コードが。</p>
<div class="section" id="id1">
<h2>ポリもーなんとかでなんとかする</h2>
<p>例えば数値を表すNumNode、足し算を表すAddNode、それらのインターフェースとなるNodeがあるとします。
で、計算を実装する場合Nodeにcalcメソッドとか定義してNumNodeとAddNodeで実装します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Node1</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="nf">calc</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">NumNode1</span> <span class="kd">implements</span> <span class="n">Node1</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">NumNode1</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AddNode1</span> <span class="kd">implements</span> <span class="n">Node1</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node1</span> <span class="n">left</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node1</span> <span class="n">right</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AddNode1</span><span class="p">(</span><span class="n">Node1</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node1</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">left</span><span class="p">.</span><span class="na">calc</span><span class="p">()</span> <span class="o">+</span> <span class="n">right</span><span class="p">.</span><span class="na">calc</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>こいつで2 + 3 + 4を計算する場合は次のように使います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">org.hamcrest.CoreMatchers.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.hamcrest.MatcherAssert.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Node1Test</span> <span class="p">{</span>

    <span class="nd">@Test</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCalc</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Node1</span> <span class="n">node1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode1</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">Node1</span> <span class="n">node2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode1</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">Node1</span> <span class="n">node3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode1</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">);</span>
        <span class="n">Node1</span> <span class="n">node4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode1</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">Node1</span> <span class="n">node5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode1</span><span class="p">(</span><span class="n">node3</span><span class="p">,</span> <span class="n">node4</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">node5</span><span class="p">.</span><span class="na">calc</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">is</span><span class="p">(</span><span class="n">expected</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>さて、今度は組み立てたNodeをWriterへ書き出したくなったとします。
Nodeへprintメソッドを追加します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Node2</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="nf">calc</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="n">Writer</span> <span class="n">out</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">NumNode2</span> <span class="kd">implements</span> <span class="n">Node2</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">NumNode2</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="n">Writer</span> <span class="n">out</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AddNode2</span> <span class="kd">implements</span> <span class="n">Node2</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node2</span> <span class="n">left</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node2</span> <span class="n">right</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AddNode2</span><span class="p">(</span><span class="n">Node2</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node2</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">left</span><span class="p">.</span><span class="na">calc</span><span class="p">()</span> <span class="o">+</span> <span class="n">right</span><span class="p">.</span><span class="na">calc</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="n">Writer</span> <span class="n">out</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"("</span><span class="p">);</span>
        <span class="n">left</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"+"</span><span class="p">);</span>
        <span class="n">right</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">")"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>さて、次は××処理を追加しますのでNodeへ××メソッドを……と、まあ、
これはこれで良いんですが、処理を追加するたびにNodeおよびNode実装クラスに手を加える必要があり、それが嬉しくない状況もあります。</p>
</div>
<div class="section" id="id2">
<h2>処理を外から渡す</h2>
<p>Nodeから処理を取り除いて外から渡すことを考えてみます。</p>
<p>まずはinstanceofで分岐しつつ各Node実装クラスについて処理してみます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Node3</span> <span class="p">{}</span>

<span class="kd">class</span> <span class="nc">NumNode3</span> <span class="kd">implements</span> <span class="n">Node3</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">NumNode3</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AddNode3</span> <span class="kd">implements</span> <span class="n">Node3</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node3</span> <span class="n">left</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node3</span> <span class="n">right</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AddNode3</span><span class="p">(</span><span class="n">Node3</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node3</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Calclurator3</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">(</span><span class="n">Node3</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">AddNode3</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AddNode3</span> <span class="n">addNode3</span> <span class="o">=</span> <span class="p">(</span><span class="n">AddNode3</span><span class="p">)</span> <span class="n">node</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">calc</span><span class="p">(</span><span class="n">addNode3</span><span class="p">.</span><span class="na">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">calc</span><span class="p">(</span><span class="n">addNode3</span><span class="p">.</span><span class="na">right</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">NumNode3</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NumNode3</span> <span class="n">numNode3</span> <span class="o">=</span> <span class="p">(</span><span class="n">NumNode3</span><span class="p">)</span> <span class="n">node</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">numNode3</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>わーいこれで処理を外だしﾃﾞｷﾀﾖｰ、じゃねえよ！という感じですね。</p>
<p>instanceofの欠点はケースの漏れを静的に検出できないことだと思っています。
例えばこの例で言うとNode実装クラスはAddNodeとNumNodeがありますが、
NumNodeへの分岐を忘れていてもコンパイル時に気付きません。
さらに node instanceof java.util.Date とか無関係なクラスを書いていても
これもコンパイル時に気付きません。</p>
<p>ケースの漏れを静的に検出といえばswitchがありますが、
Stringかprimitiveまたはenumしか使えないので今回の例には不適当です。</p>
<p>いやいやそんなのポリもーなんとかでアレすれば良いじゃん、という事で次のようなインターフェースを作ります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">interface</span> <span class="nc">Visitor4</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode4</span> <span class="n">node</span><span class="p">);</span>

    <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode4</span> <span class="n">node</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これをこういう風に実装すれば……</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">class</span> <span class="nc">Calclurator4</span> <span class="kd">implements</span> <span class="n">Visitor4</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">(</span><span class="n">Node4</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode4</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode4</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>華麗に解決！というわけには行きませんね。
calcメソッド内のvisit(node)やAddNodeをとるvisitメソッド内でのvisit(node.left)やvisit(node.right)では
渡しているNode実装クラスがなんなのか、コンパイル時には分かりませんので普通にコンパイルエラーです。</p>
<p>無理矢理コンパイルを通そうと思うとこんなコードになりました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">class</span> <span class="nc">Calclurator4</span> <span class="kd">implements</span> <span class="n">Visitor4</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calc</span><span class="p">(</span><span class="n">Node4</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">NumNode4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">visit</span><span class="p">((</span><span class="n">NumNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">AddNode4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">visit</span><span class="p">((</span><span class="n">AddNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode4</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode4</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">//compile error</span>
        <span class="c1">//return visit(node.left) + visit(node.left);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">left</span> <span class="k">instanceof</span> <span class="n">NumNode4</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NumNode4</span> <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">NumNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">right</span> <span class="k">instanceof</span> <span class="n">NumNode4</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NumNode4</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">NumNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">visit</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">visit</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">right</span> <span class="k">instanceof</span> <span class="n">AddNode4</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">AddNode4</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">AddNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">visit</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">visit</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">left</span> <span class="k">instanceof</span> <span class="n">AddNode4</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AddNode4</span> <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">AddNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">right</span> <span class="k">instanceof</span> <span class="n">NumNode4</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NumNode4</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">NumNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">visit</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">visit</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">right</span> <span class="k">instanceof</span> <span class="n">AddNode4</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">AddNode4</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">AddNode4</span><span class="p">)</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">visit</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">+</span> <span class="n">visit</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>はい、そこそこクソコードになりましたね？
ていうかまたinstanceofが出てきましたし。</p>
</div>
<div class="section" id="id3">
<h2>そこでVisitorパターンですよ</h2>
<p>Nodeにacceptメソッドを追加して実装クラスで対応するvisitメソッドを呼ぶようにします。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Node5</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor5</span> <span class="n">visitor</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">NumNode5</span> <span class="kd">implements</span> <span class="n">Node5</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">NumNode5</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor5</span> <span class="n">visitor</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AddNode5</span> <span class="kd">implements</span> <span class="n">Node5</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node5</span> <span class="n">left</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node5</span> <span class="n">right</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AddNode5</span><span class="p">(</span><span class="n">Node5</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node5</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor5</span> <span class="n">visitor</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">interface</span> <span class="nc">Visitor5</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode5</span> <span class="n">node</span><span class="p">);</span>

    <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode5</span> <span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Calclurator5</span> <span class="kd">implements</span> <span class="n">Visitor5</span> <span class="p">{</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode5</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode5</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Printer5</span> <span class="kd">implements</span> <span class="n">Visitor5</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Writer</span> <span class="n">out</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Printer5</span><span class="p">(</span><span class="n">Writer</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode5</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode5</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"("</span><span class="p">);</span>
            <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"+"</span><span class="p">);</span>
            <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">")"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>先ほどの例とは異なりvisitメソッドを各Node実装クラスのacceptメソッド内で呼んでいるので
どのvisitメソッドなのかコンパイル時に分かりますね。</p>
<p>これは次のように使います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">org.hamcrest.CoreMatchers.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.hamcrest.MatcherAssert.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.StringWriter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Node5Test</span> <span class="p">{</span>

    <span class="nd">@Test</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCalc</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Node5</span> <span class="n">node1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode5</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode5</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode5</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode5</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode5</span><span class="p">(</span><span class="n">node3</span><span class="p">,</span> <span class="n">node4</span><span class="p">);</span>
        <span class="n">Calclurator5</span> <span class="n">calclurator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calclurator5</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">node5</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">calclurator</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">expected</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">is</span><span class="p">(</span><span class="n">expected</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Test</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPrint</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Node5</span> <span class="n">node1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode5</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode5</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode5</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode5</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">Node5</span> <span class="n">node5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode5</span><span class="p">(</span><span class="n">node3</span><span class="p">,</span> <span class="n">node4</span><span class="p">);</span>
        <span class="n">StringWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="p">();</span>
        <span class="n">Printer5</span> <span class="n">printer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Printer5</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">node5</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">printer</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
        <span class="n">String</span> <span class="n">expected</span> <span class="o">=</span> <span class="s">"((2+3)+4)"</span><span class="p">;</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">is</span><span class="p">(</span><span class="n">expected</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これで処理を外に出せました。</p>
<p>が、visitメソッドの戻り値がintだったりそもそもPrinterでは戻り値が意味なかったりしてもやもやしますね。</p>
</div>
<div class="section" id="id4">
<h2>ジェネリクスを使う</h2>
<p>使いましょう。
引数と戻り値をジェネリクスでアレします。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Node6</span> <span class="p">{</span>

    <span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor6</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">NumNode6</span> <span class="kd">implements</span> <span class="n">Node6</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">NumNode6</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor6</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AddNode6</span> <span class="kd">implements</span> <span class="n">Node6</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node6</span> <span class="n">left</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node6</span> <span class="n">right</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AddNode6</span><span class="p">(</span><span class="n">Node6</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node6</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor6</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">interface</span> <span class="nc">Visitor6</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="n">R</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode6</span> <span class="n">node</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">);</span>

    <span class="n">R</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode6</span> <span class="n">node</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Calclurator6</span> <span class="kd">implements</span> <span class="n">Visitor6</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode6</span> <span class="n">node</span><span class="p">,</span> <span class="n">Void</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode6</span> <span class="n">node</span><span class="p">,</span> <span class="n">Void</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Printer6</span> <span class="kd">implements</span> <span class="n">Visitor6</span><span class="o">&lt;</span><span class="n">Void</span><span class="p">,</span> <span class="n">Writer</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Void</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode6</span> <span class="n">node</span><span class="p">,</span> <span class="n">Writer</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Void</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode6</span> <span class="n">node</span><span class="p">,</span> <span class="n">Writer</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"("</span><span class="p">);</span>
            <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
            <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"+"</span><span class="p">);</span>
            <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
            <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">")"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これでだいぶ良い感じになってきました。</p>
<p>が、PrinterでIOExceptionをRuntimeExceptionへラップしてるおなじみのコードが哀愁を漂わせます。</p>
</div>
<div class="section" id="id5">
<h2>例外もジェネリクスで</h2>
<p>やってしまいましょう。
Visitorの定義を少し修正します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">visitor</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Node7</span> <span class="p">{</span>

    <span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">accept</span><span class="p">(</span><span class="n">Visitor7</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">E</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">NumNode7</span> <span class="kd">implements</span> <span class="n">Node7</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">NumNode7</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">accept</span><span class="p">(</span>
            <span class="n">Visitor7</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">E</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AddNode7</span> <span class="kd">implements</span> <span class="n">Node7</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node7</span> <span class="n">left</span><span class="p">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Node7</span> <span class="n">right</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">AddNode7</span><span class="p">(</span><span class="n">Node7</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node7</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">R</span> <span class="nf">accept</span><span class="p">(</span>
            <span class="n">Visitor7</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">E</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">interface</span> <span class="nc">Visitor7</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="n">R</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode7</span> <span class="n">node</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">E</span><span class="p">;</span>

    <span class="n">R</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode7</span> <span class="n">node</span><span class="p">,</span> <span class="n">P</span> <span class="n">parameter</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">E</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Calclurator7</span> <span class="kd">implements</span> <span class="n">Visitor7</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Void</span><span class="p">,</span> <span class="n">RuntimeException</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode7</span> <span class="n">node</span><span class="p">,</span> <span class="n">Void</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode7</span> <span class="n">node</span><span class="p">,</span> <span class="n">Void</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Printer7</span> <span class="kd">implements</span> <span class="n">Visitor7</span><span class="o">&lt;</span><span class="n">Void</span><span class="p">,</span> <span class="n">Writer</span><span class="p">,</span> <span class="n">IOException</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Void</span> <span class="nf">visit</span><span class="p">(</span><span class="n">NumNode7</span> <span class="n">node</span><span class="p">,</span> <span class="n">Writer</span> <span class="n">parameter</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">value</span><span class="p">));</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Void</span> <span class="nf">visit</span><span class="p">(</span><span class="n">AddNode7</span> <span class="n">node</span><span class="p">,</span> <span class="n">Writer</span> <span class="n">parameter</span><span class="p">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"("</span><span class="p">);</span>
        <span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
        <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">"+"</span><span class="p">);</span>
        <span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>
        <span class="n">parameter</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">")"</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>もうだいぶ訳の分からないクソコードとなってきた感じがしますが、
Calculatorではチェック例外を投げず、PrinterではIOExceptionを投げるような表現が
できました。
お疲れ様でした。</p>
</div>
<div class="section" id="id6">
<h2>他の言語ではどうなのか</h2>
<p>Groovyではどのメソッドを呼ぶかは実行時に決まるのでacceptメソッドが不要です。
たしか動的ディスパッチと呼ばれていたと思います。</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span/><span class="kd">class</span> <span class="nc">AddNode</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">left</span>
    <span class="kt">def</span> <span class="n">right</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">NumNode</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">value</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="nf">visit</span><span class="o">(</span><span class="n">AddNode</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">visit</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">+</span> <span class="n">visit</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">right</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="kt">def</span> <span class="nf">visit</span><span class="o">(</span><span class="n">NumNode</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span> <span class="n">node</span><span class="o">.</span><span class="na">value</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">node1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode</span><span class="o">(</span><span class="nl">value:</span> <span class="mi">2</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">node2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode</span><span class="o">(</span><span class="nl">value:</span> <span class="mi">3</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">node3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode</span><span class="o">(</span><span class="nl">left:</span> <span class="n">node1</span><span class="o">,</span> <span class="nl">right:</span> <span class="n">node2</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">node4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NumNode</span><span class="o">(</span><span class="nl">value:</span> <span class="mi">4</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">node5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddNode</span><span class="o">(</span><span class="nl">left:</span> <span class="n">node3</span><span class="o">,</span> <span class="nl">right:</span> <span class="n">node4</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calculator</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="n">node5</span><span class="o">)</span>

<span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="o">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">)</span>
</pre></div>
</div>
<p>またScalaではパターンマッチを使えば良いです。
ケースの漏れはsealedを使えば検出可能だったと思います。</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span/><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Node</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">NumNode</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Node</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AddNode</span><span class="o">(</span><span class="n">left</span><span class="k">:</span> <span class="kt">Node</span><span class="o">,</span> <span class="n">right</span><span class="k">:</span> <span class="kt">Node</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Node</span>

<span class="k">def</span> <span class="n">calc</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">Node</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">node</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">NumNode</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">value</span>
  <span class="k">case</span> <span class="nc">AddNode</span><span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">calc</span><span class="o">(</span><span class="n">left</span><span class="o">)</span> <span class="o">+</span> <span class="n">calc</span><span class="o">(</span><span class="n">right</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">node1</span> <span class="o">=</span> <span class="nc">NumNode</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="k">val</span> <span class="n">node2</span> <span class="o">=</span> <span class="nc">NumNode</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="k">val</span> <span class="n">node3</span> <span class="o">=</span> <span class="nc">AddNode</span><span class="o">(</span><span class="n">node1</span><span class="o">,</span> <span class="n">node2</span><span class="o">)</span>
<span class="k">val</span> <span class="n">node4</span> <span class="o">=</span> <span class="nc">NumNode</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
<span class="k">val</span> <span class="n">node5</span> <span class="o">=</span> <span class="nc">AddNode</span><span class="o">(</span><span class="n">node3</span><span class="o">,</span> <span class="n">node4</span><span class="o">)</span>
<span class="k">val</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">calc</span><span class="o">(</span><span class="n">node5</span><span class="o">)</span>

<span class="n">assert</span><span class="o">(</span><span class="n">actual</span> <span class="o">==</span> <span class="o">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">))</span>
</pre></div>
</div>
<p>それに、Nodeを分解してvalueやleft、rightを取り出したりできてvisitorパターンより超高機能です。
しかもコード短いし。
静的なアレだし。</p>
</div>
<div class="section" id="id7">
<h2>まとめ</h2>
<p>Javaではデータとアルゴリズムを分離するとき、</p>
<ul class="simple">
<li>instanceofはケースの漏れを静的に検出できない</li>
<li>switchはString、primitive、enumしか受け付けない</li>
<li>パターンマッチが無い</li>
</ul>
<p>などの理由によりVisitorパターンを使わざるを得ない場合があります。
しかし数あるデザインパターンの中でもVisitorパターンは理解するのが難しいように思います。
またそれなりに汎用的にしようと思うとジェネリクスを使って複雑な定義になってしまったり。</p>
<p>よって、使わなくて済むならそれに越した事は無く、使う場合でも本当にVisitorパターンが必要なのかしっかり検討すべきだと思います。</p>
<p>私も最近、色々あってVisitorパターンを使ってしまいましたが、もっと良い設計があったような気がしています。</p>
<p>こんなまとめでええんか？</p>
<p>まあいいか。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/visitor-example">本日のコード</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 22 Dec 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/12/03/javaee_advent_calendar_2013.html</link>
            <guid>https://backpaper0.github.io/2013/12/03/javaee_advent_calendar_2013.html</guid>
            <title><![CDATA[私のBeanValidationの使い方(Java EE Advent Calendar 2013)]]></title>
            <description><![CDATA[<h1>私のBeanValidationの使い方(Java EE Advent Calendar 2013)</h1>
<p>このエントリは <a class="reference external" href="http://www.adventar.org/calendars/152">Java EE Advent Calendar 2013</a> の3日目です。
昨日は <a class="reference external" href="https://twitter.com/matsumana">@matsumana</a> さんのご担当で <a class="reference external" href="http://matsumana.info/blog/2013/12/02/jax-rs-mustache/">JAX-RS + mustache - @matsumana の技術メモ</a> でした。</p>
<p>今回はBeanValidationの自分なりの使い方をご紹介します。</p>
<div class="section" id="id1">
<h2>その前に</h2>
<p>BeanValidationてなんや？という方は <a class="reference external" href="http://jcp.org/en/jsr/detail?id=349">JSR 349</a> の仕様を読むと良いでしょう。
200ページ超えてますが半分以上コードっぽいのでそんなにしんどくないんじゃないかと思わなくもないけどどうでしょうか？</p>
<p>もしくは「BeanValidation しんさん」でググると良いですよ。</p>
</div>
<div class="section" id="id2">
<h2>本題</h2>
<p>BeanValidationではフィールドやgetterに@NotNullとか@Sizeとかアノテーションをモリモリ付けてバリデーションするわけですが、調子に乗ってるとすぐアノテーション地獄になってキツいのです。
ですので特定のバリデーションを集約する方法が欲しいわけでして、正攻法は独自のアノテーションを導入してそこに集約することだと思いますが、私は別のやり方を採用しています。</p>
<p>まず、正攻法と同じく独自のアノテーションとConstraintValidatorを導入します。
アノテーションはこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">net.hogedriven.backpaper0.javaeeadventcalendar2013</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.*</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="p">;</span>

<span class="nd">@Target</span><span class="p">({</span> <span class="n">METHOD</span><span class="p">,</span> <span class="n">FIELD</span><span class="p">,</span> <span class="n">ANNOTATION_TYPE</span><span class="p">,</span> <span class="n">CONSTRUCTOR</span><span class="p">,</span> <span class="n">PARAMETER</span> <span class="p">})</span>
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="p">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DomainValidator</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DomainType</span> <span class="p">{</span>

    <span class="n">String</span> <span class="nf">message</span><span class="p">()</span> <span class="k">default</span> <span class="s">""</span><span class="p">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="p">()</span> <span class="k">default</span> <span class="p">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="p">()</span> <span class="k">default</span> <span class="p">{};</span>

    <span class="nd">@Target</span><span class="p">({</span> <span class="n">METHOD</span><span class="p">,</span> <span class="n">FIELD</span><span class="p">,</span> <span class="n">ANNOTATION_TYPE</span><span class="p">,</span> <span class="n">CONSTRUCTOR</span><span class="p">,</span> <span class="n">PARAMETER</span> <span class="p">})</span>
    <span class="nd">@Retention</span><span class="p">(</span><span class="n">RUNTIME</span><span class="p">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="p">{</span>

        <span class="n">DomainType</span><span class="o">[]</span> <span class="nf">value</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>至って普通ですね。</p>
<p>続いてConstraintValidatorはこんな感じです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">net.hogedriven.backpaper0.javaeeadventcalendar2013</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DomainValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">DomainType</span><span class="p">,</span> <span class="n">WithValidation</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">DomainType</span> <span class="n">constraintAnnotation</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="p">(</span><span class="n">WithValidation</span> <span class="n">value</span><span class="p">,</span>
            <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="na">validate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">context</span><span class="p">.</span><span class="na">disableDefaultConstraintViolation</span><span class="p">();</span>
        <span class="n">context</span><span class="p">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="p">.</span><span class="na">addConstraintViolation</span><span class="p">();</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>isValidメソッドでは具体的なバリデーションは行わずWithValidation#validateに任せています。</p>
<p>WithValidation実装クラスは例えばこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">net.hogedriven.backpaper0.javaeeadventcalendar2013</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserId</span> <span class="kd">implements</span> <span class="n">WithValidation</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">UserId</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getValue</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">validate</span><span class="p">()</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="na">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">"10文字以下でｵﾅｼｬｽ"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span> <span class="p">:</span> <span class="n">value</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="sc">'a'</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span>
                    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="sc">'A'</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span>
                    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="sc">'0'</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s">"アルファベットと数字でよろろ"</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">UserId</span> <span class="nf">fromString</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">UserId</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>validateメソッド内で詳しく値をチェックしてエラーがなければnullを、エラーがあったらエラーメッセージを返しています。</p>
<p>ConstraintValidatorのisValidメソッドではこのvalidateメソッドでエラーが返ってきたらそれをもとにConstraintViolationを組み立てます。</p>
</div>
<div class="section" id="id3">
<h2>なぜこの方法を取るのか</h2>
<p>私の大好きな <a class="reference external" href="http://jcp.org/en/jsr/detail?id=339">JAX-RS</a> ではリクエストパラメータやフォームパラメータを独自のクラスで受け取ることが出来ます。
で、jersey-mvc使って画面もモリモリ書いてるのでそれなりのメッセージが返るバリデーションをしたいのです。
しかもものぐさなので出来るだけ楽したいなー、と考えたり考えなかったりしながら色々試して今ここ、といった感じです。
それにしてもJAX-RSいいよJAX-RS。</p>
<p>ちなみにDomainTypeという名前にしているのはDDD由来ではなくて私の大好きな <a class="reference external" href="http://doma.seasar.org/">Doma</a> というフレームワークの機能であるドメインクラスに対してバリデーションを付けることが多いのでそういう名前にしています。
いやホントDomaいいよDoma。</p>
</div>
<div class="section" id="id4">
<h2>メリット＆デメリット</h2>
<p>この方法をとるとアノテーションは@DomainTypeを付けるだけで良いのでどのアノテーションを使えば良いのか迷うこともないしアノテーション地獄が少しマシになります。</p>
<p>デメリットもあって、これは自分でもイケてないと思いまくっているのですが、WithValidation実装クラスがバリデーションするために不正な状態を許している、という点です。
本来ならfromStringファクトリメソッドでバリデーションしておかしな値だったら例外投げるのが正道と思います。
まあメリットとデメリットを秤にかけて現状はこの方法を取っとくのがベターやな、といった所です。</p>
</div>
<div class="section" id="id5">
<h2>おまけ：相関バリデーション</h2>
<p>……というのかどうかは知りませんが「開始時刻」と「終了時刻」の前後関係が正しいか？みたいなふたつ以上の値を用いたバリデーションをする方法です。
簡単です。</p>
<p>BeanValidationはフィールドかgetterにアノテーションを付けてバリデーションを行うので一見相関バリデーションは行えない気がします。
が、例えば、ふたつの値をまとめるTupleというクラスを作ってそれに対してバリデーションするConstraintValidatorを作ればおkです。</p>
<p>試しにふたつの値が同じか検証するやつを書いてみました。</p>
<p>まずはTupleというクラスを導入。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">net.hogedriven.backpaper0.javaeeadventcalendar2013</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tuple</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">first</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">second</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Tuple</span><span class="p">(</span><span class="n">String</span> <span class="n">first</span><span class="p">,</span> <span class="n">String</span> <span class="n">second</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">second</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>次にConstraintValidator。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">net.hogedriven.backpaper0.javaeeadventcalendar2013</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.ConstraintValidatorContext</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EqualValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">Equal</span><span class="p">,</span> <span class="n">Tuple</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">Equal</span> <span class="n">constraintAnnotation</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="p">(</span><span class="n">Tuple</span> <span class="n">value</span><span class="p">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="na">first</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="na">second</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>最後にアノテーション。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">net.hogedriven.backpaper0.javaeeadventcalendar2013</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">java.lang.annotation.ElementType.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.annotation.RetentionPolicy.*</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.Constraint</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="p">;</span>

<span class="nd">@Target</span><span class="p">({</span> <span class="n">METHOD</span><span class="p">,</span> <span class="n">FIELD</span><span class="p">,</span> <span class="n">ANNOTATION_TYPE</span><span class="p">,</span> <span class="n">CONSTRUCTOR</span><span class="p">,</span> <span class="n">PARAMETER</span> <span class="p">})</span>
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="p">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="p">{</span> <span class="n">EqualValidator</span><span class="p">.</span><span class="na">class</span> <span class="p">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Equal</span> <span class="p">{</span>

    <span class="n">String</span> <span class="nf">message</span><span class="p">()</span> <span class="k">default</span> <span class="s">""</span><span class="p">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="p">()</span> <span class="k">default</span> <span class="p">{};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="p">()</span> <span class="k">default</span> <span class="p">{};</span>

    <span class="nd">@Target</span><span class="p">({</span> <span class="n">METHOD</span><span class="p">,</span> <span class="n">FIELD</span><span class="p">,</span> <span class="n">ANNOTATION_TYPE</span><span class="p">,</span> <span class="n">CONSTRUCTOR</span><span class="p">,</span> <span class="n">PARAMETER</span> <span class="p">})</span>
    <span class="nd">@Retention</span><span class="p">(</span><span class="n">RUNTIME</span><span class="p">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="p">{</span>

        <span class="n">Equal</span><span class="o">[]</span> <span class="nf">value</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>特別なことはなにもないコードですね。</p>
<p>使い方は次のような感じです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">private</span> <span class="n">String</span> <span class="n">first</span><span class="p">;</span>

<span class="kd">private</span> <span class="n">String</span> <span class="n">second</span><span class="p">;</span>

<span class="nd">@Equal</span><span class="p">(</span><span class="n">message</span> <span class="o">=</span> <span class="s">"違う値はアカン"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Tuple</span> <span class="nf">getValue</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>また、相関バリデーションはひとつひとつの値がvalid前提であることが多いでしょうからgroupsを上手く使ってアレしてあげれば良いですね。</p>
</div>
<div class="section" id="id6">
<h2>というわけで</h2>
<p>自分なりのBeanValidationの使い方でした。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/javaee-advent-calendar">本日のコード</a></li>
</ul>
<p>Java EE Advent Calendar 2013、明日のご担当は <a class="reference external" href="https://twitter.com/kazuhira_r">@kazuhira_r</a> さんです。</p>
</div>
]]></description>
             <pubDate>Tue, 03 Dec 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/09/26/glassfish_server_xpoweredby.html</link>
            <guid>https://backpaper0.github.io/2013/09/26/glassfish_server_xpoweredby.html</guid>
            <title><![CDATA[GlassFish v3.1.2.2でServerヘッダとX-Powered-Byヘッダを返さないようにする]]></title>
            <description><![CDATA[<h1>GlassFish v3.1.2.2でServerヘッダとX-Powered-Byヘッダを返さないようにする</h1>
<p>まずはServerヘッダ。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>asadmin create-jvm-option -Dproduct.name<span class="o">=</span>
</pre></div>
</div>
<p>JVMオプションなので設定の反映にはGlassFishを再起動する必要があります。</p>
<p>次、X-Powered-Byヘッダ。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>asadmin <span class="nb">set</span> configs.config.server-config.network-config.protocols.protocol.http-listener-1.http.xpowered-by<span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
<p>こちらは設定は則反映されます。</p>
<p>で、JSP。
default-web.xmlでJspServletを設定しているところを見つけます。
でフォルトではxpoweredByがtrueに設定されているのでこれをfalseにします。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;servlet&gt;</span>
  <span class="nt">&lt;servlet-name&gt;</span>jsp<span class="nt">&lt;/servlet-name&gt;</span>
  <span class="nt">&lt;servlet-class&gt;</span>org.apache.jasper.servlet.JspServlet<span class="nt">&lt;/servlet-class&gt;</span>
  <span class="nt">&lt;init-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>xpoweredBy<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>false<span class="nt">&lt;/param-value&gt;</span>
  <span class="nt">&lt;/init-param&gt;</span>
</pre></div>
</div>
<p>最後にJSF。
web.xmlでFacesServletを設定する際にinit-paramでcom.sun.faces.sendPoweredByHeaderをfalseに設定すると良いようです。
試してない。</p>
]]></description>
             <pubDate>Thu, 26 Sep 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/07/17/jaxrs_parameter.html</link>
            <guid>https://backpaper0.github.io/2013/07/17/jaxrs_parameter.html</guid>
            <title><![CDATA[JAX-RSでパラメータの受け取り方をいろいろ試す]]></title>
            <description><![CDATA[<h1>JAX-RSでパラメータの受け取り方をいろいろ試す</h1>
<p>JAX-RSでは次に挙げるアノテーションをメソッドの引数などに付けることでクエリパラメータやパスの一部を受け取ることができます。</p>
<ul class="simple">
<li>@MatrixParam</li>
<li>@QueryParam</li>
<li>@PathParam</li>
<li>@CookieParam</li>
<li>@HeaderParam</li>
</ul>
<p>メソッドの引数はStringやプリミティブを使うことができますが、それ以外のクラスも使用できます。</p>
<div class="section" id="stringpublic">
<h2>Stringの引数をひとつだけ受け取るpublicなコンストラクタを持つクラス</h2>
<p>次のようなクラスでもクエリパラメータなどを受け取ることが出来ます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Hoge</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>リソースメソッドでは次のように使います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"abc"</span><span class="p">)</span> <span class="n">Hoge</span> <span class="n">abc</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>この例でいうとabcという名前のクエリパラメータがnullの場合はHogeはインスタンス化されず引数abcはnullとなります。
クエリパラメータがnullの場合というのはabcという名前のクエリパラメータが無い場合です。
?abc=&amp;def=xyz というようなクエリパラメータの場合はabcはnullではなく空文字列です。</p>
</div>
<div class="section" id="string-valueof-static">
<h2>Stringの引数をひとつだけ受け取る”valueOf”という名前のstaticファクトリメソッドを持つクラス</h2>
<p>次のようなクラスを使用することも可能です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="p">;</span>

    <span class="kd">private</span> <span class="nf">Hoge</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Hoge</span> <span class="nf">valueOf</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Hoge</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>staticファクトリメソッドを書く分の手間が増えますが、例えば、</p>
<ul class="simple">
<li>valueが空文字列の場合はnullを返す</li>
<li>Integerのようにキャッシュすることができる</li>
<li>サブクラスを返すことができる</li>
</ul>
<p>という風に柔軟に実装することが可能です。
また、クラス（この例でいうとHoge）をabstractにすることも可能です。</p>
</div>
<div class="section" id="string-fromstring-static">
<h2>Stringの引数をひとつだけ受け取る”fromString”という名前のstaticファクトリメソッドを持つクラス</h2>
<p>staticファクトリメソッドはvalueOf以外にfromStringという名前にすることも可能です。</p>
<p>ひとつのクラスにvalueOfとfromStringの両方が定義されている場合はvalueOfが呼ばれます。
ただし列挙型の場合はvalueOfが暗黙的に実装されており挙動を上書きできないためか、fromStringが呼ばれます。
列挙型でなくともfromStringを優先にしておけば良かったのでは、と思わなくもないです。</p>
</div>
<div class="section" id="paramconverter">
<h2>ParamConverterを使用する</h2>
<p>JAX-RS 2から</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/ws/rs/ext/ParamConverter.html">ParamConverter</a></li>
<li><a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/ws/rs/ext/ParamConverterProvider.html">ParamConverterProvider</a></li>
</ul>
<p>というふたつのインターフェースが追加されました。</p>
<p>ParamConverterの実装クラスではStringから任意のクラスに変換するロジックを書きます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HogeParamConverter</span> <span class="kd">implements</span> <span class="n">ParamConverter</span><span class="o">&lt;</span><span class="n">Hoge</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Hoge</span> <span class="nf">fromString</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Hoge</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">(</span><span class="n">Hoge</span> <span class="n">hoge</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">hoge</span><span class="p">.</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ParamConverterProviderの実装クラスではリソースメソッドの引数の型やアノテーションをもとにParamConverterを選択して返します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HogeParamConverterProvider</span> <span class="kd">implements</span> <span class="n">ParamConverterProvider</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ParamConverter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getConverter</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">rawType</span><span class="p">,</span> <span class="n">Type</span> <span class="n">genericType</span><span class="p">,</span> <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rawType</span> <span class="o">==</span> <span class="n">Hoge</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ParamConverter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">new</span> <span class="n">HogeParamConverter</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この方法は一番手間がかかりますがstaticファクトリメソッドを用いる方法と比べて</p>
<ul class="simple">
<li>Hogeをインターフェースにすることが可能</li>
<li>同じ型に対してもアノテーションによって異なるParamConverterを使用できる</li>
<li>javaから始まるパッケージのクラスなど既存のクラスも使用できる</li>
</ul>
<p>といったことが利点だと思います。</p>
</div>
<div class="section" id="id1">
<h2>まとめ</h2>
<p>JAX-RS 2からParamConverterが入った事でクリエパラメータやリクエストヘッダをどんな型でも受け取ることができるようになりました。
インターセプターやクライアントAPIに比べると地味に見えますが、なかなか素晴らしい進化だと個人的には思っています。</p>
<p>サンプル書きました。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/jaxrs-parameter-example">https://github.com/backpaper0/sandbox/tree/master/jaxrs-parameter-example</a></li>
</ul>
</div>
]]></description>
             <pubDate>Wed, 17 Jul 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/07/15/websocket_pathparam.html</link>
            <guid>https://backpaper0.github.io/2013/07/15/websocket_pathparam.html</guid>
            <title><![CDATA[Java API for WebSocketの@PathParamを試す]]></title>
            <description><![CDATA[<h1>Java API for WebSocketの@PathParamを試す</h1>
<p><a class="reference external" href="http://docs.oracle.com/javaee/7/api/javax/websocket/server/PathParam.html">@PathParam</a> というアノテーションでパスの一部をメソッドの引数で受け取ることができるようなので試してみました。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">chat</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CopyOnWriteArraySet</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnClose</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnOpen</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.Session</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.server.PathParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.server.ServerEndpoint</span><span class="p">;</span>

<span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/chat/{guest-id}"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatEndPoint</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">CopyOnWriteArraySet</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span> <span class="n">sessions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArraySet</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="nd">@OnOpen</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpen</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"guest-id"</span><span class="p">)</span> <span class="n">String</span> <span class="n">guestId</span><span class="p">,</span> <span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Session</span> <span class="n">s</span> <span class="p">:</span> <span class="n">sessions</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">s</span><span class="p">.</span><span class="na">getAsyncRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">guestId</span> <span class="o">+</span> <span class="s">"さんが入室しました"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@OnMessage</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"guest-id"</span><span class="p">)</span> <span class="n">String</span> <span class="n">guestId</span><span class="p">,</span> <span class="n">String</span> <span class="n">text</span><span class="p">)</span> <span class="kd">throws</span>
            <span class="n">IOException</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Session</span> <span class="n">s</span> <span class="p">:</span> <span class="n">sessions</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">s</span><span class="p">.</span><span class="na">getAsyncRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">guestId</span> <span class="o">+</span> <span class="s">"] "</span> <span class="o">+</span> <span class="n">text</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@OnClose</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"guest-id"</span><span class="p">)</span> <span class="n">String</span> <span class="n">guestId</span><span class="p">,</span> <span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sessions</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Session</span> <span class="n">s</span> <span class="p">:</span> <span class="n">sessions</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">s</span><span class="p">.</span><span class="na">getAsyncRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">guestId</span> <span class="o">+</span> <span class="s">"さんが退室しました"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>クラスに付けたServerEndpointに書かれたパスの一部が {guest-id} となっていますね。
それをメソッドの引数に @PathParam(“guest-id”) と付けて受け取っています。
簡単ですね。</p>
<div class="section" id="id1">
<h2>今回のソース</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/websocket-example">https://github.com/backpaper0/sandbox/tree/master/websocket-example</a></li>
</ul>
<p>今回作ったクラスはchatというパッケージにしています。
また、mvn -Pchat exec:java とすればサーバが立ち上がるようにしています。
クライアントはchat.htmlです。
Chromeで何となく動くことを確認しています。
サーバを終了したい場合はコンソールで何かキーを押してください。</p>
<p>なお、今回のコードはきしださんが下記エントリで書かれたものを参考にしました。</p>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/nowokay/20130613">http://d.hatena.ne.jp/nowokay/20130613</a></li>
</ul>
</div>
]]></description>
             <pubDate>Mon, 15 Jul 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/07/14/websocket.html</link>
            <guid>https://backpaper0.github.io/2013/07/14/websocket.html</guid>
            <title><![CDATA[Java SEでWebSocketサーバを立てて遊ぶ]]></title>
            <description><![CDATA[<h1>Java SEでWebSocketサーバを立てて遊ぶ</h1>
<p>先だってリリースされたJava EE 7に <a class="reference external" href="http://jcp.org/en/jsr/detail?id=356">JSR 356: Java API for WebSocket</a> が入りました。
GlassFish v4などを利用すればWebSocketで遊べます。</p>
<p>が、やっぱJava SEで動かしたいですよね？
ね？</p>
<p>というわけでJSR 356の参照実装であるTyrusを使います。</p>
<ul class="simple">
<li><a class="reference external" href="https://tyrus.java.net/">Tyrus Project</a></li>
</ul>
<p>サーバ側のエンドポイントを作成します。
POJOにアノテーションを付ける感じです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">javax.websocket.OnClose</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.OnOpen</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.Session</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.server.ServerEndpoint</span><span class="p">;</span>

<span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="s">"/echo"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServerEndPoint</span> <span class="p">{</span>

    <span class="nd">@OnOpen</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"[open] "</span> <span class="o">+</span> <span class="n">session</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@OnMessage</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">,</span> <span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">"] "</span> <span class="o">+</span> <span class="n">session</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@OnClose</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"[close] "</span> <span class="o">+</span> <span class="n">session</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>@OnOpenはセッションが確立したとき、@OnMessageはクライアントからメッセージが届いたとき、@OnCloseはセッションが切断されたときに呼ばれます。
@OnMessageを付けたメソッドではクライアントが送信したテキストをStringの引数で受け取ることができます。
なお、バイナリメッセージだとbyte[]やByteBufferで受け取れるようです。
また、このメソッドはStringを返していますがこれはクライアントへ送信されるテキストメッセージとなります。</p>
<p>では次にこれをJava SEで動かすためのコードを書きます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.websocket.DeploymentException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.glassfish.tyrus.server.Server</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoMain</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Server</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="s">"/ws"</span><span class="p">,</span> <span class="n">EchoServerEndPoint</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">in</span><span class="p">.</span><span class="na">read</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="n">server</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Serverのコンストラクタにホスト、ポート、ルートパス、エンドポイントのクラスを渡してインスタンス化し、startメソッドを呼べばWebSocketサーバの出来上がりです。
あとはクライアントから ws://localhost:8080/ws/echo に接続すればOKです。
簡単ですね。</p>
<div class="section" id="id1">
<h2>今日のソース</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/sandbox/tree/master/websocket-example">https://github.com/backpaper0/sandbox/tree/master/websocket-example</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 14 Jul 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/07/07/devkan_jaxrs.html</link>
            <guid>https://backpaper0.github.io/2013/07/07/devkan_jaxrs.html</guid>
            <title><![CDATA[DevLOVE関西「開発スターターキット」におけるJAX-RSの簡単な解説]]></title>
            <description><![CDATA[<h1>DevLOVE関西「開発スターターキット」におけるJAX-RSの簡単な解説</h1>
<p>どうも、GlassFishとJAX-RSを（・∀・）ｲｲﾖｲｲﾖｰと言っていた2番テーブルTAのうらがみです。</p>
<ul class="simple">
<li><a class="reference external" href="http://devlove-kansai.doorkeeper.jp/events/4363">DevLOVE関西「開発スターターキット」</a></li>
</ul>
<p>というわけで参加されたみなさん、お疲れ様でした。
いいよいいよと言いまくってた手前、今回のJAX-RSを利用していたソースコードをかるーく解説しておこうと思います。</p>
<p>まずはDevKanApplication.javaです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@ApplicationPath</span><span class="p">(</span><span class="s">"/services"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevKanApplication</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Applicationを継承して@ApplicationPathで注釈していますが、このクラスがあればGlassFishさんが
「お、これはJAX-RSの出番やな( ｰ`дｰ´)ｷﾘｯ」
という感じで認識してくれます。
なお@ApplicationPathに設定している /services が基点となるパスになります。</p>
<p>次いでCalculator.javaです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"/calc"</span><span class="p">)</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_PLAIN</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="p">{</span>

    <span class="nd">@GET</span>
    <span class="nd">@Path</span><span class="p">(</span><span class="s">"add"</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">add</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"b"</span><span class="p">)</span><span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
        <span class="k">return</span> <span class="s">"2"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>アノテーションがもりもり書かれていますが、これらはHTTPリクエスト/レスポンスに対応しています。
足し算のHTTPリクエスト/レスポンスはこんな感じになりますよー、っていうのを何となく書き出します。</p>
<p>リクエストはこんな感じ。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>GET /devkan-calc/services/calc/add?a=2&amp;b=3 HTTP/1.1
</pre></div>
</div>
<p>レスポンスはこんな感じ。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span/>HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 1

2
</pre></div>
</div>
<p>見比べるとよく分かりますが、</p>
<ul class="simple">
<li>メソッドに書かれた@GETはリクエストメソッドに、</li>
<li>クラスとメソッドに書かれた@Pathはリクエストのパスに、</li>
<li>メソッドのパラメータに書かれた@QueryParamはリクエストのクエリパラメータに、</li>
<li>クラスに書かれた@ProducesはレスポンスのContent-Typeに、</li>
</ul>
<p>それぞれ対応しています。
ついでに言うと、戻り値はレスポンスのエンティティボディに対応していますね。
HTTPを知っていればJAX-RSは使えるよー、という感じですね。</p>
<p>以上、JAX-RSの簡単な解説おわり。</p>
<div class="section" id="war">
<h2>WARを覗く</h2>
<p>jar -tf build/libs/devkan-calc.war と打ってWARの中身を覗いてみましょう。
WARファイルの中身、WEB-INFディレクトリの下にあるのは DevKanApplication.class と Calculator.class だけです。
フレームワークのJARファイルはおろか、web.xmlすらありません。</p>
<p>JAX-RSはJava EEの一部であり、Java EEのアプリケーションサーバであるGlassFishにデプロイする場合はフレームワークのJARファイルは不要です。</p>
<p>また、最近ではサーブレットの登録にもweb.xmlは必須ではありません。
@WebServletというアノテーションで登録するか、ServletContextのaddServletメソッドで動的に登録できます。</p>
<p>この辺りはまた別の機会に詳しく紹介するとして(やらないフラグ)、大事なのは「JAX-RSなら2クラスでWebアプリ作れるですよ(｀・ω・´)ｼｬｷｰﾝ」ということです。
お手軽ですね。</p>
</div>
<div class="section" id="jax-rs">
<h2>JAX-RSをもっと知りたい場合は</h2>
<p><a class="reference external" href="https://twitter.com/btnrouge">@btnrougeさん</a> のブログ <a class="reference external" href="http://www.coppermine.jp/docs/programming/">Programming Studio</a> を読むと良いでしょう。
JAX-RSのタグが付けられたエントリをざくざく読んで行けばもりもり知識がつくと思います。</p>
<p>それと、手前味噌ですが、私もJAX-RSを一通り紹介するエントリを書きました。</p>
<ul class="simple">
<li><a class="reference internal" href="https://backpaper0.github.io/2013/05/02/jaxrs.html"><span class="doc">JAX-RSとかの話</span></a></li>
</ul>
<p>ただし対象バージョンはちょっと古いです。
エントリは1.1。
最新は2.0。
そのうちエントリも2.0にアップデートしたいです(やらないフラグ)。</p>
<p>書籍なら「JavaによるRESTfulシステム構築」(ISBN:978-4873114675)が良いですかねー。
日本語訳が2010年に出版された書籍で、こちらも内容はJAX-RS 1系ですが今でも通用する情報が載っているとは思います。</p>
<p>そんな感じで、JAX-RSの回し者、うらがみでした(・∀・)</p>
</div>
]]></description>
             <pubDate>Sun, 07 Jul 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/06/02/jsr330.html</link>
            <guid>https://backpaper0.github.io/2013/06/02/jsr330.html</guid>
            <title><![CDATA[JSR 330を実装してみた]]></title>
            <description><![CDATA[<h1>JSR 330を実装してみた</h1>
<p>JSR 330はDIの仕様です。
参照実装はGuiceです。</p>
<ul class="simple">
<li><a class="reference external" href="http://jcp.org/en/jsr/detail?id=330">http://jcp.org/en/jsr/detail?id=330</a></li>
</ul>
<p>仕様は薄いしTCKもあるので実装してみました。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/radishtainer">https://github.com/backpaper0/radishtainer</a></li>
</ul>
<p>まあ何とかTCK通しただけですががが。</p>
<p>JSR 330の仕様では@Injectで注釈しているメソッドがインジェクション対象となりますが、サブクラスでオーバーライドされており、オーバーライドされたそのメソッドが@Injectで注釈されていなければインジェクション対象とはなりません。</p>
<p>で、メソッドがスーパークラスのメソッドをオーバーライドしているのかどうかはリフレクションで取得できるだろー、と思ってたけどできませんでした。</p>
<p>んで、スーパークラスに同じシグネチャのメソッドがあればオーバーライドしていると判断してええじゃろ、と思ってたけどそんな簡単なアレじゃありませんでした。
メソッド名と引数の数・型が同じでも例えば可視性がpackage privateでスーパークラスとサブクラスが異なるパッケージであればオーバーライドしていません。
パッケージが一緒でもスーパークラスの方で定義されたメソッドがprivateだとやっぱりオーバーライドしていません。</p>
<p>というわけでオーバーライドしてるかどうかの判定が面倒で泥臭くなっています。
もっと良い方法があれば教えてください、的な。</p>
]]></description>
             <pubDate>Sun, 02 Jun 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/05/02/jaxrs.html</link>
            <guid>https://backpaper0.github.io/2013/05/02/jaxrs.html</guid>
            <title><![CDATA[JAX-RSとかの話]]></title>
            <description><![CDATA[<h1>JAX-RSとかの話</h1>
<p>これは2013-04-19に行われた「いいね！Java EE！」で使用した資料を加筆修正したものです。</p>
<ul class="simple">
<li><a class="reference external" href="http://connpass.com/event/2109/">http://connpass.com/event/2109/</a></li>
</ul>
<div class="section" id="id1">
<h2>JAX-RSって？</h2>
<ul class="simple">
<li>Webアプリを作るためのAPI</li>
<li><a class="reference external" href="http://jcp.org/en/jsr/detail?id=311">JSR 311 (JAX-RS 1.x)</a></li>
<li><a class="reference external" href="http://jcp.org/en/jsr/detail?id=339">JSR 339 (JAX-RS 2.x)</a></li>
<li>Java EE 6 Full Profile に入ってる(なぜかWeb Profileじゃない)</li>
<li>Java EE 7 からは Web Profile に入る</li>
<li>Jersey(参照実装)、RESTEasy、Apache CXFなどの実装があり、みんな大好きTomcatでも使える</li>
<li>仕様書(PDF)は41ページで目に優しい(ちなみにEJB 3.1は626ページ)</li>
</ul>
</div>
<div class="section" id="id2">
<h2>開発準備</h2>
<ul class="simple">
<li><a class="reference external" href="http://ja.netbeans.org/">NetBeans</a> を使いましょう！</li>
</ul>
<p>以上</p>
<div class="section" id="maven">
<h3>Maven</h3>
<p>Mavenでアレするなら次のようなdependencyを書けば良いです。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.sun.jersey<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jersey-bundle<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.11.1<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.sun.jersey.jersey-test-framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jersey-test-framework-http<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.11.1<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<p>Jerseyのartifactはjersey-serverやjersey-jsonなどいくつかに分かれているのですが、jersey-bundleはそれらがまとめられたもので、こいつを指定するのが楽ちんです。</p>
<p>jersey-test-framework-http はJerseyのテスティングフレームワークで、Hotspotに入ってる com.sun.net.httpserver.HttpServer で実行します。</p>
<p>artifactId の末尾の -http を -grizzly にするとGrizzly(GlassFishのHTTPを捌く部分)で動かす事もできますし、-inmemory にするとソケットを介さずインメモリで動かす事もできます。</p>
</div>
</div>
<div class="section" id="id3">
<h2>はじめてのJAX-RS</h2>
<p>クエリパラメータで名前を渡すとHello, xxx!が返るWeb APIを書きましょう。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.QueryParam</span><span class="p">;</span>

<span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="nd">@GET</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span>
            <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">"Hello, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"!"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これは次のようなHTTPリクエストを処理することができます。</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span/><span class="nf">GET</span> <span class="nn">/rest/hello?name=world</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre></div>
</div>
<p>/rest がアプリケーションのルートとなります。
これは後述するApplicationサブクラスに注釈する@ApplicationPathで指定する値が対応します。
あとは何となく見たら分かる感じではありますが、/hello が @Path(“hello”) に、?name=world が @QueryParam(“name”) に、それからリクエストメソッドがGETですが @GET が対応しています。</p>
<p>こいつをとりあえずサクッと動かすならjersey-test-frameworkを使うのがらくちんです。
JUnitでぶん回すことができます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">com.sun.jersey.test.framework.AppDescriptor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jersey.test.framework.JerseyTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jersey.test.framework.LowLevelAppDescriptor.Builder</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.hamcrest.CoreMatchers.*</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.junit.Assert.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResourceTest</span> <span class="kd">extends</span> <span class="n">JerseyTest</span> <span class="p">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_say</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">resource</span><span class="p">()</span>
                <span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
                <span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"world"</span><span class="p">)</span>
                <span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">is</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AppDescriptor</span> <span class="nf">configure</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Builder</span><span class="p">(</span><span class="n">HelloResource</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id4">
<h3>アプリケーションサーバやサーブレットコンテナで動かす</h3>
<p><a class="reference external" href="https://glassfish.java.net/">GlassFish</a> などのJava EEアプリケーションサーバで動かすにはApplicationサブクラスを作ります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">javax.ws.rs.ApplicationPath</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.Application</span><span class="p">;</span>

<span class="nd">@ApplicationPath</span><span class="p">(</span><span class="s">"rest"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JaxrsActivator</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Applicationを継承して@ApplicationPathで注釈するだけです。
あとはHelloResourceとこのJaxrsActivatorをWARにパッケージングしてデプロイすればおkです。</p>
<p>Tomcatなどのサーブレットコンテナだと専用のサーブレットを登録する必要がある……と見せかけてServlet 3対応のコンテナならJerseyのJARを突っ込むだけでweb.xmlを書く必要はありません。
web.xmlを書かなくてもServletContainerInitializerを利用して動的にサーブレットを追加してくれます。</p>
</div>
</div>
<div class="section" id="id5">
<h2>リソースクラス、リソースメソッド</h2>
<p>リソースクラスは@Pathで注釈したクラスで先の例でいうとHelloResourceがリソースクラスになります。
クラス名に制約はないのでHelloでもFoobarでも何でも良いです。
@Pathにはこのリソースクラスで処理するパスを指定します。
リソースクラスはpublicなコンストラクタが必要です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>
</div>
<p>リソースメソッドはリソースクラスに定義されたメソッドで@GETや@POSTといったHTTPメソッドに対応するアノテーションで注釈します。
リソースメソッドでは@Consumesで受け取るリクエストボディのContent-Typeを指定できます。
同じように@Producesで送り返すレスポンスボディのContent-Typeを指定できます。
また引数に@QueryParamや@HeaderParamを注釈することでクエリパラメータやリクエストヘッダをマッピングすることができます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Consumes</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span>
        <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="nd">@DefaultValue</span><span class="p">(</span><span class="s">"world"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">"Hello, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"!"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>なお、@QueryParamなどでマッピング出来るのはリソースメソッドの引数だけじゃなくコンストラクタの引数や</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">HelloResource</span><span class="p">(</span>
            <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
</pre></div>
</div>
<p>フィールド、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="p">...</span>
</pre></div>
</div>
<p>setterなども使用できます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
</pre></div>
</div>
<p>個人的にはメソッドの引数を使用するのが好きです。</p>
</div>
<div class="section" id="id6">
<h2>パラメータのマッピング</h2>
<p>既にクエリパラメータを@QueryParamでマッピングする例は挙げましたが、他にはリクエストヘッダやパスの一部、Cookieの値などをアノテーションでマッピングすることができます。</p>
<div class="section" id="queryparam">
<h3>@QueryParam</h3>
<ul class="simple">
<li>クエリパラメータをマッピング</li>
<li>/hoge?<strong>name</strong>=<strong>value</strong></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="formparam">
<h3>@FormParam</h3>
<ul class="simple">
<li>フォームのPOSTリクエストで送信するパラメータをマッピング</li>
<li>&lt;input type=”text” name=”<strong>name</strong>”&gt;</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@POST</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@FormParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="pathparam">
<h3>@PathParam</h3>
<ul class="simple">
<li>パスの一部をマッピング</li>
<li>/hoge/<strong>value</strong></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Path</span><span class="p">(</span><span class="s">"{name}"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@PathParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>コロンで区切って正規表現を書く事もできます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Path</span><span class="p">(</span><span class="s">"{id:[0-9]{1,10}}"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">findById</span><span class="p">(</span>
        <span class="nd">@PathParam</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="n">Long</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="matrixparam">
<h3>@MatrixParam</h3>
<ul class="simple">
<li>マトリックスパラメータ</li>
<li>セミコロンで区切った形式</li>
<li>/hoge;foo=1;bar=2</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@MatrixParam</span><span class="p">(</span><span class="s">"left"</span><span class="p">)</span> <span class="n">String</span> <span class="n">left</span><span class="p">,</span>
        <span class="nd">@MatrixParam</span><span class="p">(</span><span class="s">"right"</span><span class="p">)</span> <span class="n">String</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="cookieparam">
<h3>@CookieParam</h3>
<ul class="simple">
<li>Cookieをマッピング</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@Cookie</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="headerparam">
<h3>@HeaderParam</h3>
<ul class="simple">
<li>リクエストヘッダをマッピング</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@HeaderParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>パラメータをまとめる</h3>
<p>パラメータがひとつふたつなら良いですが、もっと多くなると引数に列挙するのはシグネチャがうるさくなりますね。
Jerseyなら@InjectParamを使うことでパラメータをPOJOにまとめることができます。
ただし、JAX-RSの仕様じゃなくてJerseyの実装依存の機能ですので、そこんとこ注意です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@InjectParam</span> <span class="n">HogeBean</span> <span class="n">bean</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HogeBean</span> <span class="p">{</span>

    <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"foo"</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">foo</span><span class="p">;</span>

    <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"bar"</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">bar</span><span class="p">;</span>

    <span class="p">...</span>
</pre></div>
</div>
<p>ちなみにJAX-RS 2からはこの@InjectParamと同様の機能をもつ@BeanParamというアノテーションが追加されます。</p>
</div>
<div class="section" id="pojo">
<h3>パラメータをPOJOで受け取る</h3>
<p>ここまで@QueryParamなどで受け取るパラメータの型はStringを使用していましたが、自作のクラスを使用することも可能です。
パラメータを受け取れるクラスは、valueOfまたはfromStringという名前の静的ファクトリメソッドを定義する必要があります。
引数はStringです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Fullname</span> <span class="p">{</span>

   <span class="p">...</span>

    <span class="c1">//public static Fullname valueOf(String value) {</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Fullname</span> <span class="nf">fromString</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Fullname</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>リソースメソッドではStringでパラメータを受けるときと同じ感覚で使えます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="p">(</span>
        <span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">Fullname</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="xml">
<h2>XMLで通信する</h2>
<p>エンティティボディがXMLの場合、JAXBで自作のクラスにマッピングする機能がJAX-RSにはあります。</p>
<p>例えばこのようなXMLを、</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;hogeBean&gt;</span>
  <span class="nt">&lt;foo&gt;</span>hello<span class="nt">&lt;/foo&gt;</span>
  <span class="nt">&lt;bar&gt;</span>world<span class="nt">&lt;/bar&gt;</span>
<span class="nt">&lt;/hogeBean&gt;</span>
</pre></div>
</div>
<p>このようなクラスで受け取ることが可能です。
@XmlRootElementはJAXBのAPIです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@XmlRootElement</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HogeBean</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">foo</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">bar</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>リソースメソッドはこのようになります。
@ConsumesでXMLを受け取る事を明示しています。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@POST</span>
<span class="nd">@Consumes</span><span class="p">(</span><span class="s">"application/xml"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doHoge</span><span class="p">(</span><span class="n">HogeBean</span> <span class="n">bean</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>レスポンスをXMLにすることも可能です。
その場合、リソースメソッドは次のようになります。
今度は@ProducesでXMLを返すことを明示しています。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"application/xml"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">HogeBean</span> <span class="nf">getHoge</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>前述の通りXMLとクラスの相互変換を行う部分はJAX-RSではなくJAXBの仕様です。
JAXBはJava SEに入っているので動作確認は手軽にできます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">HogeBean</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">StringWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="p">();</span>
<span class="n">JAXB</span><span class="p">.</span><span class="na">marshal</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>

<span class="p">...</span>

<span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">StringReader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="p">(</span><span class="n">xml</span><span class="p">);</span>
<span class="n">HogeBean</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">JAXB</span><span class="p">.</span><span class="na">unmarshal</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">HogeBean</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="json">
<h2>JSONで通信する</h2>
<p>前述のようにJAXBでXML通信している場合、Jerseyなら@Consumesや@Producesでのメディアタイプの指定をapplication/jsonに変更するだけでJSONで通信することが可能です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@POST</span>
<span class="c1">//@Consumes("application/xml")</span>
<span class="c1">//@Produces("application/xml")</span>
<span class="nd">@Consumes</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">)</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">HogeBean</span> <span class="nf">doHoge</span><span class="p">(</span><span class="n">HogeBean</span> <span class="n">bean</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>元々はXMLで通信していましたが、たったこれだけで次のようなJSONで通信するようになります。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span/><span class="p">{</span> <span class="nt">"foo"</span> <span class="p">:</span> <span class="s2">"hello"</span><span class="p">,</span>
  <span class="nt">"bar"</span> <span class="p">:</span> <span class="s2">"world"</span> <span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id8">
<h3>JSON通信での問題点</h3>
<p>リストを含む次のようなクラスの、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@XmlRootElement</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hoge</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">foobar</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>インスタンスを作成して、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Hoge</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hoge</span><span class="p">();</span>
<span class="n">obj</span><span class="p">.</span><span class="na">foobar</span> <span class="o">=</span> <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">);</span>
</pre></div>
</div>
<p>XML通信すると次のようなXMLになります。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;hoge&gt;</span>
  <span class="nt">&lt;foobar&gt;</span>a<span class="nt">&lt;/foobar&gt;</span>
  <span class="nt">&lt;foobar&gt;</span>b<span class="nt">&lt;/foobar&gt;</span>
  <span class="nt">&lt;foobar&gt;</span>c<span class="nt">&lt;/foobar&gt;</span>
<span class="nt">&lt;/hoge&gt;</span>
</pre></div>
</div>
<p>foobar要素がリストの要素分、フラットに並んでいますね。</p>
<p>これがJSON通信の場合だと次のようなJSONになります。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span/><span class="p">{</span> <span class="nt">"foobar"</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span> <span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<p>XMLではフラットに並んでいたfoobar要素が空気を読んでリストになっていますね。</p>
<p>で、次はこんな感じのインスタンスを、</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">Hoge</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hoge</span><span class="p">();</span>
<span class="n">obj</span><span class="p">.</span><span class="na">foobar</span> <span class="o">=</span> <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="s">"x"</span><span class="p">);</span>
</pre></div>
</div>
<p>JSON通信すると次のようなJSONになります。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="p">{</span> <span class="s">"foobar"</span> <span class="p">:</span> <span class="s">"x"</span> <span class="p">}</span>
</pre></div>
</div>
<p>リストじゃなくなっていますね。
なんでやねん、と。</p>
<p>foobar要素が一つのXMLを想像するとなんとなく納得できます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="o">&lt;</span><span class="n">hoge</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">foobar</span><span class="o">&gt;</span><span class="n">x</span><span class="o">&lt;/</span><span class="n">foobar</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">hoge</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>このように、要素がひとつだとリストなのかリストじゃないのか分からないのです。
JerseyのJAXB経由のJSON変換は、XMLに変換する過程に横入りして行っているのでこの影響をモロに受けてリストじゃなくなってしまうっぽいです。</p>
<p>クライアント側もJerseyを使っていたりするとこれが問題になることは無いですが、WebアプリでjQueryなんかを使ってたりするとリストのつもりで受け取ったらリストじゃなかったでござる、という状況になって困ります。
というか困りました、実際に。</p>
</div>
<div class="section" id="jacksonjson">
<h3>JacksonでJSON通信する</h3>
<p>前述の「要素がひとつの場合にリストじゃなくなっちゃう問題」に対処するにはJacksonを利用したJSON変換を行うと良いです。</p>
<ul class="simple">
<li><a class="reference external" href="http://jackson.codehaus.org/">http://jackson.codehaus.org/</a></li>
</ul>
<p>Jacksonを使うとfoobar要素がひとつしかない場合でも次のようなJSONに変換されます。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span/><span class="p">{</span> <span class="nt">"foobar"</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">"x"</span> <span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<p>また、Jacksonを使うと、</p>
<ul class="simple">
<li>クラスを@XmlRootElementで注釈する必要がない</li>
<li>リソースメソッドの戻り値をjava.util.Listにする事が可能</li>
</ul>
<p>などの利点があります。</p>
<p>JerseyでJacksonを使うには初期パラメータ com.sun.jersey.api.json.POJOMappingFeature を true に設定します。</p>
<p>jersey-test-frameworkを使ったりJDKのHttpServerで動かす場合はResourceConfigというクラスで設定すると良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="n">ResourceConfig</span> <span class="n">rc</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">rc</span><span class="p">.</span><span class="na">getFeatures</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">JSONConfiguration</span><span class="p">.</span><span class="na">FEATURE_POJO_MAPPING</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>
</div>
<p>書くまでもないですが、このコードにあるJSONConfiguration.FEATURE_POJO_MAPPINGは文字列の定数で、”com.sun.jersey.json.POJOMappingFeature”です。</p>
<p>サーブレット経由で動かすならweb.xmlで設定することも可能です。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;servlet&gt;</span>
  <span class="nt">&lt;servlet-name&gt;</span>Jersey<span class="nt">&lt;/servlet-name&gt;</span>
  <span class="nt">&lt;servlet-class&gt;</span>com.sun.jersey.spi.container.servlet.ServletContainer<span class="nt">&lt;/servlet-class&gt;</span>
  <span class="nt">&lt;init-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>com.sun.jersey.api.json.POJOMappingFeature<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
  <span class="nt">&lt;/init-param&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
</pre></div>
</div>
<p>個人的にはJerseyでJSON通信するならJacksonを使うのが良いと思います。</p>
</div>
</div>
<div class="section" id="xmljson">
<h2>XMLでもJSONでも通信する</h2>
<p>これまでXMLかJSONのどちらか片方で通信する設定方法を紹介しましたが、ひとつのメソッドでXMLでもJSONでも通信することも可能です。
設定は単純で@Consumesや@Producesに複数のメディアタイプを書けば良いです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@POST</span>
<span class="nd">@Consumes</span><span class="p">({</span> <span class="s">"application/json"</span><span class="p">,</span> <span class="s">"application/xml"</span> <span class="p">})</span>
<span class="nd">@Produces</span><span class="p">({</span> <span class="s">"application/json"</span><span class="p">,</span> <span class="s">"application/xml"</span> <span class="p">})</span>
<span class="kd">public</span> <span class="n">HogeBean</span> <span class="nf">doHoge</span><span class="p">(</span><span class="n">HogeBean</span> <span class="n">bean</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>このリソースメソッドはクライアントがAcceptヘッダでapplication/jsonを要求すればJSONで通信し、application/xmlを要求すればXMLで通信します。
このようにメソッドの内容はまったく同じだけど、HTTPリクエストの内容によって通信のフォーマットを切り替えられるのはJAX-RSの強みですね。</p>
</div>
<div class="section" id="messagebodyreader-messagebodywriter">
<h2>MessageBodyReader/MessageBodyWriter</h2>
<p>JAX-RSで通信できるのはXMLやJSONだけではありません。
MessageBodyReaderやMessageBodyWriterを実装すればエンティティボディを好きにマッピングすることが可能です。</p>
<p>例えば、String[][]をCSVで出力するMessageBodyWriterを実装してみます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Provider</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/csv"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CsvWriter</span> <span class="kd">implements</span> <span class="n">MessageBodyWriter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">[][]&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isWriteable</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="p">,</span> <span class="n">Type</span> <span class="n">genericType</span><span class="p">,</span>
            <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">MediaType</span> <span class="n">mediaType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">type</span> <span class="o">==</span> <span class="n">String</span><span class="o">[][]</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSize</span><span class="p">(</span><span class="n">String</span><span class="o">[][]</span> <span class="n">t</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="p">,</span> <span class="n">Type</span> <span class="n">genericType</span><span class="p">,</span>
            <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">MediaType</span> <span class="n">mediaType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">String</span><span class="o">[][]</span> <span class="n">t</span><span class="p">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="p">,</span> <span class="n">Type</span> <span class="n">genericType</span><span class="p">,</span>
            <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">MediaType</span> <span class="n">mediaType</span><span class="p">,</span>
            <span class="n">MultivaluedMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">httpHeaders</span><span class="p">,</span>
            <span class="n">OutputStream</span> <span class="n">entityStream</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">WebApplicationException</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">(</span><span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="p">(</span><span class="n">entityStream</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">row</span> <span class="p">:</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">column</span> <span class="p">:</span> <span class="n">row</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">"%s,"</span><span class="p">,</span> <span class="n">column</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>@Providerで注釈していますが、これを付けておくとアノテーションスキャンで拾ってくれます。
あるいはクラスパス上にMETA-INF/services/javax.ws.rs.ext.MessageBodyWriterというファイルを作って、中にCsvWriterのFQDNを書いてServiceLoaderに拾ってもらいます。</p>
<p>@Producesで注釈することで、このMessageBodyWriterが処理する対象となるContent-Typeを指定しています。
さらにisWritableメソッドでこのMessageBodyWriterを使うべきか判断することが可能です。</p>
<p>getSizeメソッドは書き出すエンティティボディのバイトサイズです。
算出できない（し辛い）場合は-1を返しておくと良きに計らってくれます。</p>
<p>最後にwriteToメソッドですが、これが実際にエンティティボディに書き出すメソッドになります。</p>
<p>このCsvWriterに対応するレスポンスを返すリソースメソッドはこんな感じです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/csv"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span><span class="o">[][]</span> <span class="nf">getCsv</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>オブジェクトから実際の通信形式へ変換する方法をMessageBodyWriterに分離しているのでリソースメソッドはシンプルに保たれていますね。</p>
</div>
<div class="section" id="webapplicationexception">
<h2>WebApplicationException</h2>
<p>場合によってはリソースメソッドで処理中に「やっぱり404返したいわー」などというときもあると思いますが、WebApplicationExceptionを投げるのが楽ちんです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@GET</span>
<span class="nd">@Path</span><span class="p">(</span><span class="s">"{isbn}"</span><span class="p">)</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Book</span> <span class="nf">get</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"isbn"</span><span class="p">)</span> <span class="n">Isbn</span> <span class="n">isbn</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="n">bookBean</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">isbn</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">book</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">WebApplicationException</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="exceptionmapper">
<h2>ExceptionMapper</h2>
<p>リソースメソッドから投げられた特定の例外を受け取って処理したい場合はExceptionMapperを実装したサブクラスを作ります。</p>
<p>例えばJPAの楽観排他機能で更新したいエンティティが既に別のひとに更新されていた場合、OptimisticLockExceptionが投げられますが、これを受け取って処理をするExceptionMapperを書いてみます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Provider</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OptimisticLockExceptionMapper</span> <span class="kd">implements</span> <span class="n">ExceptionMapper</span><span class="o">&lt;</span><span class="n">OptimisticLockException</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">toResponse</span><span class="p">(</span><span class="n">OptimisticLockException</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="na">entity</span><span class="p">(</span><span class="s">"更新されとった＞＜"</span><span class="p">).</span><span class="na">type</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="context">
<h2>@Contextで色々な情報を参照する</h2>
<p>前述のOptimisticLockExceptionMapperですが、EJBを使っている場合はOptimisticLockExceptionがRollbackExceptionに包まれて投げられます。
RollbackExceptionはOptimisticLockExceptionと継承関係は無いのでOptimisticLockExceptionMapperで処理できません。</p>
<p>そんな場合はProvidersを使います。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RollbackExceptionMapper</span> <span class="kd">implements</span> <span class="n">ExceptionMapper</span><span class="o">&lt;</span><span class="n">RollbackException</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Context</span>
    <span class="kd">private</span> <span class="n">Providers</span> <span class="n">p</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">toResponse</span><span class="p">(</span><span class="n">RollbackException</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">exception</span><span class="p">.</span><span class="na">getCause</span><span class="p">();</span>
        <span class="n">Class</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">cause</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="na">getExceptionMapper</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="na">toResponse</span><span class="p">(</span><span class="n">cause</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>@ContextでProvidersをインジェクションします。
Providersはクラスやアノテーションを渡すとそれに対応するExceptionMapperやMessageBodyReaderを取ってこれる便利なものです。
このような便利クラスを@Contextでインジェクションできます。</p>
<p>インジェクションできる便利クラスはProvidersの他にクエリパラメータやパスの情報を取って来れるUriInfoや、HTTPヘッダを取れるHttpHeaders、認証情報を取れるSecurityContextなどがあります。</p>
</div>
<div class="section" id="di">
<h2>他にもDIしたい</h2>
<div class="section" id="ejbdi">
<h3>EJBでDI</h3>
<p>リソースクラスをStateless Session Beanにします。
@EJBでSession Beanを、@PersistenceContextでEntityManagerなどをインジェクションできます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="nd">@Stateless</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="nd">@EJB</span>
    <span class="kd">private</span> <span class="n">HelloBean</span> <span class="n">helloBean</span><span class="p">;</span>

    <span class="nd">@GET</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">helloBean</span><span class="p">.</span><span class="na">say</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>個人的な利点は宣言的トランザクションでしょうか。</p>
<p>欠点はSession BeanかEntityManagerぐらいしかDIするものがないことですかね。</p>
</div>
<div class="section" id="cdidi">
<h3>CDIでDI</h3>
<p>WEB-INF/beans.xmlを作成します。
空のファイルでもOKです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="nd">@RequestScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">HelloBean</span> <span class="n">helloBean</span><span class="p">;</span>

    <span class="nd">@GET</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">helloBean</span><span class="p">.</span><span class="na">say</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>基本的に何でもDIできるのが利点です。
CDIでは殆どのクラスが管理Beanになります。</p>
<p>欠点はEJBでは使えていた宣言的トランザクション使えないことです。
まあ自分でCDIのインターセプターを書いて適用すれば良いんですが、ちょっと面倒です。</p>
</div>
<div class="section" id="ejbcdi">
<h3>EJBとCDIを併用する</h3>
<p>というわけでEJBとCDIを併用します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Stateless</span>
<span class="nd">@Path</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloResource</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">HelloBean</span> <span class="n">helloBean</span><span class="p">;</span>

    <span class="nd">@GET</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">say</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">helloBean</span><span class="p">.</span><span class="na">say</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>利点はDIを@Injectで統一できることです。
CDI管理Beanは当然ですが、（少し手を加える必要がありますが）EntityManagerもDataSourceも@Injectでぶっ込むことが可能です。</p>
<p>欠点はJersey 1.11.1のバグです。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.coppermine.jp/docs/programming/2012/12/jax-rs-ejb2.html">http://www.coppermine.jp/docs/programming/2012/12/jax-rs-ejb2.html</a></li>
</ul>
</div>
<div class="section" id="id9">
<h3>その他、DIの利点</h3>
<ul class="simple">
<li>インターセプタをかませる（JAX-RS 2.0からはJAX-RSの仕様にインターセプターが入りますが）</li>
<li>モックにすげ替えやすい</li>
<li>Arquillianでテストしやすい</li>
</ul>
</div>
</div>
<div class="section" id="arquillian">
<h2>Arquillian</h2>
<p>ArquillianはJBossが提供しているJava EE向けの結合テストフレームワークです。
以下の例のようにテストコードを書く事が可能です。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@RunWith</span><span class="p">(</span><span class="n">Arquillian</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalcTest</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="n">CalcBean</span> <span class="n">calcBean</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_add</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">calcBean</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">is</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Deployment</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">WebArchive</span> <span class="nf">createDeployment</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ShrinkWrap</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">WebArchive</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
            <span class="p">.</span><span class="na">addClass</span><span class="p">(</span><span class="n">CalcBean</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
            <span class="p">.</span><span class="na">addAsWebInfResource</span><span class="p">(</span><span class="n">EmptyAsset</span><span class="p">.</span><span class="na">INSTANCE</span><span class="p">,</span> <span class="s">"beans.xml"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/backpaper0/20121202/1354465585">http://d.hatena.ne.jp/backpaper0/20121202/1354465585</a></li>
</ul>
</div>
<div class="section" id="jax-rs-2-0">
<h2>JAX-RS 2.0の新機能</h2>
<p>JAX-RS 2.0からは以下のような機能が追加されます。</p>
<ul class="simple">
<li>フィルター</li>
<li>インターセプター</li>
<li>非同期処理</li>
<li>クライアントAPI</li>
<li>Bean Validationとの統合</li>
</ul>
<div class="section" id="id10">
<h3>フィルター</h3>
<p>リクエスト・レスポンスそれぞれに対応するフィルターを書けます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Provider</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingFilter</span> <span class="kd">implements</span> <span class="n">ContainerRequestFilter</span><span class="p">,</span> <span class="n">ContainerResponseFilter</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">filter</span><span class="p">(</span><span class="n">ContainerRequestContext</span> <span class="n">requestContext</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="s">"request"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">filter</span><span class="p">(</span><span class="n">ContainerRequestContext</span> <span class="n">requestContext</span><span class="p">,</span>
            <span class="n">ContainerResponseContext</span> <span class="n">responseContext</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="s">"response"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>インターセプター</h3>
<p>エンティティボディを読み書きするところに横入りしてごにょごにょできます。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@Provider</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StarInterceptor</span> <span class="kd">implements</span> <span class="n">ReaderInterceptor</span><span class="p">,</span> <span class="n">WriterInterceptor</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">aroundReadFrom</span><span class="p">(</span><span class="n">ReaderInterceptorContext</span> <span class="n">context</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span>
        <span class="n">WebApplicationException</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span>
        <span class="k">return</span> <span class="s">"+"</span> <span class="o">+</span> <span class="n">entity</span> <span class="o">+</span> <span class="s">"+"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">aroundWriteTo</span><span class="p">(</span><span class="n">WriterInterceptorContext</span> <span class="n">context</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span>
        <span class="n">WebApplicationException</span> <span class="p">{</span>
        <span class="n">Object</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="na">getEntity</span><span class="p">();</span>
        <span class="n">context</span><span class="p">.</span><span class="na">setEntity</span><span class="p">(</span><span class="s">"*"</span> <span class="o">+</span> <span class="n">entity</span> <span class="o">+</span> <span class="s">"*"</span><span class="p">);</span>
        <span class="n">context</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>アノテーションで適用する範囲を決める</h3>
<p>CDIも似たような感じですが、フィルター（インターセプター）にアノテーションを付けておくと同じアノテーションが付いているリソースクラス・リソースメソッドにそのフィルター（インターセプター）を噛ませることが出来るようです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@NameBinding</span>
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">,</span>
         <span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">})</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nd">@interface</span> <span class="n">Logged</span> <span class="p">{</span>
<span class="p">}</span>

<span class="nd">@Logged</span>
<span class="nd">@Provider</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingFilter</span> <span class="kd">implements</span> <span class="n">ContainerRequestFilter</span><span class="p">,</span> <span class="n">ContainerResponseFilter</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
<p>リソースメソッドはこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="nd">@POST</span>
<span class="nd">@Logged</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">post</span><span class="p">(</span><span class="n">String</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>非同期処理</h3>
<p>Servlet 3.xにも非同期処理が入りましたが、JAX-RSにもやってきました。
以下のサンプルはJSR 339に乗っていたものです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">AsyncResponse</span><span class="o">&gt;</span> <span class="n">suspended</span> <span class="o">=</span>
    <span class="k">new</span> <span class="n">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="n">AsyncResponse</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">readMessage</span><span class="p">(</span><span class="nd">@Suspended</span> <span class="n">AsyncResponse</span> <span class="n">ar</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
    <span class="n">suspended</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@POST</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="s">"text/plain"</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">postMessage</span><span class="p">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="n">AsyncResponse</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">suspended</span><span class="p">.</span><span class="na">take</span><span class="p">();</span>
    <span class="n">ar</span><span class="p">.</span><span class="na">resume</span><span class="p">(</span><span class="n">message</span><span class="p">);</span> <span class="c1">// resumes the processing of one GET request</span>
    <span class="k">return</span> <span class="s">"Message sent"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>うん、使いどころがわかりません！</p>
</div>
<div class="section" id="id14">
<h3>使ってみたい</h3>
<p>というわけで、JAX-RS 2.0のリリースはまだですが、いち早く試したい場合はJersey 2.xを使ってみましょう！</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-server<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0-rc1<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.test-framework.providers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jersey-test-framework-provider-jdk-http<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0-rc1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id15">
<h2>まとめ</h2>
<ul class="simple">
<li>JAX-RSいいね！</li>
<li>もうServletは要らないですね</li>
<li>ところで「いいね！Java EE！」の第二回はあるんですかね？</li>
</ul>
<p>資料の手直し、最後の方疲れたので投げやりです。
まあ、またJAX-RSは話題に出すと思いますので書ききれなかった（書き忘れた）アレとかソレはまたの機会にー。</p>
</div>
]]></description>
             <pubDate>Thu, 02 May 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/04/01/shigatsubaka.html</link>
            <guid>https://backpaper0.github.io/2013/04/01/shigatsubaka.html</guid>
            <title><![CDATA[退職しました]]></title>
            <description><![CDATA[<h1>退職しました</h1>
<p>本日4/1をもって株式会社HOGEDRIVENを退職しました。</p>
<ul class="simple">
<li><a class="reference external" href="http://hogedriven.net/aprilfools2013/">株式会社HOGEDRIVEN</a></li>
</ul>
<p>HOGEDRIVENでは並行プログラミング（焼肉）、ORマッパー（フグ）、暗号（焼肉）、Java 8のラムダ（ステーキ）など、様々な技術を経験させて貰いすごく感謝しています（ごちそうさまでした）。</p>
<p>しかし、HOGEDRIVENは「しゃぶしゃぶ」「ローストチキン」「シシケバブ」など、これからも肉料理に力を入れて行くようで、魚料理にも挑戦したいという私の思いとは目指す方向が異なるため、退職という道を選択しました。</p>
<p>今後の事はまだ何も決まっていませんが、ベタなところではマグロ、カニ、あるいは捨てる所が無いと言われるアンコウあたりに興味があるので、機会を見つけてチャレンジして行きたいと思います。</p>
<p>今後とも宜しくお願いただきます。</p>
<div class="section" id="id2">
<h2>あわせて読んでもしかたがない</h2>
<ul class="simple">
<li><a class="reference external" href="http://tango.hatenablog.com/entry/2013/04/01/000811">http://tango.hatenablog.com/entry/2013/04/01/000811</a></li>
<li><a class="reference external" href="http://daiksy.blogspot.jp/2013/04/2012-hogereiven.html">http://daiksy.blogspot.jp/2013/04/2012-hogereiven.html</a></li>
<li><a class="reference external" href="http://sassembla.github.com/Public/2013:04:01%2000-00-00/2013:04:01%2000-00-00.html">http://sassembla.github.com/Public/2013:04:01%2000-00-00/2013:04:01%2000-00-00.html</a></li>
<li><a class="reference external" href="http://posaune.hatenablog.com/entry/2013/04/01/004857">http://posaune.hatenablog.com/entry/2013/04/01/004857</a></li>
<li><a class="reference external" href="http://ameblo.jp/kozake/entry-11502234288.html">http://ameblo.jp/kozake/entry-11502234288.html</a></li>
</ul>
</div>
]]></description>
             <pubDate>Mon, 01 Apr 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/03/03/like_bdd_by_java8.html</link>
            <guid>https://backpaper0.github.io/2013/03/03/like_bdd_by_java8.html</guid>
            <title><![CDATA[Java8でBDDっぽくテストを書けるかもしれないアイデア]]></title>
            <description><![CDATA[<h1>Java8でBDDっぽくテストを書けるかもしれないアイデア</h1>
<p>JasmineでJavaScriptのテスト書いたりJava8のラムダに思いを馳せていたらなんとなく思いつきました。
ラムダにインスタンスイニシャライザを組み合わせたらこんな感じでテストが書けそうです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalcSpec</span> <span class="kd">extends</span> <span class="n">Specs</span> <span class="p">{{</span>

    <span class="n">it</span><span class="p">(</span><span class="s">"1 足す 2 は 3"</span><span class="p">,</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">expect</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">).</span><span class="na">toEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="n">it</span><span class="p">(</span><span class="s">"1 割る 0 は例外"</span><span class="p">,</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="n">expect</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">).</span><span class="na">toThrow</span><span class="p">(</span><span class="n">ArithmeticException</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">});</span>

<span class="p">}}</span>
</pre></div>
</div>
<p>うむ、Jasmineぽい。
まあ実はBDDぽいとかよく分かっていませんが。</p>
<p>itメソッドを呼ぶと第一引数のテスト名をkey、第二引数のRunnableのようなオブジェクトをvalueとするマップに突っ込みます。
このマップのひとつのEntryがひとつのテストになります。
itメソッドはスーパークラスのSpecsに定義されています。
そのSpecs自体に@RunWithが注釈しており、テストはSpecRunnerというテストランナーで実行されます。
SpecRunnerはSpecsに集められたテストを実行します。</p>
<p>などと文章にしても伝えられる気がまったく無いのでSpecsとSpecRunnerのコード晒します。</p>
<p>Specsはこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.LinkedHashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Assert</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>

<span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpecRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Specs</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Spec</span><span class="o">&gt;</span> <span class="n">specs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">it</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Spec</span> <span class="n">spec</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">specs</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Expect</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">expect</span><span class="p">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Expect</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Spec</span> <span class="p">{</span>

        <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Expect</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">;</span>

        <span class="kd">public</span> <span class="nf">Expect</span><span class="p">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toEqual</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="na">call</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toThrow</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">exceptionClass</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">c</span><span class="p">.</span><span class="na">call</span><span class="p">();</span>
                <span class="n">Assert</span><span class="p">.</span><span class="na">fail</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exceptionClass</span><span class="p">.</span><span class="na">isAssignableFrom</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getClass</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="n">Assert</span><span class="p">.</span><span class="na">fail</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>SpecRunnerはこんな感じ。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">app</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.junit.runner.Description</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.Runner</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.notification.Failure</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.notification.RunNotifier</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpecRunner</span> <span class="kd">extends</span> <span class="n">Runner</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Specs</span> <span class="n">spec</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">SpecRunner</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">Specs</span><span class="o">&gt;</span> <span class="n">specClass</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">InstantiationException</span><span class="p">,</span> <span class="n">IllegalAccessException</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">specClass</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Description</span> <span class="nf">getDescription</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Description</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">Description</span><span class="p">.</span><span class="na">createSuiteDescription</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="na">getClass</span><span class="p">());</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">name</span> <span class="p">:</span> <span class="n">spec</span><span class="p">.</span><span class="na">specs</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">desc</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">Description</span><span class="p">.</span><span class="na">createSuiteDescription</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="n">RunNotifier</span> <span class="n">notifier</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">name</span> <span class="p">:</span> <span class="n">spec</span><span class="p">.</span><span class="na">specs</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">Description</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">Description</span><span class="p">.</span><span class="na">createSuiteDescription</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
            <span class="n">notifier</span><span class="p">.</span><span class="na">fireTestStarted</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">spec</span><span class="p">.</span><span class="na">specs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="na">run</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Failure</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Failure</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
                <span class="n">notifier</span><span class="p">.</span><span class="na">fireTestFailure</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
                <span class="n">notifier</span><span class="p">.</span><span class="na">fireTestFinished</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これらのコードを、Java8に対応しているNetBeansの開発版を使用して試してみました。</p>
<img alt="../../../_images/test-result.png" src="https://backpaper0.github.io/_images/test-result.png"/>
<p>いい感じで実行できました。</p>
<p>というわけで、ふわっとした思いつきをサクッと試してみただけですが、なかなかJava8の可能性を感じれた気がします。
テスティングフレームワークに限らずね、色々出てきてくれそうですね。</p>
<p>楽しみだ。はよこいJava8。</p>
<div class="section" id="id1">
<h2>ギットハブにも置いたよ</h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/backpaper0/junit-spec-runner">https://github.com/backpaper0/junit-spec-runner</a></li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 03 Mar 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/01/30/httpserver_jaxb.html</link>
            <guid>https://backpaper0.github.io/2013/01/30/httpserver_jaxb.html</guid>
            <title><![CDATA[HttpServerとJAXBでAPIを組込む]]></title>
            <description><![CDATA[<h1>HttpServerとJAXBでAPIを組込む</h1>
<p>前に小酒さんとJavaのプロセス間通信についてお話しました。</p>
<ul class="simple">
<li><a class="reference external" href="http://togetter.com/li/441590">http://togetter.com/li/441590</a></li>
</ul>
<p>んで、私も監視というかAPIというか、そんな感じのアレを簡易で良いのでサクッと組込む必要が出てきました。
という訳で <a class="reference external" href="http://docs.oracle.com/javase/7/docs/jre/api/net/httpserver/spec/com/sun/net/httpserver/HttpServer.html">HttpServer</a> とJAXBでサクッと組込もうと思います。</p>
<p>ほい、サンプルコード。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpExchange</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.sun.net.httpserver.HttpServer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.swing.JOptionPane</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.swing.SwingUtilities</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.bind.JAXB</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.bind.annotation.XmlRootElement</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Monitor</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">InetSocketAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">backlog</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">HttpServer</span><span class="p">.</span><span class="na">create</span><span class="p">();</span>
        <span class="n">server</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">HttpContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="na">createContext</span><span class="p">(</span><span class="s">"/log"</span><span class="p">);</span>
            <span class="n">HttpHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogHandler</span><span class="p">();</span>
            <span class="n">context</span><span class="p">.</span><span class="na">setHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
            <span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

            <span class="n">SwingUtilities</span><span class="p">.</span><span class="na">invokeAndWait</span><span class="p">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"ダイアログを閉じると鯖終了"</span><span class="p">;</span>
                    <span class="n">JOptionPane</span><span class="p">.</span><span class="na">showMessageDialog</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
            <span class="n">server</span><span class="p">.</span><span class="na">stop</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LogHandler</span> <span class="kd">implements</span> <span class="n">HttpHandler</span> <span class="p">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">HttpExchange</span> <span class="n">exchange</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
            <span class="n">Log</span> <span class="n">log</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Log</span><span class="p">();</span>
            <span class="n">log</span><span class="p">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">;</span>
            <span class="n">log</span><span class="p">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="p">();</span>

            <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">chunked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">exchange</span><span class="p">.</span><span class="na">sendResponseHeaders</span><span class="p">(</span><span class="n">statusCode</span><span class="p">,</span> <span class="n">chunked</span><span class="p">);</span>

            <span class="k">try</span> <span class="p">(</span><span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">exchange</span><span class="p">.</span><span class="na">getResponseBody</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">JAXB</span><span class="p">.</span><span class="na">marshal</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
                <span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@XmlRootElement</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Log</span> <span class="p">{</span>

        <span class="kd">public</span> <span class="n">Result</span> <span class="n">result</span><span class="p">;</span>

        <span class="kd">public</span> <span class="n">Date</span> <span class="n">timestamp</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">enum</span> <span class="n">Result</span> <span class="p">{</span>

        <span class="n">SUCCESS</span><span class="p">,</span> <span class="n">FAILURE</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>HttpServerはアドレス渡して準備して、パス渡してコンテキスト作って、ハンドラ登録すればおk。
Java SEでもHTTP鯖立てるの簡単ですね。
わーい。</p>
<p>今回はアプリケーションの処理結果とタイムスタンプを持ったログを返す感じのハンドラを書いてみました。
ログはPOJOで表現していますが、JAXBでXMLに変換してレスポンスに書き出しています。
このハンドラは次のようなXMLを返します。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
<span class="nt">&lt;log&gt;</span>
    <span class="nt">&lt;result&gt;</span>SUCCESS<span class="nt">&lt;/result&gt;</span>
    <span class="nt">&lt;timestamp&gt;</span>2013-01-30T23:08:37.482+09:00<span class="nt">&lt;/timestamp&gt;</span>
<span class="nt">&lt;/log&gt;</span>
</pre></div>
</div>
<p>XMLベースのWeb APIなら構築するのは簡単ですね。
わーい。</p>
<p>まあもうちょい多機能なAPIを構築したかったらJerseyを突っ込みますが要件によってはこれで十分かなー、とか思ったりしました。</p>
]]></description>
             <pubDate>Wed, 30 Jan 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/01/23/netbeans_jpql.html</link>
            <guid>https://backpaper0.github.io/2013/01/23/netbeans_jpql.html</guid>
            <title><![CDATA[NetBeans 7.2.1でJPQLの補完するー]]></title>
            <description><![CDATA[<h1>NetBeans 7.2.1でJPQLの補完するー</h1>
<p>こんばんは！
em.cQ と打って control + space で createQuery を補完するうらがみです。</p>
<p>もうキャメルケースでの補完が無かったら生きて行けません。
これはEcliなんとかでも出来ます。
たぶんIDEAでも出来るでしょう。</p>
<p>本題。
NetBeansではJPQLの補完もできます、という話。</p>
<img alt="../../../_images/compl1.png" src="https://backpaper0.github.io/_images/compl1.png"/>
<p>FROM も。</p>
<img alt="../../../_images/compl2.png" src="https://backpaper0.github.io/_images/compl2.png"/>
<p>エンティティ名も。</p>
<img alt="../../../_images/compl3.png" src="https://backpaper0.github.io/_images/compl3.png"/>
<p>WHERE や、</p>
<img alt="../../../_images/compl4.png" src="https://backpaper0.github.io/_images/compl4.png"/>
<p>プロパティも。</p>
<img alt="../../../_images/compl5.png" src="https://backpaper0.github.io/_images/compl5.png"/>
<p>演算子も。</p>
<img alt="../../../_images/compl6.png" src="https://backpaper0.github.io/_images/compl6.png"/>
<p>という感じです。
でもこれローカル変数に突っ込むと補完してくれないのが残念です。</p>
<img alt="../../../_images/compl7.png" src="https://backpaper0.github.io/_images/compl7.png"/>
<p>あと@NamedQueryに書くJPQLでも補完できます。</p>
<img alt="../../../_images/compl8.png" src="https://backpaper0.github.io/_images/compl8.png"/>
<p>ローカル変数に突っ込んだときも補完が効いてくれるようになるともっと嬉しいですねー。
簡単ですが、そんな感じでー。</p>
]]></description>
             <pubDate>Wed, 23 Jan 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/01/12/http_trace.html</link>
            <guid>https://backpaper0.github.io/2013/01/12/http_trace.html</guid>
            <title><![CDATA[GlassFish v3.1.2.2でTRACEメソッドを許可しない]]></title>
            <description><![CDATA[<h1>GlassFish v3.1.2.2でTRACEメソッドを許可しない</h1>
<p>デフォルトで許可しないようになっていますが備忘録的に一応書いておきます。
asadminコマンドで設定します。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>asadmin <span class="nb">set</span> configs.config.server-config.network-config.protocols.protocol.http-listener-1.http.trace-enabled<span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
<p>もちろんGUI管理コンソールからも設定可能で、構成 -&gt; server-config -&gt; ネットワーク構成 -&gt; プロトコル -&gt; http-listener-1 の「HTTP」タブを開いてトレースのチェックを外します。</p>
<p>この状態でTRACEリクエストを投げると405 Method Not Allowedが返ってきます。</p>
]]></description>
             <pubDate>Sat, 12 Jan 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/01/11/cookie.html</link>
            <guid>https://backpaper0.github.io/2013/01/11/cookie.html</guid>
            <title><![CDATA[GlassFish 3.1.2.2でCookieにsecure属性とhttpOnly属性をつける]]></title>
            <description><![CDATA[<h1>GlassFish 3.1.2.2でCookieにsecure属性とhttpOnly属性をつける</h1>
<p>何もしなくてもhttpOnly属性は付いてる感じですが、それはGrizzlyの機能なのでしょうかね。
それはそれでまた調べておくことにします。</p>
<div class="section" id="id1">
<h2>プログラムで設定する</h2>
<p><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/servlet/SessionCookieConfig.html">javax.servlet.SessionCookieConfig</a> を使用します。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span/><span class="kn">package</span> <span class="nn">example</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletContainerInitializer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.SessionCookieConfig</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CookieSettings</span> <span class="kd">implements</span> <span class="n">ServletContainerInitializer</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">c</span><span class="p">,</span> <span class="n">ServletContext</span> <span class="n">ctx</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="p">{</span>
        <span class="n">SessionCookieConfig</span> <span class="n">scc</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="na">getSessionCookieConfig</span><span class="p">();</span>
        <span class="n">scc</span><span class="p">.</span><span class="na">setHttpOnly</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="n">scc</span><span class="p">.</span><span class="na">setSecure</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="glassfish-server-deployment-descriptor">
<h2>GlassFish Server Deployment Descriptorで設定する</h2>
<p><a class="reference external" href="http://docs.oracle.com/cd/E18930_01/html/821-2417/beash.html#scrolltoc">cookie-properties - Oracle GlassFish Server 3.1 Application Deployment Guide</a> を参照。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE glassfish-web-app PUBLIC</span>
<span class="cp">  "-//GlassFish.org//DTD GlassFish Application Server 3.1 Servlet 3.0//EN"</span>
<span class="cp">  "http://glassfish.org/dtds/glassfish-web-app_3_0-1.dtd"&gt;</span>
<span class="nt">&lt;glassfish-web-app</span> <span class="na">error-url=</span><span class="s">""</span><span class="nt">&gt;</span>
 <span class="nt">&lt;session-config&gt;</span>
  <span class="nt">&lt;cookie-properties&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"cookieSecure"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"cookieHttpOnly"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/cookie-properties&gt;</span>
 <span class="nt">&lt;/session-config&gt;</span>
<span class="nt">&lt;/glassfish-web-app&gt;</span>
</pre></div>
</div>
</div>
]]></description>
             <pubDate>Fri, 11 Jan 2013 00:00:00 +0000</pubDate>
        </item>
    
        <item>
            <link>https://backpaper0.github.io/2013/01/06/welcome_to_tinkerer.html</link>
            <guid>https://backpaper0.github.io/2013/01/06/welcome_to_tinkerer.html</guid>
            <title><![CDATA[Welcome to Tinkerer]]></title>
            <description><![CDATA[<h1>Welcome to Tinkerer</h1>
<p>あけおめ！</p>
<p>そんなアレで<a class="reference external" href="http://d.hatena.ne.jp/backpaper0/">はてなダイアリー</a>から乗り換える何かを模索中なのです。
<a class="reference external" href="http://tinkerer.me/">Tinkerer</a>というSphinxでブログが書ける拡張を見つけたので何となく使ってみようかと。
このエントリではインストールからbackpaper0.github.comでの公開までの手順を適当に書きます。
なお、エントリのタイトルは<a class="reference external" href="http://shizone.github.com/blog/2012/12/15/uerukamutouokutopuresu/">ウェルカム・トゥ・オクトプレス</a>をパクったです。</p>
<div class="section" id="id3">
<h2>Tinkererをインストールする</h2>
<p>easy_installで一発ですよ奥さん。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>easy_install -U Tinkerer
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>セットアップする</h2>
<p>適当にディレクトリ作ってからtinker -sします。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>mkdir blog
<span class="nb">cd</span> blog
tinker -s
</pre></div>
</div>
<p>conf.pyが作成されるのでブログの名前とか設定します。</p>
</div>
<div class="section" id="id5">
<h2>記事を書く</h2>
<p>エントリ作ります。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>tinker -p <span class="s2">"Welcome to Tinkerer"</span>
</pre></div>
</div>
<p>日付を表すディレクトリに続きエントリのrstファイルが作成されますのでこれを編集します。</p>
</div>
<div class="section" id="id6">
<h2>ビルドする</h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span/>tinker -b
</pre></div>
</div>
<p>blog/htmlディレクトリにもろもろ出力されます。</p>
</div>
<div class="section" id="id7">
<h2>公開する</h2>
<p>blog/html以下をbackpaper0.github.comにプッシュします。
まあぶっちゃけこれからやることなのでこの記事書いてる段階ではそれで良いのか分かりませんが。</p>
</div>
<div class="section" id="id8">
<h2>まとめ</h2>
<ul class="simple">
<li>rstで書けるから嬉しい</li>
<li>Sphinx好きなので嬉しい</li>
<li>なんか探すときはgrep出来るから嬉しい</li>
<li>Tinkerer簡単そうで嬉しい</li>
</ul>
<p>という感じでしばらく使ってみようと思います。</p>
</div>
]]></description>
             <pubDate>Sun, 06 Jan 2013 00:00:00 +0000</pubDate>
        </item>
    
    </channel>
</rss>